<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <title>夢工廠 | 儲值申請</title>
    <style>
        :root { --primary: #ff8fa3; --bg: #f8f9fb; --gold: #ffb800; --text: #2c3e50; --danger: #ff4757; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'PingFang TC', sans-serif; padding-bottom: 50px; }
       
        .header { padding: 15px 20px; display: flex; align-items: center; background: #fff; box-shadow: 0 1px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: none; border: 1.5px solid var(--primary); color: var(--primary); padding: 5px 18px; border-radius: 50px; cursor: pointer; text-decoration: none; font-size: 0.8rem; font-weight: 900; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        
        .card { background: #fff; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        .section-title { font-size: 1.1rem; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 10px; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; color: #999; margin-bottom: 8px; }
        input { width: 100%; padding: 15px; border: 2px solid #f0f2f5; border-radius: 15px; font-size: 1.2rem; font-weight: 900; color: var(--primary); outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #fff9fa; }

        .bank-info { background: #fdfdfd; border: 1px dashed #ddd; border-radius: 15px; padding: 15px; margin-top: 10px; }
        .bank-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .bank-row span { color: #888; }
        .bank-row b { color: #333; letter-spacing: 1px; }

        .warning-box { background: #fff5f5; border-radius: 15px; padding: 15px; margin: 20px 0; border: 1px solid #ffebeb; }
        .warning-box h4 { margin: 0 0 8px; color: var(--danger); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .warning-box p { margin: 0; font-size: 0.75rem; color: #cc6666; line-height: 1.6; font-weight: bold; }

        .submit-btn { 
            background: var(--primary); color: #fff; border: none; width: 100%; padding: 18px; 
            border-radius: 50px; font-size: 1.1rem; font-weight: 900; cursor: pointer;
            box-shadow: 0 8px 20px rgba(255,143,163,0.3); transition: 0.3s;
        }
        .submit-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .m-box { background: #fff; padding: 30px; border-radius: 30px; text-align: center; width: 100%; max-width: 320px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="header">
        <a href="profile.html" class="back-btn">← 返回</a>
    </div>

    <div class="container">
        <div class="card">
            <div class="section-title">填寫儲值金額</div>
            <div class="input-group">
                <label>儲值台幣 (NTD)</label>
                <input type="number" id="amountIn" placeholder="最小金額 100" min="100" oninput="calcP()">
            </div>
            <div style="text-align: center; color: #999; font-size: 0.9rem;">
                預計獲得：<b id="pOut" style="color:var(--gold); font-size: 1.2rem;">0</b> P
            </div>
        </div>

        <div class="card">
            <div class="section-title">指定匯款帳戶</div>
            <div class="bank-info">
                <div class="bank-row"><span>銀行代碼</span><b>822 396 街口</b></div>
                <div class="bank-row"><span>帳戶號碼</span><b>903515547</b></div>
            </div>
            <p style="font-size: 0.7rem; color: #aaa; margin-top: 10px;">※ 匯款完成後請點擊下方按鈕，系統將會通知客服查帳。</p>
        </div>

        <div class="warning-box">
            <h4>⚠️ 儲值須知與提醒</h4>
            <p>
                1. 點數匯率為 1:1，儲值後僅供商城內消費使用。<br>
                2. <b>絕對禁止：</b>本商城不提供點數換回現金之服務。<br>
                3. 點擊送出申請即代表已完成匯款並同意上述規範。
            </p>
        </div>

        <button class="submit-btn" id="submitBtn" onclick="submitRequest()">我已匯款，送出申請</button>
    </div>

    <div id="resModal" class="modal">
        <div class="m-box">
            <div style="font-size: 3rem; margin-bottom: 15px;">✅</div>
            <h3 style="margin: 0 0 10px;">申請已送出</h3>
            <p style="color: #666; font-size: 0.9rem; line-height: 1.6;">已發送通知給客服。<br>5分鐘內查帳完成後會立刻幫您入點！</p>
            <button class="submit-btn" style="margin-top: 20px;" onclick="location.href='profile.html'">確認並返回</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const _cc = { apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE", databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com", projectId: "dream-169dc", appId: "1:214137228622:web:84d14bad85d865ee94e21f" };
        const _app = initializeApp(_cc); const _db = getDatabase(_app);
        const _uid = localStorage.getItem('myScratchCode');

        const GAS_URL = "https://script.google.com/macros/s/AKfycbz07UGZEQrF2A9IRlYkqnFQv4ZbquNaIb4PDsEKXxnd7DrzUrL_9oBsHl2oB3ThEItf/exec"; 

        if(!_uid) location.href = 'index.html';

        window.calcP = () => {
            const val = document.getElementById('amountIn').value;
            document.getElementById('pOut').innerText = val || 0;
        };

        window.submitRequest = async () => {
            const amt = document.getElementById('amountIn').value;
            if(!amt || amt < 100) return alert("請輸入正確的儲值金額 (最小 100)");

            const btn = document.getElementById('submit
