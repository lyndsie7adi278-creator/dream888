<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <title>å¤¢å·¥å»  | å„²å€¼ç”³è«‹</title>
    <style>
        :root { --primary: #ff8fa3; --bg: #f8f9fb; --gold: #ffb800; --text: #2c3e50; --danger: #ff4757; --success: #2ecc71; --line: #06c755; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'PingFang TC', sans-serif; padding-bottom: 50px; }
        
        .header { padding: 15px 20px; display: flex; align-items: center; background: #fff; box-shadow: 0 1px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: none; border: 1.5px solid var(--primary); color: var(--primary); padding: 5px 18px; border-radius: 50px; cursor: pointer; text-decoration: none; font-size: 0.8rem; font-weight: 900; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        
        .card { background: #fff; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        .section-title { font-size: 1.1rem; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .section-title::before { content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 10px; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; color: #999; margin-bottom: 8px; }
        input { width: 100%; padding: 15px; border: 2px solid #f0f2f5; border-radius: 15px; font-size: 1.2rem; font-weight: 900; color: var(--primary); outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: #fff9fa; }
        
        /* è©¦ç®—å€åŸŸæ¨£å¼ */
        .calc-box { background: #fff9fa; border-radius: 15px; padding: 15px; margin-top: 15px; border: 1px solid #ffe8eb; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; color: #666; }
        .calc-total { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .calc-total b { font-size: 1.4rem; color: var(--gold); }

        /* è¦å‰‡èªªæ˜å¡ç‰‡ */
        .rule-card { background: #fff; border-radius: 20px; padding: 20px; border: 1px solid #f0f0f0; margin-bottom: 20px; }
        .rule-item { margin-bottom: 15px; }
        .rule-item b { display: block; color: var(--primary); font-size: 0.9rem; margin-bottom: 5px; }
        .rule-item p { margin: 0; font-size: 0.75rem; color: #7f8c8d; line-height: 1.6; }

        /* ğŸŸ¢ æ–°å¢ï¼šLine æ´»å‹•å°ˆç”¨æ¨£å¼ */
        .line-promo-box { background: #f0fff4; border: 1px solid #c3e6cb; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .line-promo-title { color: var(--line); font-weight: 900; font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .line-link { color: var(--line); text-decoration: underline; font-weight: bold; cursor: pointer; }

        .bank-info { background: #fdfdfd; border: 1px dashed #ddd; border-radius: 15px; padding: 15px; margin-top: 10px; }
        .bank-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; }
        .bank-row span { color: #888; }
        .bank-row b { color: #333; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        
        .copy-btn { background: var(--primary); color: #fff; border: none; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; font-weight: bold; transition: 0.2s; }

        .warning-box { background: #fff5f5; border-radius: 15px; padding: 15px; margin: 20px 0; border: 1px solid #ffebeb; }
        .warning-box h4 { margin: 0 0 8px; color: var(--danger); font-size: 0.9rem; }
        .warning-box p { margin: 0; font-size: 0.75rem; color: #cc6666; line-height: 1.6; font-weight: bold; }

        .submit-btn { 
            background: var(--primary); color: #fff; border: none; width: 100%; padding: 18px; 
            border-radius: 50px; font-size: 1.1rem; font-weight: 900; cursor: pointer;
            box-shadow: 0 8px 20px rgba(255,143,163,0.3); transition: 0.3s;
        }
        .submit-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .m-box { background: #fff; padding: 30px; border-radius: 30px; text-align: center; width: 100%; max-width: 320px; }
        
        #copyTip { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 20px; border-radius: 50px; font-size: 0.8rem; display: none; z-index: 3000; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="copyTip">âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <div class="header">
        <a href="profile.html" class="back-btn">â† è¿”å›</a>
    </div>

    <div class="container">
        
        <div class="rule-card">
            <div class="section-title">å„²å€¼å„ªæƒ èªªæ˜</div>
            
            <div class="line-promo-box">
                <div class="line-promo-title">ğŸ§© Line ç©åˆ†æ›ç›²ç›’ (500å…ƒ = 1é»)</div>
                <p style="font-size:0.8rem; color:#555; margin:0; line-height:1.5;">
                    å–®ç­†å„²å€¼æ¯æ»¿ <b>500</b> å…ƒï¼Œé¡å¤–ç²å¾— <b>1</b> é» Line ç©åˆ†ï¼<br>
                    (ä¾‹å¦‚: å„²å€¼ 1000 å…ƒ +2 é»ï¼Œä»¥æ­¤é¡æ¨)<br>
                    ç´¯ç©é»æ•¸å¯è‡³ <span class="line-link" onclick="window.open('https://line.me/R/ti/p/@dream8','_blank')">å®˜æ–¹ Line</span> å…Œæ›ç†±é–€ç›²ç›’ã€å…¬ä»”æ¨¡å‹ï¼
                </p>
            </div>

            <div class="rule-item">
                <b>âœ¨ é¦–å„²é™å®š (10% è´ˆé»)</b>
                <p>å¸³è™Ÿã€Œç¬¬ä¸€æ¬¡ã€å„²å€¼å³ç‚ºé¦–å„²ã€‚ä¾‹å¦‚ï¼šå„²å€¼ 1000 å…ƒï¼Œå¯é¡å¤–ç²è´ˆ 100 Pï¼Œå…±å¾— 1100 Pã€‚é¦–å„²åŠ ç¢¼åƒ…é™ä¸€æ¬¡ã€‚</p>
            </div>
            <div class="rule-item">
                <b>ğŸ”¥ çºŒå„²åŠ ç¢¼ (3% è´ˆé»)</b>
                <p>éé¦–å„²ç”¨æˆ¶ï¼Œå–®ç­†å„²å€¼æ»¿ 1000 å…ƒï¼Œç²è´ˆ 3% é»æ•¸ã€‚ä¾‹å¦‚ï¼šå„²å€¼ 1000 å…ƒï¼Œé¡å¤–ç²è´ˆ 30 Pï¼Œå…±å¾— 1030 Pã€‚</p>
            </div>
        </div>

        <div class="card">
            <div class="section-title">å¡«å¯«å„²å€¼è³‡è¨Š</div>
            <div class="input-group">
                <label>å„²å€¼å°å¹£ (NTD)</label>
                <input type="number" id="amountIn" placeholder="è¼¸å…¥é‡‘é¡ (æœ€å° 100)" min="100">
            </div>
            <div class="input-group">
                <label>æ‚¨çš„åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" id="accountEnd" placeholder="è«‹å¡«å¯« 5 ä½æ•¸å­—" maxlength="5">
            </div>
            
            <div class="calc-box">
                <div class="calc-row"><span>å„²å€¼æœ¬é‡‘</span><span id="calcBase">0 P</span></div>
                <div class="calc-row"><span id="bonusLabel">é¦–å„²/çºŒå„²è´ˆé»</span><span id="calcBonus" style="color:var(--success)">+0 P</span></div>
                
                <div class="calc-row" style="margin-top:5px; border-top:1px dashed #eee; padding-top:5px;">
                    <span style="color:var(--line); font-weight:bold;">ğŸ§© Line ç›²ç›’ç©åˆ†</span>
                    <span id="calcLinePoints" style="color:var(--line); font-weight:900;">+0 é»</span>
                </div>

                <div class="calc-total">
                    <span>é è¨ˆå…±å¾—ï¼š</span>
                    <b id="pOut">0</b>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">æŒ‡å®šåŒ¯æ¬¾å¸³æˆ¶</div>
            <div class="bank-info">
                <div class="bank-row"><span>éŠ€è¡Œä»£ç¢¼</span><b>396 è¡—å£æ”¯ä»˜</b></div>
                <div class="bank-row"><span>å¸³æˆ¶è™Ÿç¢¼</span><b>903515547 <button class="copy-btn" onclick="copyText('903515547')">è¤‡è£½</button></b></div>
            </div>
            <p style="font-size: 0.7rem; color: #aaa; margin-top: 10px;">â€» åŒ¯æ¬¾å®Œæˆå¾Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå®¢æœå°‡æ–¼ 5 åˆ†é˜å…§æŸ¥å¸³ã€‚</p>
        </div>

        <div class="warning-box">
            <h4>âš ï¸ å„²å€¼é ˆçŸ¥</h4>
            <p>1. é»æ•¸åŒ¯ç‡ç‚º 1 å°å¹£ : 1 På¹£ã€‚<br>2. çµ•å°ç¦æ­¢é»æ•¸æ›å›ç¾é‡‘æœå‹™ã€‚<br>3. é€å‡ºç”³è«‹å³ä»£è¡¨å·²å®ŒæˆåŒ¯æ¬¾ã€‚</p>
        </div>

        <button class="submit-btn" id="submitBtn" onclick="submitRequest()">æˆ‘å·²åŒ¯æ¬¾ï¼Œé€å‡ºç”³è«‹</button>
    </div>

    <div id="resModal" class="modal">
        <div class="m-box">
            <div style="font-size: 3rem; margin-bottom: 15px;">âœ…</div>
            <h3>ç”³è«‹å·²é€å‡º</h3>
            <p style="color: #666; font-size: 0.9rem;">å·²ç™¼é€é€šçŸ¥ï¼ŒæŸ¥å¸³å®Œæˆå¾Œæœƒç«‹åˆ»å…¥é»ï¼</p>
            <button class="submit-btn" style="margin-top: 20px;" onclick="location.href='profile.html'">ç¢ºèªä¸¦è¿”å›</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const _cc = { 
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco", 
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com", 
            projectId: "dream8-7b161", 
            appId: "1:606218522479:web:2737643db3de735af7e29a" 
        };

        const _app = initializeApp(_cc); 
        const _db = getDatabase(_app);
        const _uid = localStorage.getItem('myScratchCode');
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz07UGZEQrF2A9IRlYkqnFQv4ZbquNaIb4PDsEKXxnd7DrzUrL_9oBsHl2oB3ThEItf/exec"; 

        if(!_uid) location.href = 'index.html';

        // ğŸŸ¢ æª¢æŸ¥æ˜¯å¦ç‚ºé¦–å„²ä¸¦è¨ˆç®—é»æ•¸ (å« Line ç©åˆ†)
        const amountInput = document.getElementById('amountIn');
        const calcP = async () => {
            const amt = Number(amountInput.value) || 0;
            const snap = await get(ref(_db, `users/${_uid}`));
            const userData = snap.val() || {};
            const isFirst = (userData.hasToppedUp === false || userData.hasToppedUp === undefined);
            
            let bonus = 0;
            if (isFirst) {
                bonus = amt * 0.1; // é¦–å„² 10%
                document.getElementById('bonusLabel').innerText = "âœ¨ é¦–å„²åŠ ç¢¼ (10%)";
            } else if (amt >= 1000) {
                bonus = amt * 0.03; // çºŒå„² 3% (æ»¿åƒ)
                document.getElementById('bonusLabel').innerText = "ğŸ”¥ çºŒå„²åŠ ç¢¼ (3%)";
            } else {
                bonus = 0;
                document.getElementById('bonusLabel').innerText = "ä¸€èˆ¬å„²å€¼ (ç„¡åŠ ç¢¼)";
            }

            // ğŸŸ¢ è¨ˆç®— Line ç©åˆ†ï¼šæ¯ 500 å…ƒ = 1 é»
            const linePoints = Math.floor(amt / 500);

            document.getElementById('calcBase').innerText = amt + " P";
            document.getElementById('calcBonus').innerText = "+" + Math.floor(bonus) + " P";
            document.getElementById('calcLinePoints').innerText = "+" + linePoints + " é»"; // é¡¯ç¤ºç©åˆ†
            document.getElementById('pOut').innerText = Math.floor(amt + bonus) + " P";
        };
        amountInput.addEventListener('input', calcP);

        window.copyText = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                const tip = document.getElementById('copyTip');
                tip.style.display = 'block';
                setTimeout(() => tip.style.display = 'none', 2000);
            });
        };

        window.submitRequest = async () => {
            const amt = amountInput.value;
            const accEnd = document.getElementById('accountEnd').value.trim();

            if(!amt || amt < 100) return alert("æœ€å°å„²å€¼é‡‘é¡ç‚º 100");
            if(accEnd.length !== 5 || isNaN(accEnd)) return alert("è«‹è¼¸å…¥ 5 ä½æ•¸å­—çš„å¾Œäº”ç¢¼");

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "æäº¤ä¸­...";

            try {
                await push(ref(_db, `depositRequests`), {
                    uid: _uid,
                    amount: Number(amt),
                    accountEnd: accEnd,
                    status: "pending",
                    time: serverTimestamp()
                });

                fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    body: JSON.stringify({ uid: _uid, amount: amt, accountEnd: accEnd })
                });
                
                document.getElementById('resModal').style.display = 'flex';
            } catch (e) {
                alert("ç”³è«‹å‡ºéŒ¯");
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
