<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAM æ——è‰¦å•†åŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: sans-serif; }
        .gold-text { color: #eab308; }
        .category-btn.active { background: #eab308; color: #0f172a; border-color: #eab308; }
        .modal-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4">
    <div class="bg-slate-800 rounded-3xl p-6 mb-6 text-center shadow-xl border border-slate-700 relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ğŸ’</div>
        <p class="text-slate-400 text-xs uppercase tracking-widest mb-1">My Balance</p>
        <h1 id="userPoints" class="text-5xl font-black gold-text tracking-tighter">---</h1>
    </div>

    <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-2" id="categoryBar">
        <button onclick="filterCat('å…¨éƒ¨')" class="cat-btn active px-6 py-2 rounded-full border border-slate-700 text-sm font-bold whitespace-nowrap transition">å…¨éƒ¨</button>
    </div>

    <div id="productGrid" class="grid grid-cols-2 gap-4 pb-10"></div>

    <div id="itemModal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-6">
        <div class="bg-slate-800 w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl border border-slate-700 animate-in fade-in zoom-in duration-300">
            <img id="mImg" src="" class="w-full h-52 object-cover bg-slate-900">
            <div class="p-6">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="mName" class="text-xl font-bold"></h2>
                    <span id="mPrice" class="gold-text font-black text-lg"></span>
                </div>
                <div class="h-24 overflow-y-auto mb-6 no-scrollbar">
                    <p id="mDesc" class="text-slate-400 text-sm leading-relaxed"></p>
                </div>
                
                <div class="flex items-center justify-between bg-slate-900 rounded-2xl p-2 mb-6 border border-slate-700">
                    <button onclick="adjQty(-1)" class="w-12 h-12 flex items-center justify-center text-2xl font-bold text-yellow-500">-</button>
                    <div class="text-center">
                        <span id="mQty" class="text-xl font-black">1</span>
                        <p class="text-[10px] text-slate-500 uppercase">æ•¸é‡</p>
                    </div>
                    <button onclick="adjQty(1)" class="w-12 h-12 flex items-center justify-center text-2xl font-bold text-yellow-500">+</button>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-2xl font-bold bg-slate-700 text-white">è¿”å›</button>
                    <button onclick="confirmRedeem()" class="flex-[2] py-3 rounded-2xl font-bold bg-yellow-600 text-slate-900 shadow-lg shadow-yellow-900/20">ç¢ºèªå…Œæ›</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs",
            authDomain: "dreampoint-b37df.firebaseapp.com",
            projectId: "dreampoint-b37df",
            storageBucket: "dreampoint-b37df.firebasestorage.app",
            messagingSenderId: "454938973111",
            appId: "1:454938973111:web:2191261a3175c8115d0e32",
            measurementId: "G-H4L410HB29"
        };
        const LIFF_ID = "2008964915-gP6NfUpi";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let user = { id: "", points: 0 };
        let allProducts = {};
        let currentItem = null;
        let qty = 1;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                user.id = profile.userId;
                sync();
            }
        }

        function sync() {
            db.ref('users/' + user.id + '/points').on('value', snap => {
                user.points = snap.val() || 0;
                document.getElementById('userPoints').innerText = user.points.toLocaleString();
            });

            db.ref('products').on('value', snap => {
                allProducts = snap.val() || {};
                updateCategoryBar();
                filterCat('å…¨éƒ¨');
            });
        }

        function updateCategoryBar() {
            const cats = new Set(['å…¨éƒ¨']);
            for(let id in allProducts) {
                if(allProducts[id].cat) cats.add(allProducts[id].cat);
            }
            const bar = document.getElementById('categoryBar');
            bar.innerHTML = '';
            cats.forEach(c => {
                bar.innerHTML += `<button onclick="filterCat('${c}')" class="cat-btn px-6 py-2 rounded-full border border-slate-700 text-sm font-bold whitespace-nowrap transition ${c==='å…¨éƒ¨'?'active':''}">${c}</button>`;
            });
        }

        function filterCat(cat) {
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.toggle('active', b.innerText === cat);
            });
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            for(let id in allProducts) {
                const p = allProducts[id];
                if(cat !== 'å…¨éƒ¨' && p.cat !== cat) continue;
                grid.innerHTML += `
                    <div onclick="openModal('${id}')" class="bg-slate-800 rounded-3xl overflow-hidden border border-slate-700 shadow-lg active:scale-95 transition">
                        <img src="${p.img}" class="w-full h-32 object-cover bg-slate-900">
                        <div class="p-4">
                            <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">${p.cat || 'æœªåˆ†é¡'}</p>
                            <p class="font-bold text-slate-100 truncate text-sm mb-1">${p.name}</p>
                            <p class="gold-text font-black text-base">${p.price.toLocaleString()} <span class="text-[10px]">PTS</span></p>
                        </div>
                    </div>`;
            }
        }

        function openModal(id) {
            currentItem = { id, ...allProducts[id] };
            qty = 1;
            document.getElementById('mImg').src = currentItem.img;
            document.getElementById('mName').innerText = currentItem.name;
            document.getElementById('mPrice').innerText = currentItem.price.toLocaleString() + " PTS";
            document.getElementById('mDesc').innerText = currentItem.desc || "æ­¤å•†å“æš«ç„¡è©³ç´°ä»‹ç´¹å…§å®¹ã€‚";
            document.getElementById('mQty').innerText = qty;
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function adjQty(v) {
            qty = Math.max(1, qty + v);
            document.getElementById('mQty').innerText = qty;
        }

        function closeModal() {
            document.getElementById('itemModal').classList.add('hidden');
        }

        async function confirmRedeem() {
            const totalCost = currentItem.price * qty;
            if(user.points < totalCost) return alert("æ‚¨çš„é»æ•¸é¤˜é¡ä¸è¶³ä»¥å…Œæ›æ­¤æ•¸é‡");
            
            if(confirm(`ç¢ºå®šè¦å…Œæ› ${qty} å€‹ã€Œ${currentItem.name}ã€å—ï¼Ÿ\nç¸½è¨ˆæ‰£é™¤ï¼š${totalCost} é»`)) {
                const newTotal = user.points - totalCost;
                await db.ref('users/' + user.id).update({ points: newTotal });
                
                // ç™¼é€ Line é€šçŸ¥
                const msg = `ğŸ å…Œæ›æˆåŠŸï¼\né …ç›®ï¼š${currentItem.name} x ${qty}\næ‰£é™¤é»æ•¸ï¼š${totalCost}\nç›®å‰é¤˜é¡ï¼š${newTotal}`;
                fetch(`${GAS_URL}?userId=${user.id}&msg=${encodeURIComponent(msg)}`, { mode: 'no-cors' });
                
                alert("å…Œæ›æˆåŠŸï¼è«‹ç¢ºèªæ‚¨çš„ Line é€šçŸ¥");
                closeModal();
            }
        }
        window.onload = init;
    </script>
</body>
</html>
