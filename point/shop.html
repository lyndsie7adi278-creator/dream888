<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAM å¤¢å¹»å•†åŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .item-card { background: #1e293b; border: 1px solid rgba(234, 179, 8, 0.2); border-radius: 20px; transition: 0.3s; }
        .item-card:hover { border-color: #eab308; }
        .gold-text { color: #eab308; }
        .gold-btn { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); }
    </style>
</head>
<body class="p-5">
    <div class="bg-slate-800/50 rounded-3xl p-8 mb-8 text-center shadow-2xl border border-slate-700">
        <p class="text-slate-400 text-xs uppercase tracking-widest mb-1">Current Points</p>
        <h1 id="userPoints" class="text-5xl font-black gold-text tracking-tighter">---</h1>
        <p class="mt-2 text-[10px] text-slate-500" id="userIdDisplay">è¼‰å…¥ä¸­...</p>
    </div>

    <h2 class="text-xl font-bold mb-6 flex items-center">
        <span class="w-1 h-6 bg-yellow-500 mr-3 rounded-full"></span> å…Œæ›ä¸­å¿ƒ
    </h2>

    <div id="productGrid" class="grid grid-cols-2 gap-4">
        </div>

    <script>
        const firebaseConfig = { 
            // å¡«å…¥ä½ çš„ Firebase Config
        };
        const LIFF_ID = "2008964915-gP6NfUpi";
        const GAS_URL = "AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ";
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let user = { id: "", points: 0 };

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                user.id = profile.userId;
                document.getElementById('userIdDisplay').innerText = "ID: " + user.id.substring(0,8) + "...";
                sync();
            }
        }

        function sync() {
            db.ref('users/' + user.id + '/points').on('value', snap => {
                user.points = snap.val() || 0;
                document.getElementById('userPoints').innerText = user.points.toLocaleString();
            });

            db.ref('products').on('value', snap => {
                const ps = snap.val();
                const grid = document.getElementById('productGrid');
                grid.innerHTML = '';
                for (let id in ps) {
                    grid.innerHTML += `
                        <div class="item-card p-4 shadow-lg">
                            <img src="${ps[id].img}" class="w-full h-32 object-cover rounded-xl mb-3">
                            <p class="font-bold text-slate-100 mb-1 truncate">${ps[id].name}</p>
                            <p class="gold-text font-black text-lg mb-3">${ps[id].price} <span class="text-[10px]">PTS</span></p>
                            <button onclick="redeem('${id}', '${ps[id].name}', ${ps[id].price})" class="w-full gold-btn text-slate-900 py-2 rounded-xl text-xs font-bold shadow-lg">ç«‹å³å…Œæ›</button>
                        </div>`;
                }
            });
        }

        async function redeem(id, name, price) {
            if (user.points < price) return alert("é»æ•¸é¤˜é¡ä¸è¶³ï¼");
            if (confirm(`ç¢ºå®šè¦ç”¨ ${price} é»å…Œæ›ã€Œ${name}ã€å—ï¼Ÿ`)) {
                const newTotal = user.points - price;
                await db.ref('users/' + user.id).update({ points: newTotal });
                const msg = `ğŸ’° å…Œæ›æˆåŠŸï¼\né …ç›®ï¼š${name}\næ‰£é™¤ï¼š${price} é»\nå‰©é¤˜ï¼š${newTotal} é»`;
                fetch(`${GAS_URL}?userId=${user.id}&msg=${encodeURIComponent(msg)}`, { mode: 'no-cors' })
                .then(() => { alert("å…Œæ›æˆåŠŸï¼è«‹çœ‹ Line é€šçŸ¥"); liff.closeWindow(); });
            }
        }
        window.onload = init;
    </script>
</body>
</html>
