<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>DREAM SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: system-ui; }
        .gold-text { color: #eab308; }
        .bg-gold { background: #eab308; }
        .cat-btn.active { background: #eab308; color: #111; }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(12px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 pb-20">
    <div class="bg-slate-800 rounded-3xl p-6 mb-4 text-center border border-slate-700 shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4">
            <button onclick="openRecord()" class="bg-slate-900/50 p-2 rounded-xl text-xs font-bold border border-slate-700">ÂÖåÊèõÁ¥ÄÈåÑ</button>
        </div>
        <p class="text-slate-400 text-[10px] tracking-[0.2em] mb-1">CURRENT BALANCE</p>
        <h1 id="userPoints" class="text-5xl font-black gold-text tracking-tighter italic">---</h1>
    </div>

    <div id="categoryBar" class="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar"></div>
    <div id="productGrid" class="grid grid-cols-2 gap-3"></div>

    <div id="itemModal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-6">
        <div class="bg-slate-800 w-full max-w-sm rounded-[2.5rem] overflow-hidden border border-slate-700 shadow-2xl">
            <img id="mImg" src="" class="w-full h-56 object-cover">
            <div class="p-6">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="mName" class="text-xl font-bold"></h2>
                    <span id="mPrice" class="gold-text font-black text-xl"></span>
                </div>
                <p id="mDesc" class="text-slate-400 text-sm mb-6 h-12 overflow-y-auto"></p>
                <div class="flex items-center justify-between bg-slate-900 rounded-2xl p-2 mb-6 border border-slate-700 shadow-inner">
                    <button onclick="adjQty(-1)" class="w-12 h-12 text-2xl font-bold gold-text">-</button>
                    <span id="mQty" class="text-xl font-black">1</span>
                    <button onclick="adjQty(1)" class="w-12 h-12 text-2xl font-bold gold-text">+</button>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-4 rounded-2xl font-bold bg-slate-700">ËøîÂõû</button>
                    <button onclick="confirmRedeem()" class="flex-[2] py-4 rounded-2xl font-bold bg-gold text-slate-900 active:scale-95 transition">Á¢∫Ë™çÂÖåÊèõ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="recordModal" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-md h-[80vh] rounded-[2.5rem] flex flex-col border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold gold-text italic">Redeem History</h2>
                <button onclick="closeRecord()" class="text-slate-500">‚úï</button>
            </div>
            <div id="recordList" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs", authDomain: "dreampoint-b37df.firebaseapp.com", projectId: "dreampoint-b37df", databaseURL: "https://dreampoint-b37df-default-rtdb.firebaseio.com/", storageBucket: "dreampoint-b37df.firebasestorage.app", messagingSenderId: "454938973111", appId: "1:454938973111:web:2191261a3175c8115d0e32" };
        const LIFF_ID = "2008964915-gP6NfUpi", GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        let user = { id: "", name: "", points: 0 }, allProducts = {}, currentItem = null, qty = 1;

        async function init() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) liff.login();
            else { const profile = await liff.getProfile(); user.id = profile.userId; user.name = profile.displayName; sync(); }
        }

        function sync() {
            db.ref('users/'+user.id+'/points').on('value', s => { user.points = s.val() || 0; document.getElementById('userPoints').innerText = user.points.toLocaleString(); });
            db.ref('products').on('value', s => { allProducts = s.val() || {}; updateCats(); filter('ÂÖ®ÈÉ®'); });
        }

        function updateCats() {
            const cats = new Set(['ÂÖ®ÈÉ®']); for(let id in allProducts) if(allProducts[id].cat) cats.add(allProducts[id].cat);
            const bar = document.getElementById('categoryBar'); bar.innerHTML = '';
            cats.forEach(c => { bar.innerHTML += `<button onclick="filter('${c}')" class="cat-btn px-6 py-2 rounded-full border border-slate-700 text-xs font-bold whitespace-nowrap transition ${c==='ÂÖ®ÈÉ®'?'active':''}">${c}</button>`; });
        }

        function filter(cat) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.innerText === cat));
            const grid = document.getElementById('productGrid'); grid.innerHTML = '';
            for(let id in allProducts) {
                const p = allProducts[id]; if(cat !== 'ÂÖ®ÈÉ®' && p.cat !== cat) continue;
                grid.innerHTML += `<div onclick="openModal('${id}')" class="bg-slate-800 rounded-3xl overflow-hidden border border-slate-700 active:scale-95 transition shadow-lg">
                    <img src="${p.img}" class="w-full h-36 object-cover border-b border-slate-700">
                    <div class="p-4"><p class="text-[9px] text-slate-500 font-bold uppercase mb-0.5">${p.cat||'‰∏ÄËà¨'}</p><p class="font-bold truncate text-sm mb-1">${p.name}</p><p class="gold-text font-black text-sm">${p.price.toLocaleString()} PTS</p></div>
                </div>`;
            }
        }

        function openModal(id) { currentItem = {id, ...allProducts[id]}; qty = 1; document.getElementById('mImg').src = currentItem.img; document.getElementById('mName').innerText = currentItem.name; document.getElementById('mPrice').innerText = currentItem.price.toLocaleString() + " PTS"; document.getElementById('mDesc').innerText = currentItem.desc || "Ê≠§ÂïÜÂìÅÂ∞öÁÑ°Ë©≥Á¥∞‰ªãÁ¥π"; document.getElementById('mQty').innerText = qty; document.getElementById('itemModal').classList.remove('hidden'); }
        function adjQty(v) { qty = Math.max(1, qty + v); document.getElementById('mQty').innerText = qty; }
        function closeModal() { document.getElementById('itemModal').classList.add('hidden'); }

        async function confirmRedeem() {
            const total = currentItem.price * qty; if(user.points < total) return alert("ÈªûÊï∏‰∏çË∂≥ÔºåÁπºÁ∫å‰∏äËªäÁ¥ØÁ©çÈªûÊï∏ÂêßÔºÅ");
            if(confirm(`Á¢∫Ë™çÂÖåÊèõ ${qty} ÂÄã„Äå${currentItem.name}„ÄçÔºü`)) {
                const newPts = user.points - total;
                // 1. Êâ£Èô§ÈªûÊï∏
                await db.ref('users/'+user.id).update({ points: newPts });
                // 2. ÂØ´ÂÖ•Ë®ÇÂñÆ (Êñ∞Â¢û)
                const orderData = { 
                    userId: user.id, userName: user.name, 
                    itemName: currentItem.name, qty: qty, total: total, 
                    time: firebase.database.ServerValue.TIMESTAMP, status: 'ÂæÖÂá∫Ë≤®' 
                };
                await db.ref('orders').push(orderData);
                // 3. Ëß∏Áôº LINE ÈÄöÁü•
                const msg = `üéÅ ÂÖåÊèõÊàêÂäüÔºÅ\nÈ†ÖÁõÆÔºö${currentItem.name} x ${qty}\nÊâ£Èô§Ôºö${total} pts`;
                fetch(`${GAS_URL}?userId=${user.id}&msg=${encodeURIComponent(msg)}`, { mode: 'no-cors' });
                
                alert("ÂÖåÊèõÊàêÂäüÔºÅÊàëÂÄëÊúÉÂú®ÂÖ©Â§©ÂÖßÁÇ∫ÊÇ®Âá∫Ë≤®„ÄÇ"); closeModal();
            }
        }

        function openRecord() {
            document.getElementById('recordModal').classList.remove('hidden');
            const list = document.getElementById('recordList'); list.innerHTML = '<p class="text-center text-slate-500 mt-10">ËºâÂÖ•‰∏≠...</p>';
            db.ref('orders').orderByChild('userId').equalTo(user.id).once('value', s => {
                const o = s.val(); list.innerHTML = '';
                if(!o) { list.innerHTML = '<p class="text-center text-slate-500 mt-10">Â∞öÁÑ°ÂÖåÊèõÁ¥ÄÈåÑ</p>'; return; }
                const items = Object.values(o).reverse();
                items.forEach(ord => {
                    const isDone = ord.status === 'Â∑≤Âá∫Ë≤®';
                    list.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-700">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-sm">${ord.itemName} x${ord.qty}</p>
                            <span class="text-[10px] px-2 py-0.5 rounded-full border ${isDone?'border-green-500 text-green-500':'border-orange-500 text-orange-500'}">${ord.status}</span>
                        </div>
                        <p class="text-[10px] text-slate-500">${new Date(ord.time).toLocaleString()}</p>
                    </div>`;
                });
            });
        }
        function closeRecord() { document.getElementById('recordModal').classList.add('hidden'); }

        window.onload = init;
    </script>
</body>
</html>
