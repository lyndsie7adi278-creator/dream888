<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DREAM æ——è‰¦ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-80 text-center border border-slate-700">
            <h2 class="text-xl font-bold mb-4">ç®¡ç†å“¡é©—è­‰</h2>
            <input type="password" id="adminPass" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500 outline-none">
            <button onclick="checkPass()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-black text-yellow-500 tracking-tighter">DREAM CONTROL</h1>
            <nav class="bg-slate-800 p-1 rounded-xl flex gap-1">
                <button onclick="switchTab('u')" id="btn-u" class="px-6 py-2 rounded-lg bg-yellow-600 text-slate-900 font-bold text-sm transition">æœƒå“¡ç®¡ç†</button>
                <button onclick="switchTab('p')" id="btn-p" class="px-6 py-2 rounded-lg text-slate-400 font-bold text-sm transition">å•†åŸç®¡ç†</button>
            </nav>
        </header>

        <div id="tab-u" class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-2xl">
            <table class="w-full text-left">
                <thead class="bg-slate-900/50 text-slate-500 text-xs">
                    <tr><th class="px-6 py-4">ç©å®¶æš±ç¨± / ID</th><th class="px-6 py-4">ç•¶å‰é»æ•¸</th><th class="px-6 py-4 text-right">èª¿æ•´é¡åº¦ (åŸ·è¡Œå¾Œé€šçŸ¥)</th></tr>
                </thead>
                <tbody id="userTable" class="divide-y divide-slate-700"></tbody>
            </table>
        </div>

        <div id="tab-p" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 h-fit sticky top-6 shadow-xl">
                <h2 id="fTitle" class="font-bold mb-4 text-yellow-500">ğŸ å•†å“ä¸Šæ¶/ç·¨è¼¯</h2>
                <input type="hidden" id="editId">
                <div class="space-y-3">
                    <input type="text" id="pCat" placeholder="å•†å“åˆ†é¡ (å¦‚ï¼šå¯¦é«”çå“ã€è™›æ“¬é“å…·)" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm text-white outline-none focus:border-yellow-600">
                    <input type="text" id="pName" placeholder="å•†å“åç¨±" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm text-white outline-none focus:border-yellow-600">
                    <input type="number" id="pPrice" placeholder="å…Œæ›æ‰€éœ€é»æ•¸" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm text-white outline-none focus:border-yellow-600">
                    <input type="text" id="pImg" placeholder="åœ–ç‰‡URL" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm text-white outline-none focus:border-yellow-600">
                    <textarea id="pDesc" placeholder="å•†å“ä»‹ç´¹å…§å®¹..." class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm text-white h-24 outline-none focus:border-yellow-600"></textarea>
                    <button onclick="saveProduct()" class="w-full bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition shadow-lg">å„²å­˜å•†å“å…§å®¹</button>
                    <button id="cancelBtn" onclick="resetForm()" class="hidden w-full bg-slate-700 py-2 rounded-xl text-xs">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-1 gap-4" id="pList"></div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec"; 
        const firebaseConfig = {
            apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs",
            authDomain: "dreampoint-b37df.firebaseapp.com",
            projectId: "dreampoint-b37df",
            storageBucket: "dreampoint-b37df.firebasestorage.app",
            messagingSenderId: "454938973111",
            appId: "1:454938973111:web:2191261a3175c8115d0e32",
            measurementId: "G-H4L410HB29"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function checkPass() {
            if(document.getElementById('adminPass').value === ADMIN_PASSWORD) {
                document.getElementById('lockScreen').style.display = 'none';
                sessionStorage.setItem('admin_session', 'active');
                loadData();
            } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
        }
        if(sessionStorage.getItem('admin_session') === 'active') {
            document.getElementById('lockScreen').style.display = 'none';
            loadData();
        }

        function switchTab(t) {
            document.getElementById('tab-u').classList.toggle('hidden', t!=='u');
            document.getElementById('tab-p').classList.toggle('hidden', t!=='p');
            document.getElementById('btn-u').className = t==='u' ? 'px-6 py-2 rounded-lg bg-yellow-600 text-slate-900 font-bold text-sm transition' : 'px-6 py-2 rounded-lg text-slate-400 font-bold text-sm transition';
            document.getElementById('btn-p').className = t==='p' ? 'px-6 py-2 rounded-lg bg-yellow-600 text-slate-900 font-bold text-sm transition' : 'px-6 py-2 rounded-lg text-slate-400 font-bold text-sm transition';
        }

        function loadData() {
            db.ref('users').on('value', s => {
                const u = s.val(), t = document.getElementById('userTable'); t.innerHTML = '';
                for(let id in u) {
                    t.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-800/50 transition">
                        <td class="px-6 py-4"><div class="font-bold text-yellow-500 text-base">${u[id].name || 'æœªåŒæ­¥'}</div><div class="text-[10px] text-slate-500 font-mono">${id}</div></td>
                        <td class="px-6 py-4 text-2xl font-black text-white">${u[id].points || 0}</td>
                        <td class="px-6 py-4 text-right">
                            <input type="number" id="in-${id}" placeholder="+/-" class="bg-slate-900 w-24 p-2 rounded-lg text-center mr-2 border border-slate-700">
                            <button onclick="adj('${id}')" class="bg-white text-black px-4 py-2 rounded-lg font-bold shadow-lg">åŸ·è¡Œ</button>
                        </td></tr>`;
                }
            });
            db.ref('products').on('value', s => {
                const p = s.val(), l = document.getElementById('pList'); l.innerHTML = '';
                for(let id in p) {
                    l.innerHTML += `<div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex gap-4 items-center shadow-lg transition hover:border-yellow-600">
                        <img src="${p[id].img}" class="w-20 h-20 rounded-xl object-cover bg-slate-900 shadow-inner">
                        <div class="flex-1 min-w-0">
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">${p[id].cat || 'æœªåˆ†é¡'}</p>
                            <p class="font-bold text-lg text-white truncate">${p[id].name}</p>
                            <p class="text-yellow-500 font-black">${p[id].price} PTS</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="edit('${id}','${p[id].cat||''}','${p[id].name}',${p[id].price},'${p[id].img}','${p[id].desc||''}')" class="text-blue-400 font-bold text-xs hover:underline">ç·¨è¼¯å…§å®¹</button>
                            <button onclick="if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref('products/${id}').remove()" class="text-red-500 font-bold text-xs hover:underline">åˆªé™¤å•†å“</button>
                        </div></div>`;
                }
            });
        }

        function adj(uid) {
            const v = parseInt(document.getElementById(`in-${uid}`).value);
            if(isNaN(v)) return alert("è«‹è¼¸å…¥æ•¸å­—");
            db.ref(`users/${uid}/points`).transaction(p => (p||0)+v, (e,c,snap) => {
                if(c) {
                    const changeStr = (v > 0 ? "+" : "") + v;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(changeStr)}`, {mode:'no-cors'});
                    document.getElementById(`in-${uid}`).value = '';
                }
            });
        }

        function saveProduct() {
            const id = document.getElementById('editId').value;
            const data = { 
                cat: document.getElementById('pCat').value || 'æœªåˆ†é¡',
                name: document.getElementById('pName').value, 
                price: parseInt(document.getElementById('pPrice').value), 
                img: document.getElementById('pImg').value,
                desc: document.getElementById('pDesc').value || ''
            };
            if(!data.name || isNaN(data.price)) return alert("è«‹å¡«å¯«å®Œæ•´å•†å“åç¨±èˆ‡é»æ•¸");
            if(id) db.ref('products/'+id).update(data); else db.ref('products').push(data);
            resetForm();
        }

        function edit(id,c,n,p,i,d) {
            document.getElementById('editId').value = id;
            document.getElementById('pCat').value = c;
            document.getElementById('pName').value = n; 
            document.getElementById('pPrice').value = p; 
            document.getElementById('pImg').value = i;
            document.getElementById('pDesc').value = d;
            document.getElementById('fTitle').innerText = "âœï¸ ç·¨è¼¯å•†å“";
            document.getElementById('cancelBtn').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('editId').value = ''; 
            document.getElementById('pCat').value = '';
            document.getElementById('pName').value = ''; 
            document.getElementById('pPrice').value = ''; 
            document.getElementById('pImg').value = '';
            document.getElementById('pDesc').value = '';
            document.getElementById('fTitle').innerText = "ğŸ å•†å“ä¸Šæ¶/ç·¨è¼¯";
            document.getElementById('cancelBtn').classList.add('hidden');
        }
    </script>
</body>
</html>
