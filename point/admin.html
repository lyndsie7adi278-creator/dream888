<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>DREAM æ——è‰¦ç®¡ç†ç³»çµ± v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen font-sans">

    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl w-80 text-center border border-slate-700">
            <h2 class="text-xl font-bold mb-4">ç®¡ç†å“¡é©—è­‰</h2>
            <input type="password" id="adminPass" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500 focus:outline-none focus:border-yellow-600">
            <button onclick="checkPass()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-slate-900 py-3 rounded-xl font-bold transition">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-5xl mx-auto p-6">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-yellow-500 tracking-tight">DREAM CONTROL</h1>
                <p class="text-slate-500 text-sm">ç›´æ’­æœƒå“¡èˆ‡å•†åŸç‡Ÿé‹ä¸­å¿ƒ</p>
            </div>
            <nav class="flex bg-slate-800 p-1 rounded-2xl border border-slate-700">
                <button onclick="switchTab('users')" id="btn-users" class="px-6 py-2 rounded-xl text-sm font-bold transition bg-yellow-600 text-slate-900">æœƒå“¡ç®¡ç†</button>
                <button onclick="switchTab('products')" id="btn-products" class="px-6 py-2 rounded-xl text-sm font-bold transition text-slate-400">å•†åŸç®¡ç†</button>
            </nav>
            <button onclick="logout()" class="text-slate-600 hover:text-slate-400 text-xs underline">å®‰å…¨ç™»å‡º</button>
        </header>

        <section id="tab-users" class="space-y-4">
            <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold">ğŸ‘¥ æœƒå“¡æ¸…å–®ç¸½è¦½</h2>
                    <span id="userCount" class="text-xs text-slate-400">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/50 text-slate-500 text-[10px] uppercase tracking-wider">
                            <tr>
                                <th class="px-6 py-4">ç©å®¶ ID</th>
                                <th class="px-6 py-4">ç•¶å‰é»æ•¸</th>
                                <th class="px-6 py-4 text-right">æ‰‹å‹•èª¿æ•´é»æ•¸ (è¼¸å…¥æ­£è² å€¼)</th>
                            </tr>
                        </thead>
                        <tbody id="userTable" class="divide-y divide-slate-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="tab-products" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 h-fit sticky top-6">
                <h2 id="formTitle" class="font-bold mb-4 text-yellow-500">ğŸ æ–°å¢å•†å“</h2>
                <input type="hidden" id="editProductId">
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-slate-500 ml-1">å•†å“åç¨±</label>
                        <input type="text" id="pName" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-yellow-600 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 ml-1">å…Œæ›æ‰€éœ€é»æ•¸</label>
                        <input type="number" id="pPrice" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-yellow-600 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 ml-1">å•†å“åœ–ç‰‡é€£çµ</label>
                        <input type="text" id="pImg" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-yellow-600 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <button id="submitBtn" onclick="handleProductSubmit()" class="flex-1 bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold hover:bg-yellow-500 transition">ç¢ºèªä¸Šæ¶</button>
                        <button id="cancelBtn" onclick="resetForm()" class="hidden flex-1 bg-slate-700 text-white py-3 rounded-xl font-bold">å–æ¶ˆç·¨è¼¯</button>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4" id="productList">
                </div>
        </section>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805"; // è«‹è‡ªè¡Œä¿®æ”¹
        const GAS_URL = "AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ";
        const firebaseConfig = {
  apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs",
  authDomain: "dreampoint-b37df.firebaseapp.com",
  projectId: "dreampoint-b37df",
  storageBucket: "dreampoint-b37df.firebasestorage.app",
  messagingSenderId: "454938973111",
  appId: "1:454938973111:web:2191261a3175c8115d0e32",
  measurementId: "G-H4L410HB29"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ç™»å…¥é©—è­‰é‚è¼¯
        function checkPass() {
            if(document.getElementById('adminPass').value === ADMIN_PASSWORD) {
                document.getElementById('lockScreen').style.display = 'none';
                sessionStorage.setItem('isDREAMAdmin', 'true');
                init();
            } else { alert('å¯†ç¢¼éŒ¯èª¤ï¼'); }
        }
        if(sessionStorage.getItem('isDREAMAdmin') === 'true') {
            document.getElementById('lockScreen').style.display = 'none';
            init();
        }

        function init() {
            loadUsers();
            loadProducts();
        }

        // åˆ†é åˆ‡æ›
        function switchTab(tab) {
            document.getElementById('tab-users').classList.toggle('hidden', tab !== 'users');
            document.getElementById('tab-products').classList.toggle('hidden', tab !== 'products');
            document.getElementById('btn-users').className = tab === 'users' ? 'px-6 py-2 rounded-xl text-sm font-bold transition bg-yellow-600 text-slate-900' : 'px-6 py-2 rounded-xl text-sm font-bold transition text-slate-400';
            document.getElementById('btn-products').className = tab === 'products' ? 'px-6 py-2 rounded-xl text-sm font-bold transition bg-yellow-600 text-slate-900' : 'px-6 py-2 rounded-xl text-sm font-bold transition text-slate-400';
        }

        // æœƒå“¡ç®¡ç†é‚è¼¯
        function loadUsers() {
            db.ref('users').on('value', snap => {
                const users = snap.val();
                const container = document.getElementById('userTable');
                container.innerHTML = '';
                let count = 0;
                for (let id in users) {
                    count++;
                    container.innerHTML += `
                        <tr class="hover:bg-slate-800/50 transition text-sm">
                            <td class="px-6 py-4 font-mono text-slate-400 text-xs">${id}</td>
                            <td class="px-6 py-4 font-black text-yellow-500 text-lg">${users[id].points || 0}</td>
                            <td class="px-6 py-4 text-right">
                                <input type="number" id="input-${id}" placeholder="ä¾‹å¦‚: 100" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-1 text-center w-24 mr-2 text-white">
                                <button onclick="adjustPoints('${id}')" class="bg-white text-slate-900 px-4 py-1.5 rounded-lg font-bold text-xs">åŸ·è¡Œ</button>
                            </td>
                        </tr>`;
                }
                document.getElementById('userCount').innerText = `å…± ${count} ä½æœƒå“¡`;
            });
        }

        function adjustPoints(uid) {
            const val = parseInt(document.getElementById(`input-${uid}`).value);
            if(isNaN(val)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—");
            db.ref(`users/${uid}/points`).transaction(p => (p || 0) + val, (err, comm, snap) => {
                if(comm) {
                    const msg = `ğŸ”” é»æ•¸è®Šå‹•é€šçŸ¥\nè®Šå‹•ï¼š${val > 0 ? '+' : ''}${val}\nç›®å‰å‰©é¤˜ï¼š${snap.val()} é»`;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(msg)}`, { mode: 'no-cors' });
                    document.getElementById(`input-${uid}`).value = '';
                }
            });
        }

        // å•†å“ç®¡ç†é‚è¼¯
        function loadProducts() {
            db.ref('products').on('value', snap => {
                const ps = snap.val();
                const container = document.getElementById('productList');
                container.innerHTML = '';
                for (let id in ps) {
                    container.innerHTML += `
                        <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex gap-4 items-center">
                            <img src="${ps[id].img}" class="w-16 h-16 rounded-xl object-cover bg-slate-900">
                            <div class="flex-1 min-w-0">
                                <p class="font-bold truncate">${ps[id].name}</p>
                                <p class="text-yellow-500 font-black">${ps[id].price} PTS</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="editProduct('${id}', '${ps[id].name}', ${ps[id].price}, '${ps[id].img}')" class="text-blue-400 text-[10px] uppercase font-bold hover:underline">ç·¨è¼¯</button>
                                <button onclick="deleteProduct('${id}')" class="text-red-500 text-[10px] uppercase font-bold hover:underline">åˆªé™¤</button>
                            </div>
                        </div>`;
                }
            });
        }

        function handleProductSubmit() {
            const id = document.getElementById('editProductId').value;
            const data = {
                name: document.getElementById('pName').value,
                price: parseInt(document.getElementById('pPrice').value),
                img: document.getElementById('pImg').value
            };
            if(!data.name || isNaN(data.price)) return alert("è«‹å¡«å¯«æ­£ç¢ºè³‡è¨Š");

            if(id) {
                db.ref(`products/${id}`).update(data).then(() => { alert("ä¿®æ”¹æˆåŠŸ"); resetForm(); });
            } else {
                db.ref('products').push(data).then(() => { alert("ä¸Šæ¶æˆåŠŸ"); resetForm(); });
            }
        }

        function editProduct(id, name, price, img) {
            document.getElementById('editProductId').value = id;
            document.getElementById('pName').value = name;
            document.getElementById('pPrice').value = price;
            document.getElementById('pImg').value = img;
            document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯å•†å“";
            document.getElementById('submitBtn').innerText = "å„²å­˜ä¿®æ”¹";
            document.getElementById('cancelBtn').classList.remove('hidden');
        }

        function deleteProduct(id) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ")) {
                db.ref(`products/${id}`).remove();
            }
        }

        function resetForm() {
            document.getElementById('editProductId').value = "";
            document.getElementById('pName').value = "";
            document.getElementById('pPrice').value = "";
            document.getElementById('pImg').value = "";
            document.getElementById('formTitle').innerText = "ğŸ æ–°å¢å•†å“";
            document.getElementById('submitBtn').innerText = "ç¢ºèªä¸Šæ¶";
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        function logout() { sessionStorage.clear(); location.reload(); }
    </script>
</body>
</html>
