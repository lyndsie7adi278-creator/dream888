<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><title>å¤¢å·¥å» æ§åˆ¶å° - æ——è‰¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">
    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-3xl w-80 text-center border border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-yellow-500 font-mono italic">DREAM ADMIN</h2>
            <input type="password" id="adminPass" placeholder="å¯†ç¢¼ 0805" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500 outline-none">
            <button onclick="checkPass()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <h1 class="text-3xl font-black text-yellow-500 tracking-tighter italic">å¤¢å·¥å»  CONTROL</h1>
            <nav class="bg-slate-800 p-1 rounded-2xl flex gap-1 shadow-inner border border-slate-700">
                <button onclick="tab('u')" id="bu" class="px-6 py-2 rounded-xl text-sm font-bold bg-yellow-600 text-slate-900 transition">æœƒå“¡ç®¡ç†</button>
                <button onclick="tab('o')" id="bo" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-400 transition">è¨‚å–®ç®¡ç†</button>
                <button onclick="tab('p')" id="bp" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-400 transition">å•†åŸç®¡ç†</button>
            </nav>
        </header>

        <div id="tu" class="space-y-4">
            <div class="relative">
                <input type="text" id="userSearch" oninput="renderUsers()" placeholder="ğŸ” è¼¸å…¥ Line æš±ç¨±é€²è¡Œæœå°‹..." 
                       class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 pl-12 text-yellow-500 outline-none focus:border-yellow-500 transition shadow-xl">
                <span class="absolute left-4 top-4 text-slate-500">Search</span>
            </div>
            <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden shadow-2xl">
                <table class="w-full text-left">
                    <thead class="bg-slate-900/50 text-slate-500 text-xs uppercase tracking-widest">
                        <tr><th class="px-6 py-4">æœƒå“¡è³‡è¨Š</th><th class="px-6 py-4">é¤˜é¡</th><th class="px-6 py-4 text-right">èª¿æ•´é¡åº¦</th></tr>
                    </thead>
                    <tbody id="userTable" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>

        <div id="to" class="hidden space-y-4">
            <div id="orderList" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="tp" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl h-fit sticky top-6">
                <h2 id="fTitle" class="font-bold mb-4 text-yellow-500 italic">ğŸ å•†å“ç·¨è¼¯</h2>
                <input type="hidden" id="editId">
                <div class="space-y-3">
                    <input type="text" id="pCat" placeholder="åˆ†é¡" class="w-full bg-slate-900 border-slate-700 rounded-xl p-3 text-sm">
                    <input type="text" id="pName" placeholder="å•†å“åç¨±" class="w-full bg-slate-900 border-slate-700 rounded-xl p-3 text-sm">
                    <input type="number" id="pPrice" placeholder="å…Œæ›é»æ•¸" class="w-full bg-slate-900 border-slate-700 rounded-xl p-3 text-sm">
                    <input type="text" id="pImg" placeholder="åœ–ç‰‡é€£çµ" class="w-full bg-slate-900 border-slate-700 rounded-xl p-3 text-sm">
                    <textarea id="pDesc" placeholder="å•†å“è©³ç´°ä»‹ç´¹" class="w-full bg-slate-900 border-slate-700 rounded-xl p-3 text-sm h-24"></textarea>
                    <div class="flex items-center gap-2 p-2 bg-slate-900 rounded-xl border border-slate-700">
                        <span class="text-xs text-slate-400 ml-2">é è¨­ç‹€æ…‹ï¼š</span>
                        <select id="pStatus" class="bg-transparent text-yellow-500 font-bold text-sm outline-none cursor-pointer">
                            <option value="ä¸Šæ¶">ç›´æ¥ä¸Šæ¶</option>
                            <option value="ä¸‹æ¶">æš«æ™‚ä¸‹æ¶</option>
                        </select>
                    </div>
                    <button onclick="save()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold shadow-lg">å„²å­˜å•†å“</button>
                    <button onclick="reset()" class="w-full text-slate-500 text-xs mt-2">é‡ç½®æ¬„ä½</button>
                </div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-1 gap-4" id="pList"></div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805", GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        const firebaseConfig = { apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs", authDomain: "dreampoint-b37df.firebaseapp.com", projectId: "dreampoint-b37df", databaseURL: "https://dreampoint-b37df-default-rtdb.firebaseio.com/", storageBucket: "dreampoint-b37df.firebasestorage.app", messagingSenderId: "454938973111", appId: "1:454938973111:web:2191261a3175c8115d0e32" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();
        
        let allUsers = {}, allProducts = {};

        function checkPass() { if(document.getElementById('adminPass').value === ADMIN_PASSWORD) { document.getElementById('lockScreen').style.display='none'; sessionStorage.setItem('adm','1'); load(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        if(sessionStorage.getItem('adm')==='1') { document.getElementById('lockScreen').style.display='none'; load(); }
        
        function tab(t) { ['u','o','p'].forEach(x => { document.getElementById('t'+x).classList.toggle('hidden', x!==t); document.getElementById('b'+x).className = x===t ? 'px-6 py-2 rounded-xl text-sm font-bold bg-yellow-600 text-slate-900 transition' : 'px-6 py-2 rounded-xl text-sm font-bold text-slate-400 transition'; }); }
        
        function load() {
            db.ref('users').on('value', s => { allUsers = s.val() || {}; renderUsers(); });
            db.ref('products').on('value', s => { allProducts = s.val() || {}; renderProducts(); });
            // è¨‚å–®åŠ è¼‰é‚è¼¯ä¿æŒåŸæ¨£...
            db.ref('orders').on('value', s => {
                const o = s.val(), l = document.getElementById('orderList'); l.innerHTML = '';
                if(!o) return l.innerHTML = '<p class="text-center text-slate-500 py-10">å°šç„¡å…Œæ›ç´€éŒ„</p>';
                Object.keys(o).reverse().forEach(id => {
                    const ord = o[id]; const isDone = ord.status === 'å·²å‡ºè²¨';
                    l.innerHTML += `<div class="bg-slate-800 p-5 rounded-3xl border border-slate-700 flex justify-between items-center shadow-lg ${isDone?'opacity-50':''}">
                        <div><p class="font-bold">${ord.itemName} x${ord.qty}</p><p class="text-xs text-slate-400">${ord.userName} Â· ${new Date(ord.time).toLocaleString()}</p></div>
                        <div class="flex gap-3 items-center"><span class="text-xs px-2 py-1 rounded border ${isDone?'border-green-500 text-green-500':'border-yellow-500 text-yellow-500'}">${ord.status}</span><button onclick="toggleOrder('${id}','${ord.status}')" class="bg-slate-700 px-3 py-2 rounded-xl text-xs font-bold">${isDone?'æ”¹å›':'å‡ºè²¨'}</button></div>
                    </div>`;
                });
            });
        }

        // æ¸²æŸ“æœƒå“¡æ¸…å–® (å«æœå°‹éæ¿¾)
        function renderUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const t = document.getElementById('userTable'); t.innerHTML = '';
            for(let id in allUsers) {
                const name = allUsers[id].name || 'æœªåŒæ­¥';
                if(query && !name.toLowerCase().includes(query)) continue;
                t.innerHTML += `<tr class="border-b border-slate-700/50 hover:bg-slate-800/50"><td class="px-6 py-4 font-bold text-yellow-500">${name}<br><span class="text-[10px] text-slate-500">${id}</span></td><td class="px-6 py-4 font-black text-xl">${allUsers[id].points||0}</td><td class="px-6 py-4 text-right"><input type="number" id="in-${id}" placeholder="+/-" class="bg-slate-900 w-24 p-2 rounded-lg text-center border border-slate-700 mr-2 text-yellow-500 outline-none"><button onclick="adj('${id}')" class="bg-white text-black px-4 py-2 rounded-lg font-bold text-xs shadow-lg">åŸ·è¡Œ</button></td></tr>`;
            }
        }

        // æ¸²æŸ“å•†å“æ¸…å–® (å«ç‹€æ…‹é¡¯ç¤º)
        function renderProducts() {
            const l = document.getElementById('pList'); l.innerHTML = '';
            for(let id in allProducts) {
                const p = allProducts[id];
                const isOn = p.status !== 'ä¸‹æ¶';
                l.innerHTML += `<div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex gap-4 items-center shadow-lg hover:border-yellow-600 transition ${!isOn?'opacity-50 grayscale':''}">
                    <img src="${p.img}" class="w-16 h-16 rounded-xl object-cover bg-slate-900">
                    <div class="flex-1 font-bold">
                        <p class="text-[10px] ${isOn?'text-green-500':'text-red-500'} font-black uppercase">${isOn?'â— ä¸Šæ¶ä¸­':'â—‹ å·²ä¸‹æ¶'}</p>
                        <p class="text-white truncate">${p.name}</p>
                        <p class="text-yellow-500 text-sm">${p.price} PTS</p>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button onclick="toggleStatus('${id}','${p.status}')" class="text-[10px] px-2 py-1 rounded bg-slate-700 text-slate-200">${isOn?'ä¸‹æ¶':'ä¸Šæ¶'}</button>
                        <button onclick="edit('${id}','${p.cat}','${p.name}',${p.price},'${p.img}','${p.desc}','${p.status}')" class="text-blue-400 text-[10px] font-bold">ç·¨è¼¯</button>
                    </div>
                </div>`;
            }
        }

        function toggleStatus(id, curr) { const next = curr === 'ä¸‹æ¶' ? 'ä¸Šæ¶' : 'ä¸‹æ¶'; db.ref(`products/${id}`).update({ status: next }); }
        function save() { 
            const id = document.getElementById('editId').value; 
            const data = { 
                cat: document.getElementById('pCat').value||'ä¸€èˆ¬', 
                name: document.getElementById('pName').value, 
                price: parseInt(document.getElementById('pPrice').value), 
                img: document.getElementById('pImg').value, 
                desc: document.getElementById('pDesc').value||'',
                status: document.getElementById('pStatus').value 
            }; 
            if(!data.name || isNaN(data.price)) return alert('è³‡è¨Šä¸å®Œæ•´'); 
            if(id) db.ref('products/'+id).update(data); else db.ref('products').push(data); 
            reset(); 
        }
        function edit(id,c,n,p,i,d,s) { document.getElementById('editId').value = id; document.getElementById('pCat').value = c; document.getElementById('pName').value = n; document.getElementById('pPrice').value = p; document.getElementById('pImg').value = i; document.getElementById('pDesc').value = d||''; document.getElementById('pStatus').value = s||'ä¸Šæ¶'; document.getElementById('fTitle').innerText = "âœï¸ ç·¨è¼¯æ¨¡å¼"; }
        function reset() { document.getElementById('editId').value = ''; document.getElementById('pCat').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pImg').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pStatus').value = 'ä¸Šæ¶'; document.getElementById('fTitle').innerText = "ğŸ å•†å“ç·¨è¼¯"; }
        function adj(uid) { const v = parseInt(document.getElementById(`in-${uid}`).value); if(isNaN(v)) return alert('è«‹è¼¸å…¥æ•¸å­—'); db.ref(`users/${uid}/points`).transaction(p => (p||0)+v, (e,c,snap) => { if(c) { fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent((v>0?'+':'')+v)}`, {mode:'no-cors'}); document.getElementById(`in-${uid}`).value = ''; } }); }
        function toggleOrder(oid, curr) { const next = curr === 'å¾…å‡ºè²¨' ? 'å·²å‡ºè²¨' : 'å¾…å‡ºè²¨'; db.ref(`orders/${oid}`).update({ status: next }); }
    </script>
</body>
</html>
