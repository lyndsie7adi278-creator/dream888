<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å¤¢å·¥å» å¾Œå° - æ¥µç°¡é€šçŸ¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        .gold-text { color: #eab308; }
        input, textarea, select { outline: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="p-6">
    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-3xl w-80 text-center border border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 gold-text">DREAM ADMIN</h2>
            <input type="password" id="adminPass" placeholder="è¼¸å…¥ç®¡ç†å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500">
            <button onclick="checkPass()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold active:scale-95 transition">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <h1 class="text-3xl font-bold gold-text tracking-tight">å¤¢å·¥å» ç®¡ç†å¾Œå°</h1>
            <nav class="bg-slate-800 p-1.5 rounded-2xl flex gap-1 border border-slate-700 shadow-xl">
                <button onclick="tab('u')" id="bu" class="px-6 py-2 rounded-xl text-sm font-bold bg-yellow-600 text-slate-900">æœƒå“¡ç®¡ç†</button>
                <button onclick="tab('o')" id="bo" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-400">è¨‚å–®ç®¡ç†</button>
                <button onclick="tab('p')" id="bp" class="px-6 py-2 rounded-xl text-sm font-bold text-slate-400">å•†åŸç®¡ç†</button>
            </nav>
        </header>

        <div id="tu" class="space-y-4">
            <input type="text" id="userSearch" oninput="renderUsers()" placeholder="ğŸ” æœå°‹æœƒå“¡æš±ç¨±..." class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-yellow-500">
            <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden"><table class="w-full text-left"><tbody id="userTable" class="divide-y divide-slate-700"></tbody></table></div>
        </div>
        
        <div id="to" class="hidden space-y-3"><div id="orderList"></div></div>

        <div id="tp" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl h-fit sticky top-6">
                <h2 id="fTitle" class="font-bold mb-4 text-yellow-500">ğŸ å•†å“ç·¨è¼¯</h2>
                <input type="hidden" id="editId">
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 ml-1 uppercase tracking-widest">Category å•†å“åˆ†é¡</label>
                        <div class="flex gap-2">
                            <select id="pCat" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-yellow-500 font-bold"></select>
                            <button onclick="addCategory()" class="bg-slate-700 hover:bg-slate-600 px-4 rounded-xl text-sm font-bold">ï¼‹</button>
                        </div>
                    </div>
                    <input type="text" id="pName" placeholder="å•†å“åç¨±" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm">
                    <input type="number" id="pPrice" placeholder="é»æ•¸" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm">
                    
                    <div class="space-y-2">
                        <label class="text-[10px] text-slate-500 ml-1 uppercase tracking-widest">Product Image</label>
                        <div class="flex gap-2">
                            <input type="text" id="pImg" placeholder="åœ–ç‰‡ç¶²å€" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-xs">
                            <label class="bg-slate-700 px-4 py-3 rounded-xl cursor-pointer hover:bg-slate-600 transition text-xs font-bold whitespace-nowrap">ä¸Šå‚³<input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleUpload(this)"></label>
                        </div>
                        <div id="uploadStatus" class="text-[10px] text-yellow-500 ml-1 hidden font-bold italic animate-pulse">è™•ç†ä¸­...</div>
                    </div>

                    <textarea id="pDesc" placeholder="å•†å“æè¿°" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm h-24"></textarea>
                    <div class="flex items-center gap-2 p-2 bg-slate-900 rounded-xl border border-slate-700">
                        <span class="text-xs text-slate-500 ml-2">ç‹€æ…‹ï¼š</span>
                        <select id="pStatus" class="bg-transparent text-yellow-500 font-bold text-sm"><option value="ä¸Šæ¶">ä¸Šæ¶</option><option value="ä¸‹æ¶">ä¸‹æ¶</option></select>
                    </div>
                    <button onclick="save()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">å„²å­˜ä¸¦ç™¼å¸ƒ</button>
                    <button onclick="reset()" class="w-full text-slate-500 text-xs mt-1">æ¸…ç©º</button>
                </div>
            </div>
            <div class="lg:col-span-8 space-y-3" id="pList"></div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805", GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        const firebaseConfig = { 
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco",
            authDomain: "dream8-7b161.firebaseapp.com",
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com",
            projectId: "dream8-7b161",
            storageBucket: "dream8-7b161.firebasestorage.app",
            messagingSenderId: "606218522479",
            appId: "1:606218522479:web:2737643db3de735af7e29a",
            measurementId: "G-J0YJNPZMR4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        let allUsers = {}, allProducts = {}, allCategories = ["ä¸€èˆ¬"];

        function checkPass() { if(document.getElementById('adminPass').value === ADMIN_PASSWORD) { document.getElementById('lockScreen').style.display='none'; sessionStorage.setItem('adm','1'); load(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        if(sessionStorage.getItem('adm')==='1') { document.getElementById('lockScreen').style.display='none'; load(); }
        
        function tab(t) { ['u','o','p'].forEach(x => { document.getElementById('t'+x).classList.toggle('hidden', x!==t); document.getElementById('b'+x).className = x===t ? 'px-6 py-2 rounded-xl text-sm font-bold bg-yellow-600 text-slate-900' : 'px-6 py-2 rounded-xl text-sm font-bold text-slate-400'; }); }
        
        function load() {
            db.ref('categories').on('value', s => {
                const data = s.val();
                allCategories = data ? Object.values(data) : ["ä¸€èˆ¬"];
                renderCategoryOptions();
            });
            db.ref('users').on('value', s => { allUsers = s.val() || {}; renderUsers(); });
            db.ref('products').on('value', s => { allProducts = s.val() || {}; renderProducts(); });
            db.ref('orders').on('value', s => {
                const o = s.val(), l = document.getElementById('orderList'); l.innerHTML = '';
                if(!o) return l.innerHTML = '<p class="text-center text-slate-500 py-10">ç„¡è¨‚å–®ç´€éŒ„</p>';
                Object.keys(o).reverse().forEach(id => {
                    const ord = o[id]; const isDone = ord.status === 'å·²å‡ºè²¨';
                    l.innerHTML += `<div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex justify-between items-center mb-2 ${isDone?'opacity-50':''}">
                        <div><p class="font-bold">${ord.itemName} x${ord.qty}</p><p class="text-[10px] text-slate-400">${ord.userName} Â· ${new Date(ord.time).toLocaleString()}</p></div>
                        <div class="flex gap-2 items-center"><span class="text-xs px-2 py-1 rounded border ${isDone?'border-green-500 text-green-500':'border-yellow-500 text-yellow-500'}">${ord.status}</span><button onclick="toggleOrder('${id}','${ord.status}')" class="bg-slate-700 px-3 py-1.5 rounded-xl text-[11px] font-bold">å‡ºè²¨</button><button onclick="refundOrder('${id}', '${ord.userId}', ${ord.total})" class="bg-red-900/40 text-red-400 border border-red-900 px-3 py-1.5 rounded-xl text-[11px] font-bold">é€€æ¬¾</button></div>
                    </div>`;
                });
            });
        }

        function renderCategoryOptions() {
            const select = document.getElementById('pCat');
            select.innerHTML = allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function addCategory() {
            const newCat = prompt("è«‹è¼¸å…¥æ–°åˆ†é¡åç¨±:");
            if (newCat && !allCategories.includes(newCat)) db.ref('categories').push(newCat);
        }

        async function handleUpload(input) {
            const file = input.files[0]; if (!file) return;
            const status = document.getElementById('uploadStatus');
            status.classList.remove('hidden'); status.innerText = "å„ªåŒ–ä¸¦ä¸Šå‚³ä¸­...";
            try {
                const compressedFile = await compressImage(file);
                const storageRef = storage.ref('products/' + Date.now() + "_" + file.name);
                const snapshot = await storageRef.put(compressedFile);
                const url = await snapshot.ref.getDownloadURL();
                document.getElementById('pImg').value = url;
                status.innerText = "âœ… ä¸Šå‚³æˆåŠŸ";
                setTimeout(() => status.classList.add('hidden'), 3000);
            } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); status.classList.add('hidden'); }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.8);
                    };
                };
            });
        }

        function renderUsers() { const q = document.getElementById('userSearch').value.toLowerCase(); const t = document.getElementById('userTable'); t.innerHTML = ''; for(let id in allUsers) { const name = allUsers[id].name || 'æœªåŒæ­¥'; if(q && !name.toLowerCase().includes(q)) continue; t.innerHTML += `<tr class="border-b border-slate-700/50 hover:bg-slate-800/50"><td class="px-6 py-4 font-bold text-yellow-500">${name}<br><span class="text-[10px] text-slate-500">${id}</span></td><td class="px-6 py-4 font-bold text-lg">${(allUsers[id].points||0).toLocaleString()}</td><td class="px-6 py-4 text-right"><input type="number" id="in-${id}" placeholder="+/-" class="bg-slate-900 w-20 p-2 rounded-lg text-center border border-slate-700 mr-2 text-yellow-500"><button onclick="adj('${id}')" class="bg-white text-black px-4 py-2 rounded-lg font-bold text-xs">èª¿æ•´</button></td></tr>`; } }
        
        function renderProducts() { 
            const l = document.getElementById('pList'); l.innerHTML = ''; 
            for(let id in allProducts) { 
                const p = allProducts[id]; const isOn = p.status !== 'ä¸‹æ¶'; 
                l.innerHTML += `<div class="bg-slate-800 p-3 rounded-2xl border border-slate-700 flex gap-4 items-center mb-2 ${!isOn?'opacity-50 grayscale':''}"> 
                    <img src="${p.img}" class="w-12 h-12 rounded-xl object-cover bg-slate-900 shadow-inner"> 
                    <div class="flex-1 overflow-hidden"> 
                        <p class="text-[10px] font-bold ${isOn?'text-green-500':'text-red-500'}">${isOn?'â— ä¸Šæ¶ä¸­':'â—‹ å·²ä¸‹æ¶'}</p> 
                        <p class="font-bold text-slate-100 truncate">${p.name}</p> 
                        <p class="text-yellow-500 text-xs font-bold">${p.cat || 'ä¸€èˆ¬'} Â· ${p.price.toLocaleString()} é»</p> 
                    </div> 
                    <div class="flex gap-1.5"> 
                        <button onclick="toggleStatus('${id}','${p.status}')" class="px-3 py-1.5 rounded-xl bg-slate-700 text-[11px] font-bold">${isOn?'ä¸‹æ¶':'ä¸Šæ¶'}</button> 
                        <button onclick="edit('${id}','${p.cat}','${p.name}',${p.price},'${p.img}','${p.desc}','${p.status}')" class="px-3 py-1.5 rounded-xl bg-blue-900/40 text-blue-400 border border-blue-900 text-[11px] font-bold">ç·¨è¼¯</button> 
                        <button onclick="deleteProd('${id}')" class="px-3 py-1.5 rounded-xl bg-red-900/40 text-red-400 border border-red-900 text-[11px] font-bold">åˆªé™¤</button> 
                    </div> 
                </div>`; 
            } 
        }

        // --- ä¿®æ­£åŠ é»é€šçŸ¥ï¼šç´”ç¬¦è™Ÿèˆ‡æ•¸å­— ---
        function adj(uid) { 
            const val = parseInt(document.getElementById(`in-${uid}`).value); 
            if(isNaN(val)) return alert('è«‹è¼¸å…¥æ•¸å­—'); 
            db.ref(`users/${uid}/points`).transaction(p => (p||0)+val, (err, comm) => { 
                if(comm) { 
                    // æ ¼å¼ï¼šâœ… +100 é»æ•¸å·²å…¥å¸³ æˆ– ğŸ’° -100 é»æ•¸å·²æ‰£é™¤
                    const sign = val > 0 ? '+' : '';
                    const action = val > 0 ? 'å·²å­˜å…¥' : 'å·²æ‰£é™¤';
                    const msg = `${icon} ${sign}${val} é»æ•¸${action}`;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(msg)}`, {mode:'no-cors'}); 
                    document.getElementById(`in-${uid}`).value = ''; 
                } 
            }); 
        }

        // --- ä¿®æ­£é€€æ¬¾é€šçŸ¥ï¼šç´”ç¬¦è™Ÿèˆ‡æ•¸å­— ---
        function refundOrder(oid, uid, amount) { 
            if(!confirm(`ç¢ºèªå–æ¶ˆä¸¦é€€æ¬¾ ${amount} é»ï¼Ÿ`)) return; 
            db.ref(`users/${uid}/points`).transaction(p => (p||0) + amount, (err, comm) => { 
                if(comm) { 
                    db.ref(`orders/${oid}`).remove(); 
                    // æ ¼å¼ï¼šğŸ +100 é»æ•¸å·²é€€å›
                    const msg = `ğŸ +${amount} é»æ•¸å·²é€€å›`;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(msg)}`, {mode:'no-cors'}); 
                    alert('é€€æ¬¾æˆåŠŸ'); 
                } 
            }); 
        }

        function deleteProd(id) { if(confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')) db.ref(`products/${id}`).remove(); }
        function toggleStatus(id, curr) { const next = curr === 'ä¸‹æ¶' ? 'ä¸Šæ¶' : 'ä¸‹æ¶'; db.ref(`products/${id}`).update({ status: next }); }
        
        function save() { 
            const id = document.getElementById('editId').value; 
            const data = { cat: document.getElementById('pCat').value || 'ä¸€èˆ¬', name: document.getElementById('pName').value, price: parseInt(document.getElementById('pPrice').value), img: document.getElementById('pImg').value, desc: document.getElementById('pDesc').value || '', status: document.getElementById('pStatus').value }; 
            if(!data.name || isNaN(data.price)) return alert('ä¸å®Œæ•´'); 
            if(id) db.ref('products/'+id).update(data); else db.ref('products').push(data); 
            reset(); 
        }

        function edit(id,c,n,p,i,d,s) { document.getElementById('editId').value = id; document.getElementById('pCat').value = c || 'ä¸€èˆ¬'; document.getElementById('pName').value = n; document.getElementById('pPrice').value = p; document.getElementById('pImg').value = i; document.getElementById('pDesc').value = d; document.getElementById('pStatus').value = s || 'ä¸Šæ¶'; document.getElementById('fTitle').innerText = "âœï¸ ç·¨è¼¯å•†å“"; window.scrollTo({top:0, behavior:'smooth'}); }
        function reset() { document.getElementById('editId').value = ''; document.getElementById('pCat').value = allCategories[0] || 'ä¸€èˆ¬'; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pImg').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pStatus').value = 'ä¸Šæ¶'; document.getElementById('fTitle').innerText = "ğŸ å•†å“ç·¨è¼¯"; }
        function toggleOrder(oid, curr) { const next = curr === 'å¾…å‡ºè²¨' ? 'å·²å‡ºè²¨' : 'å¾…å‡ºè²¨'; db.ref(`orders/${oid}`).update({ status: next }); }
    </script>
</body>
</html>


