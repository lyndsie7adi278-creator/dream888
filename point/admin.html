<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><title>DREAM æ——è‰¦ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #0f172a; }
        .tab-active { background: #eab308; color: #111; font-weight: bold; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-100 min-h-screen p-4">
    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-3xl w-80 border border-slate-700 shadow-2xl text-center">
            <h2 class="text-xl font-bold mb-4 text-yellow-500 font-mono">ADMIN LOGIN</h2>
            <input type="password" id="adminPass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500 outline-none">
            <button onclick="checkPass()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl font-black text-yellow-500 tracking-tighter">DREAM CONTROL <span class="text-xs text-slate-500 font-normal">v3.0</span></h1>
            <nav class="bg-slate-800 p-1 rounded-2xl flex gap-1 shadow-inner border border-slate-700">
                <button onclick="tab('u')" id="bu" class="px-5 py-2 rounded-xl text-sm transition tab-active">æœƒå“¡ç®¡ç†</button>
                <button onclick="tab('o')" id="bo" class="px-5 py-2 rounded-xl text-sm transition text-slate-400">è¨‚å–®ç®¡ç†</button>
                <button onclick="tab('p')" id="bp" class="px-5 py-2 rounded-xl text-sm transition text-slate-400">å•†åŸç®¡ç†</button>
            </nav>
        </header>

        <div id="tu" class="bg-slate-800 rounded-3xl border border-slate-700 overflow-hidden shadow-2xl">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-900/50 text-slate-500 text-xs uppercase tracking-widest">
                    <tr><th class="px-6 py-4">ç©å®¶è³‡è¨Š</th><th class="px-6 py-4">ç›®å‰é»æ•¸</th><th class="px-6 py-4 text-right">æ“ä½œ</th></tr>
                </thead>
                <tbody id="userTable" class="divide-y divide-slate-700"></tbody>
            </table>
        </div>

        <div id="to" class="hidden space-y-4">
            <div id="orderList" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="tp" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 h-fit sticky top-6 shadow-xl">
                <h2 id="fTitle" class="font-bold mb-4 text-yellow-500">ğŸ ç·¨è¼¯å•†å“</h2>
                <input type="hidden" id="editId">
                <div class="space-y-3">
                    <input type="text" id="pCat" placeholder="åˆ†é¡" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm border focus:border-yellow-500 outline-none">
                    <input type="text" id="pName" placeholder="å•†å“åç¨±" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm border focus:border-yellow-500 outline-none">
                    <input type="number" id="pPrice" placeholder="é»æ•¸" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm border focus:border-yellow-500 outline-none">
                    <input type="text" id="pImg" placeholder="åœ–ç‰‡é€£çµ (URL)" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm border focus:border-yellow-500 outline-none">
                    <textarea id="pDesc" placeholder="å•†å“ä»‹ç´¹å…§å®¹" class="w-full bg-slate-900 border-slate-700 rounded-lg p-3 text-sm h-24 border focus:border-yellow-500 outline-none"></textarea>
                    <button onclick="save()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">å„²å­˜å•†å“</button>
                    <button onclick="reset()" class="w-full text-slate-500 text-xs hover:text-slate-300">å–æ¶ˆç·¨è¼¯ä¸¦æ¸…ç©º</button>
                </div>
            </div>
            <div class="lg:col-span-2 grid grid-cols-1 gap-3" id="pList"></div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        const firebaseConfig = { apiKey: "AIzaSyDJIhgbbCJv3f8y9xdSHUCTfJi_sjKBOqs", authDomain: "dreampoint-b37df.firebaseapp.com", projectId: "dreampoint-b37df", databaseURL: "https://dreampoint-b37df-default-rtdb.firebaseio.com/", storageBucket: "dreampoint-b37df.firebasestorage.app", messagingSenderId: "454938973111", appId: "1:454938973111:web:2191261a3175c8115d0e32" };
        firebase.initializeApp(firebaseConfig); const db = firebase.database();

        function checkPass() { if(document.getElementById('adminPass').value === ADMIN_PASSWORD) { document.getElementById('lockScreen').style.display='none'; sessionStorage.setItem('adm','1'); load(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        if(sessionStorage.getItem('adm')==='1') { document.getElementById('lockScreen').style.display='none'; load(); }

        function tab(t) {
            ['u','o','p'].forEach(x => { document.getElementById('t'+x).classList.toggle('hidden', x!==t); document.getElementById('b'+x).className = x===t ? 'px-5 py-2 rounded-xl text-sm transition tab-active' : 'px-5 py-2 rounded-xl text-sm transition text-slate-400'; });
        }

        function load() {
            // æœƒå“¡è®€å–
            db.ref('users').on('value', s => {
                const u = s.val(), t = document.getElementById('userTable'); t.innerHTML = '';
                for(let id in u) {
                    t.innerHTML += `<tr class="border-b border-slate-700/50 hover:bg-slate-800/50 transition">
                        <td class="px-6 py-4"><span class="font-bold text-yellow-500">${u[id].name||'æœªåŒæ­¥'}</span><br><span class="text-[10px] text-slate-500 font-mono">${id}</span></td>
                        <td class="px-6 py-4 font-black text-xl">${(u[id].points||0).toLocaleString()}</td>
                        <td class="px-6 py-4 text-right"><input type="number" id="in-${id}" placeholder="+/-" class="bg-slate-900 w-20 p-2 rounded-lg text-center border border-slate-700 text-yellow-500 focus:border-yellow-600 outline-none mr-2"><button onclick="adj('${id}')" class="bg-slate-100 text-black px-4 py-2 rounded-lg font-bold text-sm active:scale-95 transition">åŸ·è¡Œ</button></td>
                    </tr>`;
                }
            });
            // è¨‚å–®è®€å– (æ–°)
            db.ref('orders').on('value', s => {
                const o = s.val(), l = document.getElementById('orderList'); l.innerHTML = '';
                if(!o) { l.innerHTML = '<div class="text-center py-10 text-slate-500">ç›®å‰å°šç„¡è¨‚å–®</div>'; return; }
                const sortedKeys = Object.keys(o).reverse();
                sortedKeys.forEach(id => {
                    const ord = o[id];
                    const isDone = ord.status === 'å·²å‡ºè²¨';
                    l.innerHTML += `<div class="bg-slate-800 p-5 rounded-3xl border border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4 shadow-lg ${isDone?'opacity-60':''}">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="w-12 h-12 bg-slate-900 rounded-full flex items-center justify-center font-bold text-yellow-500 border border-slate-700">${ord.userName?.charAt(0)||'ç”¨'}</div>
                            <div>
                                <p class="font-bold">${ord.itemName} <span class="text-yellow-500">x${ord.qty}</span></p>
                                <p class="text-xs text-slate-400">${ord.userName} Â· ${new Date(ord.time).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                            <span class="text-xs px-3 py-1 rounded-full border ${isDone?'border-green-500 text-green-500':'border-orange-500 text-orange-500 font-bold'}">${ord.status}</span>
                            <button onclick="toggleOrder('${id}','${ord.status}')" class="px-4 py-2 rounded-xl text-xs font-bold ${isDone?'bg-slate-700 text-slate-300':'bg-yellow-600 text-slate-900'}">${isDone?'æ”¹å›å¾…å‡ºè²¨':'è¨­ç‚ºå·²å‡ºè²¨'}</button>
                            <button onclick="if(confirm('åˆªé™¤è¨‚å–®ï¼Ÿ')) db.ref('orders/${id}').remove()" class="text-red-500 p-2">âœ•</button>
                        </div>
                    </div>`;
                });
            });
            // å•†å“è®€å–
            db.ref('products').on('value', s => {
                const p = s.val(), l = document.getElementById('pList'); l.innerHTML = '';
                for(let id in p) {
                    l.innerHTML += `<div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex gap-4 items-center shadow-lg transition hover:border-slate-500">
                        <img src="${p[id].img}" class="w-16 h-16 rounded-xl object-cover border border-slate-700">
                        <div class="flex-1 min-w-0"><p class="text-[10px] text-slate-500 font-bold uppercase">${p[id].cat||'ä¸€èˆ¬'}</p><p class="font-bold truncate">${p[id].name}</p><p class="text-yellow-500 font-black">${p[id].price} PTS</p></div>
                        <button onclick="edit('${id}','${p[id].cat}','${p[id].name}',${p[id].price},'${p[id].img}','${p[id].desc}')" class="bg-slate-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-slate-600 transition">ç·¨è¼¯</button>
                        <button onclick="if(confirm('åˆªé™¤å•†å“ï¼Ÿ')) db.ref('products/${id}').remove()" class="bg-red-900/30 text-red-500 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-900/50 transition">åˆªé™¤</button>
                    </div>`;
                }
            });
        }

        function adj(uid) {
            const v = parseInt(document.getElementById(`in-${uid}`).value); if(isNaN(v)) return;
            db.ref(`users/${uid}/points`).transaction(p => (p||0)+v, (e,c,snap) => {
                if(c) {
                    const change = (v > 0 ? "+" : "") + v;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(change)}`, {mode:'no-cors'});
                    document.getElementById(`in-${uid}`).value = '';
                }
            });
        }

        function toggleOrder(oid, curr) {
            const next = curr === 'å¾…å‡ºè²¨' ? 'å·²å‡ºè²¨' : 'å¾…å‡ºè²¨';
            db.ref(`orders/${oid}`).update({ status: next });
        }

        function save() {
            const id = document.getElementById('editId').value;
            const data = { cat: document.getElementById('pCat').value||'ä¸€èˆ¬', name: document.getElementById('pName').value, price: parseInt(document.getElementById('pPrice').value), img: document.getElementById('pImg').value, desc: document.getElementById('pDesc').value||'' };
            if(!data.name || isNaN(data.price)) return alert('è«‹å¡«å¯«å®Œæ•´å•†å“åç¨±èˆ‡åƒ¹æ ¼');
            if(id) db.ref('products/'+id).update(data); else db.ref('products').push(data);
            reset();
        }

        function edit(id,c,n,p,i,d) {
            document.getElementById('editId').value = id; document.getElementById('pCat').value = c; document.getElementById('pName').value = n; document.getElementById('pPrice').value = p; document.getElementById('pImg').value = i; document.getElementById('pDesc').value = d==='undefined'?'':d;
            document.getElementById('fTitle').innerText = "âœï¸ æ­£åœ¨ç·¨è¼¯æ¨¡å¼";
        }

        function reset() {
            document.getElementById('editId').value = ''; document.getElementById('pCat').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pImg').value = ''; document.getElementById('pDesc').value = '';
            document.getElementById('fTitle').innerText = "ğŸ ç·¨è¼¯å•†å“";
        }
    </script>
</body>
</html>
