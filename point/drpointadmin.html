<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>å¤¢å·¥å» å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        .gold-text { color: #eab308; }
        input, textarea, select { outline: none !important; appearance: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .log-plus { color: #4ade80; }
        .log-minus { color: #f87171; }
        #editFormContainer { transition: all 0.3s ease-in-out; }
        /* æ‹–æ‹½ä¸­çš„æ¨£å¼ */
        .sortable-ghost { opacity: 0.4; border: 2px dashed #eab308 !important; background: #1e293b !important; }
        .sortable-drag { border: 2px solid #eab308 !important; background: #0f172a !important; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
        .handle { cursor: grab; color: #475569; transition: color 0.2s; }
        .handle:active { cursor: grabbing; color: #eab308; }
        @media (max-width: 1024px) {
            .mobile-hide { display: none; }
            .mobile-show { display: block; }
        }
    </style>
</head>
<body class="p-3 md:p-6 pb-20">
    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[200] flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-xs text-center border border-slate-700 shadow-2xl">
            <h2 class="text-xl font-bold mb-4 gold-text tracking-widest text-nowrap">DREAM ADMIN (B)</h2>
            <input type="password" id="adminPass" placeholder="ç®¡ç†å¯†ç¢¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-4 text-center text-yellow-500 text-lg">
            <button onclick="checkPass()" class="w-full bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold active:scale-95 transition">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="sticky top-0 z-[100] bg-[#0f172a]/90 backdrop-blur-md pb-4 pt-2">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl md:text-3xl font-bold gold-text tracking-tight">å¤¢å·¥å»  <span class="text-white text-xs bg-red-600 px-2 py-0.5 rounded">å¾Œå°ç®¡ç†</span></h1>
                <nav class="bg-slate-800 p-1 rounded-2xl flex gap-0.5 border border-slate-700 shadow-xl w-full md:w-auto overflow-x-auto no-scrollbar">
                    <button onclick="tab('u')" id="bu" class="flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold bg-yellow-600 text-slate-900 transition">æœƒå“¡</button>
                    <button onclick="tab('o')" id="bo" class="flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold text-slate-400 transition">è¨‚å–®</button>
                    <button onclick="tab('p')" id="bp" class="flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold text-slate-400 transition">å•†åŸ</button>
                    <button onclick="tab('l')" id="bl" class="flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold text-slate-400 transition">æ—¥èªŒ</button>
                </nav>
            </div>
        </header>

        <div id="tu" class="space-y-4">
            <input type="text" id="userSearch" oninput="renderUsers()" placeholder="ğŸ” æœå°‹ æœƒå“¡æš±ç¨±..." class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-yellow-500 shadow-xl focus:border-yellow-600 transition">
            <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-x-auto shadow-2xl">
                <table class="w-full text-left min-w-[500px]">
                    <tbody id="userTable" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>
        
        <div id="to" class="hidden space-y-3">
            <div id="orderList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </div>

        <div id="tp" class="hidden">
            <div class="flex flex-col lg:grid lg:grid-cols-12 gap-6 relative">
                <div id="editFormContainer" class="lg:col-span-4 bg-slate-800 p-5 rounded-3xl border border-slate-700 shadow-xl h-fit lg:sticky lg:top-28 z-50 overflow-hidden">
                    <div class="flex justify-between items-center mb-4" onclick="toggleMobileEdit()">
                        <h2 id="fTitle" class="font-bold text-yellow-500 flex items-center gap-2 text-lg">
                            ğŸ <span id="fAction">æ–°å¢å•†å“</span>
                        </h2>
                        <button class="lg:hidden bg-slate-700 px-3 py-1 rounded-lg text-xs" id="toggleBtn">å±•é–‹/æ”¶åˆ</button>
                    </div>
                    
                    <div id="editFields" class="space-y-4 hidden lg:block">
                        <input type="hidden" id="editId">
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 ml-1 uppercase font-bold">åˆ†é¡</label>
                            <div class="flex gap-1">
                                <select id="pCat" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-yellow-500 font-bold"></select>
                                <button onclick="addCategory()" class="bg-slate-700 text-white w-10 rounded-xl font-bold active:scale-90">+</button>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 ml-1 uppercase font-bold">åç¨±èˆ‡é»æ•¸</label>
                            <div class="flex gap-2">
                                <input type="text" id="pName" placeholder="å•†å“åç¨±" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm">
                                <input type="number" id="pPrice" placeholder="é»æ•¸" class="w-24 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 ml-1 uppercase font-bold">åœ–ç‰‡</label>
                            <div class="flex gap-2">
                                <input type="text" id="pImg" placeholder="https://..." class="flex-1 bg-slate-900 border border-slate-700 rounded-xl p-3 text-xs">
                                <label class="bg-slate-700 px-4 py-3 rounded-xl cursor-pointer text-xs font-bold transition hover:bg-slate-600 flex items-center">
                                    ğŸ“¤<input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleUpload(this)">
                                </label>
                            </div>
                            <div id="uploadStatus" class="text-[10px] text-yellow-500 ml-1 hidden animate-pulse">ä¸Šå‚³è™•ç†ä¸­...</div>
                        </div>

                        <textarea id="pDesc" placeholder="å•†å“è©³ç´°æè¿°" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm h-32"></textarea>
                        
                        <div class="flex items-center justify-between p-2 bg-slate-900 rounded-xl border border-slate-700">
                            <span class="text-xs text-slate-500 ml-2">è²©å”®ç‹€æ…‹ï¼š</span>
                            <select id="pStatus" class="bg-transparent text-yellow-500 font-bold text-sm px-4">
                                <option value="ä¸Šæ¶">âœ… ä¸Šæ¶éŠ·å”®</option>
                                <option value="ä¸‹æ¶">âŒ ä¸‹æ¶éš±è—</option>
                            </select>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="save()" class="flex-1 bg-yellow-600 text-slate-900 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition">å„²å­˜ç™¼å¸ƒ</button>
                            <button onclick="reset()" class="bg-slate-700 text-white px-4 rounded-xl font-bold">æ¸…ç©º</button>
                        </div>
                        <p class="text-[10px] text-slate-500 text-center italic">â€» æ’åºè«‹ç›´æ¥åœ¨å³å´åˆ—è¡¨æ‹–æ‹‰</p>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-3">
                    <div class="flex flex-col md:flex-row gap-2 mb-4 sticky top-[120px] md:top-[80px] z-40 bg-[#0f172a] pb-2">
                        <input type="text" id="prodSearch" oninput="renderProducts()" placeholder="ğŸ” æœå°‹å•†å“..." class="flex-1 bg-slate-800 border border-slate-700 rounded-2xl p-4 text-yellow-500 shadow-xl">
                        <select id="pFilterCat" onchange="renderProducts()" class="bg-slate-800 border border-slate-700 rounded-2xl p-4 text-yellow-500 font-bold shadow-xl"></select>
                    </div>
                    <div id="pList" class="space-y-3 pb-20"></div>
                </div>
            </div>
        </div>

        <div id="tl" class="hidden space-y-4">
            <h2 class="text-xl font-bold gold-text px-2">å°å¸³å–®</h2>
            <div class="bg-slate-800 rounded-3xl border border-slate-700 overflow-x-auto shadow-2xl">
                <table class="w-full text-left min-w-[600px]">
                    <thead class="bg-slate-900/50 text-slate-500 text-[10px] uppercase tracking-widest font-bold">
                        <tr><th class="px-4 py-3">æ™‚é–“</th><th class="px-4 py-3">æœƒå“¡</th><th class="px-4 py-3">å…§å®¹</th><th class="px-4 py-3 text-center">ç•°å‹•</th><th class="px-4 py-3 text-right">é¤˜é¡</th></tr>
                    </thead>
                    <tbody id="logTable" class="divide-y divide-slate-700/50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = "0805", GAS_URL = "https://script.google.com/macros/s/AKfycbwuvNZo2rJ3kkcWPoKfBOiw7megpwxSu5X9rIEuxjcgDYMJ5ElWJekTQ_H7Xz-o0oQ/exec";
        const firebaseConfig = { 
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco",
            authDomain: "dream8-7b161.firebaseapp.com",
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com",
            projectId: "dream8-7b161",
            storageBucket: "dream8-7b161.firebasestorage.app",
            messagingSenderId: "606218522479",
            appId: "1:606218522479:web:2737643db3de735af7e29a",
            measurementId: "G-J0YJNPZMR4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), storage = firebase.storage();
        let allUsers = {}, allProducts = {}, allCategories = ["ä¸€èˆ¬"], allLogs = [];

        function checkPass() { if(document.getElementById('adminPass').value === ADMIN_PASSWORD) { document.getElementById('lockScreen').style.display='none'; sessionStorage.setItem('adm_B','1'); load(); } else alert('å¯†ç¢¼éŒ¯èª¤'); }
        if(sessionStorage.getItem('adm_B')==='1') { document.getElementById('lockScreen').style.display='none'; load(); }
        
        function tab(t) { 
            ['u','o','p','l'].forEach(x => { 
                document.getElementById('t'+x).classList.toggle('hidden', x!==t); 
                document.getElementById('b'+x).className = x===t ? 'flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold bg-yellow-600 text-slate-900 transition' : 'flex-1 whitespace-nowrap px-4 py-2 rounded-xl text-xs font-bold text-slate-400 transition'; 
            }); 
            window.scrollTo(0,0);
        }

        function toggleMobileEdit(forceOpen = false) {
            const fields = document.getElementById('editFields');
            if (forceOpen) fields.classList.remove('hidden');
            else fields.classList.toggle('hidden');
        }
        
        function load() {
            reset();
            db.ref('categories_B').on('value', s => { allCategories = s.val() ? Object.values(s.val()) : ["ä¸€èˆ¬"]; renderCategoryOptions(); });
            db.ref('users_B').on('value', s => { allUsers = s.val() || {}; renderUsers(); });
            db.ref('products_B').on('value', s => { allProducts = s.val() || {}; renderProducts(); });
            db.ref('orders_B').on('value', s => {
                const o = s.val(), l = document.getElementById('orderList'); l.innerHTML = '';
                if(!o) return l.innerHTML = '<p class="text-center py-10 text-slate-500 font-bold">æš«ç„¡è¨‚å–®</p>';
                Object.keys(o).reverse().forEach(id => {
                    const ord = o[id], isDone = ord.status === 'å·²å‡ºè²¨';
                    l.innerHTML += `<div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 space-y-3 shadow-xl ${isDone?'opacity-60':''}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-base font-bold text-yellow-500">${ord.itemName} x${ord.qty}</p>
                                <p class="text-[10px] text-slate-400 mt-0.5">${ord.userName} Â· ${new Date(ord.time).toLocaleString()}</p>
                            </div>
                            <span class="text-[9px] px-2 py-0.5 rounded-full border ${isDone?'border-green-500 text-green-500 bg-green-500/10':'border-yellow-500 text-yellow-500 bg-yellow-500/10'}">${ord.status}</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="track-${id}" placeholder="äº¤è²¨ä¾¿ç·¨è™Ÿ" value="${ord.trackNo || ''}" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-xs text-yellow-500 font-mono shadow-inner">
                            <button onclick="saveTrack('${id}')" class="bg-blue-600 text-white px-4 rounded-xl text-xs font-bold active:scale-95 transition">å­˜</button>
                        </div>
                        <div class="flex gap-2 justify-between items-center pt-2 border-t border-slate-700/50">
                            <button onclick="refundOrder('${id}', '${ord.userId}', ${ord.total}, '${ord.itemName}')" class="text-red-400 text-[10px] font-bold underline">å–æ¶ˆé€€æ¬¾</button>
                            <button onclick="toggleOrder('${id}','${ord.status}')" class="bg-slate-700 px-4 py-1.5 rounded-xl text-[10px] font-bold active:scale-95 transition">${isDone?'å¾…å‡ºè²¨':'å·²å‡ºè²¨'}</button>
                        </div>
                    </div>`;
                });
            });
            db.ref('logs_B').limitToLast(100).on('value', s => { allLogs = s.val() ? Object.values(s.val()).reverse() : []; renderLogs(); });
        }

        function renderLogs() {
            const t = document.getElementById('logTable'); t.innerHTML = '';
            allLogs.forEach(log => {
                const isPlus = log.change >= 0;
                t.innerHTML += `<tr class="border-b border-slate-700/30 text-xs">
                    <td class="px-4 py-3 text-slate-500">${new Date(log.time).toLocaleString([], {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="px-4 py-3 font-bold text-slate-200">${log.userName}</td>
                    <td class="px-4 py-3 text-slate-400 text-[10px]">${log.reason}</td>
                    <td class="px-4 py-3 text-center font-black ${isPlus?'log-plus':'log-minus'}">${isPlus?'+':''}${log.change}</td>
                    <td class="px-4 py-3 text-right font-bold text-yellow-500/80">${log.after}</td>
                </tr>`;
            });
        }

        function writeLog(uid, name, reason, change, after) { db.ref('logs_B').push({ time: Date.now(), userId: uid, userName: name, reason: reason, change: change, after: after }); }
        function saveTrack(oid) { const no = document.getElementById(`track-${oid}`).value; db.ref(`orders_B/${oid}`).update({ trackNo: no }).then(() => alert('ç·¨è™Ÿå·²æ›´æ–°')); }
        
        function renderCategoryOptions() { 
            const select = document.getElementById('pCat'); 
            const filterSelect = document.getElementById('pFilterCat');
            const currentVal = select.value; 
            const optHtml = allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            select.innerHTML = optHtml;
            filterSelect.innerHTML = `<option value="å…¨éƒ¨">ğŸ” åˆ†é¡ç¯©é¸</option>` + optHtml;
            if (currentVal && allCategories.includes(currentVal)) select.value = currentVal; 
        }

        function addCategory() {
            const newCat = prompt("æ–°åˆ†é¡åç¨±ï¼š");
            if (!newCat) return;
            if (allCategories.includes(newCat)) return alert("å·²å­˜åœ¨");
            db.ref('categories_B').push(newCat);
        }

        async function handleUpload(input) {
            const file = input.files[0]; if (!file) return;
            const status = document.getElementById('uploadStatus'); status.classList.remove('hidden');
            try {
                const storageRef = storage.ref('products_B/' + Date.now() + "_" + file.name);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                document.getElementById('pImg').value = url;
                status.classList.add('hidden'); alert("âœ… æˆåŠŸ");
            } catch (err) { alert("ä¸Šå‚³å¤±æ•—"); status.classList.add('hidden'); }
        }

        function renderUsers() { 
            const q = document.getElementById('userSearch').value.toLowerCase(); 
            const t = document.getElementById('userTable'); t.innerHTML = ''; 
            for(let id in allUsers) { 
                const name = allUsers[id].name || 'æœªåŒæ­¥'; 
                if(q && !name.toLowerCase().includes(q)) continue; 
                t.innerHTML += `<tr class="border-b border-slate-700/50"><td class="px-4 py-3"><p class="font-bold text-yellow-500">${name}</p><p class="text-[9px] text-slate-500">${id}</p></td><td class="px-4 py-3 font-black text-white">${(allUsers[id].points||0).toLocaleString()}</td><td class="px-4 py-3 text-right"><div class="flex justify-end gap-1"><input type="number" id="in-${id}" placeholder="+/-" class="bg-slate-900 w-16 p-2 rounded-lg text-center border border-slate-700 text-yellow-500 text-xs"><button onclick="adj('${id}')" class="bg-white text-black px-3 py-2 rounded-lg font-bold text-xs active:scale-90 transition">å¢æ¸›</button></div></td></tr>`; 
            } 
        }

        function renderProducts() { 
            const q = document.getElementById('prodSearch').value.toLowerCase();
            const catFilter = document.getElementById('pFilterCat').value;
            const l = document.getElementById('pList'); l.innerHTML = ''; 
            let items = [];
            for(let id in allProducts) { items.push({ id, ...allProducts[id] }); }
            items.sort((a, b) => (a.sort || 99) - (b.sort || 99));
            
            items.forEach(p => { 
                if(q && !p.name.toLowerCase().includes(q)) return;
                if(catFilter !== 'å…¨éƒ¨' && p.cat !== catFilter) return;
                const isOff = p.status === 'ä¸‹æ¶';
                const div = document.createElement('div');
                div.setAttribute('data-id', p.id);
                div.className = `bg-slate-800 p-3 rounded-2xl border border-slate-700 flex gap-4 items-center ${isOff?'opacity-40 grayscale':''} relative`;
                div.innerHTML = `
                    <div class="handle px-1 py-4 text-xl">â ¿</div>
                    <img src="${p.img}" class="w-14 h-14 md:w-16 md:h-16 rounded-xl object-cover bg-slate-900 border border-slate-700 shrink-0"> 
                    <div class="flex-1 overflow-hidden"> 
                        <div class="flex items-center gap-2">
                            <p class="font-black text-blue-400 text-[10px] uppercase tracking-tighter">${p.cat || 'ä¸€èˆ¬'}</p> 
                            <span class="text-[8px] px-1 py-0.5 rounded border ${isOff?'border-red-500 text-red-500':'border-green-500 text-green-500'} font-bold">${isOff?'ä¸‹æ¶':'å”®'}</span>
                        </div>
                        <p class="font-bold text-slate-100 text-sm truncate">${p.name}</p> 
                        <p class="text-yellow-500 text-xs font-black">${p.price.toLocaleString()} é»</p> 
                    </div> 
                    <div class="flex flex-col gap-1">
                        <button onclick="edit('${p.id}')" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-[11px] font-bold shadow-md active:scale-90">ç·¨è¼¯</button> 
                        <button onclick="deleteProd('${p.id}')" class="px-4 py-2 rounded-lg bg-red-900/40 text-red-400 border border-red-900 text-[11px] font-bold active:scale-90">åˆªé™¤</button> 
                    </div>`;
                l.appendChild(div);
            }); 

            // åˆå§‹åŒ–æ‹–æ‹‰åŠŸèƒ½
            if (catFilter === 'å…¨éƒ¨') {
                new Sortable(l, {
                    handle: '.handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function() {
                        const newOrder = [];
                        document.querySelectorAll('#pList > div').forEach((el, index) => {
                            const id = el.getAttribute('data-id');
                            newOrder.push({ id, sort: index + 1 });
                        });
                        updateSortToFirebase(newOrder);
                    }
                });
            }
        }

        async function updateSortToFirebase(orderData) {
            const updates = {};
            orderData.forEach(item => { updates[`products_B/${item.id}/sort`] = item.sort; });
            try {
                await db.ref().update(updates);
                console.log("æ’åºå·²æ›´æ–°");
            } catch (e) { alert("æ’åºå„²å­˜å¤±æ•—"); }
        }

        function adj(uid) { 
            const val = parseInt(document.getElementById(`in-${uid}`).value); 
            if(isNaN(val)) return alert('è¼¸å…¥æ•¸å­—'); 
            db.ref(`users_B/${uid}/points`).transaction(p => (p||0)+val, (err, comm, snap) => { 
                if(comm) { 
                    const after = snap.val(); 
                    writeLog(uid, allUsers[uid].name, "å¾Œå°èª¿æ•´", val, after); 
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent('âœ… é»æ•¸è®Šå‹•: ' + val)}`, {mode:'no-cors'});
                    document.getElementById(`in-${uid}`).value = ''; 
                } 
            }); 
        }

        function refundOrder(oid, uid, amount, itemName) { 
            if(!confirm(`ç¢ºèªé€€æ¬¾ ${amount} é»ï¼Ÿ`)) return; 
            db.ref(`users_B/${uid}/points`).transaction(p => (p||0) + amount, (err, comm, snap) => { 
                if(comm) { 
                    const after = snap.val(); 
                    db.ref(`orders_B/${oid}`).remove(); 
                    writeLog(uid, allUsers[uid].name, "è¨‚å–®é€€æ¬¾", amount, after); 
                    const notifyMsg = `âš ï¸ è¨‚å–®å–æ¶ˆé€šçŸ¥\né …ç›®ï¼š${itemName}\né»æ•¸ ${amount} å·²é€€å›ã€‚`;
                    fetch(`${GAS_URL}?userId=${uid}&msg=${encodeURIComponent(notifyMsg)}`, {mode:'no-cors'});
                } 
            }); 
        }

        function deleteProd(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref(`products_B/${id}`).remove(); }
        
        function save() { 
            const id = document.getElementById('editId').value; 
            const data = { 
                cat: document.getElementById('pCat').value || 'ä¸€èˆ¬', 
                name: document.getElementById('pName').value, 
                price: parseInt(document.getElementById('pPrice').value), 
                img: document.getElementById('pImg').value, 
                desc: document.getElementById('pDesc').value || '', 
                status: document.getElementById('pStatus').value
            }; 
            if(!data.name || isNaN(data.price)) return alert('è³‡æ–™ä¸å…¨'); 
            if(id) {
                db.ref('products_B/'+id).update(data);
            } else {
                data.sort = 999; // æ–°å•†å“é è¨­æ’æœ€å¾Œ
                db.ref('products_B').push(data);
            }
            reset(); 
            if(window.innerWidth < 1024) toggleMobileEdit();
        }
        
        function edit(id) { 
            const p = allProducts[id]; if(!p) return;
            document.getElementById('editId').value = id; 
            document.getElementById('fAction').innerText = "æ­£åœ¨ç·¨è¼¯";
            document.getElementById('pCat').value = p.cat || 'ä¸€èˆ¬'; 
            document.getElementById('pName').value = p.name; 
            document.getElementById('pPrice').value = p.price; 
            document.getElementById('pImg').value = p.img; 
            document.getElementById('pDesc').value = p.desc || ''; 
            document.getElementById('pStatus').value = p.status || 'ä¸Šæ¶'; 
            window.scrollTo({top:0, behavior:'smooth'}); 
            toggleMobileEdit(true);
        }

        function reset() { 
            document.getElementById('editId').value = ''; 
            document.getElementById('fAction').innerText = "æ–°å¢å•†å“";
            document.getElementById('pName').value = ''; 
            document.getElementById('pPrice').value = ''; 
            document.getElementById('pImg').value = ''; 
            document.getElementById('pStatus').value = 'ä¸Šæ¶'; 
            document.getElementById('pDesc').value = "â—å¤¢å·¥å» å•†å“å…Œæ›èªªæ˜â—\nã€å•†å“ç‹€æ…‹ã€‘ å…¨æ–°å“\nã€å•†å“å…§å®¹ã€‘ æœ¬é …ç›®æ¡ ã€Œéš¨æ©Ÿæ¬¾å¼ã€ å‡ºè²¨ï¼Œ\nåœ–ç‰‡åƒ…ä¾›åƒè€ƒï¼Œè«‹ä»¥æ”¶åˆ°çš„å¯¦å“ç‚ºæº–ã€‚\néš¨æ©Ÿå•†å“åŒ…å«å„é¡ç†±é–€ç³»åˆ—ï¼Œæ•ä¸æ¥å—æŒ‡å®šæ¬¾å¼ã€‚\n\nã€å…Œæ›é ˆçŸ¥ã€‘\n1.é»æ•¸ä¸€ç¶“æ‰£é™¤å…Œæ›å¯„å‡ºå•†å“ï¼Œæ•ä¸æ¥å—é€€æ›è²¨ã€‚\n2.å•†å“å°‡æ–¼ 2 å€‹å·¥ä½œå¤©å…§é€é 7-11 äº¤è²¨ä¾¿å…é‹è²»å¯„å‡ºã€‚\n3.è«‹å‹™å¿…è·Ÿå®˜æ–¹Lineç¢ºèªæ‚¨çš„7-11æ”¶ä»¶è³‡è¨Šæ­£ç¢ºï¼Œä»¥å…å½±éŸ¿é…é€ã€‚\n4.è‹¥é‡å•†å“ç¼ºè²¨ï¼Œå°‡ä¸»å‹•è¯ç¹«ä¸¦é€€å›é»æ•¸ã€‚\n\nã€æ”¶è²¨é ˆçŸ¥ï¼šé‡è¦ï¼ã€‘ âš ï¸ ç‚ºä¿éšœé›™æ–¹æ¬Šç›Šï¼Œæ‹†å°è«‹å‹™å¿…ã€Œå…¨ç¨‹éŒ„å½±ã€ã€‚\nè«‹å¾åŒ…è£¹æœªæ‹†å°å‰çš„ã€Œå¤–ç®±ç‹€æ…‹ã€é–‹å§‹æ‹æ”ã€‚\nå½±ç‰‡éœ€å®Œæ•´è¨˜éŒ„æ‹†ç®±éç¨‹è‡³æª¢æŸ¥å•†å“å¤–è§€ã€‚\nè‹¥ç„¡å®Œæ•´é–‹ç®±éŒ„å½±è­‰æ˜ï¼Œå•†å“å¦‚æœ‰æå£æˆ–ç‘•ç–µç­‰å•é¡Œï¼Œæ•ä¸è™•ç†å”®å¾Œã€‚\nå¦‚å®˜æ–¹ç‘•ç–µä¾ç…§æƒ…ç¯€è™•ç†ã€‚\n\nâ€»ç©å…·å•†å“çš†ç‚ºå·¥å» å¤§é‡è£½é€ ï¼Œä»»ä½•å¡—è£å°æº¢è‰²ã€æ¼†é¢ç•¥ä¸å¹³æ•´ã€ç›’å­æœ‰äºŒæ¬¡è† ã€é—œç¯€æ§‹ä»¶è™•é¬†ç·Šç­‰å°ç–µçš†å±¬æ­£å¸¸ç¾è±¡ã€‚";
        }

        function toggleOrder(oid, curr) { const next = curr === 'å¾…å‡ºè²¨' ? 'å·²å‡ºè²¨' : 'å¾…å‡ºè²¨'; db.ref(`orders_B/${oid}`).update({ status: next }); }
    </script>
</body>
</html>
