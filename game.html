<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <title>å¤¢å·¥å»  | æ¥µè‡´åˆ®åˆ®æ¨‚ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #ffb800; --bg: #05070a; --card: #11141b; --win: #ffd700; --danger: #ff4757; --lock: #3498db; --silver: linear-gradient(135deg, #a8a8a8 0%, #e8e8e8 50%, #a8a8a8 100%); }
        * { -webkit-tap-highlight-color: transparent; user-select: none !important; -webkit-user-drag: none !important; }
        body { margin: 0; padding: 0; width: 100%; min-height: 100vh; background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; display: flex; flex-direction: column; overflow-x: hidden; }
        
        /* é é¦–æ¨£å¼ */
        .header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,184,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: none; border: 1px solid var(--p); color: var(--p); padding: 6px 16px; border-radius: 50px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 0.8rem; transition: 0.3s; }
        .balance-tag { background: linear-gradient(90deg, var(--p), #fff59d); padding: 6px 20px; border-radius: 50px; font-weight: 900; color: #000; box-shadow: 0 4px 15px rgba(255,184,0,0.3); }

        /* å•†å“å±•ç¤º */
        .gallery-container { background: #000; width: 100%; max-width: 600px; margin: 0 auto; }
        .main-img-wrap { width: 100%; height: 40vh; max-height: 350px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); }
        #gMainImg { width: 100%; height: 100%; object-fit: contain; }
        .thumb-scroll { display: flex; gap: 10px; padding: 12px; overflow-x: auto; background: var(--card); }
        .thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 2px solid #333; opacity: 0.5; transition: 0.3s; }
        .thumb-img.active { border-color: var(--p); opacity: 1; transform: scale(1.1); }

        /* è³‡è¨Šçœ‹æ¿ */
        .info-box { padding: 20px 15px; background: var(--card); border-bottom: 1px solid #222; max-width: 600px; margin: 0 auto; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        /* åˆ®åˆ®æ¨‚æ ¼æŸµ */
        #scroll-area { width: 100%; max-width: 600px; margin: 0 auto; padding: 20px 15px 120px; }
        .pool-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        
        .ticket { 
            aspect-ratio: 1/1; background: #1a1e26; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; border: 1px solid #333; font-weight: 900; transition: 0.3s; overflow: hidden;
        }
        .ticket.available { cursor: pointer; background: var(--silver); color: #666; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        .ticket.available:active { transform: scale(0.95); }
        .ticket.taken { background: #0a0c10; color: #444; border-color: #222; }
        .ticket.revealed { background: #161a22; color: var(--p); border-color: rgba(255,184,0,0.4); animation: flipIn 0.5s ease; }
        @keyframes flipIn { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0deg); opacity: 1; } }

        .winner-glow { border-color: var(--win) !important; box-shadow: 0 0 15px rgba(255,184,0,0.4); }
        .ticket-no { font-size: 0.6rem; position: absolute; top: 5px; left: 6px; opacity: 0.6; }

        /* åˆ®åˆ®å¡æ‡¸æµ®å±¤ */
        .scratch-overlay { display: none; position: fixed; inset: 0; z-index: 5000; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); }
        .scratch-box { 
            position: relative; width: 280px; height: 280px; border-radius: 20px; background: #fff; 
            border: 6px solid var(--p); box-shadow: 0 0 40px rgba(255,184,0,0.3);
        }
        #luckyVal { font-size: 6rem; font-weight: 900; color: #111; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
        #scratch-canvas { position: absolute; inset: 0; z-index: 10; cursor: crosshair; touch-action: none; border-radius: 12px; }

        /* ä¸­çæ¨™è¨˜ */
        .prize-tag { background: #1a1e26; border: 1px solid #444; padding: 5px 10px; border-radius: 5px; font-weight: 900; color: #aaa; }
        .prize-tag.won { color: var(--danger); border-color: var(--danger); position: relative; }
        .prize-tag.won::after { content: "OUT"; position: absolute; top: -5px; right: -5px; background: var(--danger); color: #fff; font-size: 0.5rem; padding: 1px 4px; border-radius: 3px; }

        .modal { display: none; position: fixed; inset: 0; z-index: 9999; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
        .m-card { background: var(--card); border: 2px solid var(--p); border-radius: 30px; padding: 25px; width: 85%; max-width: 320px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <a href="index.html" class="back-btn">â† é›¢é–‹</a>
    <div class="balance-tag">P <span id="uBal">0</span></div>
</div>

<div class="gallery-container">
    <div class="main-img-wrap"><img id="gMainImg" src=""></div>
    <div class="thumb-scroll" id="thumbList"></div>
</div>

<div class="info-box">
    <div>
        <h2 id="gTitle" style="margin:0; font-size:1.1rem;">è¼‰å…¥ä¸­...</h2>
        <small id="progText" style="color:#666; font-weight:bold;">-- / --</small>
    </div>
    <div id="priceDisplay" style="color:var(--p); font-weight:900; font-size:1.4rem;">-- P</div>
</div>

<div id="scroll-area">
    <div style="margin-bottom:15px; display:flex; gap:8px; flex-wrap:wrap;" id="prizeTags"></div>
    <div class="pool-grid" id="poolGrid"></div>
</div>

<div id="scratchOverlay" class="scratch-overlay">
    <div style="text-align:center;">
        <div style="color:var(--p); font-weight:900; font-size:1.2rem; margin-bottom:10px;">è«‹åˆ®é–‹è™Ÿç¢¼</div>
        <div class="scratch-box" id="scratchBox">
            <div id="luckyVal">?</div>
        </div>
        <div style="margin-top:20px; color:#fff; font-size:0.8rem; opacity:0.7;">æ‰‹å‹•åˆ®é™¤ 60% å³å¯è‡ªå‹•å…Œç</div>
    </div>
</div>

<div id="resModal" class="modal">
    <div class="m-card">
        <div id="res_msg" style="font-size:1.4rem; font-weight:900; color:var(--p); margin-bottom:15px;"></div>
        <img id="res_img" style="width:100%; border-radius:15px; margin-bottom:15px;">
        <button class="m-btn" style="width:100%; padding:15px; background:var(--p); border:none; border-radius:12px; font-weight:900;" onclick="location.reload()">ç¢ºå®š</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, get, update, serverTimestamp, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const _cc = { apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE", databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com", projectId: "dream-169dc", appId: "1:214137228622:web:84d14bad85d865ee94e21f" };
const _app = initializeApp(_cc); const _db = getDatabase(_app);
const _p = new URLSearchParams(window.location.search); const _gid = _p.get('id'); const _uid = localStorage.getItem('myScratchCode');

if(!_gid) location.href = 'index.html';

onValue(ref(_db, `users/${_uid}/balance`), s => document.getElementById('uBal').innerText = (s.val()||0).toLocaleString());

onValue(ref(_db, `gameSettings/${_gid}`), async snap => {
    const data = snap.val(); if(!data) return;
    document.getElementById('gTitle').innerText = _gid;
    document.getElementById('gMainImg').src = data.img;
    document.getElementById('priceDisplay').innerText = data.isSoldOut ? "å·²åœç›¤" : `${data.price} P`;

    // ç›£è½è™Ÿç¢¼æ± 
    onValue(ref(_db, `games/${_gid}/pool`), s => {
        const pool = s.val() || [];
        const grid = document.getElementById('poolGrid');
        const tags = document.getElementById('prizeTags');
        const prizeNums = data.prizes.map(p => Number(p.num));
        
        document.getElementById('progText').innerText = `å·²å”® ${pool.filter(x=>x.taken).length} / ${data.total}`;
        
        // æ¸²æŸ“å¤§çæ¨™ç±¤
        tags.innerHTML = data.prizes.map(p => {
            const isWon = pool.some(t => Number(t.grade) === Number(p.num) && t.revealed);
            return `<div class="prize-tag ${isWon?'won':''}">${p.num}</div>`;
        }).join('');

        // æ¸²æŸ“æ ¼å­
        grid.innerHTML = '';
        pool.forEach((t, i) => {
            const el = document.createElement('div');
            const no = (i+1).toString().padStart(2,'0');
            
            if(t.taken && t.revealed) {
                // å·²å®Œå…¨å…¬é–‹
                const isBig = prizeNums.includes(Number(t.grade));
                el.className = `ticket revealed ${isBig?'winner-glow':''}`;
                el.innerHTML = `<span class="ticket-no">${no}</span><span>${t.grade}</span>`;
            } else if(t.taken && !t.revealed) {
                // å·²è²·ä½†æœªåˆ®å®Œ
                el.className = `ticket revealed`;
                el.style.opacity = "0.7";
                el.innerHTML = `<span class="ticket-no">${no}</span><span style="font-size:0.6rem">åˆ®é–‹ä¸­</span>`;
            } else {
                // å¯è³¼è²·
                el.className = `ticket available`;
                el.innerHTML = `<span>${no}</span>`;
                el.onclick = () => buyTicket(i, data.price);
            }
            grid.appendChild(el);
        });
    });
});

async function buyTicket(idx, price) {
    const s = await get(ref(_db, `users/${_uid}/balance`));
    const bal = s.val() || 0;
    if(bal < price) return alert("é»æ•¸ä¸è¶³");
    if(!confirm(`ç¢ºèªæ”¯ä»˜ ${price} P è³¼è²· ${idx+1} è™Ÿï¼Ÿ`)) return;

    const pSnap = await get(ref(_db, `games/${_gid}/pool/${idx}`));
    if(pSnap.val().taken) return alert("å·²è¢«æ¶å…ˆè³¼è²·");

    // æ‰£æ¬¾ä¸¦æ¨™è¨˜ã€Œåˆ®é–‹ä¸­ã€
    await update(ref(_db, `users/${_uid}`), { balance: bal - price });
    await update(ref(_db, `games/${_gid}/pool/${idx}`), { taken: true, user: _uid });
    await push(ref(_db, `users/${_uid}/logs`), { game: _gid, cost: price, time: serverTimestamp() });

    // ç²å–é€™å¼µç‰ŒçœŸæ­£çš„è™Ÿç¢¼
    const realGrade = pSnap.val().grade;
    initScratch(idx, realGrade);
}

function initScratch(poolIdx, grade) {
    const overlay = document.getElementById('scratchOverlay');
    const box = document.getElementById('scratchBox');
    const lucky = document.getElementById('luckyVal');
    lucky.innerText = grade;
    overlay.style.display = 'flex';

    const canvas = document.createElement('canvas');
    canvas.id = 'scratch-canvas';
    canvas.width = 280; canvas.height = 280;
    box.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    
    // ç¹ªè£½é«˜ç´šéŠ€è‰²åˆ®å±¤
    const grad = ctx.createLinearGradient(0,0,280,280);
    grad.addColorStop(0, '#adb5bd');
    grad.addColorStop(0.5, '#dee2e6');
    grad.addColorStop(1, '#adb5bd');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,280,280);
    
    // åŠ å…¥æ‹‰çµ²ç´‹ç†èˆ‡é›œé»æé«˜è³ªæ„Ÿ
    for(let i=0; i<500; i++) {
        ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.1})`;
        ctx.fillRect(Math.random()*280, Math.random()*280, 2, 2);
    }

    let isDrawing = false;
    const scratch = (e) => {
        if(!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        
        ctx.globalCompositeOperation = 'destination-out';
        ctx.beginPath();
        ctx.arc(x, y, 30, 0, Math.PI * 2);
        ctx.fill();
        checkProgress();
    };

    const checkProgress = () => {
        const data = ctx.getImageData(0,0,280,280).data;
        let clear = 0;
        for(let i=3; i<data.length; i+=4) if(data[i] === 0) clear++;
        if(clear > (280*280*0.6)) {
            isDrawing = false;
            finishGame(poolIdx, grade);
        }
    };

    canvas.onmousedown = () => isDrawing = true;
    window.onmouseup = () => isDrawing = false;
    canvas.onmousemove = scratch;
    canvas.ontouchstart = () => isDrawing = true;
    canvas.ontouchmove = (e) => { e.preventDefault(); scratch(e); };
}

async function finishGame(idx, grade) {
    // åŒæ­¥åˆ°è³‡æ–™åº«ï¼šæ¨™è¨˜ç‚º revealedï¼Œè®“æ•¸å­—æ°¸é é¡¯ç¤ºåœ¨å¡ç‰‡ä¸Š
    await update(ref(_db, `games/${_gid}/pool/${idx}`), { revealed: true });
    
    const settingsSnap = await get(ref(_db, `gameSettings/${_gid}`));
    const data = settingsSnap.val();
    const hit = data.prizes.find(p => Number(p.num) === Number(grade));

    if(hit) {
        document.getElementById('res_msg').innerHTML = `ğŸŠ æ­å–œç²å¾— ğŸŠ<br>${hit.name}`;
        document.getElementById('res_img').src = data.img;
        confetti({ particleCount: 150, spread: 70 });
        push(ref(_db, `winLogs`), { user: _uid, game: _gid, prize: hit.name, time: serverTimestamp() });
    } else {
        document.getElementById('res_msg').innerText = "éŠ˜è¬æƒ é¡§";
        document.getElementById('res_img').src = "https://i.ibb.co/7t4gt23K/image.png";
    }

    setTimeout(() => {
        document.getElementById('resModal').style.display = 'flex';
    }, 500);
}
</script>
</body>
</html>
