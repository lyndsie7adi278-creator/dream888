<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å·¥å»  | åˆ®åˆ®æ¨‚é«”é©—</title>
    <style>
        :root { --primary: #ff8fa3; --bg: #f0f2f5; }
        * { -webkit-tap-highlight-color: transparent; user-select: none !important; box-sizing: border-box; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .header { width: 100%; background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .back-btn { cursor: pointer; font-size: 1.2rem; color: #7f8c8d; font-weight: bold; text-decoration: none; }
        .user-stats { text-align: right; }
        .stat-val { color: var(--primary); font-weight: 900; font-size: 1.1rem; }

        /* éŠæˆ²å€åŸŸ */
        .game-info-card { width: 92%; max-width: 450px; background: white; border-radius: 20px; padding: 20px; margin: 15px 0; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .game-title { font-size: 1.3rem; font-weight: 900; color: #2c3e50; margin-bottom: 5px; }
        .price-tag { font-size: 0.9rem; color: #95a5a6; font-weight: bold; }
        .promo-active { color: #ff4757; animation: blink 1.2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* åˆ®åˆ®æ¨‚æ–¹æ ¼ç³»çµ± */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 94%; max-width: 450px; padding: 10px; }
        .card { aspect-ratio: 1/1; background: #ddd; border-radius: 12px; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card.sold { opacity: 0.4; cursor: default; filter: grayscale(1); }
        .card-inner { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; font-weight: bold; }
        .grade-txt { font-size: 1.2rem; color: var(--primary); }
        .prize-name { font-size: 0.6rem; color: #7f8c8d; margin-top: 2px; }
        .cover { position: absolute; inset: 0; background: linear-gradient(135deg, #bdc3c7, #95a5a6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 1.2rem; transition: 0.5s; z-index: 2; }
        .card.reveal .cover { transform: translateY(-100%); opacity: 0; }

        /* å½ˆçª—ç³»çµ± */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .m-box { background: white; padding: 35px; border-radius: 30px; width: 85%; max-width: 320px; text-align: center; }
        .win-icon { font-size: 4rem; margin-bottom: 15px; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 50px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 15px; }
        
        /* é¤˜é¡ä¸è¶³å½ˆçª—ç‰¹åŒ– */
        .no-bal-box b { color: #ff4757; font-size: 1.2rem; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <a href="index.html" class="back-btn">â® è¿”å›å•†åŸ</a>
    <div class="user-stats">
        <small style="color:#adb5bd">æ‚¨çš„é»æ•¸</small><br>
        <span class="stat-val">P <span id="uBal">0</span></span>
    </div>
</div>

<div class="game-info-card">
    <div class="game-title" id="gTitle">è¼‰å…¥ä¸­...</div>
    <div class="price-tag" id="priceDisplay">è«‹ç¨å€™...</div>
    <div id="promoMsg" style="font-size:0.75rem; margin-top:5px;"></div>
</div>

<div class="grid" id="grid"></div>

<div id="winModal" class="modal">
    <div class="m-box">
        <div class="win-icon">ğŸ</div>
        <h2 id="winGrade" style="margin:0; color:var(--primary);">æ­å–œä¸­ç</h2>
        <p id="winPrize" style="color:#7f8c8d; margin:10px 0 20px;"></p>
        <button class="btn" onclick="location.reload()">ç¹¼çºŒåˆ®ä¸‹ä¸€å¼µ</button>
    </div>
</div>

<div id="noBalModal" class="modal">
    <div class="m-box no-bal-box">
        <div style="font-size:3rem;">ğŸ’¸</div>
        <h3>é¤˜é¡ä¸è¶³</h3>
        <p>æ­¤æ¬¾éŠæˆ²ç›®å‰åƒ¹æ ¼ç‚º <b>P <span id="needP">0</span></b><br>æ‚¨ç›®å‰æŒæœ‰ P <span id="haveP">0</span></p>
        <p style="font-size:0.8rem; color:#adb5bd;">è«‹è¯ç¹«ç®¡ç†å“¡é€²è¡Œå„²å€¼</p>
        <button class="btn" onclick="document.getElementById('noBalModal').style.display='none'">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, update, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE", databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com", projectId: "dream-169dc", appId: "1:214137228622:web:84d14bad85d865ee94e21f" };
    const app = initializeApp(config); const db = getDatabase(app);
    
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id');
    const userId = localStorage.getItem('myScratchCode');

    if(!gameId || !userId) { location.href='index.html'; }

    let gData = {};
    let isProcessing = false;

    // ğŸ”’ å®‰å…¨é–å®š
    document.onkeydown = (e) => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; };

    function init() {
        // 1. ç²å–éŠæˆ²è¨­å®š (åŒ…å«å„ªæƒ è³‡è¨Š)
        onValue(ref(db, `gameSettings/${gameId}`), s => {
            gData = s.val();
            if(!gData) return;
            document.getElementById('gTitle').innerText = gameId;
            updatePriceUI();
        });

        // 2. ç›£è½ä½¿ç”¨è€…é¤˜é¡
        onValue(ref(db, `users/${userId}/balance`), s => {
            document.getElementById('uBal').innerText = (s.val() || 0).toLocaleString();
        });

        // 3. ç›£è½ç±¤æ± ç‹€æ…‹
        onValue(ref(db, `games/${gameId}/pool`), s => {
            const pool = s.val() || [];
            renderGrid(pool);
            updatePriceUI(pool);
        });
    }

    // æ›´æ–°åƒ¹æ ¼é¡¯ç¤ºé‚è¼¯ (é€£å‹•éšæ¢¯å„ªæƒ )
    function updatePriceUI(pool = []) {
        if(!gData.price) return;
        const sold = pool.filter(x => x.taken).length;
        
        // ğŸ”´ åŒæ™‚æ”¯æŒ promoCount èˆ‡ pCount (å®¹éŒ¯)
        const pCount = gData.promoCount || gData.pCount || 0;
        const pPrice = gData.promoPrice || gData.pPrice || 0;

        const priceEl = document.getElementById('priceDisplay');
        const msgEl = document.getElementById('promoMsg');

        if(pCount > 0 && sold < pCount) {
            priceEl.innerHTML = `å–®å¼µåƒ¹æ ¼ï¼š<span class="promo-active">P ${pPrice}</span> <small>(åŸåƒ¹ P${gData.price})</small>`;
            msgEl.innerHTML = `<span style="color:#ff4757; font-weight:bold;">ğŸ”¥ é–‹ç›¤å„ªæƒ ä¸­ï¼å‰©é¤˜ ${pCount - sold} å¼µå„ªæƒ åé¡</span>`;
        } else {
            priceEl.innerHTML = `å–®å¼µåƒ¹æ ¼ï¼šP ${gData.price}`;
            msgEl.innerHTML = `<span style="color:#adb5bd;">å„ªæƒ å·²çµæŸï¼Œç›®å‰ç‚ºæ­£å¸¸å”®åƒ¹</span>`;
        }
    }

    function renderGrid(pool) {
        const container = document.getElementById('grid');
        container.innerHTML = '';
        pool.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = `card ${item.taken ? 'sold' : ''}`;
            card.innerHTML = `
                <div class="card-inner">
                    <div class="grade-txt">${item.grade}</div>
                    <div class="prize-name">${item.name}</div>
                </div>
                <div class="cover">${index + 1}</div>
            `;
            if(!item.taken) {
                card.onclick = () => buy(index, item.grade, item.name);
            }
            container.appendChild(card);
        });
    }

    async function buy(idx, grade, name) {
        if(isProcessing) return;
        
        // å†æ¬¡ç¢ºèªç•¶å‰åƒ¹æ ¼
        const poolSnap = await get(ref(db, `games/${gameId}/pool`));
        const pool = poolSnap.val() || [];
        if(pool[idx].taken) return alert("é€™å¼µå‰›è¢«åˆ®èµ°å›‰ï¼");

        const sold = pool.filter(x => x.taken).length;
        const pCount = gData.promoCount || gData.pCount || 0;
        const pPrice = gData.promoPrice || gData.pPrice || 0;
        
        let finalCost = gData.price;
        if(pCount > 0 && sold < pCount) {
            finalCost = pPrice;
        }

        const uSnap = await get(ref(db, `users/${userId}/balance`));
        const curBal = uSnap.val() || 0;

        if(curBal < finalCost) {
            document.getElementById('needP').innerText = finalCost;
            document.getElementById('haveP').innerText = curBal;
            document.getElementById('noBalModal').style.display = 'flex';
            return;
        }

        if(!confirm(`ç¢ºå®šè¦èŠ±è²» P ${finalCost} åˆ®é–‹é€™å¼µå—ï¼Ÿ`)) return;

        isProcessing = true;
        try {
            // æ‰£æ¬¾èˆ‡ç´€éŒ„
            await update(ref(db, `users/${userId}`), { balance: curBal - finalCost });
            await update(ref(db, `games/${gameId}/pool/${idx}`), { taken: true, user: userId });
            await push(ref(db, `users/${userId}/logs`), {
                game: gameId,
                cost: finalCost,
                prize: `${grade}-${name}`,
                time: serverTimestamp()
            });

            // é¡¯ç¤ºå‹•ç•«
            const cards = document.querySelectorAll('.card');
            cards[idx].classList.add('reveal');
            
            setTimeout(() => {
                document.getElementById('winGrade').innerText = `æ­å–œç²å¾— ${grade} è³`;
                document.getElementById('winPrize').innerText = name;
                document.getElementById('winModal').style.display = 'flex';
                isProcessing = false;
            }, 600);

        } catch (e) {
            alert("äº¤æ˜“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
            isProcessing = false;
        }
    }

    init();
</script>
</body>
</html>
