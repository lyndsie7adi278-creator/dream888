<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å·¥å» åˆ®åˆ®æ¨‚</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --p: #ffb7c5; --a: #ff8fa3; --b: #fffcf9; --g: #ffd700; --gold-glow: rgba(255, 215, 0, 0.8); }
        * { -webkit-tap-highlight-color: transparent; user-select: none !important; -webkit-user-select: none; }
        body { font-family: sans-serif; background: var(--b); margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        
        .header { width: 100%; background: white; padding: 12px 0; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .back-btn { position: absolute; left: 15px; top: 15px; text-decoration: none; color: #888; font-size: 0.9rem; font-weight: bold; }
        .admin-trigger { position: absolute; right: 0; top: 0; width: 60px; height: 60px; background: transparent; border: none; z-index: 999; }

        /* é€²åº¦æ¢ */
        .progress-box { width: 92%; max-width: 450px; background: white; border-radius: 15px; margin: 15px 0; padding: 15px; box-sizing: border-box; border: 1px solid #eee; }
        .prog-header { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; color: #888; margin-bottom: 8px; }
        .prog-bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
        .prog-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--p), var(--a)); transition: width 0.8s ease; }

        /* ğŸ†• ä¸Šæ–¹å¤§çå±•ç¤ºå€ (ä¿®å¾©é») */
        .p_info_panel { width: 92%; max-width: 450px; background: white; border-radius: 20px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .p_main_img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
        .p_detail { padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        /* ğŸ†• ä¸­çè™Ÿç¢¼æ¨™ç±¤ (ä¿®å¾©é») */
        .win-tag { 
            display: inline-block; background: #000; border: 3px solid var(--g); 
            padding: 8px 30px; border-radius: 50px; color: var(--g); font-weight: 900; 
            font-size: 1.3rem; animation: gold-pulse 1.5s infinite alternate; 
        }
        @keyframes gold-pulse { from { box-shadow: 0 0 5px var(--gold-glow); transform: scale(1); } to { box-shadow: 0 0 20px var(--g); transform: scale(1.05); } }

        /* æ ¼å­å€ */
        .g_con { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 92%; max-width: 450px; padding: 15px; background: white; border-radius: 25px; box-shadow: 0 4px 15px rgba(255,183,197,0.2); }
        .t_s { aspect-ratio: 1/1; background: linear-gradient(135deg, var(--p), var(--a)); border-radius: 8px; cursor: pointer; border: 2px solid #fff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 3px 0 #e67e91; }
        .t_s::after { content: "ãŠ—ï¸"; }
        .t_s.so { background: #f0f0f0 !important; border-color: #ddd; box-shadow: none; }
        .t_s.so::after { content: "âœ”"; }
        
        /* ğŸ”´ ä¸»ç•«é¢è™Ÿç¢¼ï¼šçµ±ä¸€ç´…è‰²ç²—é«” */
        .t_s.rv::after { content: attr(data-num); color: #ff4757 !important; font-size: 1.3rem; font-weight: 900; }
        .t_s.so.is-win-cell { border: 2px solid var(--g) !important; box-shadow: 0 0 10px var(--gold-glow); }

        /* æ­·å²ç´€éŒ„ */
        .history-panel { width: 92%; max-width: 450px; background: white; border-radius: 15px; margin: 20px 0; padding: 15px; border: 1px solid #eee; }
        .history-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 150px; overflow-y: auto; }
        .history-item { background: #f9f9f9; padding: 8px; border-radius: 10px; font-size: 0.75rem; text-align: center; border: 1px solid #eee; }
        .history-item.win { background: #fffde7; border-color: var(--g); color: #ff4757; font-weight: bold; }

        /* å½ˆçª— */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .s_card { position: relative; width: 320px; height: 380px; background: white; border-radius: 24px; overflow: hidden; border: 6px solid #ddd; display: flex; justify-content: center; align-items: center; }
        
        /* ğŸ”´ å’ªç‰Œè™Ÿç¢¼ï¼šçµ±ä¸€ç´…è‰²è¶…å¤§ç²—é«” */
        .r_num { font-size: 8rem; font-weight: 900; color: #ff4757 !important; display: none; text-shadow: 0 4px 10px rgba(0,0,0,0.1); } 
        .res_img { width: 220px; height: 220px; object-fit: contain; display: none; margin-bottom: 10px; }
        .btn_c { display: none; margin-top: 25px; padding: 12px 60px; background: #ff4757; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <a href="index.html" class="back-btn">â¬… è¿”å›</a>
    <div class="admin-trigger" onclick="_admin_reset()"></div>
    <div style="color:var(--a); font-weight:bold; font-size:0.9rem;">éŒ¢åŒ…: $ <span id="curBal">0</span></div>
</div>

<div class="progress-box">
    <div class="prog-header"><span>SCRATCH PROGRESS</span><span><span id="drawCount">0</span> / <span id="totalDisplay">0</span></span></div>
    <div class="prog-bar-bg"><div id="progBar" class="prog-bar-fill"></div></div>
</div>

<div class="p_info_panel">
    <img id="top_prize_img" src="" class="p_main_img">
    <div class="p_detail">
        <div id="p_display_name" style="font-weight:900; margin-bottom:12px; font-size: 1.2rem; color: #333;">å•†å“è¼‰å…¥ä¸­...</div>
        <div class="win-tag" id="winNotice">ä¸­çè™Ÿç¢¼ï¼š--</div>
    </div>
</div>

<div class="g_con" id="g_d"></div>

<div class="history-panel">
    <div style="font-weight:bold; margin-bottom:10px; font-size: 0.9rem; color: #555;">ğŸ“Š å¯¦æ™‚ç´€éŒ„</div>
    <div class="history-grid" id="history_grid"></div>
</div>

<div id="ovl" class="overlay">
    <div class="s_card" id="c_con">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div id="w_t" class="r_num"></div>
            <img id="res_img" class="res_img" src="">
            <div id="res_msg" style="font-size:1.8rem; font-weight:900; color:#ff4757; margin-top:5px; display:none;"></div>
        </div>
    </div>
    <button class="btn_c" id="c_btn" onclick="_cl_ov()">é ˜å–çµæœ</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, runTransaction, onValue, set, get, push, query, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE",
        databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com",
        projectId: "dream-169dc",
        appId: "1:214137228622:web:84d14bad85d865ee94e21f" 
    };
    const app = initializeApp(config);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const gid = urlParams.get('id'), total = parseInt(urlParams.get('total')) || 50, 
          winGoal = parseInt(urlParams.get('win')), prizeImg = decodeURIComponent(urlParams.get('img')),
          myCode = localStorage.getItem('myScratchCode');

    const _p_ref = ref(db, `games/${gid}/pool`), _h_ref = ref(db, `games/${gid}/history`);
    let _is_p = false, _sel_i = null, _cvs, _ctx, _is_d = false, _drawn_nums = new Set();

    window.onload = () => {
        if(!myCode) return location.href = 'index.html';
        document.getElementById('totalDisplay').innerText = total;
        // ç§»é™¤ gid ä¸­çš„ä»£ç¢¼æ„Ÿï¼Œé¡¯ç¤ºä¹¾æ·¨åç¨±
        document.getElementById('p_display_name').innerText = gid.replace(/_/g, ' ');
        document.getElementById('top_prize_img').src = prizeImg;
        document.getElementById('winNotice').innerText = `âœ¨ ä¸­çè™Ÿç¢¼ï¼š${winGoal.toString().padStart(2,'0')}`;
        
        onValue(ref(db, `users/${myCode}/balance`), s => {
            const b = s.val() || 0;
            document.getElementById('curBal').innerText = b.toLocaleString();
        });
        _listen_history();
        _init_pool();
    };

    function _listen_history() {
        onValue(query(_h_ref, limitToLast(15)), s => {
            const d = s.val(); let html = ''; _drawn_nums.clear();
            if(d) Object.values(d).reverse().forEach(item => {
                _drawn_nums.add(parseInt(item.g));
                html += `<div class="history-item ${item.w?'win':''}"><b>${item.g.toString().padStart(2,'0')}</b><br>${item.w?'ä¸­ç':'æœªä¸­'}</div>`;
            });
            document.getElementById('history_grid').innerHTML = html || 'æš«ç„¡ç´€éŒ„';
        });
    }

    async function _init_pool() {
        onValue(_p_ref, s => {
            const d = s.val(); if(!d) return;
            const drawn = d.filter(x => x.taken).length;
            document.getElementById('drawCount').innerText = drawn;
            document.getElementById('progBar').style.width = (drawn / total * 100) + "%";
            document.getElementById('g_d').innerHTML = d.map((x, i) => {
                const is_settled = x.taken && _drawn_nums.has(parseInt(x.grade)) && (i !== _sel_i);
                const num = is_settled ? x.grade.toString().padStart(2,'0') : '';
                return `<div class="t_s ${x.taken?'so':''} ${is_settled?'rv':''} ${is_settled && parseInt(x.grade)===winGoal?'is-win-cell':''}" 
                             data-num="${num}" onclick="_h_ck(${i},${x.taken})"></div>`;
            }).join('');
        });
    }

    window._h_ck = async (i, tk) => {
        if(tk || _is_p) return; _is_p = true; _sel_i = i;
        const balSnap = await get(ref(db, `users/${myCode}/balance`));
        if((balSnap.val()||0) < 100) { alert("é¤˜é¡ä¸è¶³"); _is_p = false; return; }
        
        runTransaction(_p_ref, (p) => {
            if (!p) return p;
            window._l_w = p[i].grade; p[i].taken = true; return p;
        }).then(res => {
            if(res.committed) {
                runTransaction(ref(db, `users/${myCode}/balance`), b => b - 100);
                push(_h_ref, { u: myCode, g: window._l_w, w: window._l_w === winGoal, t: Date.now() });
                _pp_s();
            } else _is_p = false;
        });
    };

    function _pp_s() {
        const w_t = document.getElementById('w_t');
        w_t.innerText = ""; w_t.style.display = 'none';
        document.getElementById('res_img').style.display = 'none';
        document.getElementById('res_msg').style.display = 'none';
        document.getElementById('ovl').style.display = 'flex';
        const c = document.getElementById('c_con'); const o = c.querySelector('canvas'); if(o) o.remove();
        const n = document.createElement('canvas'); n.width = 320; n.height = 380; 
        n.style.position = 'absolute'; n.style.zIndex = '10'; c.appendChild(n);
        _cvs = n; _ctx = n.getContext('2d');
        _ctx.fillStyle = '#C0C0C0'; _ctx.fillRect(0, 0, 320, 380);
        _ctx.font = "bold 24px sans-serif"; _ctx.fillStyle = "#888"; _ctx.textAlign = "center"; _ctx.fillText("æ‰‹å‹•åˆ®é–‹çœ‹è™Ÿç¢¼", 160, 190);
        _cvs.onmousedown = _sS; _cvs.ontouchstart = _sS;
        window.onmousemove = _sM; window.ontouchmove = _sM; window.onmouseup = _sE; window.ontouchend = _sE;
    }

    function _sS(e) { _is_d = true; _sM(e); }
    function _sE() { if(_is_d) { _is_d = false; _ck_s(); } }
    function _sM(e) {
        if(!_is_d) return; if(e.cancelable) e.preventDefault();
        const w_t = document.getElementById('w_t');
        if(w_t.innerText === "") {
            w_t.innerText = window._l_w.toString().padStart(2, '0');
            w_t.style.display = "block";
            w_t.style.opacity = "1";
        }
        const r = _cvs.getBoundingClientRect();
        const x = (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - r.left, y = (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - r.top;
        _ctx.globalCompositeOperation = 'destination-out';
        _ctx.beginPath(); _ctx.arc(x, y, 35, 0, Math.PI*2); _ctx.fill();
    }

    function _ck_s() {
        const d = _ctx.getImageData(0, 0, 320, 380).data;
        let c = 0; for (let i=3; i<d.length; i+=4) if(d[i]===0) c++;
        if (c > (d.length/4)*0.4) {
            _cvs.style.display = 'none';
            const num = window._l_w, w_t = document.getElementById('w_t'), 
                  res_img = document.getElementById('res_img'), res_msg = document.getElementById('res_msg');
            w_t.style.fontSize = "5.5rem";
            if(num === winGoal) {
                res_img.src = prizeImg; res_img.style.display = 'block';
                res_msg.innerText = "ğŸŠ æ­å–œæŠ½ä¸­å¤§ç ğŸŠ"; res_msg.style.display = 'block';
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            } else {
                res_img.src = "https://i.ibb.co/7t4gt23K/image.png"; 
                res_img.style.display = 'block';
                res_msg.innerText = "å†æ¥å†å²ï¼"; res_msg.style.display = 'block';
            }
            document.getElementById('c_btn').style.display = 'block';
        }
    }

    window._cl_ov = () => { _is_p = false; document.getElementById('ovl').style.display = 'none'; };
    window._admin_reset = () => { const p = prompt("ADMIN:"); if(p === "0000") { let n = []; for(let i=1; i<=total; i++) n.push(i); n.sort(() => Math.random() - 0.5); set(_p_ref, n.map(v => ({ grade: v, taken: false }))); remove(_h_ref); alert("æ´—ç‰Œå®Œæˆ"); } };
</script>
</body>
</html>

