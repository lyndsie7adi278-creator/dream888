<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ®åˆ®æ¨‚ - <span id="p_display_name_header"></span></title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary: #ff8fa3; /* ä¸»è‰²èª¿ç²‰ */
            --dark: #2c3e50; /* æ·±è‰²æ–‡å­— */
            --gold: #d4a017; /* é‡‘è‰² */
            --bg: #f8f9fa; /* èƒŒæ™¯æ·ºç° */
            --card-bg: white;
            --shadow: rgba(0,0,0,0.05);
            --border-light: #eee;
        }
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: var(--bg); margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center;
            color: var(--dark);
            user-select: none;
        }
        
        /* é ‚éƒ¨å°èˆª */
        .header { 
            width: 100%; background: var(--card-bg); padding: 15px 0; 
            text-align: center; box-shadow: 0 4px 12px var(--shadow); 
            position: sticky; top: 0; z-index: 100; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .back-btn { 
            position: absolute; left: 15px; color: #888; text-decoration: none; 
            font-size: 0.9rem; padding: 5px 10px; border-radius: 8px;
            transition: background 0.2s;
        }
        .back-btn:hover { background: #f0f0f0; }

        /* ğŸ”´ çµ•å°éš±å½¢çš„ç®¡ç†å“¡è§¸ç™¼å€ */
        .admin-trigger { 
            position: absolute; right: 0; top: 0; 
            width: 50px; height: 50px; 
            background: transparent; border: none; 
            z-index: 999; cursor: default;
        }
        .balance-display { 
            color: var(--primary); font-weight: bold; font-size: 0.9rem; 
            margin-left: auto; margin-right: 15px; /* æ¨åˆ°å³é‚Š */
        }
        .header-title { 
            font-weight: 900; color: var(--dark); font-size: 1.1rem; 
            position: absolute; left: 50%; transform: translateX(-50%);
        }

        /* é€²åº¦æ¢ */
        .progress-box { 
            width: 92%; max-width: 450px; background: var(--card-bg); 
            border-radius: 15px; margin: 15px 0 10px 0; padding: 15px; 
            box-sizing: border-box; border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .prog-text { 
            display: flex; justify-content: space-between; font-weight: bold; 
            font-size: 0.9rem; margin-bottom: 8px; color: #555; 
        }
        .prog-bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
        .prog-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ffb7c5, var(--primary)); transition: width 0.5s ease; }

        /* å•†å“è³‡è¨Šé¢æ¿ */
        .p_info_panel { 
            width: 92%; max-width: 450px; background: var(--card-bg); 
            border-radius: 20px; margin-bottom: 15px; overflow: hidden; 
            box-shadow: 0 5px 15px var(--shadow); border: 1px solid var(--border-light); 
        }
        .p_main_img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #eee; }
        .p_detail { padding: 15px; text-align: center; }
        .prize-label { font-weight: bold; margin-bottom: 8px; font-size: 1.2rem; color: #333; }
        .win-tag { 
            display: inline-block; background: #fff9e6; border: 2px solid var(--gold); 
            padding: 8px 25px; border-radius: 50px; color: var(--gold); font-weight: 900; 
            font-size: 1.1rem; animation: gold-glow 2s infinite alternate;
        }
        @keyframes gold-glow { from { box-shadow: 0 0 5px rgba(255, 215, 0, 0.4); } to { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); } }

        /* åˆ®åˆ®æ¨‚æ ¼å­ */
        .g_con { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; 
            width: 92%; max-width: 450px; padding: 15px; background: var(--card-bg); 
            border-radius: 25px; box-shadow: 0 5px 15px var(--shadow); 
        }
        .t_s { 
            aspect-ratio: 1/1; background: linear-gradient(135deg, #ffb7c5, var(--primary)); 
            border-radius: 8px; cursor: pointer; border: 2px solid var(--card-bg); 
            color: white; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; box-shadow: 0 3px 0 #e67e91; font-size: 1.2rem;
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
        }
        .t_s:active { transform: translateY(2px); box-shadow: 0 1px 0 #e67e91; }
        .t_s::after { content: "æŠ½"; }
        .t_s.so { background: #e8e8e8 !important; border-color: #ccc; color: #bbb; box-shadow: none; cursor: default; }
        .t_s.so::after { content: "âœ”"; }
        .t_s.rv { font-size: 1.1rem; color: #ccc; background: #f9f9f9 !important; border: 1px solid #eee; box-shadow: none; cursor: default; }
        .t_s.rv::after { content: attr(data-val); }
        .t_s.rv.is-winner { 
            color: var(--gold) !important; background: #fff3cd !important; 
            border: 2px solid var(--gold) !important; font-weight: 900 !important; 
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        /* å’ªç‰Œå½ˆçª— */
        .overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; 
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .s_card { 
            position: relative; width: 320px; height: 380px; background: var(--card-bg); 
            border-radius: 24px; overflow: hidden; border: 6px solid #ddd; 
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3); transition: border-color 0.4s ease-in-out;
        }
        .s_res { 
            position: absolute; width: 100%; height: 100%; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        .r_num { font-size: 8rem; font-weight: 900; color: #333; transition: all 0.4s ease-in-out; }
        .res_img { 
            width: 180px; height: 180px; object-fit: contain; margin-bottom: 10px; 
            display: none; opacity: 0; transition: opacity 0.5s ease-in-out;
        }
        .res_msg { font-size: 1.5rem; font-weight: bold; margin-top: 5px; display: none; }
        .btn_c { 
            display: none; margin-top: 25px; padding: 12px 60px; background: #ff4757; 
            color: white; border: none; border-radius: 50px; font-weight: bold; 
            font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(255,71,87,0.4);
            transition: transform 0.2s;
        }
        .btn_c:active { transform: translateY(2px); box-shadow: 0 2px 8px rgba(255,71,87,0.4); }


        /* ğŸ†• æ­·å²ç´€éŒ„å€å¡Š */
        .history-panel {
            width: 92%; max-width: 450px; background: var(--card-bg);
            border-radius: 15px; margin: 20px 0 40px 0; padding: 20px;
            box-sizing: border-box; border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .history-header {
            font-weight: bold; font-size: 1.1rem; margin-bottom: 15px;
            display: flex; align-items: center; color: var(--dark);
        }
        .history-header::before { content: "ğŸ“Š"; margin-right: 8px; }

        .history-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); /* é¡¯ç¤ºæ™‚é–“ã€ç±¤è™Ÿã€çµæœ */
            gap: 10px; max-height: 250px; overflow-y: auto;
            padding-right: 10px; /* ç•™çµ¦æ²è»¸ç©ºé–“ */
        }
        .history-item {
            background: #f9f9f9; padding: 10px; border-radius: 10px;
            font-size: 0.8rem; text-align: center; color: #555;
            display: flex; flex-direction: column; justify-content: center;
            border: 1px solid #eee;
        }
        .history-item.win { background: #fffde7; border-color: var(--gold); color: var(--gold); font-weight: bold; }
        .history-item.loss { background: #f0f0f0; border-color: #ddd; color: #888; }
        .history-time { font-size: 0.7rem; color: #aaa; margin-bottom: 3px; }
        .history-val { font-size: 1.1rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <a href="index.html" class="back-btn">â¬… è¿”å›</a>
    <span class="header-title" id="p_display_name_header">å•†å“åˆ®åˆ®æ¨‚</span>
    <div class="admin-trigger" onclick="_admin_reset()"></div>
    <div class="balance-display">éŒ¢åŒ…: $ <span id="curBal">0</span></div>
</div>

<div class="progress-box">
    <div class="prog-text"><span>å·²åˆ® <span id="drawCount">0</span> æŠ½</span><span>å‰©é¤˜ <span id="remainCount">0</span> æŠ½</span></div>
    <div class="prog-bar-bg"><div id="progBar" class="prog-bar-fill"></div></div>
</div>

<div class="p_info_panel">
    <img id="top_prize_img" src="" class="p_main_img">
    <div class="p_detail">
        <div id="p_display_name" class="prize-label">è¼‰å…¥ä¸­...</div>
        <div class="win-tag" id="winNotice">ä¸­çè™Ÿç¢¼ï¼š--</div>
    </div>
</div>

<div class="g_con" id="g_d"></div>

<div class="history-panel">
    <div class="history-header">è¿‘æœŸåˆ®çç´€éŒ„</div>
    <div class="history-grid" id="history_grid">
        <div class="history-item loss">
            <span class="history-time">12:30</span>
            <span class="history-val">05</span>
            <span>æ²’ä¸­</span>
        </div>
         <div class="history-item win">
            <span class="history-time">12:28</span>
            <span class="history-val">01</span>
            <span>ä¸­çï¼</span>
        </div>
    </div>
</div>

<div class="overlay" id="ovl">
    <div class="s_card" id="c_con">
        <div class="s_res">
            <div id="w_t" class="r_num">?</div>
            <img id="res_img" class="res_img" src="">
            <div id="res_msg" class="res_msg"></div>
        </div>
    </div>
    <button class="btn_c" id="c_btn" onclick="_cl_ov()">é ˜å–ä¸¦ç¹¼çºŒ</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, runTransaction, onValue, set, get, push, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ğŸ”´ è«‹å¡«å…¥æ‚¨çš„ Firebase é…ç½®
    const config = { 
  apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE",
  authDomain: "dream-169dc.firebaseapp.com",
  databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com",
  projectId: "dream-169dc",
  storageBucket: "dream-169dc.firebasestorage.app",
  messagingSenderId: "214137228622",
  appId: "1:214137228622:web:84d14bad85d865ee94e21f",
  measurementId: "G-7YD4VSW7CZ"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const gid = urlParams.get('id'), price = parseInt(urlParams.get('price')), total = parseInt(urlParams.get('total')), 
          safe = parseInt(urlParams.get('safe')), winGoal = parseInt(urlParams.get('win')), 
          prizeImg = decodeURIComponent(urlParams.get('img')), myCode = localStorage.getItem('myScratchCode');

    const _p_ref = ref(db, `games/${gid}/pool`);
    const _gh_ref = ref(db, `games/${gid}/god_hand`);
    const _history_ref = ref(db, `games/${gid}/history`); // ğŸ†• æ­·å²ç´€éŒ„åƒè€ƒ

    let _is_p = false, _sel_i = null, _cvs, _ctx, _is_d = false;

    window.onload = () => {
        if(!myCode) return location.href = 'index.html';
        document.getElementById('p_display_name').innerText = gid;
        document.getElementById('p_display_name_header').innerText = gid; /* ğŸ†• æ¨™é¡Œä¹Ÿé¡¯ç¤ºå•†å“å */
        document.getElementById('top_prize_img').src = prizeImg;
        document.getElementById('winNotice').innerText = `âœ¨ ä¸­çè™Ÿç¢¼ï¼š${winGoal.toString().padStart(2,'0')}`;
        onValue(ref(db, `users/${myCode}/balance`), s => document.getElementById('curBal').innerText = (s.val()||0).toLocaleString());
        _init_pool();
        _listen_history(); // ğŸ†• ç›£è½æ­·å²ç´€éŒ„
    };

    async function _init_pool() {
        const s = await get(_p_ref); if(!s.exists()) _reset_game();
        onValue(_p_ref, s => {
            const d = s.val(); if(!d) return;
            const drawn = d.filter(x => x.taken).length;
            document.getElementById('drawCount').innerText = drawn;
            document.getElementById('remainCount').innerText = total - drawn;
            document.getElementById('progBar').style.width = (drawn / total * 100) + "%";
            document.getElementById('g_d').innerHTML = d.map((x, i) => {
                const isW = (parseInt(x.grade) === winGoal), rv = x.taken && (i !== _sel_i);
                return `<div class="t_s ${x.taken?'so':''} ${rv?'rv':''} ${rv && isW?'is-winner':''}" data-val="${x.grade.toString().padStart(2,'0')}" onclick="_h_ck(${i},${x.taken})"></div>`;
            }).join('');
        });
    }

    window._h_ck = async (i, tk) => {
        if(tk || _is_p) return; _is_p = true; _sel_i = i;
        const balSnap = await get(ref(db, `users/${myCode}/balance`));
        if((balSnap.val()||0) < price) { alert("é¤˜é¡ä¸è¶³ï¼"); _is_p = false; return; }
        
        const ghSnap = await get(_gh_ref); let target = ghSnap.val();
        runTransaction(_p_ref, (p) => {
            if(!p) return p;
            let win = p[i].grade; const drawn = p.filter(x => x.taken).length;
            if(target) {
                let pos = p.findIndex(x => x.grade == target && !x.taken);
                if(pos!=-1) [p[i].grade, p[pos].grade] = [p[pos].grade, p[i].grade], win = target;
                set(_gh_ref, null);
            } else if (drawn < safe && win == winGoal) {
                let safePos = p.findIndex(x => !x.taken && x.grade != winGoal);
                if(safePos!=-1) [p[i].grade, p[safePos].grade] = [p[safePos].grade, p[i].grade], win = p[i].grade;
            }
            p[i].taken = true; window._l_w = win; return p;
        }).then(res => {
            if(res.committed) {
                runTransaction(ref(db, `users/${myCode}/balance`), b => b - price);
                _record_history(window._l_w === winGoal, window._l_w); // ğŸ†• è¨˜éŒ„æ­·å²
                _pp_s();
            } else _is_p = false;
        });
    };

    // ğŸ†• è¨˜éŒ„åˆ®çæ­·å²
    function _record_history(isWin, resultNum) {
        const now = new Date();
        push(_history_ref, {
            user: myCode,
            isWin: isWin,
            result: resultNum,
            timestamp: now.getTime()
        });
    }

    // ğŸ†• ç›£è½æ­·å²ç´€éŒ„ä¸¦æ›´æ–°ä»‹é¢
    function _listen_history() {
        const historyGrid = document.getElementById('history_grid');
        onValue(query(_history_ref, limitToLast(12)), (snapshot) => { // é¡¯ç¤ºæœ€è¿‘ 12 ç­†
            const historyData = snapshot.val();
            let html = '';
            if (historyData) {
                const sortedHistory = Object.values(historyData).sort((a, b) => a.timestamp - b.timestamp);
                sortedHistory.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
                    const resultText = item.isWin ? 'ä¸­çï¼' : 'æ²’ä¸­';
                    const itemClass = item.isWin ? 'win' : 'loss';
                    html += `
                        <div class="history-item ${itemClass}">
                            <span class="history-time">${time}</span>
                            <span class="history-val">${item.result.toString().padStart(2,'0')}</span>
                            <span>${resultText}</span>
                        </div>
                    `;
                });
            } else {
                html = '<div style="grid-column: 1 / -1; text-align: center; color: #bbb; padding: 20px;">å°šç„¡åˆ®çç´€éŒ„</div>';
            }
            historyGrid.innerHTML = html;
            historyGrid.scrollTop = historyGrid.scrollHeight; // æ²å‹•åˆ°æœ€æ–°ç´€éŒ„
        });
    }

    function _pp_s() {
        const num = window._l_w, w_t = document.getElementById('w_t'), res_img = document.getElementById('res_img'),
              res_msg = document.getElementById('res_msg'), s_card = document.querySelector('.s_card');

        w_t.innerText = num.toString().padStart(2, '0');
        w_t.style.display = 'block'; w_t.style.fontSize = '8rem'; w_t.style.color = '#333';
        res_img.style.display = 'none'; res_msg.style.display = 'none';
        s_card.style.borderColor = '#ddd';

        document.getElementById('ovl').style.display = 'flex';
        const c = document.getElementById('c_con'); const o = c.querySelector('canvas'); if(o) o.remove();
        const n = document.createElement('canvas'); n.width = 320; n.height = 380; 
        n.style.position = 'absolute'; n.style.top = '0'; n.style.left = '0'; n.style.zIndex = '10';
        c.appendChild(n); _cvs = n; _ctx = n.getContext('2d');
        _ctx.fillStyle = '#C0C0C0'; _ctx.fillRect(0,0,320,380);
        _ctx.font = "bold 22px sans-serif"; _ctx.fillStyle = "#888"; _ctx.textAlign = "center"; _ctx.textBaseline = "middle";
        _ctx.fillText("å‹•æ‰‹åˆ®é–‹çœ‹è™Ÿç¢¼", 160, 190);
        
        _cvs.onmousedown = _sS; _cvs.ontouchstart = _sS;
        window.onmousemove = _sM; window.ontouchmove = _sM; 
        window.onmouseup = _sE; window.ontouchend = _sE;
    }

    function _sS(e) { _is_d = true; _sM(e); }
    function _sE() { if(_is_d) { _is_d = false; _ck_s(); } }
    function _sM(e) {
        if(!_is_d) return; if(e.cancelable) e.preventDefault();
        const r = _cvs.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - r.left, y = (e.clientY || e.touches[0].clientY) - r.top;
        _ctx.globalCompositeOperation = 'destination-out';
        _ctx.beginPath(); _ctx.arc(x, y, 35, 0, Math.PI*2); _ctx.fill();
    }

    function _ck_s() {
        const d = _ctx.getImageData(0,0,320,380).data;
        let c = 0; for(let i=3; i<d.length; i+=4) if(d[i]==0) c++;
        if(c > (d.length/4)*0.45) { 
            _cvs.style.display = 'none';
            _show_final_result();
        }
    }

    function _show_final_result() {
        const num = window._l_w, w_t = document.getElementById('w_t'), res_img = document.getElementById('res_img'),
              res_msg = document.getElementById('res_msg'), s_card = document.querySelector('.s_card');

        if(num === winGoal) {
            s_card.style.borderColor = 'var(--gold)';
            w_t.style.fontSize = '4rem'; w_t.style.color = '#ff4757';
            res_img.src = prizeImg; res_img.style.display = 'block';
            res_msg.innerText = "â­ æ­å–œä¸­ç â­"; res_msg.style.color = "var(--gold)";
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else {
            w_t.style.fontSize = '4rem'; w_t.style.color = '#aaa';
            res_img.src = "https://i.ibb.co/7t4gt23K/image.png"; 
            res_img.style.display = 'block';
            res_msg.innerText = "å†æ¥å†å²å”·ï¼"; res_msg.style.color = "#888";
        }
        res_msg.style.display = 'block';
        document.getElementById('c_btn').style.display = 'block';
    }

    // ğŸ”´ å”¯ä¸€ç®¡ç†å“¡é‡ç½®å…¥å£ (å³ä¸Šè§’éš±å½¢æŒ‰éˆ•)
    window._admin_reset = () => {
        const pw = prompt("ç®¡ç†å“¡èº«ä»½é©—è­‰ï¼š");
        if(pw === "0000") { // æ‚¨å¯ä»¥åœ¨æ­¤ä¿®æ”¹å¯†ç¢¼
            if(confirm("ç¢ºå®šè¦æ•´ç›¤é‡ç½®æ´—ç‰Œå—ï¼Ÿæ­¤æ“ä½œå°‡æ¸…ç©ºæ‰€æœ‰åˆ®çç´€éŒ„ï¼")) { 
                _reset_game(); alert("æ´—ç‰Œå®Œæˆï¼"); 
            }
        }
    };

    function _reset_game() {
        let n = []; for(let i=1; i<=total; i++) n.push(i);
        n.sort(() => Math.random() - 0.5);
        set(_p_ref, n.map(v => ({ grade: v, taken: false })));
        set(_history_ref, null); // ğŸ†• é‡ç½®æ™‚æ¸…ç©ºæ­·å²ç´€éŒ„
    }
    window._cl_ov = () => { _is_p = false; document.getElementById('ovl').style.display = 'none'; document.getElementById('c_btn').style.display = 'none'; };
</script>
</body>
</html>

