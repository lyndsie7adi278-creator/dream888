<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>å¤¢å·¥å»  | æœƒå“¡ä¸­å¿ƒ</title>
<style>
    :root { --p: #ffb800; --bg: #05070a; --card: #11141b; --win: #ffd700; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; padding-bottom: 50px; }
    .header { padding: 20px; background: #000; border-bottom: 1px solid rgba(255,184,0,0.3); display: flex; align-items: center; gap: 15px; }
    .back-btn { background: none; border: 1px solid var(--p); color: var(--p); padding: 5px 15px; border-radius: 50px; cursor: pointer; text-decoration: none; font-size: 0.8rem; }
    
    .user-info { padding: 25px 20px; background: linear-gradient(180deg, #000, var(--card)); text-align: center; }
    .uid-tag { font-size: 0.8rem; color: #888; margin-bottom: 8px; }
    .balance-val { font-size: 2.5rem; font-weight: 900; color: var(--p); }

    .section-title { padding: 15px 20px; font-size: 1.1rem; font-weight: 900; color: var(--p); border-left: 4px solid var(--p); margin: 20px 0 10px; background: rgba(255,184,0,0.05); }
    
    .win-item { background: var(--card); margin: 10px 15px; padding: 15px; border-radius: 15px; border: 1px solid #222; position: relative; }
    .win-time { font-size: 0.75rem; color: #666; margin-bottom: 8px; }
    .win-name { font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
    
    /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
    .status-box { display: flex; flex-direction: column; gap: 8px; padding-top: 10px; border-top: 1px dashed #333; }
    .status-row { display: flex; justify-content: space-between; align-items: center; }
    .status-tag { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    .status-pending { background: #555; color: #ccc; }    /* å¾…è™•ç† */
    .status-shipping { background: #2980b9; color: #fff; } /* å‡ºè²¨ä¸­ */
    .status-delivered { background: #27ae60; color: #fff; } /* å·²é€é” */
    
    .shipping-no { font-family: monospace; color: var(--p); background: rgba(255,184,0,0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }
    .copy-btn { font-size: 0.7rem; color: #aaa; text-decoration: underline; cursor: pointer; }

    .empty-msg { text-align: center; padding: 40px; color: #444; }
</style>
</head>
<body>

<div class="header">
    <a href="index.html" class="back-btn">â† å›é¦–é </a>
    <div style="font-weight:900;">æœƒå“¡ä¸­å¿ƒ</div>
</div>

<div class="user-info">
    <div class="uid-tag">æœƒå“¡ ID: <span id="displayUid">------</span></div>
    <div style="color:#aaa; font-size:0.9rem;">ç›®å‰é¤˜é¡</div>
    <div class="balance-val"><span id="uBal">0</span> <small style="font-size:1rem;">P</small></div>
</div>

<div class="section-title">ğŸ† æˆ‘çš„ä¸­çå­˜æ ¹</div>
<div id="winList">
    <div class="empty-msg">è¼‰å…¥ä¸­...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = { 
    apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco", 
    databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com", 
    projectId: "dream8-7b161", 
    appId: "1:606218522479:web:2737643db3de735af7e29a" 
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const uid = localStorage.getItem('myScratchCode');

if(!uid) location.href = 'index.html';
document.getElementById('displayUid').innerText = uid;

// ç›£è½é¤˜é¡
onValue(ref(db, `users/${uid}/balance`), s => {
    document.getElementById('uBal').innerText = (s.val() || 0).toLocaleString();
});

// ç›£è½ä¸­çç´€éŒ„
onValue(ref(db, `winLogs`), snap => {
    const list = document.getElementById('winList');
    const data = snap.val();
    if(!data) {
        list.innerHTML = '<div class="empty-msg">å°šç„¡ä¸­çç´€éŒ„</div>';
        return;
    }

    // ç¯©é¸å‡ºå±¬æ–¼è©²ç”¨æˆ¶çš„ç´€éŒ„ä¸¦æ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
    const myWins = Object.keys(data)
        .map(key => ({ id: key, ...data[key] }))
        .filter(item => item.user === uid)
        .sort((a, b) => b.time - a.time);

    if(myWins.length === 0) {
        list.innerHTML = '<div class="empty-msg">å°šç„¡ä¸­çç´€éŒ„</div>';
        return;
    }

    list.innerHTML = myWins.map(item => {
        const date = new Date(item.time).toLocaleString();
        // ç‹€æ…‹æ–‡å­—è™•ç†
        let statusClass = "status-pending";
        let statusText = item.status || "å¾…è™•ç†";
        if(statusText === "å‡ºè²¨ä¸­") statusClass = "status-shipping";
        if(statusText === "å·²å®Œæˆ") statusClass = "status-delivered";

        const shippingNo = item.shippingNo || "å°šæœªå¡«å¯«";

        return `
            <div class="win-item">
                <div class="win-time">${date}</div>
                <div class="win-name">${item.prize}</div>
                <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">ä¾†è‡ªéŠæˆ²ï¼š${item.game}</div>
                
                <div class="status-box">
                    <div class="status-row">
                        <span style="font-size:0.85rem; color:#aaa;">ç‰©æµç‹€æ…‹</span>
                        <span class="status-tag ${statusClass}">${statusText}</span>
                    </div>
                    <div class="status-row">
                        <span style="font-size:0.85rem; color:#aaa;">äº¤è²¨ä¾¿ç·¨è™Ÿ</span>
                        <div>
                            <span class="shipping-no" id="no_${item.id}">${shippingNo}</span>
                            ${item.shippingNo ? `<span class="copy-btn" onclick="copyNo('${item.id}')">è¤‡è£½</span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
});

// è¤‡è£½åŠŸèƒ½
window.copyNo = (id) => {
    const text = document.getElementById('no_' + id).innerText;
    navigator.clipboard.writeText(text).then(() => alert('ç·¨è™Ÿå·²è¤‡è£½: ' + text));
};
</script>
</body>
</html>
