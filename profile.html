<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <title>å¤¢å·¥å»  | æœƒå“¡ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId && refId.trim() !== "") {
                localStorage.setItem('pending_ref', refId.trim());
            }
        })();
        window.forceApplyRef = function() {
            const savedRef = localStorage.getItem('pending_ref');
            const refEl = document.getElementById('refIn');
            if (savedRef && refEl) { refEl.value = savedRef; }
        };
    </script>
    
    <style>
        :root { --primary: #ff8fa3; --bg: #f8f9fb; --gold: #ffb800; --text: #2c3e50; --success: #2ecc71; --wait: #f1c40f; --alliance: #6c5ce7; --danger: #ff4757; --line: #06c755; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none !important; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'PingFang TC', sans-serif; display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }
        
        .header { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; background: #fff; box-shadow: 0 1px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: none; border: 1.5px solid var(--primary); color: var(--primary); padding: 5px 18px; border-radius: 50px; cursor: pointer; text-decoration: none; font-size: 0.8rem; font-weight: 900; }
        .logout-btn { background: #f0f2f5; color: #999; padding: 5px 15px; border-radius: 50px; font-size: 0.75rem; font-weight: bold; cursor: pointer; border: none; }

        .user-panel { 
            padding: 50px 20px 60px; 
            background: linear-gradient(135deg, #ff8fa3 0%, #ffb1bf 100%); 
            text-align: center; color: #fff; position: relative; 
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 10px 30px rgba(255,143,163,0.3);
        }
        
        .avatar-wrap { position: relative; width: 95px; height: 95px; margin: 0 auto 15px; }
        .avatar { width: 100%; height: 100%; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: var(--primary); font-weight: 900; box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 4px solid rgba(255,255,255,0.4); }
        .nickname-box { font-size: 1.4rem; font-weight: 900; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .uid-tag { font-size: 0.7rem; color: #fff; letter-spacing: 1px; background: rgba(0,0,0,0.1); padding: 4px 14px; border-radius: 50px; display: inline-block; margin-top: 5px; backdrop-filter: blur(5px); cursor: pointer; }

        .balance-card { 
            margin: 25px auto -85px; background: rgba(255,255,255,0.95); 
            width: 88%; padding: 20px; border-radius: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); position: relative; z-index: 5;
        }
        .balance-label { font-size: 0.75rem; color: #999; font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .balance-amount { font-size: 2rem; font-weight: 900; color: #333; margin-bottom: 15px; text-align: left; }
        .balance-amount span { color: var(--gold); }
        
        .commission-tag { font-size: 0.7rem; background: #eee; color: #666; padding: 2px 8px; border-radius: 5px; }
        .commission-tag b { color: var(--alliance); }

        .deposit-btn { background: var(--primary); color: #fff; border: none; width: 100%; padding: 12px; border-radius: 15px; font-size: 1rem; font-weight: 900; cursor: pointer; box-shadow: 0 5px 15px rgba(255,143,163,0.3); transition: 0.3s; }

        .tabs { display: flex; background: rgba(248, 249, 251, 0.95); backdrop-filter: blur(5px); margin-top: 90px; padding: 5px 10px; position: sticky; top: 58px; z-index: 10; gap: 5px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab-btn { flex: 0 0 auto; padding: 12px 15px; text-align: center; font-size: 0.85rem; font-weight: 900; color: #bbb; cursor: pointer; position: relative; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ""; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--primary); border-radius: 10px; }

        .content-area { flex-grow: 1; padding: 10px 15px 100px; max-width: 500px; margin: 0 auto; width: 100%; }
        .page-content { display: none; animation: fadeIn 0.4s ease; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Assets Grid */
        .assets-grid { display: grid; grid-template-columns: 1fr; margin: 120px auto 0; width: 88%; max-width: 500px; }
        .asset-box { background: #fff; border-radius: 20px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .asset-label { font-size: 0.9rem; font-weight: bold; color: #555; display: flex; align-items: center; gap: 8px; }
        .asset-val { font-size: 1.2rem; font-weight: 900; color: var(--line); }

        /* Energy Section */
        .energy-section { margin: 15px auto; width: 88%; max-width: 500px; background: linear-gradient(145deg, #1a1e26, #000); border-radius: 20px; padding: 20px; border: 1px solid #333; position: relative; overflow: hidden; color: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .energy-title { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; font-weight: bold; }
        .energy-bar-bg { width: 100%; height: 14px; background: #222; border-radius: 50px; border: 1px solid #444; overflow: hidden; position: relative; }
        .energy-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff4757, #ff6b6b); box-shadow: 0 0 15px rgba(255, 71, 87, 0.6); transition: width 0.5s ease; border-radius: 50px; }
        .energy-text { font-size: 0.75rem; color: #aaa; margin-top: 8px; text-align: center; }
        
        .claim-btn { display: none; width: 100%; padding: 12px; background: linear-gradient(90deg, #ff9f43, #ff6b6b); color: #fff; border: none; border-radius: 50px; font-weight: 900; margin-top: 15px; font-size: 1rem; cursor: pointer; animation: pulse 1.5s infinite; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }

        /* ğŸŸ¢ çˆ†æ“Šå‹•ç•«å½ˆçª— (æ•¸å­—äº‚è·³ç‰ˆ) */
        .gacha-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(10px); }
        
        .gacha-box { 
            width: 200px; height: 200px; 
            border-radius: 50%;
            background: radial-gradient(circle, #fff, #ffeb3b, #ff9f43, #ff4757);
            box-shadow: 0 0 30px #ff9f43, 0 0 60px #ff4757;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            transform: scale(1);
        }

        /* èƒ½é‡çƒå‘¼å¸æ•ˆæœ */
        .gacha-box.charging { animation: orb-charge 0.1s infinite alternate; }
        @keyframes orb-charge { 
            0% { transform: scale(1); filter: hue-rotate(0deg); } 
            100% { transform: scale(1.1); filter: hue-rotate(30deg); box-shadow: 0 0 100px #ff4757; } 
        }

        /* ğŸŸ¢ æ•¸å­—é¡¯ç¤ºå„ªåŒ–ï¼šé è¨­é¡¯ç¤ºä½†éš±è—ï¼Œæ»¾å‹•æ™‚å¯è¦‹ */
        .gacha-num { 
            font-size: 4rem; font-weight: 900; color: rgba(255,255,255,0.9); 
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10; display: none; 
        }
        
        /* æ»¾å‹•æ™‚çš„æ¨£å¼ */
        .gacha-num.rolling {
            display: block;
            animation: none;
            transform: scale(1);
        }

        /* æœ€çµ‚çµæœè“‹ç« å‹•ç•« */
        .gacha-num.stamp { 
            display: block;
            font-size: 6rem;
            color: #fff;
            text-shadow: 0 0 20px #ff4757;
            animation: stamp-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }
        @keyframes stamp-in {
            0% { opacity: 0; transform: scale(5); }
            50% { opacity: 1; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .gacha-title { color: #fff; margin-top: 40px; font-size: 1.2rem; font-weight: bold; opacity: 0; transition: 0.5s; text-align: center; }
        .gacha-title span { display: block; font-size: 1.5rem; color: var(--gold); margin-top: 5px; }

        .gacha-btn-link { 
            display: none; margin-top: 20px; padding: 15px 25px; 
            background: #06c755; color: #fff; border-radius: 50px; font-weight: 900; 
            text-decoration: none; font-size: 1rem; width: 85%; text-align: center;
            box-shadow: 0 5px 15px rgba(6,199,85,0.4); animation: btn-pop 0.5s ease forwards;
        }
        @keyframes btn-pop { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        .gacha-btn-close {
            margin-top: 15px; background: transparent; border: 1px solid #555; color: #aaa;
            padding: 8px 20px; border-radius: 50px; cursor: pointer; display: none; font-size: 0.8rem;
        }

        /* ğŸ“¦ æ”¶ä»¶è³‡è¨Šæ¨£å¼ */
        .shipping-card { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1.5px solid var(--primary); }
        .ship-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 12px; font-size: 0.9rem; font-weight: bold; outline: none; background: #fdfdfd; }
        .ship-input:focus { border-color: var(--primary); }
        .ship-btn { background: var(--primary); color: #fff; border: none; padding: 12px; border-radius: 12px; font-weight: 900; width: 100%; cursor: pointer; font-size: 0.9rem; }

        .collapse-box { background: #fff; border-radius: 18px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .collapse-head { padding: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 900; font-size: 0.9rem; color: #333; }
        .collapse-head .arrow { transition: 0.3s; color: #ccc; font-size: 0.7rem; }
        .collapse-body { display: none; padding: 0 18px 10px; border-top: 1px solid #f9f9f9; }
        .collapse-body.show { display: block; }
        .collapse-box.open .arrow { transform: rotate(180deg); }

        .alliance-box { background: #fff; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .ref-url-box { background: #f0f2f5; padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 0.75rem; color: #666; word-break: break-all; border: 1px dashed var(--alliance); }
        .alliance-btn { background: var(--alliance); color: #fff; border: none; padding: 12px 20px; border-radius: 10px; font-weight: 900; width: 100%; cursor: pointer; margin-top: 10px; }
        
        .withdraw-btn { background: #fff; color: var(--alliance); border: 1.5px solid var(--alliance); padding: 10px 20px; border-radius: 10px; font-weight: 900; width: 100%; cursor: pointer; margin-top: 8px; transition: 0.3s; }
        .withdraw-btn:active { background: var(--alliance); color: #fff; }

        .notice-card { background: #fff9e6; border-left: 4px solid var(--wait); padding: 15px; border-radius: 8px; font-size: 0.75rem; text-align: left; margin-top: 20px; color: #856404; line-height: 1.6; }

        .list-item { background: #fff; border-radius: 18px; padding: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .list-item-inner { border-bottom: 1px solid #f9f9f9; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .list-item-inner:last-child { border: none; }
        
        .item-info b { display: block; font-size: 0.95rem; color: #333; margin-bottom: 4px; font-weight: 900; }
        .item-info small { color: #ccc; font-size: 0.7rem; font-weight: bold; }
        
        .status-tag { padding: 5px 12px; border-radius: 10px; font-size: 0.7rem; font-weight: 900; }
        .status-pending { background: #fff9e6; color: var(--wait); border: 1px solid #ffeebf; }
        .status-shipping { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .status-completed { background: #eefdf4; color: var(--success); border: 1px solid #dcf7e6; }
        
        .item-val { font-weight: 900; font-size: 1.1rem; }
        .val-minus { color: var(--primary); }
        .val-plus { color: var(--success); }

        .empty-state { text-align: center; padding: 30px 20px; color: #d0d5dd; font-weight: bold; font-size: 0.8rem;}
        #copyToast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 25px; border-radius: 50px; font-size: 0.8rem; font-weight: bold; z-index: 5000; display: none; }
        
        .shipping-info { font-size: 0.75rem; color: #7f8c8d; margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 12px; width: 100%; border: 1px solid #eee; }
        .shipping-no-box { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .shipping-no { color: var(--primary); font-weight: 900; font-size: 0.9rem; }
        .copy-btn { background: #fff; border: 1px solid #ddd; color: #666; padding: 2px 8px; border-radius: 6px; font-size: 0.65rem; cursor: pointer; font-weight: bold; }
        .track-link { display: block; text-align: center; background: #000; color: #fff; padding: 8px; border-radius: 8px; text-decoration: none; font-size: 0.7rem; font-weight: bold; margin-top: 5px; }

        .friend-status { font-size: 0.65rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-left: 5px;}
        .is-topped { color: var(--success); background: #eefdf4; }
        .not-topped { color: #999; background: #f0f0f0; }

        /* æ¯æ—¥ç°½åˆ° */
        .checkin-card { background: #fff; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .checkin-btn { background: linear-gradient(135deg, #ffb800 0%, #ff9d00 100%); color: #fff; border: none; width: 100%; padding: 15px; border-radius: 15px; font-size: 1rem; font-weight: 900; cursor: pointer; box-shadow: 0 5px 15px rgba(255,184,0,0.3); transition: 0.3s; margin-bottom: 20px; }
        .checkin-btn.disabled { background: #ddd; box-shadow: none; cursor: default; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .cal-day-label { font-size: 0.7rem; color: #ccc; font-weight: bold; }
        .cal-date { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; border-radius: 10px; background: #f8f9fb; color: #bbb; font-weight: bold; position: relative; }
        .cal-date.today { border: 1.5px solid var(--primary); color: var(--primary); }
        .cal-date.checked { background: #e3faf3; color: var(--success); }
        .cal-date.checked::after { content: 'âœ”'; font-size: 0.5rem; position: absolute; bottom: 2px; right: 3px; }
    </style>
</head>
<body>

    <div id="copyToast">âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <div class="header">
        <a href="index.html" class="back-btn">â† è¿”å›å•†åŸ</a>
        <button class="logout-btn" onclick="handleLogout()">ç™»å‡ºå¸³è™Ÿ</button>
    </div>

    <div class="user-panel">
        <div class="avatar-wrap"><div class="avatar" id="avatarLetter">?</div></div>
        <div class="nickname-box"><span id="uNick">---</span></div>
        <div class="uid-tag" onclick="copyText(localStorage.getItem('myScratchCode'), 'UID')">ID: <span id="displayUid">--------</span> ğŸ“‹</div>
        
        <div class="balance-card">
            <div class="balance-label">
                <span>æˆ‘çš„é»æ•¸</span>
                <span class="commission-tag">ç›Ÿå‹çé‡‘ï¼š<b id="uComm">0</b> P</span>
            </div>
            <div class="balance-amount"><span>P</span> <span id="uBal">0</span></div>
            <button class="deposit-btn" onclick="location.href='deposit.html'">ğŸ’³ å„²å€¼é»æ•¸</button>
        </div>
    </div>

    <div class="assets-grid">
        <div class="asset-box">
            <div class="asset-label"><span style="font-size:1.2rem;">ğŸ§©</span> Line ç›²ç›’ç©åˆ†</div>
            <div class="asset-val line-pt" id="pointDisplay">0</div>
        </div>
    </div>

    <div class="energy-section">
        <div class="energy-title">
            <span>âš¡ æ¶ˆè²»èƒ½é‡é›†æ°£ (æ»¿500æŠ½ç)</span>
            <span style="color:var(--danger)" id="energyVal">0 / 500</span>
        </div>
        <div class="energy-bar-bg">
            <div class="energy-bar-fill" id="energyFill"></div>
        </div>
        <div class="energy-text" id="energyDesc">ç´¯ç©æ¶ˆè²»æ»¿ 500 P å¯é€²è¡Œä¸€æ¬¡çˆ†æ“ŠæŠ½çï¼<br>(æœ‰æ©Ÿæœƒç²å¾— 1~50 é»ç©åˆ†)</div>
        <button class="claim-btn" id="claimBtn" onclick="startGacha()">ğŸ”¥ èƒ½é‡å·²æ»¿ï¼é»æ“Šçˆ†ç™¼</button>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab(0)">é è¨­å¯„ä»¶èˆ‡æ¶ˆè²»æ˜ç´°</div>
        <div class="tab-btn" onclick="switchTab(1)">ä¸­çå­˜æ ¹</div>
        <div class="tab-btn" onclick="switchTab(2)">ç›Ÿå‹ä¸­å¿ƒ</div>
        <div class="tab-btn" onclick="switchTab(3)">æ¯æ—¥ç°½åˆ°</div>
    </div>

    <div class="content-area">
        <div id="tab-0" class="page-content active">
            <div class="shipping-card">
                <div style="font-weight: 900; font-size: 1rem; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    ğŸ“¦ 7-11 é è¨­æ”¶ä»¶è³‡è¨Š
                </div>
                <input type="text" id="shipName" class="ship-input" placeholder="æ”¶ä»¶äººçœŸå¯¦å§“å">
                <input type="tel" id="shipPhone" class="ship-input" placeholder="æ”¶ä»¶äººæ‰‹æ©Ÿè™Ÿç¢¼">
                <input type="text" id="shipStore" class="ship-input" placeholder="7-11 åº—åæˆ–åº—è™Ÿ (ä¾‹: å¤¢æƒ³é–€å¸‚)">
                <button class="ship-btn" onclick="saveShippingInfo()">å„²å­˜æ”¶ä»¶è³‡è¨Š</button>
                <div style="font-size: 1rem; color: #aaa; margin-top: 10px; line-height: 1.4;">
                    * å¡«å¯«å¾Œä¸­çå°‡è‡ªå‹•ä»¥æ­¤è³‡è¨Šå‡ºè²¨ï¼Œç„¡éœ€é‡è¤‡è©¢å•ã€‚<br>
                    * è‹¥éœ€æ›´æ”¹è³‡è¨Šï¼Œç›´æ¥ä¿®æ”¹ä¸¦å†æ¬¡é»æ“Šå„²å­˜å³å¯ã€‚
                </div>
            </div>

            <div class="collapse-box" id="boxDep">
                <div class="collapse-head" onclick="toggleCollapse('boxDep', 'depListBody')">
                    <span>ğŸ’° å„²å€¼å…¥é»ç´€éŒ„ (é»æ“Šå±•é–‹)</span>
                    <span class="arrow">â–¼</span>
                </div>
                <div class="collapse-body" id="depListBody"></div>
            </div>

            <div class="collapse-box" id="boxGame">
                <div class="collapse-head" onclick="toggleCollapse('boxGame', 'gameListBody')">
                    <span>ğŸ° éŠæˆ²æ¶ˆè²»ç´€éŒ„ (é»æ“Šå±•é–‹)</span>
                    <span class="arrow">â–¼</span>
                </div>
                <div class="collapse-body" id="gameListBody"></div>
            </div>
        </div>

        <div id="tab-1" class="page-content"><div id="winsList"></div></div>
        
        <div id="tab-2" class="page-content">
            <div class="alliance-box">
                <div style="font-weight: 900; font-size: 1.2rem; color: var(--alliance);">ç›Ÿå‹åˆ†æ½¤è¨ˆç•«</div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">é‚€è«‹å¥½å‹å„²å€¼ï¼Œæœ€é«˜äº« 10% åˆ†æ½¤</div>
                
                <div class="ref-url-box" id="refLink">è¼‰å…¥ä¸­...</div>
                
                <button class="alliance-btn" onclick="copyRefLink()">ğŸ“‹ è¤‡è£½æˆ‘çš„æ¨å»£é€£çµ</button>
                
                <button class="withdraw-btn" onclick="requestWithdraw()">ğŸ’° ç”³è«‹çé‡‘æç¾ (äººå·¥å¯©æ ¸)</button>
                
                <div class="notice-card">
                    <b>ğŸ† ç›Ÿå‹åˆ†æ½¤èˆ‡ç‡Ÿé‹è¦ç¯„ï¼š</b><br>
                    1. <b>é¦–å„²é™å®šå„ªæƒ </b>ï¼šå¥½å‹ç¶å®šå¾Œã€Œç¬¬ä¸€ç­†ã€å„²å€¼ç‚ºé¦–å„²ï¼Œæ‚¨å¾— <b>10%</b> çé‡‘ï¼Œå¥½å‹äº¦å¾— 10% è´ˆé»ã€‚<br>
                    2. <b>çºŒå„²å›é¥‹</b>ï¼šå¥½å‹å¾ŒçºŒå–®ç­†å„²å€¼æ»¿åƒï¼Œå¥½å‹å¾— 3% è´ˆé»ï¼Œæ‚¨å›ºå®šå¾— <b>5%</b> çé‡‘ã€‚<br>
                    3. <b>æç¾é–€æª»</b>ï¼šçé‡‘ç´¯ç©æ»¿ <b>1,000P</b> å³å¯ç”³è«‹ã€‚<br>
                    4. <b>çé‡‘è½‰é»å„ªæƒ </b>ï¼šçé‡‘è½‰ç‚ºéŠæˆ²é»æ•¸ï¼Œäº« <b>10% é¡å¤–åŠ ç¢¼</b>ã€‚<br>
                    <b style="color:#c0392b;">âš ï¸ åš´ç¦ç•°å¸¸å¥—åˆ©è²æ˜ï¼š</b><br>
                    5. <b>ç¦æ­¢è‡ªæˆ‘æ¨è–¦</b>ï¼šåš´ç¦ä½¿ç”¨ç›¸åŒè¨­å‚™æˆ– IP å»ºç«‹å¤šå¸³è™Ÿç›¸äº’æ¨è–¦ï¼Œç¶“æŸ¥ç²å°‡æ²’æ”¶æ‰€æœ‰çé‡‘ã€‚
                </div>
            
                <div id="referralFriendsList"></div>
                <div id="referralLogList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="tab-3" class="page-content">
            <div class="checkin-card">
                <div style="font-weight: 900; font-size: 1.2rem; color: var(--gold); margin-bottom: 5px;">æ¯æ—¥ç°½åˆ°é ˜çå‹µ</div>
                <div style="font-size: 0.8rem; color: #999; margin-bottom: 20px;">å¤©å¤©ç°½åˆ°é ˜ 3Pï¼Œå­˜ä¹…äº†ä¹Ÿèƒ½å…è²»æŠ½ï¼</div>
                
                <button class="checkin-btn" id="checkBtn" onclick="handleCheckIn()">ğŸ“… ç«‹å³ç°½åˆ°é ˜ 3P</button>
                
                <div class="calendar-wrap" style="text-align: left;">
                    <div class="calendar-title" style="margin-bottom: 10px; font-weight: 900; font-size: 0.9rem;">
                        <span id="calMonth">2026å¹´ 2æœˆ</span>
                        <span style="color:var(--gold); font-size: 0.7rem; float: right;">âœ” ä»£è¡¨ç°½åˆ°æˆåŠŸ</span>
                    </div>
                    <div class="calendar-grid" id="calGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="gachaModal" class="gacha-modal">
        <div class="gacha-box" id="gachaBox">
            <div class="gacha-num" id="gachaNum">0</div>
        </div>
        <div class="gacha-title" id="gachaResultText">èƒ½é‡é‡‹æ”¾ä¸­...</div>
        
        <a href="https://line.me/R/ti/p/@dream8" target="_blank" class="gacha-btn-link" id="gachaLineBtn">ğŸ’¬ æˆªåœ–å‚³çµ¦ Line å®¢æœé€²è¡Œæ ¸éŠ·è½‰é»</a>
        <button class="gacha-btn-close" id="gachaCloseBtn" onclick="location.reload()">é—œé–‰</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, update, set, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ğŸ”’ æ¢å¾©ä½¿ç”¨èˆ‡ Admin ç›¸åŒçš„åŠ å¯†è¨­å®šï¼Œç¢ºä¿é€£ç·šç©©å®š
        const _0x9d1 = (s) => atob(s);
        const _cc = { 
            apiKey: _0x9d1("QUl6YVN5RFBHRUl3Q0t5WXh6NlRZZHhta3dBeElXamZRSThBd2Nv"), 
            databaseURL: _0x9d1("aHR0cHM6Ly9kcmVhbTgtN2IxNjEtZGVmYXVsdC1ydGRiLmZpcmViYXNlaW8uY29t"), 
            projectId: _0x9d1("ZHJlYW04LTdiMTYx"), 
            appId: _0x9d1("MTo2MDYyMTg1MjI0Nzk6d2ViOjI3Mzc2NDNkYjNkZTczNWFmN2UyOWE=") 
        };
        
        const _app = initializeApp(_cc); 
        const _db = getDatabase(_app);
        const _uid = localStorage.getItem('myScratchCode');

        if(!_uid) location.href = 'index.html';
        document.getElementById('displayUid').innerText = _uid;

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼å®šç¾© ---

        window.handleLogout = () => {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå¸³è™Ÿå—ï¼Ÿ")) {
                localStorage.removeItem('myScratchCode');
                location.href = 'index.html';
            }
        };

        window.toggleCollapse = (boxId, bodyId) => {
            const box = document.getElementById(boxId);
            const body = document.getElementById(bodyId);
            const isOpen = box.classList.contains('open');
            document.querySelectorAll('.collapse-box').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.collapse-body').forEach(el => el.style.display = 'none');
            if(!isOpen) {
                box.classList.add('open');
                body.style.display = 'block';
            }
        };

        const myRefUrl = `${window.location.origin}${window.location.pathname.replace('member.html', 'index.html').replace('profile.html', 'index.html')}?ref=${_uid}`;
        document.getElementById('refLink').innerText = myRefUrl;

        window.copyRefLink = () => copyText(myRefUrl, 'æ¨å»£é€£çµ');

        window.handleCheckIn = async () => {
            const btn = document.getElementById('checkBtn');
            if(btn.classList.contains('disabled')) return;

            try {
                const userRef = ref(_db, `users/${_uid}`);
                const snap = await get(userRef);
                const u = snap.val();
                const today = new Date().toLocaleDateString('sv-SE');

                if(u.lastCheckIn === today) return alert("ä»Šå¤©å·²ç¶“ç°½åˆ°éäº†å”·ï¼");

                const newCheckInDates = u.checkInDates || [];
                newCheckInDates.push(today);

                await update(userRef, {
                    balance: (u.balance || 0) + 3,
                    lastCheckIn: today,
                    checkInDates: newCheckInDates
                });

                await set(ref(_db, `users/${_uid}/logs/${Date.now()}`), {
                    game: "ğŸ“… æ¯æ—¥ç°½åˆ°çå‹µ",
                    cost: -3, 
                    time: Date.now()
                });

                alert("âœ… ç°½åˆ°æˆåŠŸï¼ç²å¾— 3P çå‹µ");
                renderCalendar(newCheckInDates);
            } catch (e) { alert("ç°½åˆ°å¤±æ•—ï¼Œè«‹è¯ç¹«å®¢æœ"); }
        };

        function renderCalendar(checkedDates = []) {
            const grid = document.getElementById('calGrid');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const todayStr = now.toLocaleDateString('sv-SE');
            
            document.getElementById('calMonth').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            grid.innerHTML = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => `<div class="cal-day-label">${d}</div>`).join('');

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

            for(let d=1; d<=daysInMonth; d++) {
                const curStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = curStr === todayStr ? 'today' : '';
                const isChecked = checkedDates.includes(curStr) ? 'checked' : '';
                grid.innerHTML += `<div class="cal-date ${isToday} ${isChecked}">${d}</div>`;
            }

            if(checkedDates.includes(todayStr)) {
                const btn = document.getElementById('checkBtn');
                btn.innerText = "âœ¨ ä»Šæ—¥å·²ç°½åˆ°";
                btn.classList.add('disabled');
            }
        }

        // ğŸŸ¢ ç¢ºä¿ renderLogs å­˜åœ¨
        function renderLogs(logs) {
            const gBody = document.getElementById('gameListBody');
            const dBody = document.getElementById('depListBody');
            
            if(!logs) { 
                gBody.innerHTML = dBody.innerHTML = '<div class="empty-state">ç„¡ç´€éŒ„</div>'; 
                return; 
            }
            
            const arr = Object.values(logs).sort((a,b) => b.time - a.time);
            const g = arr.filter(l => Number(l.cost) > 0);
            const d = arr.filter(l => Number(l.cost) <= 0);

            gBody.innerHTML = g.length ? g.map(l => `
                <div class="list-item-inner">
                    <div class="item-info">
                        <b>${l.game}</b>
                        <small>${new Date(l.time).toLocaleString()}</small>
                    </div>
                    <div class="item-val val-minus">-${l.cost} P</div>
                </div>
            `).join('') : '<div class="empty-state">ç„¡æ¶ˆè²»</div>';

            dBody.innerHTML = d.length ? d.map(l => {
                const isGift = l.cost === 0 && l.note;
                return `
                <div class="list-item-inner">
                    <div class="item-info">
                        <b>${l.game || 'é»æ•¸å…¥å¸³'}</b>
                        <small>${new Date(l.time).toLocaleString()}</small>
                    </div>
                    <div class="item-val val-plus">${isGift ? l.note : '+' + Math.abs(l.cost) + ' P'}</div>
                </div>`;
            }).join('') : '<div class="empty-state">ç„¡å…¥é»</div>';
        }

        window.saveShippingInfo = async () => {
            const name = document.getElementById('shipName').value.trim();
            const phone = document.getElementById('shipPhone').value.trim();
            const store = document.getElementById('shipStore').value.trim();
            if(!name || !phone || !store) return alert("è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶è³‡è¨Š");
            try {
                await update(ref(_db, `users/${_uid}/shipping`), { name, phone, store, time: Date.now() });
                alert("âœ… å„²å­˜æˆåŠŸï¼ä¹‹å¾Œä¸­çæœƒè‡ªå‹•ä»¥æ­¤è³‡æ–™å‡ºè²¨ã€‚");
            } catch (e) { alert("å„²å­˜å¤±æ•—"); }
        };

        window.requestWithdraw = async () => {
            const snap = await get(ref(_db, `users/${_uid}/commission`));
            const currentComm = snap.val() || 0;
            if (currentComm < 1000) {
                alert(`âš ï¸ æç¾å¤±æ•—\n\nç›®å‰çé‡‘ç‚º ${currentComm}Pï¼Œéœ€ç´¯ç©æ»¿ 1,000P æ–¹å¯ç”³è«‹ã€‚`);
            } else {
                alert(`âœ… è³‡æ ¼ç¢ºèª\n\næ‚¨çš„çé‡‘å·²é”æç¾é–€æª»ï¼\nè«‹æˆªåœ–æ­¤é é¢ä¸¦è¯ç¹«å®˜æ–¹å®¢æœ LINEï¼Œæˆ‘å€‘å°‡ç‚ºæ‚¨è¾¦ç†åŒ¯æ¬¾ã€‚`);
                window.open('https://line.me/ti/p/@dream8','_blank');
            }
        };

        window.copyText = (text, type) => {
            if(!text) return;
            navigator.clipboard.writeText(text);
            const t = document.getElementById('copyToast');
            t.innerText = `âœ… å·²è¤‡è£½ ${type}`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        };

        window.switchTab = (idx) => {
            document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            document.querySelectorAll('.page-content').forEach((p, i) => p.classList.toggle('active', i === idx));
        };

        // ğŸŸ¢ ç›£è½æ•¸æ“š (å«é›†æ°£æ¢)
        onValue(ref(db, `users/${_uid}`), s => {
            const u = s.val(); if(!u) return;
            
            try {
                document.getElementById('uBal').innerText = (u.balance || 0).toLocaleString();
                document.getElementById('uComm').innerText = (u.commission || 0).toLocaleString();
                document.getElementById('uNick').innerText = u.nickname || "æ–°ç©å®¶";
                document.getElementById('avatarLetter').innerText = (u.nickname || _uid).charAt(0).toUpperCase();
                document.getElementById('pointDisplay').innerText = (u.linePoints || 0);

                const spending = Number(u.spending_counter) || 0;
                const target = 500;
                const pct = Math.min((spending / target) * 100, 100);
                
                document.getElementById('energyVal').innerText = `${spending} / ${target}`;
                document.getElementById('energyFill').style.width = `${pct}%`;

                if (spending >= target) {
                    document.getElementById('claimBtn').style.display = 'block';
                    document.getElementById('energyDesc').style.display = 'none';
                } else {
                    document.getElementById('claimBtn').style.display = 'none';
                    document.getElementById('energyDesc').style.display = 'block';
                }

                if (u.shipping) {
                    document.getElementById('shipName').value = u.shipping.name || '';
                    document.getElementById('shipPhone').value = u.shipping.phone || '';
                    document.getElementById('shipStore').value = u.shipping.store || '';
                }

                renderCalendar(u.checkInDates || []);
                renderLogs(u.logs);
            } catch (e) {
                console.error("Data render error:", e);
            }
        });

        // ğŸŸ¢ çˆ†æ“Šæ¼”ç®—æ³• (æ§ç›¤ç‰ˆ)
        function calculateReward() {
            const rand = Math.random() * 100; 
            if (rand < 1) return 50; 
            if (rand < 15) return Math.floor(Math.random() * (20 - 11 + 1)) + 11; 
            return Math.floor(Math.random() * (10 - 1 + 1)) + 1; 
        }

        // ğŸŸ¢ åŸ·è¡ŒæŠ½ç (å‡ç´šç‰ˆæ•¸å­—è·³å‹•å‹•ç•«)
        window.startGacha = async () => {
            const snap = await get(ref(db, `users/${_uid}/spending_counter`));
            const currentSpend = snap.val() || 0;
            if (currentSpend < 500) return alert("èƒ½é‡ä¸è¶³ï¼");

            const modal = document.getElementById('gachaModal');
            const box = document.getElementById('gachaBox');
            const numDisplay = document.getElementById('gachaNum');
            const title = document.getElementById('gachaResultText');
            
            modal.style.display = 'flex';
            box.classList.add('charging'); 
            
            // ğŸŸ¢ é–‹å§‹æ•¸å­—äº‚è·³ (åœ¨çƒé«”å…§)
            numDisplay.classList.add('rolling');
            numDisplay.style.display = 'block';

            const rewardPoints = calculateReward();
            
            // äº‚è·³å‹•ç•«
            let counter = 0;
            const interval = setInterval(() => {
                numDisplay.innerText = Math.floor(Math.random() * 50) + 1; // 1~50 éš¨æ©Ÿè·³
                counter++;
                if (counter > 25) { // ç´„ 2 ç§’å¾Œåœæ­¢
                    clearInterval(interval);
                    showResult(rewardPoints);
                }
            }, 50); // æ¯ 50ms è·³ä¸€æ¬¡

            // è³‡æ–™åº«å¯«å…¥
            const uRef = ref(db, `users/${_uid}`);
            const uSnap = await get(uRef);
            const u = uSnap.val();

            await update(uRef, {
                spending_counter: (Number(u.spending_counter) || 0) - 500,
                linePoints: (Number(u.linePoints) || 0) + rewardPoints
            });

            push(ref(db, `users/${_uid}/logs`), {
                game: "âš¡ èƒ½é‡çˆ†ç™¼",
                cost: 0,
                note: `æŠ½ä¸­ ${rewardPoints} é»`,
                time: Date.now()
            });

            push(ref(db, `winLogs`), {
                uid: _uid,
                user: u.nickname || "ç©å®¶",
                game: "âš¡ èƒ½é‡çˆ†ç™¼",
                prize: `ç²å¾— ${rewardPoints} é»ç©åˆ†`,
                time: serverTimestamp(),
                status: "å·²å…¥å¸³"
            });
        };

        function showResult(points) {
            const box = document.getElementById('gachaBox');
            const num = document.getElementById('gachaNum');
            const text = document.getElementById('gachaResultText');
            const btnLink = document.getElementById('gachaLineBtn');
            const btnClose = document.getElementById('gachaCloseBtn');

            // ç§»é™¤é›†æ°£ç‹€æ…‹ï¼Œé€²å…¥çµæœç‹€æ…‹
            box.classList.remove('charging');
            box.style.background = 'transparent'; // éš±è—çƒé«”èƒŒæ™¯
            box.style.boxShadow = 'none';
            box.style.border = 'none';
            
            num.classList.remove('rolling');
            num.classList.add('stamp'); // è“‹ç« æ•ˆæœ
            num.innerText = points;
            num.style.color = points >= 50 ? '#ff4757' : (points > 10 ? '#f1c40f' : '#fff');
            
            text.style.opacity = 1;
            text.innerHTML = points >= 50 ? `ğŸ ç©åˆ†å·²å­˜å…¥æ‚¨çš„å¸³è™Ÿï¼<br><span style="color:#ff4757">ğŸ”¥ è¶…ç´šçˆ†æ“Šï¼${points} é»</span>` : `ğŸ ç©åˆ†å·²å­˜å…¥æ‚¨çš„å¸³è™Ÿï¼<br><span>ç²å¾— ${points} é»</span>`;
            
            btnLink.style.display = 'block';
            btnClose.style.display = 'inline-block';
            
            confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
        }

        onValue(ref(db, `users`), s => {
            const list = document.getElementById('referralFriendsList');
            const allUsers = s.val() || {};
            const myFriends = Object.entries(allUsers)
                .map(([id, data]) => ({ ...data, uid: id }))
                .filter(u => u.invitedBy === _uid)
                .sort((a,b) => (b.createTime || 0) - (a.createTime || 0));

            if(myFriends.length) {
                list.innerHTML = `<div style="padding: 10px; font-weight: 900; color: #999; font-size: 0.8rem; margin-top:15px;">å·²ç¶å®šå¥½å‹ (${myFriends.length}äºº)</div>` + 
                myFriends.map(f => `
                    <div class="list-item" style="padding: 12px 18px; margin-bottom: 8px;">
                        <div class="item-info">
                            <b>${f.nickname || 'åŒ¿åç›Ÿå‹'}</b>
                            <small>ID: ${f.uid.substring(0,8)}... <span class="friend-status ${f.hasToppedUp ? 'is-topped' : 'not-topped'}">${f.hasToppedUp ? 'å·²é¦–å„²' : 'æœªå„²å€¼'}</span></small>
                        </div>
                    </div>
                `).join('');
            }
        });

        onValue(ref(db, `referralLogs/${_uid}`), s => {
            const list = document.getElementById('referralLogList');
            if(s.exists()) {
                const logs = Object.values(s.val()).sort((a,b) => b.time - a.time);
                list.innerHTML = `<div style="padding: 10px; font-weight: 900; color: #999; font-size: 0.8rem;">åˆ†æ½¤æ˜ç´°</div>` + 
                logs.map(l => `
                    <div class="list-item">
                        <div class="item-info">
                            <b>ä¾†è‡ªå¥½å‹å„²å€¼å›é¥‹</b>
                            <small>å¥½å‹: ${l.from_uid ? l.from_uid.substring(0,8) : '---'}... | ${new Date(l.time).toLocaleString()}</small>
                        </div>
                        <div class="item-val val-plus">+${l.reward} P</div>
                    </div>
                `).join('');
            }
        });

        onValue(ref(db, `winLogs`), s => {
            const list = document.getElementById('winsList');
            const data = s.val() || {};
            const myWins = Object.values(data).filter(w => w.user === _uid).sort((a,b) => b.time - a.time);
            if(myWins.length) {
                list.innerHTML = myWins.map(w => {
                    let sc = "status-pending", st = w.status || "å¾…å‡ºè²¨";
                    if(st === "å·²å‡ºè²¨") sc = "status-shipping"; if(st === "å·²å®Œæˆ") sc = "status-completed";
                    if(w.game === "âš¡ èƒ½é‡çˆ†ç™¼") { st = "å·²å…¥å¸³"; sc = "status-completed"; }
                    
                    return `<div class="list-item" style="flex-direction: column; align-items: flex-start; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <div class="item-info"><b>${w.prize}</b><small>${w.game} | ${new Date(w.time).toLocaleString()}</small></div>
                            <div class="status-tag ${sc}">${st}</div>
                        </div>
                        ${w.shippingNo ? `<div class="shipping-info"><div class="shipping-no-box"><span>ç‰©æµç·¨è™Ÿï¼š<b class="shipping-no">${w.shippingNo}</b></span><button class="copy-btn" onclick="copyText('${w.shippingNo}', 'ç·¨è™Ÿ')">ğŸ“‹</button></div><a href="https://tracking.shopmore.com.tw/" target="_blank" class="track-link">ğŸ“¦ ç‰©æµæŸ¥è©¢</a></div>` : ''}
                    </div>`;
                }).join('');
            } else { list.innerHTML = '<div class="empty-state">å°šæœªä¸­ç</div>'; }
        });
    </script>
</body>
</html>
