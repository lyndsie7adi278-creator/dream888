<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <title>å¤¢å·¥å»  | åˆ®åˆ®æ¨‚å•†åŸ</title>
    
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            if (refId && refId.trim() !== "") {
                localStorage.setItem('pending_ref', refId.trim());
                console.log("å·²æ•æ‰åˆ°æ¨è–¦ç¢¼ä¸¦æš«å­˜:", refId);
            }
        })();

        // ğŸŸ¢ æ ¸å¿ƒä¿®æ­£ 2ï¼šå…¨åŸŸå¼·åˆ¶è³¦å€¼å‡½æ•¸ï¼Œè™•ç†éš±è—å…ƒç´ å¡«å€¼å•é¡Œ
        window.forceApplyRef = function() {
            const savedRef = localStorage.getItem('pending_ref');
            const refEl = document.getElementById('refIn');
            if (savedRef && refEl) {
                refEl.value = savedRef;
                console.log("è¨»å†Šè¡¨å–®å·²å¼·åˆ¶å¡«å…¥:", savedRef);
            }
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root{--primary:#ff8fa3;--dark:#1a1c23;--bg:#f0f2f5;--line:#06c755;--soldout:#95a5a6;--free:#4cd137;--lock:#3498db;--gold:#ffb800}
        * {-webkit-tap-highlight-color:transparent;user-select:none!important;box-sizing:border-box}
        body{font-family:'PingFang TC','Microsoft JhengHei',sans-serif;background:var(--bg);margin:0;padding:0;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;padding-bottom:100px}
        .welcome-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);background:rgba(26,28,35,.95);color:var(--gold);padding:12px 25px;border-radius:50px;font-weight:900;font-size:.9rem;z-index:5000;box-shadow:0 10px 30px rgba(0,0,0,.3);border:1px solid var(--gold);display:none;opacity:0;transition:.5s}
        .welcome-toast.show{display:block;opacity:1;transform:translateX(-50%) translateY(0)}
        .top-nav{width:100%;background:#fff;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 15px rgba(0,0,0,.08);position:sticky;top:0;z-index:1000}
        .nav-left{display:flex;align-items:center;gap:15px;cursor:pointer;color:#333;font-size:1.4rem;position:relative}
        
        .logo-txt{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center}
        .logo-img{height:35px;width:auto;display:block;object-fit:contain}

        .menu-dropdown{display:none;position:absolute;top:60px;left:15px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:2000;min-width:150px;overflow:hidden;border:1px solid #eee}
        .menu-dropdown.show{display:block;animation:menuFade .3s ease}@keyframes menuFade{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .menu-item{padding:15px 20px;font-size:.9rem;color:#2c3e50;font-weight:700;border-bottom:1px solid #f9f9f9;display:flex;align-items:center;gap:10px;cursor:pointer;text-decoration:none}
        .menu-item:active{background:#fff1f3;color:var(--primary)}
        
        .marquee-container{width:100%;background:#1a1c23;color:var(--primary);padding:12px 0;overflow:hidden;white-space:nowrap;font-size:.85rem;font-weight:700;border-bottom:2px solid var(--primary);position: relative;}
        .marquee-content{display:inline-block;padding-left: 100%;animation: marquee-linear 40s linear infinite;will-change: transform;}
        @keyframes marquee-linear { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        @media screen and (max-width: 768px) { .marquee-content { animation-duration: 30s; } }

        .category-scroll{display:flex;overflow-x:auto;padding:15px 20px;gap:12px;width:100%;scrollbar-width:none;-webkit-overflow-scrolling:touch}
        .cat-item{flex-shrink:0;padding:10px 22px;border-radius:50px;background:#fff;border:1px solid #eee;font-size:.85rem;color:#7f8c8d;font-weight:700;transition:.3s;cursor:pointer}
        .cat-item.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 4px 12px rgba(255,143,163,.4)}
        .product-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;width:94%;max-width:500px;padding:15px 0}
        .p-card{background:#fff;border-radius:22px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.06);border:1px solid #f0f0f0;transition:.3s;position:relative;cursor:pointer}
        .p-card:active{transform:scale(.95)}
        .p-card.soldout{filter:grayscale(.8);opacity:.8}
        .p-card.free-gift{border:2px solid var(--free);box-shadow:0 8px 25px rgba(76,209,55,.4)}
        .p-img{width:100%;aspect-ratio:1/1;object-fit:cover;background:#fdfdfd}
        .p-info{padding:18px 10px;text-align:center;min-height:115px;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .p-name{font-weight:900;font-size:.95rem;color:#2c3e50;margin-bottom:5px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .p-price-value{color:var(--primary);font-weight:900;font-size:1.15rem;display:flex;align-items:center;justify-content:center;gap:5px}
        .soldout-tag{background:#57606f;color:#fff;font-size:.7rem;padding:4px 10px;border-radius:6px;margin-top:5px;display:inline-block;font-weight:900}
        .free-tag{background:var(--free);color:#fff;font-size:.7rem;padding:4px 10px;border-radius:6px;margin-top:5px;display:inline-block;font-weight:900}
        .lock-tag{background:var(--lock);color:#fff;font-size:.7rem;padding:4px 10px;border-radius:6px;margin-top:5px;display:inline-block;font-weight:900}
        .promo-tag{background:#ff4757;color:#fff;font-size:.6rem;padding:2px 6px;border-radius:4px;font-weight:900}
        .promo-info{font-size:.65rem;color:#ff8fa3;margin-top:5px;font-weight:900}
        .line-wrapper{position:fixed;bottom:30px;right:20px;z-index:2000;display:flex;flex-direction:column;align-items:flex-end;animation:float-breath 2s infinite ease-in-out}
        .line-bubble{background:#fff;color:#333;padding:10px 15px;border-radius:15px;font-size:.8rem;font-weight:900;margin-bottom:10px;box-shadow:0 5px 15px rgba(0,0,0,.15);position:relative;border:1px solid #eee;white-space:nowrap}
        .line-bubble::after{content:"";position:absolute;bottom:-8px;right:20px;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #fff}
        .line-float{width:60px;height:60px;background:var(--line);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(6,199,85,.4);cursor:pointer}
        .line-float img{width:35px;height:35px}@keyframes float-breath{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .status-section{width:92%;max-width:460px;margin:35px 0 15px;background:#fff;border-radius:28px;padding:25px;border:1px solid rgba(0,0,0,.04);box-shadow:0 5px 20px rgba(0,0,0,.03)}
        .status-item{display:flex;align-items:flex-start;background:#f9fafb;padding:18px;border-radius:20px;margin-bottom:15px}.status-icon{font-size:1.6rem;margin-right:18px;margin-top:3px}
        .status-text b{display:block;font-size:.9rem;color:#1a1c23;margin-bottom:5px}.status-text p{margin:0;font-size:.75rem;color:#7f8c8d;line-height:1.6}
        
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:4000;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
        .m-box{background:#fff;padding:25px 15px;border-radius:35px;width:90%;max-width:360px;text-align:center;position:relative;box-shadow:0 20px 50px rgba(0,0,0,.3);overflow:hidden}
        .close-modal{position:absolute;top:15px;right:20px;font-size:1.5rem;color:#ccc;cursor:pointer;z-index:10}
        .swiper { width: 100%; height: auto; padding-bottom: 30px; }
        .pop-img-box { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 15px; background: #f0f0f0; }
        .pop-img-box img { width: 100%; height: auto; display: block; object-fit: cover; }
        .pop-title { font-weight: 900; font-size: 1.1rem; color: #333; margin-bottom: 10px; }
        .pop-text { font-size: 0.9rem; color: #666; text-align: left; line-height: 1.6; white-space: pre-wrap; padding: 0 10px; }
        .swiper-pagination-bullet-active { background: var(--primary) !important; }
        
        input{width:100%;padding:14px;margin:8px 0;border:1px solid #eee;border-radius:12px;text-align:center;font-size:1rem;font-weight:700;color:var(--primary);outline:none}
        .btn{background:var(--primary);color:#fff;border:none;padding:16px;border-radius:50px;font-weight:900;width:100%;cursor:pointer;font-size:1rem;box-shadow:0 8px 20px rgba(255,143,163,.3);margin-top:10px}
        .footer{padding:30px 0 50px;font-size:.75rem;color:#95a5a6;text-align:center;line-height:2}

        .modal-footer { margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .no-show-label { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; color: #999; cursor: pointer; margin-bottom: 12px; }
        .no-show-label input { width: 16px; height: 16px; margin: 0; cursor: pointer; }
        .tip-text { font-size: 0.7rem; color: #ccc; margin-top: 8px; }
    </style>
</head>
<body oncontextmenu="return false;">
<div id="welcomeToast" class="welcome-toast"></div>
<div class="line-wrapper" onclick="window.open('https://line.me/ti/p/@dream8','_blank')"><div class="line-bubble">å„²å€¼/å•é¡Œè«‹é»æˆ‘ ğŸ’¬</div><div class="line-float"><img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" alt="LINE"></div></div>

<div id="annModal" class="modal">
    <div class="m-box">
        <div class="close-modal" onclick="closeModal()">âœ•</div>
        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="annSwiperWrapper"></div>
            <div class="swiper-pagination"></div>
        </div>
        
        <div class="modal-footer">
            <label class="no-show-label">
                <input type="checkbox" id="noMoreToday"> ä»Šæ—¥ä¸å†é¡¯ç¤º
            </label>
            <button class="btn" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
            <div class="tip-text">ğŸ’¡ æº«é¦¨æç¤ºï¼šé»æ“Šå·¦ä¸Šè§’ã€Œâ˜° æœ€æ–°å…¬å‘Šã€å¯å†æ¬¡æŸ¥çœ‹</div>
        </div>
    </div>
</div>

<div class="top-nav">
    <div class="nav-left" id="menuToggle">
        <span>â˜°</span>
        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" onclick="openAnn()">ğŸ“œ æœ€æ–°å…¬å‘Š</div>
            <a href="faq.html" class="menu-item">â“ å¸¸è¦‹å•é¡Œ</a>
        </div>
    </div>
    
    <div class="logo-txt">
        <img src="https://firebasestorage.googleapis.com/v0/b/dream8-7b161.firebasestorage.app/o/images%2F%E6%9C%AA%E5%91%BD%E5%90%8D%E8%A8%AD%E8%A8%88%20(5).png?alt=media&token=1c7a2e9a-c1bb-465e-9a34-b179fbe98ce8" alt="Logo" class="logo-img">
    </div>
    
    <div id="userEntryPoint" onclick="handleUserClick()" style="cursor:pointer;font-size:1.4rem;color:#444">ğŸ‘¤</div>
</div>

<div class="marquee-container"><div class="marquee-content" id="mq">æ­£åœ¨åŒæ­¥æœ€æ–°ä¸­çå–œå ±...</div></div>
<div class="category-scroll" id="catList"><div class="cat-item active" onclick="filterCat('ALL')">å…¨éƒ¨å•†å“ ALL</div></div>
<div class="product-grid" id="pGrid"></div>
<div class="status-section"><div class="status-item"><div class="status-icon">ğŸ›¡ï¸</div><div class="status-text"><b>åŠ å¯†å®‰å…¨è¨ªå•ç³»çµ±</b><p>æ•¸æ“šç¶“ SSL é«˜ç´šåŠ å¯†ï¼Œå®ˆè­·è³‡ç”¢å®‰å…¨ã€‚</p></div></div><div class="status-item"><div class="status-icon">ğŸ°</div><div class="status-text"><b>å…¬å¹³éš¨æ©Ÿæ´—ç‰Œç®—æ³•</b><p>ç±¤æ± ç™¼ä½ˆå³éš¨æ©Ÿæ’åºï¼Œå…¬æ­£é€æ˜ã€‚</p></div></div></div>
<div class="footer"> Â© 2026 | å¤¢å·¥å»  </div>

<div id="loginModal" class="modal"><div class="m-box"><div class="close-modal" onclick="document.getElementById('loginModal').style.display='none'">âœ•</div><h2 id="loginStepTitle" style="margin:0 0 10px;letter-spacing:2px;font-size:1.2rem">æœƒå“¡ç™»å…¥</h2><div id="step1"><input type="text" id="cIn" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ (ID)"><button class="btn" onclick="checkCode()">ä¸‹ä¸€æ­¥ NEXT</button><p style="font-size:.7rem;color:var(--primary);margin-top:15px;cursor:pointer" onclick="showReg()">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿç«‹å³è¨»å†Š</p></div><div id="step2" style="display:none"><input type="password" id="pinIn" placeholder="è¼¸å…¥å¯†ç¢¼"><button class="btn" onclick="handlePinLogin()">ç¢ºèªç™»å…¥ ENTER</button><button class="btn" style="background:#eee;color:#666;margin-top:10px" onclick="backStep1()">å›ä¸Šä¸€æ­¥</button></div><div id="stepRegister" style="display:none;text-align:left"><p style="color:var(--primary);font-weight:700;text-align:center;margin-bottom:10px">âœ¨ å»ºç«‹æ–°å¸³è™Ÿ</p><input type="text" id="regId" placeholder="è¨­å®šç™»å…¥å¸³è™Ÿ"><input type="text" id="regNick" placeholder="è¨­å®šé¡¯ç¤ºæš±ç¨±"><input type="password" id="regPass1" placeholder="è¨­å®šå¯†ç¢¼"><input type="password" id="regPass2" placeholder="å†æ¬¡ç¢ºèªå¯†ç¢¼"><input type="text" id="refIn" placeholder="æ¨è–¦äººå¸³è™Ÿ (éå¿…å¡«)"><button class="btn" onclick="handleRegister()">ç¢ºèªè¨»å†Š REGISTER</button><p style="font-size:.7rem;color:#aaa;text-align:center;margin-top:10px;cursor:pointer" onclick="backStep1()">å·²æœ‰å¸³è™Ÿï¼Ÿè¿”å›ç™»å…¥</p></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,onValue,get,update,set} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const _c = { 
    apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco", 
    databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com", 
    projectId: "dream8-7b161", 
    appId: "1:606218522479:web:2737643db3de735af7e29a" 
};

const _app=initializeApp(_c);
const _db=getDatabase(_app);
const _sk=localStorage.getItem('myScratchCode');
let _g={},_cc='ALL',_u=null;

const _mt=document.getElementById('menuToggle'),_md=document.getElementById('menuDropdown');
_mt.onclick=(e)=>{e.stopPropagation();_md.classList.toggle('show')};
window.onclick=()=>_md.classList.remove('show');

window.openAnn=()=>{
    document.getElementById('annModal').style.display='flex';
    _md.classList.remove('show');
};

window.handleUserClick = () => {
    if(_sk) { location.href = 'profile.html'; } else { openLogin(); }
};

window.openLogin=()=>{document.getElementById('loginModal').style.display='flex';backStep1()};
window.showWelcomeToast=(n)=>{const t=document.getElementById('welcomeToast');t.innerText=`âœ¨ æ­¡è¿å›ä¾†ï¼Œ${n}ï¼`;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500)};

function init(){
    // ğŸŸ¢ ä¿®æ­£ 1ï¼šå…ˆç›£è½æœƒå“¡è³‡æ–™ï¼Œå»ºç«‹ã€ŒID -> æš±ç¨±ã€å°ç…§è¡¨
    onValue(ref(_db, 'users'), (userSnap) => {
        const allUsers = userSnap.val() || {};

        // ğŸŸ¢ ä¿®æ­£ 2ï¼šæ¥è‘—ç›£è½ä¸­çç´€éŒ„ï¼Œä¸¦å³æ™‚æŸ¥è¡¨
        onValue(ref(_db, 'winLogs'), (snapshot) => {
            const winData = snapshot.val();
            let winText = "ğŸŠ æ­¡è¿å…‰è‡¨å¤¢å·¥å» ï¼Œç¥æ‚¨å¤§çé€£é€£ï¼ ğŸŠ"; 
            
            if (winData) {
                const sortedWins = Object.values(winData)
                    .sort((a, b) => (b.time || 0) - (a.time || 0))
                    .slice(0, 5);
                
                winText = sortedWins.map(w => {
                    // ğŸ” æš±ç¨±æŸ¥æ‰¾é‚è¼¯ï¼š
                    // 1. å¦‚æœ w.nickname æœ‰å€¼å°±ç”¨å®ƒ
                    // 2. å¦‚æœæ²’æœ‰ï¼Œæ‹¿ w.user å» allUsers æŸ¥
                    // 3. é‚„æ˜¯æ²’æœ‰ï¼Œå°±é¡¯ç¤º 'ç¥ç§˜å®¢'
                    let finalName = w.nickname;
                    if (!finalName && w.user && allUsers[w.user]) {
                        finalName = allUsers[w.user].nickname;
                    }
                    return `ğŸŠ æ­å–œç©å®¶ã€${finalName || 'ç¥ç§˜å®¢'}ã€‘åœ¨ã€Š${w.game}ã€‹åˆ®ä¸­ã€${w.prize}ã€‘ï¼ï¼`;
                }).join(' ã€€ | ã€€ ');
            }
            
            // æ›´æ–°è·‘é¦¬ç‡ˆæ–‡å­—èˆ‡å…¬å‘Š
            get(ref(_db, 'settings/announcement')).then(annSnap => {
                const staticAnn = annSnap.val() || "ç¥å„ä½ç©å®¶éƒ½èƒ½åˆ®ä¸­ï¼å¥½é‹é€£é€£ï¼";
                const finalContent = winText !== "ğŸŠ æ­¡è¿å…‰è‡¨å¤¢å·¥å» ï¼Œç¥æ‚¨å¤§çé€£é€£ï¼ ğŸŠ" 
                    ? `${winText} ã€€ | ã€€ ğŸ“¢ å…¬å‘Šï¼š${staticAnn}` 
                    : staticAnn;
                
                const mq = document.getElementById('mq');
                if(mq) {
                    mq.innerText = finalContent;
                    const duration = Math.max(25, Math.floor(finalContent.length * 0.3));
                    mq.style.animationDuration = duration + 's';
                }
            });
        });
    }); // ğŸŸ¢ é€™è£¡æ­£ç¢ºé–‰åˆäº† onValue

    onValue(ref(_db,'settings/announcement_config'), s => {
        if(s.exists()){
            const config = s.val();
            const wrapper = document.getElementById('annSwiperWrapper');
            if(wrapper) wrapper.innerHTML = ""; 
            
            if(config.active && config.items && config.items.length > 0 && wrapper) {
                config.items.forEach(item => {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    slide.innerHTML = `
                        ${item.img ? `<div class="pop-img-box"><img src="${item.img}"></div>` : ''}
                        <div class="pop-title">${item.title}</div>
                        <div class="pop-text">${item.content}</div>
                    `;
                    wrapper.appendChild(slide);
                });

                new Swiper(".mySwiper", {
                    pagination: { el: ".swiper-pagination", clickable: true },
                    autoHeight: true,
                    observer: true,
                    observeParents: true
                });

                const lastHideDate = localStorage.getItem('hide_ann_date');
                const lastAnnId = localStorage.getItem('last_ann_id');
                const today = new Date().toDateString();

                if(lastAnnId !== config.id || lastHideDate !== today) {
                    const annModal = document.getElementById('annModal');
                    if(annModal) annModal.style.display = 'flex';
                }
            }
        }
    });

    onValue(ref(_db,'gameSettings'),s=>{_g=s.val()||{};renderCats();renderGrid()});
    if(_sk){
        onValue(ref(_db,`users/${_sk}`),s=>{
            const u=s.val(); if(!u)return;
            if(!sessionStorage.getItem('welcomed')){showWelcomeToast(u.nickname||'ç©å®¶');sessionStorage.setItem('welcomed','1')}
        });
    }
}

window.closeModal = () => {
    const isChecked = document.getElementById('noMoreToday').checked;
    const today = new Date().toDateString();
    
    if (isChecked) {
        localStorage.setItem('hide_ann_date', today);
    } else {
        localStorage.removeItem('hide_ann_date');
    }

    get(ref(_db,'settings/announcement_config')).then(s => {
        if(s.exists()) localStorage.setItem('last_ann_id', s.val().id);
    });

    document.getElementById('annModal').style.display = 'none';
};

window.showReg=()=>{
    document.getElementById('step1').style.display='none';
    document.getElementById('stepRegister').style.display='block';
    document.getElementById('loginStepTitle').innerText="è¨»å†Šæ–°å¸³è™Ÿ";
    
    // ğŸŸ¢ æ ¸å¿ƒä¿®æ­£ 3ï¼šå‘¼å«å…¨åŸŸå‡½æ•¸é€²è¡Œå¼·åˆ¶å¸¶å…¥
    if(typeof window.forceApplyRef === 'function') window.forceApplyRef();
};

window.backStep1=()=>{document.getElementById('step1').style.display='block';document.getElementById('step2').style.display='none';document.getElementById('stepRegister').style.display='none';document.getElementById('loginStepTitle').innerText="æœƒå“¡ç™»å…¥"};
window.checkCode=async()=>{const c=document.getElementById('cIn').value.trim();if(!c)return;const s=await get(ref(_db,`users/${c}`));if(!s.exists())return alert("å¸³è™Ÿä¸å­˜åœ¨");_u={id:c,data:s.val()};document.getElementById('step1').style.display='none';document.getElementById('step2').style.display='block'};

window.handleRegister=async()=>{
    // ğŸŸ¢ æ ¸å¿ƒä¿®æ­£ 4ï¼šé€å‡ºè¨»å†Šå‰æœ€å¾Œä¸€åˆ»å†æ¬¡å¼·åˆ¶è®€å–æš«å­˜
    const savedRef = localStorage.getItem('pending_ref');
    const refInput = document.getElementById('refIn');
    if (savedRef && refInput && refInput.value.trim() === "") {
        refInput.value = savedRef;
    }

    const i=document.getElementById('regId').value.trim(),
          n=document.getElementById('regNick').value.trim(),
          p1=document.getElementById('regPass1').value,
          p2=document.getElementById('regPass2').value,
          r=document.getElementById('refIn').value.trim();

    if(!i||!n||!p1||!p2) return alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
    if(p1!==p2) return alert("å¯†ç¢¼ä¸ä¸€è‡´");
    if(i===r) return alert("æ¨è–¦äººä¸èƒ½æ˜¯è‡ªå·±");
    const ex=await get(ref(_db,`users/${i}`));
    if(ex.exists()) return alert("å¸³è™Ÿå·²å­˜åœ¨");
    if(r !== "") {
        const rs=await get(ref(_db,`users/${r}`));
        if(!rs.exists()) return alert("æ¨è–¦äººå¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªæˆ–ç•™ç©º");
    }
    await set(ref(_db,`users/${i}`),{
        balance: 0, commission: 0, nickname: n, pin: p1, invitedBy: r, hasToppedUp: false, createTime: Date.now()
    });
    localStorage.setItem('myScratchCode',i);
    localStorage.removeItem('pending_ref'); 
    alert("è¨»å†ŠæˆåŠŸï¼");
    location.reload();
};

window.handlePinLogin=async()=>{const p=document.getElementById('pinIn').value;if(_u.data.pin!==p)return alert("å¯†ç¢¼éŒ¯èª¤");localStorage.setItem('myScratchCode',_u.id);location.reload()};

function renderCats(){const c=new Set(['ALL']);Object.values(_g).forEach(i=>{if(i.category)c.add(i.category)});document.getElementById('catList').innerHTML=Array.from(c).map(i=>`<div class="cat-item ${_cc===i?'active':''}" onclick="filterCat('${i}')">${i==='ALL'?'å…¨éƒ¨':i}</div>`).join('')}
window.filterCat=c=>{_cc=c;renderCats();renderGrid()};

function renderGrid(){
    const grid=document.getElementById('pGrid');grid.innerHTML='';
    if(_cc==='ALL'){
        const f=document.createElement('div');
        f.className='p-card free-gift';
        f.onclick=()=>window.open('https://www.dream888.fun/live/','_blank');
        f.innerHTML=`<img src="https://firebasestorage.googleapis.com/v0/b/dream8-7b161.firebasestorage.app/o/images%2FChatGPT%20Image%202025%E5%B9%B48%E6%9C%883%E6%97%A5%20%E4%B8%8B%E5%8D%8803_05_35.png?alt=media&token=084fa287-7f52-407d-a785-a4e3ef8ad4d2" class="p-img"><div class="p-info"><div class="p-name">ğŸ ç›´æ’­åˆ®åˆ®æ¨‚</div><div class="free-tag">FREE / é»æˆ‘</div></div>`;
        grid.appendChild(f);
    }
    const keys=Object.keys(_g).sort((a,b)=>(_g[a].order||99)-(_g[b].order||99));
    keys.forEach(id=>{
        const it=_g[id]; if(_cc!=='ALL'&&it.category!==_cc)return;
        const sId=id.replace(/\s+/g,'-');
        const displayTitle = it.name || id;
        const card=document.createElement('div');
        card.className=`p-card ${it.isSoldOut?'soldout':''}`;
        card.onclick=()=>location.href=`game.html?id=${id}`;
        card.innerHTML=`<img src="${it.img||''}" class="p-img"><div class="p-info" id="info-${sId}"><div class="p-name" id="name-${sId}">${displayTitle}</div><div id="status-${sId}"></div><div id="promo-${sId}"></div></div>`;
        grid.appendChild(card);
        onValue(ref(_db,`games/${id}`),s=>{
            const d=s.val()||{},l=d.lock,p=d.pool||[],sB=document.getElementById(`status-${sId}`),pB=document.getElementById(`promo-${sId}`);
            if(!sB)return;
            if(it.isSoldOut){sB.innerHTML=`<div class="soldout-tag">SOLD OUT / å·²åœç›¤</div>`;pB.innerHTML="";}
            else if(l&&l.expire>Date.now()){sB.innerHTML=`<div class="lock-tag">ğŸ”’ ç©å®¶åŒ…å°ä¸­</div>`;pB.innerHTML="";}
            else{
                const sold=p.filter(x=>x.taken).length;
                if(it.promoCount>0&&sold<it.promoCount){
                    sB.innerHTML=`<div class="p-price-value">P${it.promoPrice} <span class="promo-tag">é–‹ç›¤å„ªæƒ </span></div>`;
                    pB.innerHTML=`<div class="promo-info">å‰${it.promoCount}åˆ® P${it.promoPrice} / å¾Œ P${it.price}</div>`;
                }
                else{sB.innerHTML=`<div class="p-price-value">ä¸€åˆ® / P${it.price||0}</div>`;pB.innerHTML="";}
            }
        });
    });
}
init();
</script>
</body>
</html>
