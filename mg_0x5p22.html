<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>DREAM CMS | æ——è‰¦æˆ°ç•¥ä¸­æ§å°</title>
<style>
:root{--p:#ffb800;--bg:#05070a;--card:#11141b;--text:#e2e8f0;--border:rgba(255,184,0,0.3);--lock:#3498db;--success:#2ecc71}
body{font-family:'PingFang TC','Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text);margin:0;display:none;overflow-x:hidden}
.sidebar{width:240px;height:100vh;background:#000;position:fixed;border-right:1px solid var(--border);padding:30px 15px;box-sizing:border-box;z-index:1000;transition:.3s;left:0}
.main{margin-left:240px;padding:20px;padding-top:65px;transition:.3s}
@media screen and (max-width:768px){.sidebar{left:-240px}.sidebar.open{left:0}.main{margin-left:0;padding:15px;padding-top:70px}.menu-toggle{display:block!important}}
.menu-toggle{display:none;position:fixed;top:15px;left:15px;z-index:1100;background:var(--p);color:#000;border:none;padding:10px 15px;border-radius:8px;font-weight:700;cursor:pointer}
.logo{font-size:1.2rem;font-weight:900;color:var(--p);letter-spacing:4px;margin-bottom:40px;text-align:center;border:1px solid var(--p);padding:10px}
.nav-link{padding:12px 15px;margin-bottom:8px;border-radius:10px;cursor:pointer;color:#666;transition:.3s;font-size:.9rem;font-weight:700}
.nav-link:hover,.nav-link.active{background:rgba(255,184,0,.1);color:var(--p)}
.page{display:none;animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.page.active{display:block}
.card{background:var(--card);border-radius:15px;padding:20px;border:1px solid rgba(255,255,255,.05);margin-bottom:20px}
.title{font-size:1.1rem;color:var(--p);font-weight:700;margin-bottom:20px;display:block}
input,textarea,select{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid #333;background:#000;color:#fff;box-sizing:border-box;font-size:.9rem}

.file-input-wrapper { background: #000; border: 1px dashed var(--p); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; cursor: pointer; position: relative; min-height: 50px; display: flex; align-items: center; justify-content: center; }
.file-input-wrapper input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 2; }
.file-input-wrapper span { z-index: 1; font-size: 0.85rem; font-weight: bold; }

.btn{background:var(--p);color:#000;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:800;transition:.2s}
.btn-sm{padding:8px 12px;font-size:.85rem;margin-right:5px;margin-top:5px}
.btn-danger{background:#ff4757;color:#fff}.btn-unlock{background:var(--lock);color:#fff}.btn-success{background:var(--success);color:#fff}

.user-item,.request-item{background:#0a0c10;border:1px solid #222;border-radius:12px;margin-bottom:10px}
.user-header,.request-header{padding:15px;display:flex;justify-content:space-between;align-items:center}
.user-content{display:none;padding:15px;background:#0d1016;border-top:1px solid #222;border-radius:0 0 12px 12px}.user-content.show{display:block}

.win-table{width:100%;border-collapse:collapse;font-size:.85rem}
.win-table th{text-align:left;color:var(--p);padding:10px;border-bottom:2px solid #222}
.win-table td{padding:10px;border-bottom:1px solid #222}
.win-status-row { display: flex; flex-direction: column; gap: 5px; }
.win-shipping-input { padding: 5px !important; margin-bottom: 0 !important; font-size: 0.75rem !important; border: 1px solid #444 !important; }

.dynamic-row{display:flex;gap:10px;margin-bottom:12px;align-items:center;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;border:1px solid #222}
.dynamic-row input { margin-bottom: 0; }
.upload-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid var(--p); flex-shrink: 0; background: #000; }

.safe-box{border:1px solid var(--p);padding:15px;border-radius:12px;background:rgba(255,184,0,0.05);margin-bottom:15px}
.adj-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
</style>
</head>
<body>
<button class="menu-toggle" onclick="toggleSidebar()">â˜° é¸å–®</button>
<div id="logModal" class="log-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center">
Â  Â  <div class="log-box" style="background:var(--card);width:95%;max-width:500px;border-radius:20px;border:1px solid var(--p);padding:25px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center"><h3 id="logUserName" style="margin:0;color:var(--p)">æ­·å²å°å¸³ç´€éŒ„</h3><button class="btn btn-sm" onclick="closeLog()">é—œé–‰</button></div>
Â  Â  Â  Â  <div id="logItems" class="log-list" style="overflow-y:auto;flex-grow:1;margin-top:15px"></div>
Â  Â  </div>
</div>

<div class="sidebar" id="sidebar">
Â  Â  <div class="logo">DREAM ADMIN</div>
Â  Â  <div class="nav-link active" onclick="switchTab('mon')">ğŸ“Š å•†å“ç›£æ§</div>
Â  Â  <div class="nav-link" onclick="switchTab('deposit')">ğŸ’³ å„²å€¼å¯©æ ¸ <span id="depositBadge" style="background:#ff4757; color:#fff; border-radius:50%; padding:2px 6px; font-size:0.6rem; display:none;">0</span></div>
Â  Â  <div class="nav-link" onclick="switchTab('game')">ğŸ“¦ å•†å“ç®¡ç†</div>
Â  Â  <div class="nav-link" onclick="switchTab('win_logs')">ğŸ† ä¸­çç´€éŒ„</div>
Â  Â  <div class="nav-link" onclick="switchTab('user')">ğŸ‘¤ æœƒå“¡è³‡æ–™</div>
Â  Â  <div class="nav-link" onclick="switchTab('ann')">ğŸ“œ å…¬å‘Š/åˆ†é¡</div>
</div>

<div class="main">
Â  Â  <div id="mon" class="page active">
Â  Â  Â  Â  <span class="title">å•†å“å³æ™‚ç›£æ§</span>
Â  Â  Â  Â  <div id="monList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px"></div>
Â  Â  </div>

Â  Â  <div id="deposit" class="page">
Â  Â  Â  Â  <span class="title">å„²å€¼ä¸Šåˆ†ç”³è«‹å¯©æ ¸</span>
Â  Â  Â  Â  <div id="depositListContainer"></div>
Â  Â  </div>

Â  Â  <div id="game" class="page">
Â  Â  Â  Â  <span class="title" id="gameActionTitle">æ–°å¢å•†å“</span>
Â  Â  Â  Â  <div class="card" style="max-width:600px;margin:0 auto">
            <label style="font-size:0.75rem; color:var(--p)">éŠæˆ² ID (ä¸å¯æ”¹)ï¼š</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="gId" placeholder="ID (å¦‚ï¼šA01)">
            
            <label style="font-size:0.75rem; color:var(--p)">å•†å“åç¨± (å¯éš¨æ™‚ä¿®æ”¹)ï¼š</label>
            <input type="text" id="gTitleInput" placeholder="è¼¸å…¥è¦é¡¯ç¤ºçš„æ¨™é¡Œ">

Â  Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="gCat"><option value="">è¼‰å…¥åˆ†é¡ä¸­...</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="gOrder" placeholder="æ’åº" value="99">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="gTotal" placeholder="ç¸½ç±¤æ•¸">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="gPrice" placeholder="å–®æŠ½åŸåƒ¹">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="safe-box">
Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size:0.7rem; color:var(--p); margin-left:5px;">å‰å¹¾æŠ½ä¸ä¸­å¤§ç (ä¿è­·å€)ï¼š</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="gSafeZone" placeholder="å¤§çä¿è­·å€æ•¸é‡" value="0">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="pCount" placeholder="å„ªæƒ å¼µæ•¸">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="pPrice" placeholder="å„ªæƒ åƒ¹æ ¼">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="margin:10px 0; color:var(--p); font-weight:700">å•†å“ä¸»åœ–(å°é¢)ï¼š</div>
Â  Â  Â  Â  Â  Â  <div class="file-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="mainImgStatus">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡ä¸Šå‚³</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" accept="image/*" onchange="handleFileUpload(this, 'gImg', 'mainImgStatus')">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="gImg">Â 

Â  Â  Â  Â  Â  Â  <div style="margin:20px 0 10px; color:var(--p); font-weight:700">å±•ç¤ºåœ–ç‰‡(ç›¸ç°¿)ï¼š</div>
Â  Â  Â  Â  Â  Â  <div id="albumContainer"></div>
Â  Â  Â  Â  Â  Â  <button class="btn btn-sm" onclick="addAlbumInput()" style="width:100%; margin-bottom:20px; background:rgba(255,184,0,0.2); color:var(--p); border:1px solid var(--p)">ï¼‹ æ–°å¢ä¸€å¼µå±•ç¤ºåœ–</button>

Â  Â  Â  Â  Â  Â  <div style="margin:20px 0 10px; color:var(--p); font-weight:700">çé …è¨­å®š (çè™Ÿå¿…é ˆåœ¨ç¸½ç±¤æ•¸å…§)ï¼š</div>
Â  Â  Â  Â  Â  Â  <div id="prizeContainer"></div>
Â  Â  Â  Â  Â  Â  <button class="btn btn-sm" onclick="addPrizeInput()" style="width:100%; background:rgba(255,184,0,0.2); color:var(--p); border:1px solid var(--p)">ï¼‹ æ–°å¢ä¸€å€‹çé …</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:10px;margin-top:30px">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="flex:2" id="publishBtn" onclick="publishGame()">ç™¼å¸ƒä¸¦è‡ªå‹•æ´—ç‰Œ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" style="flex:1;display:none" id="cancelEditBtn" onclick="resetGameForm()">å–æ¶ˆç·¨è¼¯</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <hr style="border:0;border-top:1px solid #333;margin:40px 0">
Â  Â  Â  Â  <div id="quickAdjustList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:15px"></div>
Â  Â  </div>

Â  Â  <div id="win_logs" class="page">
Â  Â  Â  Â  <span class="title">å…¨æœä¸­çå³æ™‚ç´€éŒ„</span>
Â  Â  Â  Â  <div class="card"><table class="win-table"><thead><tr><th>æ™‚é–“/ç©å®¶</th><th>å•†å“/çé …</th><th>å‡ºè²¨ç®¡ç†</th></tr></thead><tbody id="globalWinItems"></tbody></table></div>
Â  Â  </div>

Â  Â  <div id="user" class="page">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span class="title" style="margin:0">æœƒå“¡æ•¸æ“šç®¡ç†</span><button class="btn btn-sm" onclick="createUser()">ï¼‹ æ–°å¢æœƒå“¡</button></div>
Â  Â  Â  Â  <div id="userListContainer"></div>
Â  Â  </div>

Â  Â  <div id="ann" class="page">
Â  Â  Â  Â  <span class="title">é¦–é è·‘é¦¬ç‡ˆå…¬å‘Š</span>
Â  Â  Â  Â  <textarea id="annContent" rows="5" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
Â  Â  Â  Â  <button class="btn" style="width:100%;margin-bottom:30px" onclick="saveAnnouncement()">åŒæ­¥å…¬å‘Š</button>
Â  Â  Â  Â  <span class="title">å•†åŸåˆ†é¡ç®¡ç†</span>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <div id="catManageList"></div>
Â  Â  Â  Â  Â  Â  <div class="dynamic-row" style="margin-top:15px; border:none; background:none; padding:0">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newCatIn" placeholder="æ–°åˆ†é¡åç¨±" style="flex:1">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm" onclick="addNewCat()">æ–°å¢åˆ†é¡</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,set,update,get,onValue,remove,push,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getStorage, ref as sRef, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const _cc = { 
    apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco", 
    databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com", 
    projectId: "dream8-7b161", 
    appId: "1:606218522479:web:2737643db3de735af7e29a",
    storageBucket: "dream8-7b161.firebasestorage.app"
};

const app = initializeApp(_cc);
const db = getDatabase(app);
const storage = getStorage(app);
let isEditing = false;

window.onload=()=>{
Â  Â  const auth = prompt("ç®¡ç†æˆæ¬Šç¢¼:");
Â  Â  if("8888"===auth){
Â  Â  Â  Â  document.body.style.display="block";
Â  Â  Â  Â  startSync();
Â  Â  }else{
Â  Â  Â  Â  location.href="index.html";
Â  Â  }
};

window.handleFileUpload = async (input, targetId, statusId) => {
Â  Â  const file = input.files[0];
Â  Â  if(!file) return;
Â  Â  const status = document.getElementById(statusId);
Â  Â  status.innerText = "â³ ä¸Šå‚³ä¸­...";
Â  Â  status.style.color = "#ffb800";
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
Â  Â  Â  Â  const storageRef = sRef(storage, `images/${fileName}`);
Â  Â  Â  Â  const snapshot = await uploadBytes(storageRef, file);
Â  Â  Â  Â  const url = await getDownloadURL(snapshot.ref);
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById(targetId).value = url;
Â  Â  Â  Â  status.innerText = "âœ… ä¸Šå‚³æˆåŠŸ";
Â  Â  Â  Â  status.style.color = "#2ecc71";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const parentRow = input.closest('.dynamic-row');
Â  Â  Â  Â  if(parentRow) {
Â  Â  Â  Â  Â  Â  const previewImg = parentRow.querySelector('.upload-preview');
Â  Â  Â  Â  Â  Â  if(previewImg) {
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.src = url;
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  0 }
Â  Â  } catch (e) { 
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  status.innerText = "âŒ å¤±æ•—";
Â  Â  Â  Â  status.style.color = "#ff4757";
Â  Â  Â  Â  alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message); 
Â  Â  }
};

window.toggleSidebar=()=>document.getElementById('sidebar').classList.toggle('open');
window.switchTab=id=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));document.getElementById(id).classList.add('active');if(window.innerWidth<=768)toggleSidebar()};
window.toggleUser=uid=>document.getElementById(`content-${uid}`).classList.toggle('show');
window.closeLog=()=>document.getElementById('logModal').style.display='none';

window.addPrizeInput=(num='',name='')=>{
Â  Â  const d=document.createElement('div');
Â  Â  d.className='dynamic-row';
Â  Â  d.innerHTML=`
Â  Â  Â  Â  <input type="number" placeholder="è™Ÿç¢¼" value="${num}" style="flex:1">
Â  Â  Â  Â  <input type="text" placeholder="åç¨±" value="${name}" style="flex:2">
Â  Â  Â  Â  <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()" style="margin-top:0">âœ•</button>
Â  Â  `;
Â  Â  document.getElementById('prizeContainer').appendChild(d)
};

window.addAlbumInput=(url='')=>{
Â  Â  const id = "alb_" + Math.random().toString(36).substr(2, 9);
Â  Â  const d=document.createElement('div');
Â  Â  d.className='dynamic-row';
Â  Â  d.innerHTML=`
Â  Â  Â  Â  <div class="file-input-wrapper" style="flex:1; margin-bottom:0; padding:8px; border-style:solid;">
Â  Â  Â  Â  Â  Â  <span id="st-${id}">${url ? 'âœ… å·²ä¸Šå‚³' : 'é»æ“Šä¸Šå‚³'}</span>
Â  Â  Â  Â  Â  Â  <input type="file" accept="image/*" onchange="handleFileUpload(this, 'in-${id}', 'st-${id}')">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="hidden" id="in-${id}" value="${url}">
Â  Â  Â  Â  <img src="${url || ''}" class="upload-preview" style="${url?'':'display:none'}">
Â  Â  Â  Â  <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()" style="margin-top:0">âœ•</button>
Â  Â  `;
Â  Â  document.getElementById('albumContainer').appendChild(d)
};

function startSync(){
Â  Â  onValue(ref(db,'settings/categories'),s=>{
Â  Â  Â  Â  const list=document.getElementById('catManageList'),select=document.getElementById('gCat'),data=s.val()||[];
Â  Â  Â  Â  list.innerHTML='';select.innerHTML='<option value="">è«‹é¸æ“‡åˆ†é¡</option>';
Â  Â  Â  Â  data.forEach((c,idx)=>{
Â  Â  Â  Â  Â  Â  list.innerHTML+=`<div class="dynamic-row" style="border:none; padding:0; background:none;"><input type="text" value="${c}" onchange="editCat(${idx},this.value)" style="flex:1"><button class="btn btn-sm btn-danger" onclick="delCat(${idx})" style="margin-top:0">åˆªé™¤</button></div>`;
Â  Â  Â  Â  Â  Â  select.innerHTML+=`<option value="${c}">${c}</option>`;
Â  Â  })});

Â  Â  onValue(ref(db,'gameSettings'),s=>{
Â  Â  Â  Â  const list=document.getElementById('monList'),adj=document.getElementById('quickAdjustList'),data=s.val()||{};
Â  Â  Â  Â  list.innerHTML='',adj.innerHTML='';
Â  Â  Â  Â  const keys=Object.keys(data).sort((a,b)=>(data[a].order||99)-(data[b].order||99));
Â  Â  Â  Â  keys.forEach(id=>{
Â  Â  Â  Â  Â  Â  const g=data[id],mon=document.createElement('div');
Â  Â  Â  Â  Â  Â  mon.className='card';
Â  Â  Â  Â  Â  Â  onValue(ref(db,`games/${id}/lock`),ls=>{
Â  Â  Â  Â  Â  Â  Â  Â  const l=ls.val(),isL=l&&l.expire>Date.now(),lT=isL?`<br><small style="color:var(--lock)">ğŸ”’ åŒ…å°ä¸­: ${l.user}</small>`:'',uB=isL?`<button class="btn btn-sm btn-unlock" onclick="forceUnlock('${id}')">ğŸ”“ è§£é–</button>`:'';
Â  Â  Â  Â  Â  Â  Â  Â  mon.innerHTML=`<b>${g.title || id}</b> ${g.isSoldOut?'<span style="color:#ff4757">[å·²åœç›¤]</span>':'<span style="color:#2ecc71">[éŠ·å”®ä¸­]</span>'}<small style="color:#666"> (ID:${id})</small>${lT}<div id="rem-${id}" style="color:var(--p);font-size:1.5rem;margin:10px 0">--</div><button class="btn btn-sm" onclick="loadGameToEdit('${id}')">ç·¨è¼¯</button><button class="btn btn-sm" onclick="resetShuffle('${id}')">æ´—ç‰Œ</button>${uB}<button class="btn btn-sm btn-danger" onclick="deleteGame('${id}')">åˆªé™¤</button>`
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  list.appendChild(mon);
Â  Â  Â  Â  Â  Â  onValue(ref(db,`games/${id}/pool`),ps=>{
Â  Â  Â  Â  Â  Â  Â  Â  const p=ps.val()||[];
Â  Â  Â  Â  Â  Â  Â  Â  if(document.getElementById(`rem-${id}`))document.getElementById(`rem-${id}`).innerText=`å‰©é¤˜ ${p.filter(x=>!x.taken).length} / ${g.total}`
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const aC=document.createElement('div');
Â  Â  Â  Â  Â  Â  aC.className='card';
Â  Â  Â  Â  Â  Â  aC.innerHTML=`<b>${id} èª¿æ§</b><div class="adj-grid" style="margin-top:10px"><input type="number" value="${g.price}" onchange="updNum('${id}','price',this.value)" title="åƒ¹æ ¼"><input type="number" value="${g.order||99}" onchange="updNum('${id}','order',this.value)" title="æ’åº"></div>`;
Â  Â  Â  Â  Â  Â  adj.appendChild(aC)
Â  Â  })});

Â  Â  onValue(ref(db,'winLogs'),s=>{
Â  Â  Â  Â  const l=document.getElementById('globalWinItems');
Â  Â  Â  Â  l.innerHTML=''; const data = s.val() || {};
Â  Â  Â  Â  const entries = Object.keys(data).sort((a,b) => (data[b].time || 0) - (data[a].time || 0)).slice(0,50);
Â  Â  Â  Â  entries.forEach(key => {
Â  Â  Â  Â  Â  Â  const i = data[key];
Â  Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <td><small>${new Date(i.time).toLocaleString()}</small><br><b>${i.user}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><small>${i.game}</small><br><span style="color:var(--p)">${i.prize}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="win-status-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="updateWinStatus('${key}', this.value)" class="win-shipping-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="å¾…å‡ºè²¨" ${i.status==='å¾…å‡ºè²¨'?'selected':''}>å¾…å‡ºè²¨</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="å·²å‡ºè²¨" ${i.status==='å·²å‡ºè²¨'?'selected':''}>å·²å‡ºè²¨</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="å·²å®Œæˆ" ${i.status==='å·²å®Œæˆ'?'selected':''}>å·²å®Œæˆ</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="äº¤è²¨ä¾¿ç·¨è™Ÿ" value="${i.shippingNo||''}" onchange="updateWinShipping('${key}', this.value)" class="win-shipping-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  l.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  });

Â  Â  onValue(ref(db,'users'),s=>{
Â  Â  Â  Â  const c=document.getElementById('userListContainer');
Â  Â  Â  Â  c.innerHTML='';const u=s.val()||{},r={};
Â  Â  Â  Â  Object.values(u).forEach(i=>{if(i.referrer)r[i.referrer]=(r[i.referrer]||0)+1});
Â  Â  Â  Â  Object.entries(u).forEach(([id,d])=>{
Â  Â  Â  Â  Â  Â  const sp=d.logs?Object.values(d.logs).reduce((a,b)=>a+(Number(b.cost)||0),0):0,ic=r[id]||0,i=document.createElement('div');
Â  Â  Â  Â  Â  Â  i.className='user-item';
Â  Â  Â  Â  Â  Â  i.innerHTML=`<div class="user-header" onclick="toggleUser('${id}')"><div><b>${d.nickname||'ç©å®¶'}</b><span class="spent-badge">ç´¯è¨ˆ:${sp.toLocaleString()}P</span>${d.referrer?`<span class="ref-tag">æº:${d.referrer}</span>`:''}${ic>0?`<span class="ref-tag" style="color:#2ecc71;border-color:#2ecc71">é‚€:${ic}äºº</span>`:''}</div><div style="color:var(--p)">${(d.balance||0).toLocaleString()}P â–¼</div></div><div class="user-content" id="content-${id}">UID: ${id} | PIN: ${d.pin||'ç„¡'}<br>${d.referrer?`æ¨è–¦äºº: ${d.referrer}<br>`:'è‡ªè¡Œè¨»å†Š<br>'}é‚€è«‹: ${ic}äºº<div style="margin-top:10px"><button class="btn btn-sm" onclick="showLogs('${id}')">å°å¸³</button><button class="btn btn-sm" onclick="addBal('${id}')">é»æ•¸</button><button class="btn btn-sm" onclick="editPin('${id}')">PIN</button><button class="btn btn-sm btn-danger" onclick="deleteUser('${id}')">åˆªé™¤</button></div></div>`;
Â  Â  Â  Â  Â  Â  c.appendChild(i)
Â  Â  })});

Â  Â  get(ref(db,'settings/announcement')).then(s=>{if(s.exists())document.getElementById('annContent').value=s.val()});

Â  Â  onValue(ref(db, 'depositRequests'), s => {
Â  Â  Â  Â  const container = document.getElementById('depositListContainer');
Â  Â  Â  Â  const badge = document.getElementById('depositBadge');
Â  Â  Â  Â  container.innerHTML = ''; const data = s.val() || {};
Â  Â  Â  Â  const pendingRequests = Object.entries(data).filter(([k, v]) => v.status === 'pending');
Â  Â  Â  Â  if (pendingRequests.length > 0) { badge.innerText = pendingRequests.length; badge.style.display = 'inline-block'; } 
Â  Â  Â  Â  else { badge.style.display = 'none'; container.innerHTML = '<div class="card" style="text-align:center;color:#666;">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç”³è«‹</div>'; }
Â  Â  Â  Â  pendingRequests.sort((a, b) => b[1].time - a[1].time).forEach(([key, req]) => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div'); item.className = 'request-item';
Â  Â  Â  Â  Â  Â  item.innerHTML = `<div class="request-header"><div><b style="color:var(--p)">${req.amount} NTD</b><br><small style="color:#888">UID: ${req.uid} | ${new Date(req.time).toLocaleString()}</small></div><div><button class="btn btn-sm btn-success" onclick="approveDeposit('${key}', '${req.uid}', ${req.amount})">æ ¸å‡†ä¸Šåˆ†</button><button class="btn btn-sm btn-danger" onclick="rejectDeposit('${key}')">æ‹’çµ•/åˆªé™¤</button></div></div>`;
Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  });
Â  Â  });
}

window.updateWinStatus = (key, status) => { update(ref(db, `winLogs/${key}`), { status: status }); };
window.updateWinShipping = (key, no) => { update(ref(db, `winLogs/${key}`), { shippingNo: no }); };

async function runMasterShuffle(id, g) {
Â  Â  const pN = g.prizes.map(p => Number(p.num)); 
Â  Â  let allNumbers = [];
Â  Â  for (let i = 1; i <= g.total; i++) allNumbers.push(i);
Â  Â  for (let i = allNumbers.length - 1; i > 0; i--) {
Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  [allNumbers[i], allNumbers[j]] = [allNumbers[j], allNumbers[i]];
Â  Â  }
Â  Â  let losePool = allNumbers.filter(n => !pN.includes(n));
Â  Â  let winPool = allNumbers.filter(n => pN.includes(n));
Â  Â  const safeZoneSize = Number(g.safeZone) || 0;
Â  Â  let finalNumbers = [];
Â  Â  if (safeZoneSize > 0 && losePool.length >= safeZoneSize) {
Â  Â  Â  Â  const frontSafe = losePool.splice(0, safeZoneSize);
Â  Â  Â  Â  let restMixed = [...losePool, ...winPool];
Â  Â  Â  Â  for (let i = restMixed.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  Â  [restMixed[i], restMixed[j]] = [restMixed[j], restMixed[i]];
Â  Â  Â  Â  }
Â  Â  Â  Â  finalNumbers = [...frontSafe, ...restMixed];
Â  Â  } else {
Â  Â  Â  Â  finalNumbers = allNumbers;
Â  Â  }
Â  Â  const pool = finalNumbers.map(n => ({ grade: Number(n), taken: false, revealed: false }));
Â  Â  await set(ref(db, `games/${id}/pool`), pool);
Â  Â  return true;
}

window.approveDeposit = async (key, uid, amount) => {
Â  Â  if(!confirm(`ç¢ºèªæ”¶åˆ°æ¬¾é …ä¸¦å¹« [${uid}] å¢åŠ  ${amount} P å—ï¼Ÿ`)) return;
Â  Â  try {
Â  Â  Â  Â  const uRef = ref(db, `users/${uid}`);
Â  Â  Â  Â  const snap = await get(uRef);
Â  Â  Â  Â  if(!snap.exists()) return alert("æ‰¾ä¸åˆ°è©²æœƒå“¡");
Â  Â  Â  Â  const uData = snap.val();
Â  Â  Â  Â  await update(uRef, { balance: (uData.balance || 0) + amount });
Â  Â  Â  Â  await push(ref(db, `users/${uid}/logs`), { game: "ç³»çµ±å„²å€¼å…¥é»", cost: -amount, time: serverTimestamp() });
Â  Â  Â  Â  await update(ref(db, `depositRequests/${key}`), { status: 'completed' });
Â  Â  Â  Â  alert("ä¸Šåˆ†æˆåŠŸï¼");
Â  Â  } catch(e) { alert("æ“ä½œå¤±æ•—ï¼š" + e.message); }
};

window.rejectDeposit = async (key) => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å„²å€¼ç”³è«‹å—ï¼Ÿ")) await remove(ref(db, `depositRequests/${key}`)); };
window.addNewCat=async()=>{const v=document.getElementById('newCatIn').value.trim();if(!v)return;const s=await get(ref(db,'settings/categories')),data=s.val()||[];data.push(v);await set(ref(db,'settings/categories'),data);document.getElementById('newCatIn').value=''};
window.editCat=async(idx,v)=>{const s=await get(ref(db,'settings/categories')),data=s.val()||[];data[idx]=v;await set(ref(db,'settings/categories'),data)};
window.delCat=async(idx)=>{if(confirm("åˆªé™¤åˆ†é¡ï¼Ÿ")){const s=await get(ref(db,'settings/categories')),data=s.val()||[];data.splice(idx,1);await set(ref(db,'settings/categories'),data)}};
window.forceUnlock=async id=>{if(confirm(`è§£é™¤ [${id}] åŒ…å°ï¼Ÿ`)){await remove(ref(db,`games/${id}/lock`));alert("å·²è§£é–")}};

window.publishGame = async () => {
Â  Â  const id = document.getElementById('gId').value.trim();
    const title = document.getElementById('gTitleInput').value.trim(); // ğŸ”´ æ–°å¢ï¼šç²å–æ¨™é¡Œ
    const tot = Number(document.getElementById('gTotal').value), cat = document.getElementById('gCat').value;
Â  Â  const prRows = Array.from(document.querySelectorAll('#prizeContainer .dynamic-row'));
Â  Â  const prs = prRows.map(r => ({ num: Number(r.querySelectorAll('input')[0].value), name: r.querySelectorAll('input')[1].value }));
Â  Â  const albRows = Array.from(document.querySelectorAll('#albumContainer .dynamic-row'));
Â  Â  const alb = albRows.map(r => r.querySelector('input[type="hidden"]').value).filter(v => v.trim());
Â  Â Â 
Â  Â  if (!id || !title || !tot || 0 === prs.length || !cat) return alert("è³‡è¨Šä¸å…¨(IDã€åç¨±ã€åˆ†é¡å¿…å¡«)");
Â  Â  const d = { title: title, total: tot, price: Number(document.getElementById('gPrice').value), prizes: prs, album: alb, safeZone: Number(document.getElementById('gSafeZone').value) || 0, img: document.getElementById('gImg').value, promoCount: Number(document.getElementById('pCount').value) || 0, promoPrice: Number(document.getElementById('pPrice').value) || 0, category: cat, order: Number(document.getElementById('gOrder').value) || 99, isSoldOut: false };
Â  Â  if(!d.img) return alert("è«‹å‹™å¿…ä¸Šå‚³å°é¢åœ–ç‰‡");
Â  Â Â 
Â  Â  await update(ref(db, `gameSettings/${id}`), d);
Â  Â  if (!isEditing) { await runMasterShuffle(id, d); alert("ç™¼å¸ƒæˆåŠŸ"); } else alert("æ›´æ–°æˆåŠŸ");
Â  Â  resetGameForm();
};

window.resetShuffle = async id => {
Â  Â  if (confirm(`ã€è­¦å‘Šã€‘ç¢ºå®šé‡æ–°æ´—ç‰Œ [${id}]ï¼Ÿ\næ­¤æ“ä½œå°‡é‡ç½®æ‰€æœ‰æ ¼ä½ä¸¦æ‰“äº‚çè™Ÿé †åºã€‚`)) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const s = await get(ref(db, `gameSettings/${id}`)), g = s.val();
Â  Â  Â  Â  Â  Â  if (!g) return alert("æ‰¾ä¸åˆ°è¨­å®š");
Â  Â  Â  Â  Â  Â  await runMasterShuffle(id, g);
Â  Â  Â  Â  Â  Â  await update(ref(db, `gameSettings/${id}`), { isSoldOut: false });
Â  Â  Â  Â  Â  Â  await remove(ref(db, `games/${id}/lock`));
Â  Â  Â  Â  Â  Â  alert(`[${id}] æ´—ç‰ŒæˆåŠŸï¼`);
Â  Â  Â  Â  } catch (e) { alert("æ´—ç‰Œå¤±æ•—ï¼š" + e.message); }
Â  Â  }
};

window.loadGameToEdit=async id=>{
Â  Â  const s=await get(ref(db,`gameSettings/${id}`)),g=s.val();
Â  Â  if(!g)return;
Â  Â  isEditing=true;
Â  Â  document.getElementById('gId').value=id;
Â  Â  document.getElementById('gId').disabled=true;
    document.getElementById('gTitleInput').value=g.title || id; // ğŸ”´ æ–°å¢ï¼šè¼‰å…¥æ¨™é¡Œ
Â  Â  document.getElementById('gCat').value=g.category;
Â  Â  document.getElementById('gTotal').value=g.total;
Â  Â  document.getElementById('gPrice').value=g.price;
Â  Â  document.getElementById('gSafeZone').value=g.safeZone||0;
Â  Â  document.getElementById('pCount').value=g.promoCount||0;
Â  Â  document.getElementById('pPrice').value=g.promoPrice||0;
Â  Â  document.getElementById('gImg').value=g.img;
Â  Â  document.getElementById('mainImgStatus').innerText = "âœ… å·²æœ‰åœ–ç‰‡ (å¯é»æ“Šæ›´æ›)";
Â  Â  document.getElementById('gOrder').value=g.order||99;
Â  Â Â 
Â  Â  const aC=document.getElementById('albumContainer'); aC.innerHTML='';
Â  Â  if(g.album) g.album.forEach(u=>addAlbumInput(u));
Â  Â Â 
Â  Â  const pC=document.getElementById('prizeContainer'); pC.innerHTML='';
Â  Â  g.prizes.forEach(p=>addPrizeInput(p.num,p.name));
Â  Â Â 
Â  Â  document.getElementById('gameActionTitle').innerText="æ­£åœ¨ç·¨è¼¯ï¼š" + (g.title || id);
Â  Â  document.getElementById('publishBtn').innerText="å„²å­˜æ›´æ–°è³‡è¨Š";
Â  Â  document.getElementById('cancelEditBtn').style.display="block";
Â  Â  switchTab('game');
Â  Â  window.scrollTo({top: 0, behavior: 'smooth'});
};

window.resetGameForm=()=>{
Â  Â  isEditing=false;
Â  Â  document.getElementById('gId').value='';
    document.getElementById('gTitleInput').value=''; // ğŸ”´ æ–°å¢ï¼šæ¸…ç©ºæ¨™é¡Œ
Â  Â  document.getElementById('gId').disabled=false;
Â  Â  document.getElementById('prizeContainer').innerHTML='';
Â  Â  document.getElementById('albumContainer').innerHTML='';
Â  Â  document.getElementById('cancelEditBtn').style.display="none";
Â  Â  document.getElementById('gameActionTitle').innerText="æ–°å¢å•†å“";
Â  Â  document.getElementById('publishBtn').innerText="ç™¼å¸ƒä¸¦æ´—ç‰Œ";
Â  Â  document.getElementById('mainImgStatus').innerText="é»æ“Šä¸Šå‚³åœ–ç‰‡";
Â  Â  document.getElementById('gImg').value='';
};

window.showLogs=async uid=>{
Â  Â  const s=await get(ref(db,`users/${uid}/logs`)),l=s.val()||{},c=document.getElementById('logItems');
Â  Â  c.innerHTML='';
Â  Â  Object.values(l).reverse().forEach(i=>{
Â  Â  Â  Â  c.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #222;display:flex;justify-content:space-between;"><span>${i.game}<br><small>${new Date(i.time).toLocaleString()}</small></span><b style="color:${Number(i.cost)>0?'#ff4757':'#2ecc71'}">${Number(i.cost)>0?'-':'+'}${Math.abs(i.cost)}P</b></div>`
Â  Â  });
Â  Â  document.getElementById('logModal').style.display='flex'
};

window.updNum=(id,f,v)=>update(ref(db,`gameSettings/${id}`),{[f]:Number(v)});
window.addBal=async uid=>{const a=prompt("èª¿æ•´é¤˜é¡ (æ­£æ•¸åŠ åˆ†ï¼Œè² æ•¸æ‰£åˆ†):");if(a){const s=await get(ref(db,`users/${uid}/balance`));await update(ref(db,`users/${uid}`),{balance:(s.val()||0)+parseInt(a)})}};
window.editPin=async uid=>{const p=prompt("æ–° PIN:");if(p)update(ref(db,`users/${uid}`),{pin:p})};
window.deleteGame=async id=>{if(confirm("ç¢ºå®šåˆªé™¤å•†å“ï¼Ÿé€™æœƒåŒæ™‚åˆªé™¤æ‰€æœ‰åˆ®çç´€éŒ„ä¸”ç„¡æ³•å¾©åŸï¼")){remove(ref(db,`gameSettings/${id}`));remove(ref(db,`games/${id}`))}};
window.deleteUser=async uid=>{if(confirm("ç¢ºå®šåˆªé™¤æœƒå“¡ï¼Ÿ"))remove(ref(db,`users/${uid}`))};
window.saveAnnouncement=async()=>{await set(ref(db,'settings/announcement'),document.getElementById('annContent').value);alert("é¦–é å…¬å‘ŠåŒæ­¥å®Œæˆ")};
window.createUser=async()=>{const u=prompt("æ–°å¸³è™Ÿ ID:");if(u)set(ref(db,`users/${u}`),{balance:0,nickname:"æ–°ç©å®¶",pin:"123456"})};
</script>
</body>
</html>
