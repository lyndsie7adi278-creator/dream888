<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å·¥å» æ§åˆ¶å° | æ——è‰¦ç®¡ç†ç‰ˆ</title>
    <style>
        :root { --primary: #ff8fa3; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 2px solid var(--primary); padding: 20px 0; margin-bottom: 30px; }
        
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
        h3 { color: var(--primary); margin-top: 0; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        label { font-size: 0.8rem; color: #94a3b8; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0 15px; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 1rem; box-sizing: border-box; }
        textarea { height: 100px; font-family: monospace; }
        
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .btn:active { transform: scale(0.98); }
        .btn-query { background: #64748b; margin-bottom: 15px; }
        .btn-reset { background: #e11d48; margin-top: 10px; }

        .info-panel { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; }
        .highlight { color: #22c55e; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ADMIN SYSTEM</h1></div>

    <div class="card">
        <h3>ğŸ‘¤ æœƒå“¡å¸³è™Ÿç®¡ç†</h3>
        <label>æœƒå“¡ä»£ç¢¼ (å¦‚: DREAM001)</label>
        <input type="text" id="targetId" placeholder="è¼¸å…¥ä»£ç¢¼" oninput="this.value = this.value.toUpperCase()">
        
        <button class="btn btn-query" onclick="queryUser()">ğŸ” æŸ¥è©¢ / å»ºç«‹æœƒå“¡</button>

        <div id="userResult" style="display:none;" class="info-panel">
            <div>ç‹€æ…‹ï¼š<span id="uStatus" class="highlight">--</span></div>
            <div style="margin: 10px 0;">ç›®å‰é»æ•¸ï¼šP <span id="uBalDisplay" style="color:var(--primary); font-weight:bold;">0</span></div>
            <label>ä¿®æ”¹é»æ•¸ (ç›´æ¥è¼¸å…¥æ•¸å­—ï¼Œæˆ– +500, -200)</label>
            <input type="text" id="newBal" placeholder="è¨­å®šé»æ•¸">
            <button class="btn" onclick="saveUserBal()">ç¢ºèªæ›´æ–°é»æ•¸</button>
            <button class="btn btn-reset" onclick="resetUserPin()">âŒ é‡ç½® 6 ä½æ•¸å¯†ç¢¼é–</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“¦ éŠæˆ²ä¸Šæ¶èˆ‡æ›´æ–°</h3>
        <label>éŠæˆ² ID (ä¾‹å¦‚: LEGO_01)</label>
        <input type="text" id="gId" placeholder="LEGO_01">
        
        <label>åˆ†é¡æ¨™ç±¤ (ä¾‹å¦‚: æ¨‚é«˜ã€å…¬ä»”)</label>
        <input type="text" id="gCat" placeholder="æ¨‚é«˜">

        <label>å–®æŠ½åƒ¹æ ¼</label>
        <input type="number" id="gPrice" placeholder="100">

        <label>ç¸½ç±¤æ•¸</label>
        <input type="number" id="gTotal" placeholder="80">

        <label>çé …åœ–ç‰‡ç¶²å€ (ä¸»åœ–)</label>
        <input type="text" id="gImg" placeholder="https://...">

        <label>å¤šéšç´šçé …é…ç½® (JSON æ ¼å¼)</label>
        <p style="font-size:0.7rem; color:#888;">[{"num":8, "name":"é ­ç", "img":""}, {"num":1, "name":"äºŒç", "img":""}]</p>
        <textarea id="gPrizes">[{"num":8, "name":"é ­ç", "img":""}]</textarea>

        <button class="btn" onclick="publishGame()">ğŸš€ ç™¼ä½ˆä¸¦åˆå§‹åŒ–æ´—ç‰Œ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { 
        apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE",
        databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com",
        projectId: "dream-169dc",
        appId: "1:214137228622:web:84d14bad85d865ee94e21f"
    };
    const app = initializeApp(config);
    const db = getDatabase(app);

    // --- æœƒå“¡ç®¡ç†åŠŸèƒ½ ---
    window.queryUser = async () => {
        const id = document.getElementById('targetId').value.trim();
        if(!id) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
        
        const s = await get(ref(db, `users/${id}`));
        const resDiv = document.getElementById('userResult');
        resDiv.style.display = "block";

        if(s.exists()) {
            const data = s.val();
            document.getElementById('uStatus').innerText = "å·²å­˜åœ¨æœƒå“¡";
            document.getElementById('uBalDisplay').innerText = (data.balance || 0).toLocaleString();
        } else {
            document.getElementById('uStatus').innerText = "æ–°å¸³è™Ÿ (å°šæœªå»ºç«‹)";
            document.getElementById('uBalDisplay').innerText = "0";
            if(confirm(`ä»£ç¢¼ ${id} å°šä¸å­˜åœ¨ï¼Œæ˜¯å¦ç›´æ¥å»ºç«‹æ­¤æœƒå“¡ï¼Ÿ`)) {
                await set(ref(db, `users/${id}`), { balance: 0, pin: "" });
                alert("æœƒå“¡å»ºç«‹æˆåŠŸï¼");
                queryUser();
            }
        }
    };

    window.saveUserBal = async () => {
        const id = document.getElementById('targetId').value.trim();
        const input = document.getElementById('newBal').value.trim();
        const s = await get(ref(db, `users/${id}`));
        let curBal = s.val().balance || 0;
        let finalBal;

        if(input.startsWith('+')) finalBal = curBal + parseInt(input.slice(1));
        else if(input.startsWith('-')) finalBal = curBal - parseInt(input.slice(1));
        else finalBal = parseInt(input);

        if(isNaN(finalBal)) return alert("è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—");
        await update(ref(db, `users/${id}`), { balance: finalBal });
        alert("æ›´æ–°æˆåŠŸï¼");
        queryUser();
    };

    window.resetUserPin = async () => {
        const id = document.getElementById('targetId').value.trim();
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ­¤æœƒå“¡çš„ 6 ä½æ•¸å¯†ç¢¼é–å—ï¼Ÿ")) {
            await update(ref(db, `users/${id}`), { pin: "" });
            alert("å¯†ç¢¼å·²æ¸…é™¤");
        }
    };

    // --- éŠæˆ²ç®¡ç†åŠŸèƒ½ ---
    window.publishGame = async () => {
        const id = document.getElementById('gId').value.trim();
        const category = document.getElementById('gCat').value.trim() || "æœªåˆ†é¡";
        const price = parseInt(document.getElementById('gPrice').value);
        const total = parseInt(document.getElementById('gTotal').value);
        const img = document.getElementById('gImg').value.trim();
        let prizes;

        try {
            prizes = JSON.parse(document.getElementById('gPrizes').value);
        } catch(e) { return alert("çé … JSON æ ¼å¼éŒ¯èª¤ï¼"); }

        if(!id || isNaN(price) || isNaN(total)) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

        // 1. å¯«å…¥åƒæ•¸
        await set(ref(db, `gameSettings/${id}`), { price, total, prizes, img, category });

        // 2. åˆå§‹åŒ–æ´—ç‰Œ
        let pool = [];
        for(let i=1; i<=total; i++) pool.push(i);
        pool.sort(() => Math.random() - 0.5);
        await set(ref(db, `games/${id}/pool`), pool.map(v => ({ grade: v, taken: false })));
        
        alert(`éŠæˆ² ${id} ç™¼ä½ˆæˆåŠŸï¼Œå·²è‡ªå‹•æ´—ç‰Œï¼`);
    };
</script>
</body>
</html>
