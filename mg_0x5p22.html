<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>DREAM CMS | æ——è‰¦æˆ°ç•¥ä¸­æ§å°</title>
<style>
:root{--p:#ffb800;--bg:#05070a;--card:#11141b;--text:#e2e8f0;--border:rgba(255,184,0,0.3);--lock:#3498db;--success:#2ecc71}
body{font-family:'PingFang TC','Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text);margin:0;display:none;overflow-x:hidden}
.sidebar{width:240px;height:100vh;background:#000;position:fixed;border-right:1px solid var(--border);padding:30px 15px;box-sizing:border-box;z-index:1000;transition:.3s;left:0}
.main{margin-left:240px;padding:20px;padding-top:65px;transition:.3s}
@media screen and (max-width:768px){.sidebar{left:-240px}.sidebar.open{left:0}.main{margin-left:0;padding:15px;padding-top:70px}.menu-toggle{display:block!important}}
.menu-toggle{display:none;position:fixed;top:15px;left:15px;z-index:1100;background:var(--p);color:#000;border:none;padding:10px 15px;border-radius:8px;font-weight:700;cursor:pointer}
.logo{font-size:1.2rem;font-weight:900;color:var(--p);letter-spacing:4px;margin-bottom:40px;text-align:center;border:1px solid var(--p);padding:10px}
.nav-link{padding:12px 15px;margin-bottom:8px;border-radius:10px;cursor:pointer;color:#666;transition:.3s;font-size:.9rem;font-weight:700}
.nav-link:hover,.nav-link.active{background:rgba(255,184,0,.1);color:var(--p)}
.page{display:none;animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.page.active{display:block}
.card{background:var(--card);border-radius:15px;padding:20px;border:1px solid rgba(255,255,255,.05);margin-bottom:20px}
.title{font-size:1.1rem;color:var(--p);font-weight:700;margin-bottom:20px;display:block}
input,textarea,select{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:1px solid #333;background:#000;color:#fff;box-sizing:border-box;font-size:.9rem}
.file-input-wrapper { background: #000; border: 1px dashed var(--p); padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; cursor: pointer; position: relative; min-height: 50px; display: flex; align-items: center; justify-content: center; }
.file-input-wrapper input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 2; }
.file-input-wrapper span { z-index: 1; font-size: 0.85rem; font-weight: bold; }
.btn{background:var(--p);color:#000;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:800;transition:.2s}
.btn-sm{padding:8px 12px;font-size:.85rem;margin-right:5px;margin-top:5px}
.btn-danger{background:#ff4757;color:#fff}.btn-unlock{background:var(--lock);color:#fff}.btn-success{background:var(--success);color:#fff}
.user-item,.request-item{background:#0a0c10;border:1px solid #222;border-radius:12px;margin-bottom:10px}
.user-header,.request-header{padding:15px;display:flex;justify-content:space-between;align-items:center}
.user-content{display:none;padding:15px;background:#0d1016;border-top:1px solid #222;border-radius:0 0 12px 12px}.user-content.show{display:block}
.win-table{width:100%;border-collapse:collapse;font-size:.85rem}
.win-table th{text-align:left;color:var(--p);padding:10px;border-bottom:2px solid #222}
.win-table td{padding:10px;border-bottom:1px solid #222}
.win-status-row { display: flex; flex-direction: column; gap: 5px; }
.win-shipping-input { padding: 5px !important; margin-bottom: 0 !important; font-size: 0.75rem !important; border: 1px solid #444 !important; }
.dynamic-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: rgba(255,255,255,0.02); padding: 10px; border-radius: 8px; border: 1px solid #222; box-sizing: border-box; }
.dynamic-row input[type="number"] { width: 70px !important; flex: none !important; margin-bottom: 0 !important; }
.dynamic-row input[type="text"] { flex: 1 !important; margin-bottom: 0 !important; }
.dynamic-row .btn-danger { margin-top: 0 !important; flex: none !important; width: 42px; height: 42px; padding: 0 !important; display: flex; align-items: center; justify-content: center; }
.upload-preview { width: 42px; height: 42px; object-fit: cover; border-radius: 6px; border: 1px solid var(--p); flex-shrink: 0; background: #000; }
.mini-upload-btn { position: relative; width: 42px; height: 42px; background: #222; border: 1px dashed #666; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
.mini-upload-btn input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.safe-box{border:1px solid var(--p);padding:15px;border-radius:12px;background:rgba(255,184,0,0.05);margin-bottom:15px}
.adj-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.spent-badge { font-size: 0.7rem; color: #aaa; margin-left: 10px; border: 1px solid #333; padding: 2px 6px; border-radius: 4px; }
.ref-tag { font-size: 0.65rem; padding: 2px 5px; border: 1px solid var(--p); color: var(--p); border-radius: 4px; margin-left: 5px; }
#globalLoading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 30000; flex-direction: column; align-items: center; justify-content: center; color: #fff; }
.spinner { width: 45px; height: 45px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--p); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.mon-filter-bar { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px; padding-bottom: 5px; scrollbar-width: none; }
.filter-btn { flex-shrink: 0; padding: 8px 15px; background: #1a1d24; border: 1px solid #333; border-radius: 30px; color: #888; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
.filter-btn.active { background: var(--p); color: #000; border-color: var(--p); }

.ship-info-card { background: rgba(46,204,113,0.1); border: 1px solid rgba(46,204,113,0.3); padding: 12px; border-radius: 10px; margin: 10px 0; font-size: 0.8rem; line-height: 1.6; }
.ship-label { color: var(--success); font-weight: bold; margin-right: 5px; }

.rep-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
.rep-item { background: #0a0c10; padding: 15px; border-radius: 12px; border: 1px solid #222; border-left: 4px solid var(--p); }
</style>
</head>
<body>
<div id="globalLoading"><div class="spinner"></div><div id="loadingText">è™•ç†ä¸­...</div></div>
<button class="menu-toggle" onclick="toggleSidebar()">â˜° é¸å–®</button>
<div id="logModal" class="log-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center">
<div class="log-box" style="background:var(--card);width:95%;max-width:500px;border-radius:20px;border:1px solid var(--p);padding:25px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
<div style="display:flex;justify-content:space-between;align-items:center"><h3 id="logUserName" style="margin:0;color:var(--p)">æ˜ç´°èˆ‡å°å¸³</h3><button class="btn btn-sm" onclick="closeLog()">é—œé–‰</button></div>
<div id="logTabs" style="display:flex; gap:10px; margin-top:15px;"><button class="btn btn-sm" onclick="showUserSubTab('spend')">æ¶ˆè²»æ—¥èªŒ</button><button class="btn btn-sm" onclick="showUserSubTab('comm')">åˆ†æ½¤æ˜ç´°</button></div>
<div id="logItems" class="log-list" style="overflow-y:auto;flex-grow:1;margin-top:15px"></div></div></div>
<div class="sidebar" id="sidebar">
    <div class="logo">DREAM ADMIN</div>
    <div class="nav-link active" onclick="switchTab('report_page')">ğŸ“ˆ æ•¸æ“šå ±è¡¨</div>
    <div class="nav-link" onclick="switchTab('mon')">ğŸ“Š å•†å“ç›£æ§</div>
    <div class="nav-link" onclick="switchTab('deposit')">ğŸ’³ å„²å€¼å¯©æ ¸ <span id="depositBadge" style="background:#ff4757; color:#fff; border-radius:50%; padding:2px 6px; font-size:0.6rem; display:none;">0</span></div>
    <div class="nav-link" onclick="switchTab('game')">ğŸ“¦ å•†å“ç®¡ç†</div>
    <div class="nav-link" onclick="switchTab('win_logs')">ğŸ† ä¸­çç´€éŒ„</div>
    <div class="nav-link" onclick="switchTab('user')">ğŸ‘¤ æœƒå“¡è³‡æ–™</div>
    <div class="nav-link" onclick="switchTab('ann')">ğŸ“œ å…¬å‘Š/åˆ†é¡</div>
</div>

<div class="main">
    <div id="report_page" class="page active">
        <span class="title">ç‡Ÿé‹æ•¸æ“šçµ±è¨ˆå ±è¡¨</span>
        <div class="card">
            <div id="repTitle" style="font-size: 1rem; color: var(--p); margin-bottom: 15px; font-weight: bold;">ğŸ“… æ•¸æ“šæŸ¥è©¢</div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="date" id="repDate" style="margin: 0; flex: 1; min-width: 150px;">
                <button class="btn btn-sm" onclick="fetchDailyReport()" style="margin: 0; width: 100px;">å–®æ—¥æŸ¥è©¢</button>
                <button class="btn btn-sm btn-success" onclick="fetchMonthlyReport()" style="margin: 0; width: 100px;">ç•¶æœˆç¸½è¨ˆ</button>
            </div>
        </div>
        <div class="rep-grid">
            <div class="rep-item"><small style="color:#888">æ¶ˆè²»ç¸½é¡ (P)</small><div id="rRev" style="font-size:1.5rem; font-weight:900; color:var(--p); margin-top:5px;">0</div></div>
            <div class="rep-item"><small style="color:#888">åŠ é»ç¸½é¡ (P)</small><div id="rDep" style="font-size:1.5rem; font-weight:900; color:var(--success); margin-top:5px;">0</div></div>
            <div class="rep-item"><small style="color:#888">ç¸½åˆ®å–æ¬¡æ•¸</small><div id="rCnt" style="font-size:1.5rem; font-weight:900; color:#fff; margin-top:5px;">0</div></div>
        </div>
        <div class="card">
            <span class="title" style="font-size: 0.9rem;">å•†å“éŠ·å”®æ˜ç´° / åˆ†ä½ˆ</span>
            <div id="rList" style="font-size: 0.85rem; line-height: 1.8;">é¸æ“‡æ—¥æœŸæˆ–æœˆä»½é»æ“ŠæŸ¥è©¢...</div>
        </div>
        <div class="card">
            <span class="title" style="font-size: 0.9rem;">ä¸­çç´€éŒ„</span>
            <table class="win-table">
                <thead><tr><th>ç©å®¶</th><th>çé …</th><th>æ™‚é–“</th></tr></thead>
                <tbody id="rWins"></tbody>
            </table>
        </div>
    </div>

<div id="mon" class="page"><span class="title">å•†å“å³æ™‚ç›£æ§</span>
<div id="monFilters" class="mon-filter-bar"></div>
<div id="monList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px"></div></div>
<div id="deposit" class="page"><span class="title">å„²å€¼ä¸Šåˆ†ç”³è«‹å¯©æ ¸</span><div id="depositListContainer"></div></div>

<div id="game" class="page"><span class="title" id="gameActionTitle">æ–°å¢å•†å“</span>
<div class="card" style="max-width:600px;margin:0 auto">
<input type="text" id="gId" placeholder="éŠæˆ² ID (å¦‚ï¼šA01)">
<input type="text" id="gName" placeholder="å•†å“åç¨± (å¯éš¨æ™‚ä¿®æ”¹çš„æ¨™é¡Œ)">
<div style="display:grid;grid-template-columns:2fr 1fr;gap:10px"><select id="gCat"><option value="">è¼‰å…¥åˆ†é¡ä¸­...</option></select><input type="number" id="gOrder" placeholder="æ’åº" value="99"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input type="number" id="gTotal" placeholder="ç¸½ç±¤æ•¸"><input type="number" id="gPrice" placeholder="å–®æŠ½åŸåƒ¹"></div>
<div class="safe-box"><label style="font-size:0.7rem; color:var(--p); margin-left:5px;">å‰å¹¾æŠ½ä¸ä¸­å¤§ç (ä¿è­·å€)ï¼š</label><input type="number" id="gSafeZone" placeholder="å¤§çä¿è­·å€æ•¸é‡" value="0">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px"><input type="number" id="pCount" placeholder="å„ªæƒ å¼µæ•¸"><input type="number" id="pPrice" placeholder="å„ªæƒ åƒ¹æ ¼"></div></div>
<div class="file-input-wrapper"><span id="mainImgStatus">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡ä¸Šå‚³</span><input type="file" accept="image/*" onchange="handleFileUpload(this, 'gImg', 'mainImgStatus')"></div><input type="hidden" id="gImg"> 
<div style="margin:20px 0 10px; color:var(--p); font-weight:700">å±•ç¤ºåœ–ç‰‡(ç›¸ç°¿)ï¼š</div><div id="albumContainer"></div><button class="btn btn-sm" onclick="addAlbumInput()" style="width:100%; margin-bottom:20px; background:rgba(255,184,0,0.2); color:var(--p); border:1px solid var(--p)">ï¼‹ æ–°å¢ä¸€å¼µå±•ç¤ºåœ–</button>

<div style="margin:20px 0 10px; color:var(--p); font-weight:700">çé …è¨­å®š (çè™Ÿå¿…é ˆåœ¨ç¸½ç±¤æ•¸å…§)ï¼š</div>
<div id="prizeContainer"></div>
<button class="btn btn-sm" onclick="addPrizeInput()" style="width:100%; background:rgba(255,184,0,0.2); color:var(--p); border:1px solid var(--p)">ï¼‹ æ–°å¢ä¸€å€‹çé … (å«åœ–ç‰‡)</button>

<div style="display:flex;gap:10px;margin-top:30px"><button class="btn" style="flex:2" id="publishBtn" onclick="publishGame()">ç™¼å¸ƒä¸¦è‡ªå‹•æ´—ç‰Œ</button><button class="btn btn-danger" style="flex:1;display:none" id="cancelEditBtn" onclick="resetGameForm()">å–æ¶ˆç·¨è¼¯</button></div></div>
<hr style="border:0;border-top:1px solid #333;margin:40px 0"><div id="quickAdjustList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:15px"></div></div>
<div id="win_logs" class="page"><span class="title">å…¨æœä¸­çå³æ™‚ç´€éŒ„</span><div class="card"><table class="win-table"><thead><tr><th>æ™‚é–“/ç©å®¶</th><th>å•†å“/çé …</th><th>å‡ºè²¨ç®¡ç†</th></tr></thead><tbody id="globalWinItems"></tbody></table></div></div>
<div id="user" class="page"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><span class="title" style="margin:0">æœƒå“¡æ•¸æ“šç®¡ç†</span><button class="btn btn-sm" onclick="createUser()">ï¼‹ æ–°å¢æœƒå“¡</button></div><div id="userListContainer"></div></div>

<div id="ann" class="page">
    <span class="title">é¦–é è·‘é¦¬ç‡ˆå…¬å‘Š</span>
    <textarea id="annContent" rows="3" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
    <button class="btn" style="width:100%;margin-bottom:30px" onclick="saveAnnouncement()">åŒæ­¥è·‘é¦¬ç‡ˆå…§å®¹</button>

    <span class="title">å¤šé‡å½ˆçª—å…¬å‘Šç®¡ç†</span>
    <div class="card">
        <div id="popListContainer"></div>
        <button class="btn btn-sm" onclick="addNewPopItem()" style="width:100%; background:rgba(52,152,219,0.2); color:#3498db; border:1px solid #3498db; margin-top:15px">ï¼‹ æ–°å¢ä¸€å‰‡å…¬å‘Šå…§å®¹</button>
        <hr style="border:0; border-top:1px solid #333; margin:25px 0">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label style="font-size:0.75rem; color:var(--p)">å…¬å‘Š IDï¼š</label><input type="text" id="popId" placeholder="ä¾‹å¦‚: 20260204"></div>
          <div><label style="font-size:0.75rem; color:var(--p)">æ˜¯å¦å•Ÿç”¨ï¼š</label><select id="popActive"><option value="true">å•Ÿç”¨</option><option value="false">åœç”¨</option></select></div>
        </div>
        <button class="btn btn-success" style="width:100%; margin-top:10px" onclick="savePopConfigs()">åŒæ­¥ç™¼ä½ˆæ‰€æœ‰å½ˆçª—</button>
    </div>

    <span class="title">å•†åŸåˆ†é¡ç®¡ç†</span>
    <div class="card">
        <div id="catManageList"></div>
        <div class="dynamic-row" style="margin-top:15px; border:none; background:none; padding:0">
            <input type="text" id="newCatIn" placeholder="æ–°åˆ†é¡åç¨±" style="flex:1">
            <button class="btn btn-sm" onclick="addNewCat()">æ–°å¢åˆ†é¡</button>
        </div>
    </div>
</div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,set,update,get,onValue,remove,push,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {getStorage, ref as sRef, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
const _cc = { apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco", databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com", projectId: "dream8-7b161", appId: "1:606218522479:web:2737643db3de735af7e29a", storageBucket: "dream8-7b161.firebasestorage.app"};
const app = initializeApp(_cc); const db = getDatabase(app); const storage = getStorage(app);
let isEditing = false, currentViewingUid = "", monFilter = 'ALL'; 

window.showLoading = (t = "è™•ç†ä¸­...") => { document.getElementById('loadingText').innerText = t; document.getElementById('globalLoading').style.display = 'flex'; };
window.hideLoading = () => { document.getElementById('globalLoading').style.display = 'none'; };
window.onload=()=>{ const auth = prompt("ç®¡ç†æˆæ¬Šç¢¼:"); if("8888"===auth){ document.body.style.display="block"; document.getElementById('repDate').value = new Date().toISOString().split('T')[0]; startSync(); fetchDailyReport(); }else{ location.href="index.html"; }};

window.handleFileUpload = async (input, targetId, statusId) => {
const file = input.files[0]; if(!file) return; const status = document.getElementById(statusId); if(status) {status.innerText = "â³"; status.style.color = "#ffb800";}
try { const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`; const storageRef = sRef(storage, `images/${fileName}`); const snapshot = await uploadBytes(storageRef, file); const url = await getDownloadURL(snapshot.ref); document.getElementById(targetId).value = url; if(status) {status.innerText = "âœ…"; status.style.color = "#2ecc71";}
// é è¦½åœ–æ›´æ–°é‚è¼¯
const parentRow = input.closest('.dynamic-row') || input.closest('.file-input-wrapper').parentElement; if(parentRow) { const previewImg = parentRow.querySelector('.upload-preview'); if(previewImg) { previewImg.src = url; previewImg.style.display = 'block'; }}
// é‡å°ä¸»åœ–
if(targetId === 'gImg') { document.getElementById('mainImgStatus').innerText = "âœ… ä¸Šå‚³æˆåŠŸ"; }
} catch (e) { console.error(e); if(status) {status.innerText = "âŒ"; status.style.color = "#ff4757";} alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message); }};

window.toggleSidebar=()=>document.getElementById('sidebar').classList.toggle('open');
window.switchTab=id=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));document.getElementById(id).classList.add('active');if(window.innerWidth<=768)toggleSidebar()};
window.toggleUser=uid=>document.getElementById(`content-${uid}`).classList.toggle('show');
window.closeLog=()=>document.getElementById('logModal').style.display='none';

// ğŸŸ¢ ä¿®æ­£ï¼šçé …è¼¸å…¥æ¡† (åŒ…å«åœ–ç‰‡ä¸Šå‚³)
window.addPrizeInput = (num = '', name = '', img = '') => { 
    const id = "pz_" + Math.random().toString(36).substr(2, 9);
    const d = document.createElement('div'); 
    d.className = 'dynamic-row'; 
    d.innerHTML = `
        <input type="number" placeholder="è™Ÿç¢¼" value="${num}">
        <input type="text" placeholder="çé …åç¨±" value="${name}">
        <div class="mini-upload-btn">
            <span id="st-${id}" style="font-size:0.6rem; color:#aaa;">${img ? 'âœ…' : 'ğŸ“·'}</span>
            <input type="file" accept="image/*" onchange="handleFileUpload(this, 'in-${id}', 'st-${id}')">
        </div>
        <input type="hidden" class="prize-img-input" id="in-${id}" value="${img}">
        <img src="${img || ''}" class="upload-preview" style="${img?'':'display:none'}">
        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">âœ•</button>
    `; 
    document.getElementById('prizeContainer').appendChild(d); 
};

window.addAlbumInput=(url='')=>{ const id = "alb_" + Math.random().toString(36).substr(2, 9); const d=document.createElement('div'); d.className='dynamic-row'; d.innerHTML=`<div class="file-input-wrapper" style="flex:1; margin-bottom:0; padding:8px; border-style:solid; min-height:auto;"><span id="st-${id}" style="font-size:0.7rem">${url ? 'âœ… å·²æœ‰åœ–' : 'é»æ“Šä¸Šå‚³'}</span><input type="file" accept="image/*" onchange="handleFileUpload(this, 'in-${id}', 'st-${id}')"></div><input type="hidden" id="in-${id}" value="${url}"><img src="${url || ''}" class="upload-preview" style="${url?'':'display:none'}"><button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()" style="margin-top:0; flex:none;">âœ•</button>`; document.getElementById('albumContainer').appendChild(d)};
window.addNewPopItem = (data = {title:'', content:'', img:''}) => {
    const id = "pop_" + Math.random().toString(36).substr(2, 9);
    const d = document.createElement('div');
    d.className = 'card pop-item-config'; d.style.background = 'rgba(255,255,255,0.02)'; d.style.border = '1px solid #333';
    d.innerHTML = `<div style="text-align:right; margin-bottom:10px;"><button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">âœ• åˆªé™¤æ­¤å‰‡</button></div><input type="text" class="p-title" placeholder="å…¬å‘Šæ¨™é¡Œ" value="${data.title}"><textarea class="p-content" rows="3" placeholder="å…¬å‘Šå…§å®¹å…§å®¹">${data.content}</textarea><div class="file-input-wrapper" style="border-style:solid; min-height:40px;"><span id="st-${id}">${data.img ? 'âœ… å·²æœ‰åœ–ç‰‡' : 'ä¸Šå‚³åœ–ç‰‡ (é¸å¡«)'}</span><input type="file" accept="image/*" onchange="handleFileUpload(this, 'img-${id}', 'st-${id}')"></div><input type="hidden" class="p-img" id="img-${id}" value="${data.img}"><img src="${data.img || ''}" class="upload-preview" style="width:100%; height:auto; max-height:100px; object-fit:contain; margin-top:10px; ${data.img?'':'display:none'}">`;
    document.getElementById('popListContainer').appendChild(d);
};

window.setMonFilter = (cat) => { monFilter = cat; startSync(); };

// ğŸŸ¢ æ•¸æ“šè¨ˆç®—é‚è¼¯
async function runReport(start, end) {
    const [uSnap, wSnap] = await Promise.all([get(ref(db, 'users')), get(ref(db, 'winLogs'))]);
    const users = uSnap.val() || {}, wins = wSnap.val() || {};
    let rev = 0, dep = 0, cnt = 0;
    let games = {};
    let winItems = [];
    Object.values(users).forEach(u => {
        if(u.logs) {
            Object.values(u.logs).forEach(log => {
                if(log.time >= start && log.time <= end) {
                    if(log.cost > 0) { rev += log.cost; cnt++; games[log.game] = (games[log.game] || 0) + log.cost; }
                    else if(log.cost < 0) { dep += Math.abs(log.cost); }
                }
            });
        }
    });
    Object.values(wins).forEach(w => { if(w.time >= start && w.time <= end) winItems.push(w); });
    winItems.sort((a,b) => b.time - a.time);
    document.getElementById('rRev').innerText = rev.toLocaleString();
    document.getElementById('rDep').innerText = dep.toLocaleString();
    document.getElementById('rCnt').innerText = cnt.toLocaleString();
    document.getElementById('rList').innerHTML = Object.entries(games).sort((a,b)=>b[1]-a[1]).map(([n,s])=>`<div>â€¢ <b>${n}</b>: ${s} P</div>`).join('') || "ç„¡æ•¸æ“š";
    document.getElementById('rWins').innerHTML = winItems.map(w=>`<tr><td>${w.user}</td><td>${w.game}<br><small style="color:var(--p)">${w.prize}</small></td><td>${new Date(w.time).toLocaleString()}</td></tr>`).join('') || "<tr><td colspan='3' style='text-align:center'>ç„¡ç´€éŒ„</td></tr>";
}

window.fetchDailyReport = async () => {
    const date = document.getElementById('repDate').value; if(!date) return alert("è«‹é¸æ“‡æ—¥æœŸ");
    showLoading(`çµ±è¨ˆ ${date} ä¸­...`);
    await runReport(new Date(date + "T00:00:00").getTime(), new Date(date + "T23:59:59").getTime());
    document.getElementById('repTitle').innerText = `ğŸ“… æ—¥å ±è¡¨ï¼š${date}`;
    hideLoading();
};

window.fetchMonthlyReport = async () => {
    const date = document.getElementById('repDate').value; if(!date) return alert("è«‹é¸æ“‡æ—¥æœŸä»¥ç¢ºå®šæœˆä»½");
    const d = new Date(date);
    const month = d.getMonth(), year = d.getFullYear();
    const start = new Date(year, month, 1).getTime();
    const end = new Date(year, month + 1, 0, 23, 59, 59).getTime();
    showLoading(`çµ±è¨ˆ ${year}/${month+1} æœˆå ±ä¸­...`);
    await runReport(start, end);
    document.getElementById('repTitle').innerText = `ğŸ“… æœˆå ±è¡¨ï¼š${year}å¹´ ${month+1}æœˆ`;
    hideLoading();
};

function startSync(){
    onValue(ref(db, 'depositRequests'), s => {
        const container = document.getElementById('depositListContainer');
        const badge = document.getElementById('depositBadge');
        container.innerHTML = ''; const data = s.val() || {};
        const pendingRequests = Object.entries(data).filter(([k, v]) => v.status === 'pending');
        if (pendingRequests.length > 0) { badge.innerText = pendingRequests.length; badge.style.display = 'inline-block'; } 
        else { badge.style.display = 'none'; container.innerHTML = '<div class="card" style="text-align:center;color:#666;">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ç”³è«‹</div>'; }
        pendingRequests.sort((a, b) => b[1].time - a[1].time).forEach(([key, req]) => {
            const item = document.createElement('div'); item.className = 'request-item';
            item.innerHTML = `<div class="request-header"><div><b style="color:var(--p)">${req.amount} NTD</b><br><small style="color:#888">UID: ${req.uid} | ${new Date(req.time).toLocaleString()}</small></div><div><button class="btn btn-sm btn-success" onclick="approveDeposit('${key}', '${req.uid}', ${req.amount})">æ ¸å‡†ä¸Šåˆ†</button><button class="btn btn-sm btn-danger" onclick="rejectDeposit('${key}')">æ‹’çµ•/åˆªé™¤</button></div></div>`;
            container.appendChild(item);
        });
    });

    onValue(ref(db,'settings/categories'),s=>{ const list=document.getElementById('catManageList'),select=document.getElementById('gCat'),data=s.val()||[]; list.innerHTML='';select.innerHTML='<option value="">è«‹é¸æ“‡åˆ†é¡</option>';
    const filterBar = document.getElementById('monFilters'); filterBar.innerHTML = `<button class="filter-btn ${monFilter==='ALL'?'active':''}" onclick="setMonFilter('ALL')">å…¨éƒ¨</button>`;
    data.forEach((c,idx)=>{ 
        list.innerHTML+=`<div class="dynamic-row" style="border:none; padding:0; background:none;"><input type="text" value="${c}" onchange="editCat(${idx},this.value)" style="flex:1"><button class="btn btn-sm btn-danger" onclick="delCat(${idx})" style="margin-top:0">åˆªé™¤</button></div>`; 
        select.innerHTML+=`<option value="${c}">${c}</option>`;
        filterBar.innerHTML+=`<button class="filter-btn ${monFilter===c?'active':''}" onclick="setMonFilter('${c}')">${c}</button>`;
    })});

    get(ref(db,'settings/announcement')).then(s=>{if(s.exists())document.getElementById('annContent').value=s.val()});
    get(ref(db,'settings/announcement_config')).then(s=>{ if(s.exists()){ const d = s.val(); document.getElementById('popId').value = d.id || ""; document.getElementById('popActive').value = (d.active !== false).toString(); document.getElementById('popListContainer').innerHTML = ""; if(d.items) d.items.forEach(item => addNewPopItem(item)); }});

    onValue(ref(db,'gameSettings'),s=>{ const list=document.getElementById('monList'),adj=document.getElementById('quickAdjustList'),data=s.val()||[]; list.innerHTML='',adj.innerHTML=''; const keys=Object.keys(data).sort((a,b)=>(data[a].order||99)-(data[b].order||99));
    keys.forEach(id=>{ 
        const g=data[id]; if(monFilter !== 'ALL' && g.category !== monFilter) return;
        const mon=document.createElement('div'); mon.className='card'; 
        onValue(ref(db,`games/${id}/lock`),ls=>{ 
            const l=ls.val(),isL=l&&l.expire>Date.now(),lT=isL?`<br><small style="color:var(--lock)">ğŸ”’ åŒ…å°ä¸­: ${l.user}</small>`:'',uB=isL?`<button class="btn btn-sm btn-unlock" onclick="forceUnlock('${id}')">ğŸ”“ è§£é–</button>`:''; 
            mon.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><b>${g.name || id}</b><br><small style="color:#666">${id} | ${g.category}</small></div> ${g.isSoldOut?'<span style="color:#ff4757">[å·²åœç›¤]</span>':'<span style="color:#2ecc71">[éŠ·å”®ä¸­]</span>'}</div>${lT}<div id="rem-${id}" style="color:var(--p);font-size:1.5rem;margin:10px 0">--</div><div style="display:flex; flex-wrap:wrap; gap:5px;"><button class="btn btn-sm" onclick="loadGameToEdit('${id}')">ç·¨è¼¯</button><button class="btn btn-sm" onclick="resetShuffle('${id}')">æ´—ç‰Œ</button>${uB}<button class="btn btn-sm btn-danger" onclick="deleteGame('${id}')">åˆªé™¤</button></div>`
        }); list.appendChild(mon);
        onValue(ref(db,`games/${id}/pool`),ps=>{ const p=ps.val()||[]; if(document.getElementById(`rem-${id}`))document.getElementById(`rem-${id}`).innerText=`å‰©é¤˜ ${p.filter(x=>!x.taken).length} / ${g.total}`});
        const aC=document.createElement('div'); aC.className='card'; aC.innerHTML=`<b>${g.name || id} èª¿æ§</b><div class="adj-grid" style="margin-top:10px"><input type="number" value="${g.price}" onchange="updNum('${id}','price',this.value)" title="åƒ¹æ ¼"><input type="number" value="${g.order||99}" onchange="updNum('${id}','order',this.value)" title="æ’åº"></div>`; adj.appendChild(aC)})});

    onValue(ref(db,'winLogs'),s=>{ const l=document.getElementById('globalWinItems'); l.innerHTML=''; const data = s.val() || {}; const entries = Object.keys(data).sort((a,b) => (data[b].time || 0) - (data[a].time || 0)).slice(0,50);
    entries.forEach(async key => { 
        const i = data[key]; 
        const uSnap = await get(ref(db, `users/${i.uid}/shipping`));
        const ship = uSnap.val() || {};
        const shipText = ship.name ? `<br><small style="color:var(--success)">ğŸ“ ${ship.name} ${ship.phone} (${ship.store})</small>` : '';
        const tr = document.createElement('tr'); 
        tr.innerHTML = `<td><small>${new Date(i.time).toLocaleString()}</small><br><b>${i.user}</b>${shipText}</td><td><small>${i.game}</small><br><span style="color:var(--p)">${i.prize}</span></td><td><div class="win-status-row"><select onchange="updateWinStatus('${key}', this.value)" class="win-shipping-input"><option value="å¾…å‡ºè²¨" ${i.status==='å¾…å‡ºè²¨'?'selected':''}>å¾…å‡ºè²¨</option><option value="å·²å‡ºè²¨" ${i.status==='å·²å‡ºè²¨'?'selected':''}>å·²å‡ºè²¨</option><option value="å·²å®Œæˆ" ${i.status==='å·²å®Œæˆ'?'selected':''}>å·²å®Œæˆ</option></select><input type="text" placeholder="äº¤è²¨ä¾¿ç·¨è™Ÿ" value="${i.shippingNo||''}" onchange="updateWinShipping('${key}', this.value)" class="win-shipping-input"></div></td>`; l.appendChild(tr); 
    })});

    onValue(ref(db,'users'),s=>{ 
        const c=document.getElementById('userListContainer'); c.innerHTML='';const u=s.val()||{},r={}; 
        Object.values(u).forEach(i=>{if(i.invitedBy)r[i.invitedBy]=(r[i.invitedBy]||0)+1});
        Object.entries(u).forEach(([id,d])=>{ 
            const sp = d.logs ? Object.values(d.logs).reduce((acc, log) => { const cost = Number(log.cost) || 0; return acc + (cost > 0 ? cost : 0); }, 0) : 0; 
            const ic=r[id]||0; const comm = (d.commission || 0).toLocaleString(); 
            const firstTag = d.hasToppedUp ? `<span class="ref-tag" style="color:#aaa; border-color:#aaa">å·²é¦–å„²</span>` : `<span class="ref-tag" style="color:var(--p); border-color:var(--p)">æ–°ç”¨æˆ¶</span>`;
            const ship = d.shipping || {};
            const shipHtml = ship.name ? `<div class="ship-info-card"><span class="ship-label">ğŸ“¦ æ”¶ä»¶äºº:</span> ${ship.name}<br><span class="ship-label">ğŸ“± é›»è©±:</span> ${ship.phone}<br><span class="ship-label">ğŸª é–€å¸‚:</span> ${ship.store}</div>` : `<div class="ship-info-card" style="background:rgba(255,255,255,0.05); border:1px solid #333; color:#666;">å°šæœªå¡«å¯«æ”¶ä»¶è³‡è¨Š</div>`;
            const i=document.createElement('div'); i.className='user-item'; 
            i.innerHTML=`<div class="user-header" onclick="toggleUser('${id}')"><div><b>${d.nickname||'ç©å®¶'}</b><span class="spent-badge">ç´¯è¨ˆæ¶ˆè²»:${sp.toLocaleString()}P</span>${d.invitedBy?`<span class="ref-tag">æº:${d.invitedBy}</span>`:''}${ic>0?`<span class="ref-tag" style="color:#2ecc71;border-color:#2ecc71">é‚€:${ic}äºº</span>`:''}${firstTag}</div><div style="color:var(--p)">${(d.balance||0).toLocaleString()}P â–¼</div></div><div class="user-content" id="content-${id}">UID: ${id} | PIN: ${d.pin||'ç„¡'}<br>ç›Ÿå‹çé‡‘: <b style="color:var(--success)">${comm} P</b><br>${shipHtml}<div style="margin-top:10px"><button class="btn btn-sm" onclick="showLogs('${id}')">å°å¸³/æ˜ç´°</button><button class="btn btn-sm" onclick="addBal('${id}')">æ‰‹å‹•åŠ é»</button><button class="btn btn-sm btn-unlock" onclick="clearCommission('${id}')">ğŸ’° çµæ¸…çé‡‘</button><button class="btn btn-sm" onclick="editPin('${id}')">PIN</button><button class="btn btn-sm btn-danger" onclick="deleteUser('${id}')">åˆªé™¤</button></div></div>`; 
            c.appendChild(i)
        })
    });
}

window.saveAnnouncement=async()=>{const content = document.getElementById('annContent').value; showLoading("åŒæ­¥è·‘é¦¬ç‡ˆä¸­..."); try { await set(ref(db,'settings/announcement'), content); alert("è·‘é¦¬ç‡ˆå…§å®¹å·²åŒæ­¥ï¼"); } finally { hideLoading(); }};
window.savePopConfigs = async () => {
    const titleInputs = document.querySelectorAll('#popListContainer .p-title'), contentInputs = document.querySelectorAll('#popListContainer .p-content'), imgInputs = document.querySelectorAll('#popListContainer .p-img'), items = [];
    titleInputs.forEach((el, idx) => { items.push({ title: el.value, content: contentInputs[idx].value, img: imgInputs[idx].value }); });
    const popId = document.getElementById('popId').value, popActive = document.getElementById('popActive').value === "true";
    if(!popId) return alert("è«‹è¼¸å…¥å…¬å‘Š ID"); showLoading("åŒæ­¥ä¸­..."); try { await set(ref(db, 'settings/announcement_config'), { id: popId, active: popActive, items: items }); alert("æˆåŠŸï¼"); } finally { hideLoading(); }
};
window.updateWinStatus = (key, status) => { update(ref(db, `winLogs/${key}`), { status: status }); };
window.updateWinShipping = (key, no) => { update(ref(db, `winLogs/${key}`), { shippingNo: no }); };
async function runMasterShuffle(id, g) { showLoading("æ­£åœ¨æ´—ç‰Œ..."); try { const pN = g.prizes.map(p => Number(p.num)); let allArr = []; for (let i = 1; i <= g.total; i++) allArr.push(i);
let loseP = allArr.filter(n => !pN.includes(n)), winP = allArr.filter(n => pN.includes(n));
for (let i = loseP.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [loseP[i], loseP[j]] = [loseP[j], loseP[i]]; }
const safe = Number(g.safeZone) || 0; let finalN = [];
if (safe > 0 && loseP.length >= safe) { const front = loseP.splice(0, safe); let rest = [...loseP, ...winP]; for (let i = rest.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [rest[i], rest[j]] = [rest[j], rest[i]]; } finalN = [...front, ...rest]; } else { finalN = allArr; for (let i = finalN.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [finalN[i], finalN[j]] = [finalN[j], finalN[i]]; }}
const poolData = finalN.map(n => ({ grade: Number(n), taken: false, revealed: false })); await set(ref(db, `games/${id}/pool`), poolData); return true; } finally { hideLoading(); }}
window.approveDeposit = async (key, uid, amount) => { amount = Number(amount); if(!confirm(`å¹« [${uid}] å¢åŠ  ${amount} Pï¼Ÿ`)) return; showLoading("ä¸Šåˆ†ä¸­...");
try { const uRef = ref(db, `users/${uid}`), snap = await get(uRef); if(!snap.exists()) return alert("ç„¡æ­¤æœƒå“¡"); const uData = snap.val(), isFirst = (uData.hasToppedUp === false || uData.hasToppedUp === undefined);
let uBonus = isFirst ? 0.1 : (amount >= 1000 ? 0.03 : 0), rRate = isFirst ? 0.1 : 0.05, finalBonus = amount * uBonus, rBonus = Math.floor(amount * rRate), now = Date.now();
await update(uRef, { balance: (Number(uData.balance) || 0) + amount + finalBonus, hasToppedUp: true }); await push(ref(db, `users/${uid}/logs`), { game: isFirst ? "é¦–å„²å…¥é»(+10%)" : (finalBonus > 0 ? "çºŒå„²å…¥é»(+3%)" : "çºŒå„²å…¥é»"), cost: -(amount + finalBonus), time: now });
if (uData.invitedBy && uData.invitedBy !== uid) { const rRef = ref(db, `users/${uData.invitedBy}`), rSnap = await get(rRef); if (rSnap.exists()) { await update(rRef, { commission: (Number(rSnap.val().commission) || 0) + rBonus }); await push(ref(db, `referralLogs/${uData.invitedBy}`), { time: now, from_uid: uid, amount: amount, reward: rBonus, type: isFirst ? "FIRST" : "RECURRING" }); }}
await update(ref(db, `depositRequests/${key}`), { status: 'completed' }); alert(`å®Œæˆï¼å¯¦å¾—ï¼š${amount+finalBonus} P`); } catch(e) { alert("éŒ¯èª¤: " + e.message); } finally { hideLoading(); }};
window.showUserSubTab = async (type) => { const c = document.getElementById('logItems'); c.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">è¼‰å…¥ä¸­...</div>';
if(type === 'spend') { const s = await get(ref(db, `users/${currentViewingUid}/logs`)); const l = s.val()||{}; c.innerHTML = Object.values(l).reverse().map(i => `<div style="padding:10px;border-bottom:1px solid #222;display:flex;justify-content:space-between;"><span>${i.game}<br><small>${new Date(i.time).toLocaleString()}</small></span><b style="color:${Number(i.cost)>0?'#ff4757':'#2ecc71'}">${Number(i.cost)>0?'-':'+'}${Math.abs(i.cost)}P</b></div>`).join('');
} else { const s = await get(ref(db, `referralLogs/${currentViewingUid}`)); const l = s.val()||{}; c.innerHTML = Object.values(l).reverse().map(i => { const label = Number(i.reward) < 0 ? "çµæ¸…æç¾" : `ä¾†è‡ªå¥½å‹: ${i.from_uid}`; return `<div style="padding:10px;border-bottom:1px solid #222;display:flex;justify-content:space-between;"><span>${label}<br><small>${new Date(i.time).toLocaleString()}</small></span><b style="color:${Number(i.reward)>0?'#2ecc71':'#ff4757'}">${Number(i.reward)>0?'+':''}${i.reward}P</b></div>`; }).join(''); }
if(!c.innerHTML) c.innerHTML = '<div class="empty-state">å°šç„¡ç´€éŒ„</div>'; };
window.showLogs = (uid) => { currentViewingUid = uid; document.getElementById('logUserName').innerText = `å¸³è™Ÿ ${uid} çš„æ˜ç´°`; document.getElementById('logModal').style.display='flex'; showUserSubTab('spend'); };
window.addBal=async uid=>{ const a=prompt("èª¿æ•´é¤˜é¡ (æ­£åŠ è² æ¸›):"); if(a && !isNaN(a)){ const val = Number(a), s=await get(ref(db,`users/${uid}/balance`)); await update(ref(db,`users/${uid}`),{balance: (s.val() || 0) + val}); await push(ref(db, `users/${uid}/logs`), { game: "æ‰‹å‹•èª¿æ•´", cost: -val, time: Date.now() }); alert("å®Œæˆ"); }};
window.clearCommission = async (uid) => { const snap = await get(ref(db, `users/${uid}/commission`)), currentComm = snap.val() || 0; if (currentComm <= 0) return alert("ç„¡çé‡‘");
if (confirm(`çµæ¸… [${uid}] çš„ ${currentComm} P çé‡‘ï¼Ÿ`)) { showLoading("è™•ç†ä¸­..."); try { await update(ref(db, `users/${uid}`), { commission: 0 }); await push(ref(db, `referralLogs/${uid}`), { time: Date.now(), from_uid: "ADMIN", amount: 0, reward: -currentComm, type: "WITHDRAW" }); alert("å®Œæˆï¼"); } finally { hideLoading(); }}};
window.rejectDeposit = async (key) => { if(confirm("åˆªé™¤ç”³è«‹ï¼Ÿ")) await remove(ref(db, `depositRequests/${key}`)); };
window.addNewCat=async()=>{const v=document.getElementById('newCatIn').value.trim();if(!v)return;const s=await get(ref(db,'settings/categories')),data=s.val()||[];data.push(v);await set(ref(db,'settings/categories'),data);document.getElementById('newCatIn').value=''};
window.editCat=async(idx,v)=>{const s=await get(ref(db,'settings/categories')),data=s.val()||[];data[idx]=v;await set(ref(db,'settings/categories'),data)};
window.delCat=async(idx)=>{if(confirm("åˆªé™¤åˆ†é¡ï¼Ÿ")){const s=await get(ref(db,'settings/categories')),data=s.val()||[];data.splice(idx,1);await set(ref(db,'settings/categories'),data)}};
window.forceUnlock=async id=>{if(confirm(`è§£é– [${id}]ï¼Ÿ`)){await remove(ref(db,`games/${id}/lock`));alert("å·²è§£é–")}};

// ğŸŸ¢ ä¿®æ­£ï¼šç™¼å¸ƒéŠæˆ²æ™‚ï¼Œå„²å­˜çé …åœ–ç‰‡
window.publishGame = async () => {
    const id = document.getElementById('gId').value.trim(), gName = document.getElementById('gName').value.trim(), tot = Number(document.getElementById('gTotal').value), cat = document.getElementById('gCat').value;
    
    // ç²å–çé …è³‡è¨Š (å«åœ–ç‰‡)
    const prRows = Array.from(document.querySelectorAll('#prizeContainer .dynamic-row'));
    const prs = prRows.map(r => ({ 
        num: Number(r.querySelectorAll('input')[0].value), 
        name: r.querySelectorAll('input')[1].value,
        img: r.querySelector('.prize-img-input').value // ç²å–åœ–ç‰‡é€£çµ
    }));
    
    const albRows = Array.from(document.querySelectorAll('#albumContainer .dynamic-row')), alb = albRows.map(r => r.querySelector('input[type="hidden"]').value).filter(v => v.trim());
    if (!id || !tot || 0 === prs.length || !cat) return alert("è³‡è¨Šä¸å…¨");
    const d = { name: gName || id, total: tot, price: Number(document.getElementById('gPrice').value), prizes: prs, album: alb, safeZone: Number(document.getElementById('gSafeZone').value) || 0, img: document.getElementById('gImg').value, promoCount: Number(document.getElementById('pCount').value) || 0, promoPrice: Number(document.getElementById('pPrice').value) || 0, category: cat, order: Number(document.getElementById('gOrder').value) || 99, isSoldOut: false };
    if(!d.img) return alert("è«‹ä¸Šå‚³ä¸»åœ–"); showLoading("ç™¼å¸ƒä¸­..."); try { await update(ref(db, `gameSettings/${id}`), d); if (!isEditing) { await runMasterShuffle(id, d); alert("ç™¼å¸ƒæˆåŠŸ"); } else alert("æ›´æ–°æˆåŠŸ"); resetGameForm(); } finally { hideLoading(); }
};

window.resetShuffle = async id => { if (confirm(`ã€è­¦å‘Šã€‘é‡æ–°æ´—ç‰Œ [${id}]ï¼Ÿ`)) { try { const s = await get(ref(db, `gameSettings/${id}`)), g = s.val(); if (!g) return alert("ç„¡è¨­å®š"); await runMasterShuffle(id, g); await update(ref(db, `gameSettings/${id}`), { isSoldOut: false }); await remove(ref(db, `games/${id}/lock`)); alert("æˆåŠŸï¼"); } catch (e) { alert("å¤±æ•—: " + e.message); }}};

// ğŸŸ¢ ä¿®æ­£ï¼šç·¨è¼¯æ™‚å›å¡«çé …åœ–ç‰‡
window.loadGameToEdit=async id=>{ const s=await get(ref(db,`gameSettings/${id}`)),g=s.val(); if(!g)return; isEditing=true; document.getElementById('gId').value=id; document.getElementById('gId').disabled=true; document.getElementById('gName').value = g.name || id; document.getElementById('gCat').value=g.category; document.getElementById('gTotal').value=g.total; document.getElementById('gPrice').value=g.price; document.getElementById('gSafeZone').value=g.safeZone||0; document.getElementById('pCount').value=g.promoCount||0; document.getElementById('pPrice').value=g.promoPrice||0; document.getElementById('gImg').value=g.img; document.getElementById('mainImgStatus').innerText = "âœ… å·²æœ‰åœ–"; document.getElementById('gOrder').value=g.order||99;
const aC=document.getElementById('albumContainer'); aC.innerHTML=''; if(g.album) g.album.forEach(u=>addAlbumInput(u));
const pC=document.getElementById('prizeContainer'); pC.innerHTML=''; g.prizes.forEach(p=>addPrizeInput(p.num, p.name, p.img || '')); // å›å¡«åœ–ç‰‡
document.getElementById('gameActionTitle').innerText="ç·¨è¼¯ï¼š" + id; document.getElementById('publishBtn').innerText="å„²å­˜æ›´æ–°"; document.getElementById('cancelEditBtn').style.display="block"; switchTab('game'); window.scrollTo({top: 0, behavior: 'smooth'});};

window.resetGameForm=()=>{ isEditing=false; document.getElementById('gId').value=''; document.getElementById('gId').disabled=false; document.getElementById('gName').value=''; document.getElementById('prizeContainer').innerHTML=''; document.getElementById('albumContainer').innerHTML=''; document.getElementById('cancelEditBtn').style.display="none"; document.getElementById('gameActionTitle').innerText="æ–°å¢å•†å“"; document.getElementById('publishBtn').innerText="ç™¼å¸ƒä¸¦æ´—ç‰Œ"; document.getElementById('mainImgStatus').innerText="é»æ“Šä¸Šå‚³åœ–ç‰‡"; document.getElementById('gImg').value='';};
window.updNum=(id,f,v)=>update(ref(db,`gameSettings/${id}`),{[f]:Number(v)});
window.editPin=async uid=>{const p=prompt("æ–° PIN:");if(p)update(ref(db,`users/${uid}`),{pin:p})};
window.deleteGame=async id=>{if(confirm("ç¢ºå®šåˆªé™¤å•†å“ï¼Ÿ")){remove(ref(db,`gameSettings/${id}`));remove(ref(db,`games/${id}`))}};
window.deleteUser=async uid=>{if(confirm("ç¢ºå®šåˆªé™¤æœƒå“¡ï¼Ÿ"))remove(ref(db,`users/${uid}`))};
window.saveAnnouncement=async()=>{await set(ref(db,'settings/announcement'),document.getElementById('annContent').value);alert("å®Œæˆ")};
window.createUser=async()=>{const u=prompt("æ–°å¸³è™Ÿ ID:");if(u)set(ref(db,`users/${u}`),{balance:0,nickname:"æ–°ç©å®¶",pin:"123456"})};
</script>
</body>
</html>
