<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤¢å·¥å»  | æ——è‰¦ç®¡ç†å¾Œå°</title>
    <style>
        :root { --p: #ff8fa3; --bg: #f8f9fa; --dark: #2d3436; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { border-left: 5px solid var(--p); padding-left: 15px; color: var(--dark); margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--p); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        .btn-gray { background: #636e72; }
        .btn-danger { background: #ff7675; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background: #fdf2f4; color: var(--p); }

        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-soldout { background: #ffeaa7; color: #d63031; }
        .tag-ref { background: #e1f5fe; color: #0288d1; } /* æ¨è–¦äººæ¨™ç±¤æ¨£å¼ */

        .prize-item { display: flex; gap: 10px; align-items: center; background: #fff9fa; padding: 10px; border-radius: 8px; margin-bottom: 5px; border: 1px dashed var(--p); }
        .img-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>DREAM FACTORY ç®¡ç†ç³»çµ±</h1>

    <div class="card">
        <h2>ğŸ“œ å…¬å‘Šèˆ‡è·‘é¦¬ç‡ˆç®¡ç†</h2>
        <textarea id="annIn" rows="3" placeholder="è¼¸å…¥å•†åŸæœ€æ–°å…¬å‘Š..."></textarea>
        <button onclick="saveAnn()">æ›´æ–°å…¬å‘Š</button>
    </div>

    <div class="card">
        <h2 id="formTitle">ğŸ® æ–°å¢/ç·¨è¼¯å•†å“</h2>
        <input type="text" id="gName" placeholder="å•†å“åç¨± (ä¾‹å¦‚: 2000è¬è¶…ç´šç´…åŒ…)">
        <div class="grid">
            <input type="text" id="gImg" placeholder="å•†å“å°é¢åœ–ç‰‡ç¶²å€">
            <input type="text" id="gCat" placeholder="å•†å“åˆ†é¡ (ALL, ä¸€ç•ªè³, åˆ®åˆ®æ¨‚...)">
            <input type="number" id="gPrice" placeholder="å–®æŠ½åƒ¹æ ¼ (P)">
            <input type="number" id="gTotal" placeholder="ç¸½å¼µæ•¸">
        </div>
        
        <div style="background: #fff5f6; padding: 15px; border-radius: 10px; margin: 15px 0;">
            <p style="margin: 0 0 10px; font-weight: bold; color: var(--p);">ğŸ”´ é–‹ç›¤å„ªæƒ è¨­å®š (ä¸ä½¿ç”¨è«‹å¡« 0)</p>
            <div class="grid">
                <input type="number" id="pCount" placeholder="å‰å¹¾æŠ½æœ‰å„ªæƒ ">
                <input type="number" id="pPrice" placeholder="å„ªæƒ åƒ¹æ ¼ (P)">
            </div>
        </div>

        <div id="prizeArea">
            <p style="font-weight: bold;">ğŸ† çé …è¨­å®š (è«‹è‡³å°‘è¨­å®šä¸€å€‹çé …)</p>
            <div id="prizeList"></div>
            <button class="btn-gray" onclick="addPrizeRow()">+ æ–°å¢çé …</button>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="saveGame()">ä¿å­˜ä¸¦ç™¼å¸ƒå•†å“</button>
            <button class="btn-gray" id="cancelBtn" style="display:none;" onclick="resetForm()">å–æ¶ˆç·¨è¼¯</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ‘¥ æœƒå“¡åå–®èˆ‡æ¨è–¦çµ±è¨ˆ</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>UID / æš±ç¨±</th>
                        <th>é¤˜é¡ (P)</th>
                        <th>æ¨è–¦äºº</th>
                        <th>å—é‚€äººæ•¸</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“¦ è²©å”®ä¸­å•†å“æ¸…å–®</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>å°é¢</th>
                        <th>å•†å“åç¨±</th>
                        <th>åƒ¹æ ¼</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="gameTable"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ‰ å…¨çƒä¸­çå¿«å ± (winLogs)</h2>
        <div style="overflow-x: auto; max-height: 300px;">
            <table>
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>ç©å®¶</th>
                        <th>å•†å“</th>
                        <th>ç²çå…§å®¹</th>
                    </tr>
                </thead>
                <tbody id="winTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, push, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = { apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE", databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com", projectId: "dream-169dc", appId: "1:214137228622:web:84d14bad85d865ee94e21f" };
    const app = initializeApp(config); const db = getDatabase(app);

    let editMode = false;
    let editId = "";

    // --- 1. åˆå§‹åŒ–ç›£è½ ---
    onValue(ref(db, 'settings/announcement'), s => document.getElementById('annIn').value = s.val() || "");

    onValue(ref(db, 'gameSettings'), s => {
        const games = s.val() || {};
        const tbody = document.getElementById('gameTable');
        tbody.innerHTML = "";
        for (let id in games) {
            const g = games[id];
            tbody.innerHTML += `
                <tr>
                    <td><img src="${g.img}" class="img-preview"></td>
                    <td><b>${id}</b><br><small>${g.category}</small></td>
                    <td>${g.price} P</td>
                    <td>${g.isSoldOut ? '<span class="tag tag-soldout">å·²åœç›¤</span>' : '<span class="tag" style="background:#e3fced;color:#2ecc71">éŠ·å”®ä¸­</span>'}</td>
                    <td>
                        <button class="btn-gray" onclick="editGame('${id}')">ç·¨è¼¯</button>
                        <button class="btn-danger" onclick="deleteGame('${id}')">åˆªé™¤</button>
                        <button style="background:#f1c40f;color:black" onclick="toggleSoldOut('${id}', ${g.isSoldOut})">${g.isSoldOut?'å¾©ç›¤':'åœç›¤'}</button>
                    </td>
                </tr>`;
        }
    });

    // ğŸŸ¢ æœƒå“¡ç›£è½ (å«æ¨è–¦é‚è¼¯)
    onValue(ref(db, 'users'), s => {
        const users = s.val() || {};
        const tbody = document.getElementById('userTable');
        tbody.innerHTML = "";
        
        // çµ±è¨ˆå—é‚€äººæ•¸
        const refCount = {};
        Object.values(users).forEach(u => {
            if(u.referrer) refCount[u.referrer] = (refCount[u.referrer] || 0) + 1;
        });

        for (let uid in users) {
            const u = users[uid];
            tbody.innerHTML += `
                <tr>
                    <td><b>${uid}</b><br>${u.nickname || 'æœªè¨­å®š'}</td>
                    <td><input type="number" value="${u.balance || 0}" style="width:80px" onchange="updateBalance('${uid}', this.value)"></td>
                    <td>${u.referrer ? '<span class="tag tag-ref">ä¾†è‡ª: ' + u.referrer + '</span>' : '<small style="color:#ccc">è‡ªè¡Œè¨»å†Š</small>'}</td>
                    <td><b style="color:var(--p)">${refCount[uid] || 0}</b> äºº</td>
                    <td><button class="btn-danger" onclick="deleteUser('${uid}')">åˆªé™¤</button></td>
                </tr>`;
        }
    });

    onValue(ref(db, 'winLogs'), s => {
        const logs = s.val() || {};
        const tbody = document.getElementById('winTable');
        tbody.innerHTML = Object.values(logs).reverse().map(l => `
            <tr>
                <td><small>${new Date(l.time).toLocaleString()}</small></td>
                <td>${l.user}</td>
                <td>${l.game}</td>
                <td><b>${l.prize}</b></td>
            </tr>`).join('');
    });

    // --- 2. åŠŸèƒ½å‡½æ•¸ ---
    window.saveAnn = () => set(ref(db, 'settings/announcement'), document.getElementById('annIn').value);

    window.addPrizeRow = (num = "", name = "", img = "") => {
        const div = document.createElement('div');
        div.className = 'prize-item';
        div.innerHTML = `
            <input type="number" class="p-num" value="${num}" placeholder="ç±¤è™Ÿ" style="width:70px">
            <input type="text" class="p-name" value="${name}" placeholder="çé …åç¨±">
            <input type="text" class="p-img" value="${img}" placeholder="çé …åœ–ç‰‡ç¶²å€" style="flex:1">
            <button class="btn-danger" onclick="this.parentElement.remove()">âœ•</button>
        `;
        document.getElementById('prizeList').appendChild(div);
    };

    window.saveGame = async () => {
        const name = document.getElementById('gName').value.trim();
        const price = Number(document.getElementById('gPrice').value);
        const total = Number(document.getElementById('gTotal').value);
        const promoCount = Number(document.getElementById('pCount').value);
        const promoPrice = Number(document.getElementById('pPrice').value);
        const img = document.getElementById('gImg').value;
        const cat = document.getElementById('gCat').value || "ALL";

        if (!name || !price || !total) return alert("è«‹å®Œæ•´å¡«å¯«åŸºç¤è³‡è¨Š");

        const prizes = [];
        document.querySelectorAll('.prize-item').forEach(row => {
            prizes.push({
                num: row.querySelector('.p-num').value,
                name: row.querySelector('.p-name').value,
                img: row.querySelector('.p-img').value
            });
        });

        if (prizes.length === 0) return alert("è‡³å°‘éœ€è¦ä¸€å€‹çé …");

        const gameData = {
            price, total, img, category: cat, prizes,
            promoCount: promoCount || 0,
            promoPrice: promoPrice || 0,
            isSoldOut: false
        };

        // å¦‚æœæ˜¯æ–°å•†å“ï¼Œç”Ÿæˆç±¤æ± 
        if (!editMode) {
            const pool = [];
            for (let i = 0; i < total; i++) pool.push({ taken: false, grade: 0 });
            prizes.forEach(p => { if (pool[p.num - 1]) pool[p.num - 1].grade = p.num; });
            await set(ref(db, `games/${name}/pool`), pool);
        }

        await update(ref(db, `gameSettings/${name}`), gameData);
        alert("ä¿å­˜æˆåŠŸï¼");
        resetForm();
    };

    window.editGame = async (id) => {
        const s = await get(ref(db, `gameSettings/${id}`));
        const g = s.val();
        document.getElementById('gName').value = id;
        document.getElementById('gName').disabled = true;
        document.getElementById('gPrice').value = g.price;
        document.getElementById('gTotal').value = g.total;
        document.getElementById('gImg').value = g.img;
        document.getElementById('gCat').value = g.category;
        document.getElementById('pCount').value = g.promoCount;
        document.getElementById('pPrice').value = g.promoPrice;
        document.getElementById('prizeList').innerHTML = "";
        g.prizes.forEach(p => addPrizeRow(p.num, p.name, p.img));
        editMode = true;
        document.getElementById('formTitle').innerText = "æ­£åœ¨ç·¨è¼¯å•†å“ï¼š" + id;
        document.getElementById('cancelBtn').style.display = "inline-block";
    };

    window.resetForm = () => {
        editMode = false;
        document.getElementById('gName').value = "";
        document.getElementById('gName').disabled = false;
        document.getElementById('prizeList').innerHTML = "";
        document.getElementById('formTitle').innerText = "æ–°å¢/ç·¨è¼¯å•†å“";
        document.getElementById('cancelBtn').style.display = "none";
    };

    window.deleteGame = (id) => { if(confirm("ç¢ºå®šåˆªé™¤å•†å“èˆ‡æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) { remove(ref(db, `gameSettings/${id}`)); remove(ref(db, `games/${id}`)); } };
    window.toggleSoldOut = (id, cur) => update(ref(db, `gameSettings/${id}`), { isSoldOut: !cur });
    window.updateBalance = (uid, val) => update(ref(db, `users/${uid}`), { balance: Number(val) });
    window.deleteUser = (uid) => { if(confirm("ç¢ºå®šåˆªé™¤æ­¤æœƒå“¡ï¼Ÿ")) remove(ref(db, `users/${uid}`)); };

</script>
</body>
</html>
