<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢å·¥å» æ§åˆ¶å° | æ——è‰¦ç›£æ§ç‰ˆ</title>
    <style>
        :root { --primary: #ff8fa3; --accent: #7dd3fc; --bg: #0b0f1a; --card: #161e2d; --text: #f1f5f9; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: none; } /* å¯†ç¢¼é©—è­‰å‰éš±è— */
        
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding: 40px 0; background: linear-gradient(180deg, #1e293b 0%, transparent 100%); border-radius: 0 0 40px 40px; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { margin: 0; font-size: 1.8rem; letter-spacing: 4px; color: var(--primary); text-shadow: 0 0 20px rgba(255,143,163,0.3); }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        .card { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); height: fit-content; }
        h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; color: var(--accent); }
        
        label { font-size: 0.75rem; color: #64748b; margin-top: 10px; display: block; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #2d3748; background: #0b0f1a; color: white; font-size: 0.95rem; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(255,143,163,0.2); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; transition: 0.3s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-secondary { background: #334155; margin-top: 10px; }

        /* å•†å“ç›£æ§æ¸…å–®æ¨£å¼ */
        .monitor-list { margin-top: 15px; display: flex; flex-direction: column; gap: 12px; }
        .monitor-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .monitor-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; }
        .progress-bar { height: 6px; background: #1e293b; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 10px; transition: width 1s ease; }
        
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; background: var(--primary); color: white; }
        .badge-blue { background: #3b82f6; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>DREAM FACTORY CMS</h1>
        <p style="font-size: 0.8rem; color: #64748b;">æ——è‰¦ç´šæ•¸æ“šç®¡ç†ç³»çµ± v3.0</p>
    </div>

    <div class="grid-layout">
        <div class="column">
            <div class="card" style="margin-bottom: 20px;">
                <h3>ğŸ“Š å•†å“æŠ½æ•¸ç›£æ§</h3>
                <div id="monitorContainer" class="monitor-list">
                    <p style="font-size:0.8rem; color:#64748b;">æ­£åœ¨é€£æ¥æ•¸æ“šä¸­å¿ƒ...</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ‘¤ æœƒå“¡å¸³è™Ÿç®¡ç†</h3>
                <input type="text" id="targetId" placeholder="è¼¸å…¥æœƒå“¡ä»£ç¢¼" oninput="this.value = this.value.toUpperCase()">
                <button class="btn btn-secondary" onclick="queryUser()">ğŸ” æŸ¥è©¢ / å¿«é€Ÿå»ºè™Ÿ</button>
                
                <div id="userResult" style="display:none; margin-top:20px; padding:15px; background:rgba(0,0,0,0.2); border-radius:15px;">
                    <div style="font-size:0.85rem; margin-bottom:10px;">ç›®å‰é¤˜é¡ï¼š<span id="uBalDisplay" style="color:var(--primary); font-weight:bold; font-size:1.2rem;">0</span></div>
                    <input type="text" id="newBal" placeholder="å¢æ¸›é»æ•¸ (å¦‚ +500 æˆ– 1000)">
                    <button class="btn" onclick="saveUserBal()">æ›´æ–°é¤˜é¡</button>
                    <button class="btn btn-secondary" onclick="resetUserPin()" style="background:#ef4444; margin-top:8px;">æ¸…é™¤ PIN ç¢¼</button>
                </div>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <h3>ğŸ“¦ éŠæˆ²ä¸Šæ¶è¨­å®š</h3>
                <label>éŠæˆ² ID (ä¸å¯é‡è¤‡)</label>
                <input type="text" id="gId" placeholder="ä¾‹å¦‚: BOSS_01">
                
                <label>åˆ†é¡ (è‡ªå‹•ç”Ÿæˆé¸å–®)</label>
                <input type="text" id="gCat" placeholder="ä¾‹å¦‚: å…¬ä»”ã€é»æ•¸">

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>å–®æŠ½åƒ¹æ ¼</label><input type="number" id="gPrice" placeholder="100"></div>
                    <div><label>ç¸½ç±¤æ•¸</label><input type="number" id="gTotal" placeholder="80"></div>
                </div>

                <label>ä¸»åœ–ç‰‡ç¶²å€</label>
                <input type="text" id="gImg" placeholder="https://...">

                <label>å¤šéšç´šçé … (JSON æ ¼å¼)</label>
                <textarea id="gPrizes">[{"num":8, "name":"é ­ç", "img":""}]</textarea>

                <button class="btn" onclick="publishGame()">ğŸš€ ç™¼ä½ˆå•†å“ä¸¦æ´—ç‰Œ</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- 1. ä¿®æ”¹å¾Œå°ç®¡ç†å¯†ç¢¼ ---
    const ADMIN_KEY = "8888"; // ğŸ‘ˆ ä¿®æ”¹é€™è£¡

    window.onload = () => {
        const pass = prompt("DREAM FACTORY ADMIN\nè«‹è¼¸å…¥é©—è­‰é‡‘é‘°ï¼š");
        if(pass !== ADMIN_KEY) {
            alert("é©—è­‰å¤±æ•—");
            window.location.href = "index.html";
        } else {
            document.body.style.display = "block";
            initMonitor(); // å•Ÿå‹•ç›£æ§
        }
    };

    const config = { 
        apiKey: "AIzaSyCnzsglCCm8QQXmRSi8g96JKW5k7b18BcE",
        databaseURL: "https://dream-169dc-default-rtdb.firebaseio.com",
        projectId: "dream-169dc",
        appId: "1:214137228622:web:84d14bad85d865ee94e21f"
    };
    const app = initializeApp(config);
    const db = getDatabase(app);

    // --- å•†å“ç›£æ§åŠŸèƒ½ ---
    function initMonitor() {
        onValue(ref(db, 'gameSettings'), async (snap) => {
            const settings = snap.val();
            const monitorContainer = document.getElementById('monitorContainer');
            monitorContainer.innerHTML = '';

            for(let id in settings) {
                const s = settings[id];
                const poolSnap = await get(ref(db, `games/${id}/pool`));
                const pool = poolSnap.val() || [];
                const remain = pool.filter(p => !p.taken).length;
                const total = s.total || pool.length;
                const percent = Math.floor(((total - remain) / total) * 100);

                monitorContainer.innerHTML += `
                    <div class="monitor-item">
                        <div class="monitor-info">
                            <b>${id} <span class="badge-blue badge">${s.category}</span></b>
                            <span>${total - remain} / ${total} æŠ½</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <div style="font-size:0.7rem; color:#64748b; margin-top:8px;">
                            å‰©é¤˜ç±¤æ•¸ï¼š${remain} | å–®åƒ¹ï¼šP ${s.price}
                        </div>
                    </div>
                `;
            }
        });
    }

    // --- æœƒå“¡ç®¡ç†åŠŸèƒ½ ---
    window.queryUser = async () => {
        const id = document.getElementById('targetId').value.trim();
        if(!id) return;
        const s = await get(ref(db, `users/${id}`));
        const resDiv = document.getElementById('userResult');
        resDiv.style.display = "block";
        if(s.exists()){
            document.getElementById('uBalDisplay').innerText = s.val().balance.toLocaleString();
        } else {
            if(confirm("æŸ¥ç„¡æ­¤äººï¼Œæ˜¯å¦ç›´æ¥æ–°å»ºæœƒå“¡å¸³è™Ÿï¼Ÿ")){
                await set(ref(db, `users/${id}`), { balance: 0, pin: "" });
                queryUser();
            }
        }
    };

    window.saveUserBal = async () => {
        const id = document.getElementById('targetId').value.trim();
        const input = document.getElementById('newBal').value.trim();
        const s = await get(ref(db, `users/${id}`));
        let cur = s.val().balance || 0;
        let final = input.startsWith('+') ? cur + parseInt(input.slice(1)) : 
                    input.startsWith('-') ? cur - parseInt(input.slice(1)) : parseInt(input);
        await update(ref(db, `users/${id}`), { balance: final });
        alert("é‡‘é¡å·²æ›´æ–°");
        queryUser();
    };

    window.resetUserPin = async () => {
        const id = document.getElementById('targetId').value.trim();
        if(confirm("ç¢ºå®šé‡ç½® PIN ç¢¼ï¼Ÿ")) {
            await update(ref(db, `users/${id}`), { pin: "" });
            alert("å·²é‡ç½®");
        }
    };

    // --- éŠæˆ²ç™¼ä½ˆåŠŸèƒ½ ---
    window.publishGame = async () => {
        const id = document.getElementById('gId').value.trim();
        const category = document.getElementById('gCat').value.trim() || "æœªåˆ†é¡";
        const price = parseInt(document.getElementById('gPrice').value);
        const total = parseInt(document.getElementById('gTotal').value);
        const img = document.getElementById('gImg').value.trim();
        const prizes = JSON.parse(document.getElementById('gPrizes').value);

        await set(ref(db, `gameSettings/${id}`), { price, total, prizes, img, category });
        let pool = Array.from({length: total}, (_, i) => ({ grade: i+1, taken: false }));
        pool.sort(() => Math.random() - 0.5);
        await set(ref(db, `games/${id}/pool`), pool);
        alert("éŠæˆ²ç™¼ä½ˆæˆåŠŸä¸¦å·²æ´—ç‰Œï¼");
    };
</script>
</body>
</html>
