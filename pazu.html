<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>夢工廠旗艦彈珠台 V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        html, body { 
            position: fixed; width: 100%; height: 100%; 
            overflow: hidden; touch-action: none; 
            background: #020617; margin: 0;
        }
        .game-wrapper {
            display: flex; align-items: center; justify-content: center;
            height: 90vh; gap: 10px; padding: 10px;
        }
        .machine-frame {
            border: 10px solid #422006; border-radius: 40px 40px 10px 10px;
            background: #2d140a; position: relative;
            flex-grow: 1; max-width: 450px; height: 100%;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9), 0 20px 50px rgba(0,0,0,0.7);
        }
        .plunger-area {
            width: 40px; height: 180px; background: #1a0f0a;
            border: 3px solid #713f12; border-radius: 20px;
            position: relative; display: flex; justify-content: center;
        }
        #plunger-stick { width: 8px; height: 100px; background: #64748b; border-radius: 4px; margin-top: 5px; }
        #plunger-knob {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            width: 32px; height: 32px; background: radial-gradient(circle at 30% 30%, #ff4d4d, #7f1d1d);
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div class="w-full max-w-[500px] p-4 flex justify-between items-center text-white">
        <div class="bg-slate-900/80 p-2 px-5 rounded-2xl border border-amber-900/50">
            <p class="text-[10px] text-amber-500 font-bold uppercase">Points</p>
            <p id="userPoints" class="text-xl font-black">---</p>
        </div>
        <div class="bg-slate-900/80 p-2 px-5 rounded-2xl border border-amber-900/50 text-right">
            <p class="text-[10px] text-amber-500 font-bold uppercase">Game Progress</p>
            <p id="gameState" class="text-xl font-black italic">BALLS: 0 / 5</p>
        </div>
    </div>

    <div class="game-wrapper">
        <div class="machine-frame">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div class="plunger-area">
            <div id="plunger-stick">
                <div id="plunger-knob"></div>
            </div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-amber-50 w-full max-w-sm rounded-[3rem] p-10 border-[10px] border-amber-900 text-center">
            <h2 class="text-amber-900 font-black text-2xl uppercase">總積分結算</h2>
            <h1 id="finalScore" class="text-7xl font-black text-red-600 my-6">0</h1>
            <button onclick="location.reload()" class="w-full py-5 rounded-2xl font-black bg-amber-800 text-white text-xl active:scale-95 transition">開始新局 (10點)</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco",
            authDomain: "dream8-7b161.firebaseapp.com",
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com",
            projectId: "dream8-7b161",
            storageBucket: "dream8-7b161.firebasestorage.app",
            messagingSenderId: "606218522479",
            appId: "1:606218522479:web:2737643db3de735af7e29a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let user = { id: "", points: 0 };
        let activeBall = { x: 0, y: 0, vx: 0, vy: 0, r: 8, active: false };
        let settledBalls = []; // 存放置在洞裡的球
        let pins = [];
        let holes = [10, 50, 100, 20, 10, 80, 20, 100, 50, 10];
        let totalBalls = 5, usedBalls = 0, currentScore = 0;
        let isDragging = false, startY = 0, dragOffset = 0;

        function resize() {
            const container = document.querySelector('.machine-frame');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            initPins();
            resetActiveBall();
        }

        function initPins() {
            pins = [];
            const gameWidth = canvas.width - 50; 
            for (let i = 0; i < 8; i++) {
                let rowCount = i % 2 === 0 ? 6 : 7;
                for (let j = 0; j < rowCount; j++) {
                    pins.push({ x: (i % 2 === 0 ? 35 : 15) + j * (gameWidth/rowCount), y: 160 + i * 40 });
                }
            }
        }

        function resetActiveBall() {
            activeBall.x = canvas.width - 25; 
            activeBall.y = canvas.height - 40;
            activeBall.vx = 0; activeBall.vy = 0; activeBall.active = false;
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2008968610-8dLoGQie" });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    user.id = p.userId;
                    db.ref('users/' + user.id + '/points').on('value', s => {
                        user.points = s.val() || 0;
                        document.getElementById('userPoints').innerText = user.points.toLocaleString();
                    });
                }
            } catch (e) {}
        }

        function draw() {
            ctx.fillStyle = "#2d140a";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const laneX = canvas.width - 45;

            // 1. 物理軌道線條
            ctx.strokeStyle = "#5d2e17"; ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(laneX, canvas.height); ctx.lineTo(laneX, 100); // 直軌
            ctx.arc(laneX - 100, 100, 100, 0, Math.PI, true); // 頂部大圓弧
            ctx.stroke();

            // 2. 孔位與分數
            const holeWidth = laneX / holes.length;
            holes.forEach((s, i) => {
                const x = i * holeWidth;
                ctx.fillStyle = "#1a0f0a";
                ctx.beginPath(); ctx.arc(x + holeWidth/2, canvas.height - 40, holeWidth/2.2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#eab308"; ctx.font = "bold 10px Arial"; ctx.textAlign = "center";
                ctx.fillText(s, x + holeWidth/2, canvas.height - 15);
            });

            // 3. 釘子
            ctx.fillStyle = "#94a3b8";
            pins.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill(); });

            // 4. 畫掉入洞裡的球 (不會消失)
            settledBalls.forEach(b => drawBall(b.x, b.y));

            // 5. 畫當前活動球
            if (!activeBall.active && usedBalls < totalBalls) {
                drawBall(activeBall.x, activeBall.y);
            } else if (activeBall.active) {
                drawBall(activeBall.x, activeBall.y);
            }

            update();
            requestAnimationFrame(draw);
        }

        function drawBall(x, y) {
            let g = ctx.createRadialGradient(x-3, y-3, 1, x, y, 8);
            g.addColorStop(0, '#fff'); g.addColorStop(1, '#64748b');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, 8, 0, Math.PI*2); ctx.fill();
        }

        function update() {
            if (!activeBall.active) return;

            activeBall.vy += 0.22;
            activeBall.x += activeBall.vx;
            activeBall.y += activeBall.vy;

            const laneX = canvas.width - 45;

            // 牆壁碰撞 (考慮發射軌道)
            if (activeBall.x < activeBall.r) { activeBall.x = activeBall.r; activeBall.vx *= -0.5; }
            if (activeBall.y < activeBall.r) { activeBall.y = activeBall.r; activeBall.vy *= -0.5; }
            if (activeBall.x > canvas.width - activeBall.r) { activeBall.x = canvas.width - activeBall.r; activeBall.vx *= -0.5; }

            // 軌道隔離：球在發射道內(x > laneX) 只有在衝出軌道口(y < 100)後才能進入遊戲區
            if (activeBall.x > laneX - activeBall.r && activeBall.y > 100) {
                activeBall.x = laneX - activeBall.r; activeBall.vx *= -0.4;
            }

            // 釘子反彈
            pins.forEach(p => {
                const dx = activeBall.x - p.x, dy = activeBall.y - p.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < activeBall.r + 3) {
                    const angle = Math.atan2(dy, dx);
                    const speed = Math.sqrt(activeBall.vx**2 + activeBall.vy**2);
                    activeBall.vx = Math.cos(angle) * (speed * 0.7 + 0.8);
                    activeBall.vy = Math.sin(angle) * (speed * 0.7 + 0.8);
                }
            });

            // 結算落點
            if (activeBall.y > canvas.height - 50 && activeBall.x < laneX) {
                const holeWidth = laneX / holes.length;
                let idx = Math.floor(activeBall.x / holeWidth);
                currentScore += holes[Math.min(idx, 9)];
                
                // 將球存入「已結算」陣列
                settledBalls.push({ x: activeBall.x, y: canvas.height - 40 });
                usedBalls++;
                document.getElementById('gameState').innerText = `BALLS: ${usedBalls} / 5`;
                
                if (usedBalls < totalBalls) {
                    resetActiveBall();
                } else {
                    activeBall.active = false;
                    setTimeout(() => {
                        document.getElementById('finalScore').innerText = currentScore;
                        document.getElementById('resultModal').classList.remove('hidden');
                    }, 800);
                }
            }

            // 如果球沒衝上去掉回來
            if (activeBall.y > canvas.height - 20 && activeBall.x >= laneX) {
                resetActiveBall();
            }
        }

        const knob = document.getElementById('plunger-knob');
        const stick = document.getElementById('plunger-stick');

        knob.addEventListener('touchstart', (e) => {
            if (activeBall.active || usedBalls >= totalBalls) return;
            isDragging = true; startY = e.touches[0].clientY;
        }, { passive: false });

        window.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            dragOffset = Math.max(0, Math.min(100, e.touches[0].clientY - startY));
            stick.style.transform = `translateY(${dragOffset}px)`;
            e.preventDefault();
        }, { passive: false });

        window.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            if (dragOffset > 20) {
                if (usedBalls === 0) { // 第一球扣點
                    if (user.points < 10) return alert("點數不足！");
                    db.ref('users/' + user.id).update({ points: user.points - 10 });
                }
                activeBall.active = true;
                activeBall.vy = -(dragOffset / 4);
                activeBall.vx = -1.5; // 強制給予向左的「甩出力」
            }
            stick.style.transform = `translateY(0px)`;
            dragOffset = 0;
        });

        window.onload = () => { initLIFF(); resize(); draw(); };
        window.onresize = resize;
    </script>
</body>
</html>
