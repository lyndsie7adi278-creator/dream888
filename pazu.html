<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>å¤¢å·¥å» å½ˆç å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        html, body { 
            position: fixed; width: 100%; height: 100%; 
            overflow: hidden; touch-action: none; 
            background: #1a0f0a; margin: 0; 
            overscroll-behavior: none;
        }
        .wood-bg { background-color: #d2b48c; background-image: url('https://www.transparenttextures.com/patterns/wood-pattern-polished.png'); }
        .machine-frame {
            border: 10px solid #5d2e17; border-radius: 40px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5), 0 20px 40px rgba(0,0,0,0.8);
            background: #fdf5e6; position: relative; overflow: hidden;
        }
        .plunger-outer {
            width: 45px; height: 180px; background: #8b4513; border: 4px solid #422006;
            border-radius: 22px; display: flex; justify-content: center; align-self: flex-end; margin-bottom: 20px;
        }
        #p-stick { width: 8px; height: 100px; background: #94a3b8; border-radius: 4px; margin-top: 5px; position: relative; }
        #p-knob {
            position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            width: 42px; height: 42px; background: radial-gradient(circle at 30% 30%, #ef4444, #7f1d1d);
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .modal-active { display: flex !important; }
    </style>
</head>
<body class="flex flex-col items-center wood-bg">

    <div class="w-full max-w-[420px] p-3 flex justify-between items-center gap-2">
        <div class="bg-white/40 flex-1 px-3 py-1 rounded-xl border border-amber-900/20 text-center shadow-sm">
            <p class="text-[8px] uppercase font-bold text-amber-900">æŒæœ‰</p>
            <p id="userPoints" class="text-lg font-black text-amber-900">---</p>
        </div>
        <div class="bg-amber-900/80 flex-1 px-3 py-1 rounded-xl border border-amber-600 text-center shadow-sm">
            <p class="text-[8px] uppercase font-bold text-amber-100">æœ¬å±€ç©åˆ†</p>
            <p id="gameScore" class="text-lg font-black text-white">0</p>
        </div>
        <button onclick="togglePrize(true)" class="bg-red-700 text-white px-3 py-2 rounded-xl text-xs font-bold shadow-lg">çé …</button>
    </div>

    <div class="flex items-stretch gap-3 px-2 h-[80vh] w-full max-w-[480px]">
        <div class="machine-frame flex-grow">
            <canvas id="gameCanvas"></canvas>
            <div id="ballIndicator" class="absolute top-2 left-1/2 -translate-x-1/2 text-[10px] font-bold text-amber-900/40 uppercase">Remaining: 5</div>
        </div>
        <div class="plunger-side plunger-outer">
            <div id="p-stick">
                <div id="p-knob"></div>
            </div>
        </div>
    </div>

    <div id="prizeModal" class="fixed inset-0 bg-black/70 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm" onclick="togglePrize(false)">
        <div class="bg-[#fdf5e6] w-full max-w-xs rounded-[2rem] p-6 border-8 border-[#5d2e17]" onclick="event.stopPropagation()">
            <h3 class="text-center font-black text-xl text-[#5d2e17] mb-4">ğŸ† ç©åˆ†çå‹µè¡¨</h3>
            <ul class="space-y-3 text-sm font-bold text-amber-900">
                <li class="flex justify-between border-b border-amber-200 pb-1"><span>500åˆ†ä»¥ä¸Š</span> <span>ç¥ç§˜å¤§çğŸ</span></li>
                <li class="flex justify-between border-b border-amber-200 pb-1"><span>300åˆ†ä»¥ä¸Š</span> <span>ç²¾ç¾å¥½ç¦®âœ¨</span></li>
                <li class="flex justify-between border-b border-amber-200 pb-1"><span>100åˆ†ä»¥ä¸Š</span> <span>å®‰æ…°çé …ğŸˆ</span></li>
            </ul>
            <button onclick="togglePrize(false)" class="mt-6 w-full py-3 bg-amber-800 text-white rounded-xl font-bold">é—œé–‰</button>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black/95 z-[110] hidden items-center justify-center p-6">
        <div class="bg-[#fdf5e6] w-full max-w-sm rounded-[3rem] p-10 border-[10px] border-[#5d2e17] text-center shadow-2xl">
            <h2 class="text-[#5d2e17] font-black text-2xl">éŠæˆ²çµæŸ</h2>
            <h1 id="finalScore" class="text-7xl font-black text-red-600 my-6">0</h1>
            <button onclick="location.reload()" class="w-full py-5 rounded-2xl font-black bg-[#5d2e17] text-white text-xl shadow-lg">æ–°éŠæˆ² (10é»)</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco",
            authDomain: "dream8-7b161.firebaseapp.com",
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com",
            projectId: "dream8-7b161",
            storageBucket: "dream8-7b161.firebasestorage.app",
            messagingSenderId: "606218522479",
            appId: "1:606218522479:web:2737643db3de735af7e29a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let user = { id: "", points: 0 };
        let ball = { x: 0, y: 0, vx: 0, vy: 0, r: 8.5, active: false, hasLeftLane: false };
        let settledBalls = [];
        let holeOccupancy = Array(10).fill(0);
        let pins = [];
        let holes = [10, 20, 50, 100, 30, 30, 100, 50, 20, 10];
        let score = 0, usedBalls = 0, isDragging = false, startY = 0, dragOffset = 0;
        let arcCenterX, arcCenterY, arcRadius, laneX, holeWidth;

        function togglePrize(show) { document.getElementById('prizeModal').classList.toggle('modal-active', show); }

        function initLayout() {
            const container = document.querySelector('.machine-frame');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            laneX = canvas.width - 40;
            holeWidth = laneX / 10;
            arcCenterX = canvas.width / 2;
            arcCenterY = 145; 
            arcRadius = canvas.width / 2 - 5;
            
            pins = [];
            const pinTop = 160, pinBottom = canvas.height - 160, rows = 10;
            const rowSp = (pinBottom - pinTop) / (rows - 1);
            for (let i = 0; i < rows; i++) {
                const isSix = (i % 2 === 0);
                const count = isSix ? 6 : 5;
                const sp = laneX / 6;
                for (let j = 0; j < count; j++) {
                    let px = isSix ? (laneX/12 + j*sp) : (laneX/6 + j*sp);
                    pins.push({ x: px, y: pinTop + i * rowSp });
                }
            }
            resetToLaunch();
        }

        function resetToLaunch() {
            ball.x = canvas.width - 20;
            ball.y = canvas.height - 40;
            ball.vx = 0; ball.vy = 0;
            ball.active = false;
            ball.hasLeftLane = false;
        }

        function drawBall(x, y) {
            let g = ctx.createRadialGradient(x-2, y-2, 1, x, y, 8.5);
            g.addColorStop(0, '#ff7e7e'); g.addColorStop(1, '#8b0000');
            ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, 8.5, 0, Math.PI*2); ctx.fill();
        }

        function update() {
            if (!ball.active) return;
            const steps = 15;
            for(let s=0; s<steps; s++) {
                ball.vy += 0.22 / steps;
                ball.x += ball.vx / steps;
                ball.y += ball.vy / steps;

                // æ§½ä½ç‰©ç†
                if (ball.y > canvas.height - 110 && ball.x < laneX) {
                    const idx = Math.floor(ball.x / holeWidth);
                    const left = idx * holeWidth + ball.r, right = (idx + 1) * holeWidth - ball.r;
                    if (ball.x < left) { ball.x = left; ball.vx *= -0.3; }
                    if (ball.x > right) { ball.x = right; ball.vx *= -0.3; }
                }

                if (ball.x < laneX - ball.r) ball.hasLeftLane = true;
                if (ball.hasLeftLane) {
                    if (ball.x > laneX - ball.r && ball.y > arcCenterY) { ball.x = laneX - ball.r; ball.vx *= -0.5; }
                } else {
                    if (ball.x < laneX + ball.r && ball.y > arcCenterY) { ball.x = Math.max(laneX + ball.r, ball.x); ball.vx = 0; }
                }

                const dx = ball.x - arcCenterX, dy = ball.y - arcCenterY, dist = Math.sqrt(dx*dx + dy*dy);
                if (ball.y < arcCenterY && dist + ball.r > arcRadius) {
                    const nx = dx / dist, ny = dy / dist;
                    ball.x = arcCenterX + nx * (arcRadius - ball.r);
                    ball.y = arcCenterY + ny * (arcRadius - ball.r);
                    const dot = ball.vx * nx + ball.vy * ny;
                    if (dot > 0) { ball.vx = (ball.vx - 1.8 * dot * nx) * 0.98; ball.vy = (ball.vy - 1.8 * dot * ny) * 0.98; }
                }

                pins.forEach(p => {
                    const pdx = ball.x - p.x, pdy = ball.y - p.y, pdist = Math.sqrt(pdx*pdx + pdy*pdy);
                    if (pdist < ball.r + 3.5) {
                        const angle = Math.atan2(pdy, pdx);
                        const speed = Math.sqrt(ball.vx**2 + ball.vy**2);
                        ball.vx = Math.cos(angle) * (speed * 0.75 + 0.4); ball.vy = Math.sin(angle) * (speed * 0.75 + 0.4);
                    }
                });
                if (ball.x < ball.r) { ball.x = ball.r; ball.vx *= -0.5; }
                if (ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.5; }
            }

            // çµç®—é»åˆ¤æ–·
            if (ball.y > canvas.height - 30 && ball.x < laneX) {
                const idx = Math.floor(ball.x / holeWidth);
                score += holes[Math.min(idx, 9)];
                const stack = holeOccupancy[idx];
                
                // å¼·åˆ¶çµ•å°ç½®ä¸­
                const targetX = (idx + 0.5) * holeWidth;
                settledBalls.push({ x: targetX, y: canvas.height - 20 - (stack * 18) });
                holeOccupancy[idx]++;
                usedBalls++;
                
                document.getElementById('gameScore').innerText = score;
                document.getElementById('ballIndicator').innerText = `Remaining: ${5 - usedBalls}`;
                
                if (usedBalls < 5) {
                    resetToLaunch();
                } else {
                    ball.active = false;
                    setTimeout(() => {
                        document.getElementById('finalScore').innerText = score;
                        document.getElementById('resultModal').classList.remove('hidden');
                    }, 800);
                }
            }
            // æ²’è¡ä¸Šå»æ‰å›ä¾†
            if (ball.y > canvas.height && ball.x >= laneX) resetToLaunch();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "#8b4513"; ctx.lineWidth = 6;
            ctx.beginPath(); ctx.moveTo(laneX, canvas.height); ctx.lineTo(laneX, arcCenterY); ctx.stroke();
            ctx.beginPath(); ctx.arc(arcCenterX, arcCenterY, arcRadius, Math.PI, 0, false); ctx.stroke();
            for(let i=0; i<=10; i++) {
                ctx.beginPath(); ctx.lineWidth = 4;
                ctx.moveTo(i * holeWidth, canvas.height - 110); ctx.lineTo(i * holeWidth, canvas.height); ctx.stroke();
            }
            holes.forEach((s, i) => {
                ctx.fillStyle = "#8b4513"; ctx.font = "bold 10px Arial"; ctx.textAlign = "center";
                ctx.fillText(s, i * holeWidth + holeWidth/2, canvas.height - 10);
            });
            ctx.fillStyle = "#cd853f";
            pins.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2); ctx.fill(); });
            
            settledBalls.forEach(b => drawBall(b.x, b.y));
            
            // åªè¦éŠæˆ²é‚„æ²’æ‰“å®Œ 5 é¡†ï¼Œç™¼å°„å°ä¸Šä¸€å®šè¦ç•«å‡ºä¸€é¡†çƒ
            if (usedBalls < 5) {
                drawBall(ball.x, ball.y);
            }
            
            update();
            requestAnimationFrame(animate);
        }

        const pStick = document.getElementById('p-stick');
        document.addEventListener('touchstart', (e) => {
            if (e.target.closest('.plunger-outer')) {
                if (ball.active || usedBalls >= 5) return;
                isDragging = true; startY = e.touches[0].clientY;
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (isDragging) {
                dragOffset = Math.max(0, Math.min(100, e.touches[0].clientY - startY));
                pStick.style.transform = `translateY(${dragOffset}px)`;
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            if (dragOffset > 25) {
                if (usedBalls === 0) db.ref('users/' + user.id).update({ points: user.points - 10 });
                ball.active = true;
                ball.vy = -(dragOffset / 3.2); 
                ball.vx = (Math.random() - 0.5) * 0.5; 
            }
            pStick.style.transform = `translateY(0px)`;
            dragOffset = 0;
        });

        async function init() {
            try {
                await liff.init({ liffId: "2008968610-8dLoGQie" });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    user.id = p.userId;
                    db.ref('users/' + user.id + '/points').on('value', s => {
                        user.points = s.val() || 0;
                        document.getElementById('userPoints').innerText = user.points.toLocaleString();
                    });
                }
            } catch (e) {}
            initLayout();
            animate();
        }
        window.onload = init;
    </script>
</body>
</html>
