<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>夢工廠皇冠彈珠台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { background: #020617; color: #f8fafc; font-family: "PingFang TC", sans-serif; overflow: hidden; touch-action: none; }
        .wood-border { border: 12px solid #422006; outline: 4px solid #713f12; border-radius: 40px; }
        .neon-line { box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        #spring-container { 
            position: absolute; right: 25px; bottom: 40px; width: 45px; height: 160px; 
            background: #1e293b; border: 3px solid #475569; border-radius: 10px; overflow: hidden;
        }
        #spring-plunger { 
            position: absolute; bottom: 0; width: 100%; height: 30px; 
            background: linear-gradient(to top, #475569, #94a3b8); border-top: 4px solid #fff;
        }
        .score-box { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2">

    <div class="w-full max-w-[360px] score-box mb-2 p-4 rounded-2xl border border-slate-700 flex justify-between items-center shadow-2xl">
        <div>
            <p class="text-[10px] text-slate-400 font-bold uppercase">WALLET</p>
            <p id="userPoints" class="text-xl font-black text-amber-500">---</p>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-slate-400 font-bold uppercase">SCORE / BALLS</p>
            <p id="gameState" class="text-xl font-black text-white">0 <span class="text-xs text-slate-400">PTS</span> / 5 <span class="text-xs text-slate-400">B</span></p>
        </div>
    </div>

    <div class="relative wood-border shadow-[0_0_50px_rgba(0,0,0,0.8)]">
        <canvas id="gameCanvas"></canvas>
        
        <div id="spring-container">
            <div id="spring-plunger"></div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-[3rem] p-10 border-4 border-amber-600 text-center shadow-[0_0_100px_rgba(234,179,8,0.3)]">
            <p class="text-amber-500 font-bold tracking-widest mb-2">GAME OVER</p>
            <h2 id="finalScore" class="text-7xl font-black text-white mb-6">0</h2>
            <div class="bg-slate-800 rounded-2xl p-4 mb-8 border border-slate-700">
                <p id="prizeMsg" class="text-slate-300 font-medium">請截圖找官方 Line 領取獎勵！</p>
            </div>
            <button onclick="location.reload()" class="w-full py-5 rounded-2xl font-black bg-amber-500 text-black text-xl shadow-lg active:scale-95 transition">再挑戰一次 (10點)</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPGEIwCKyYxz6TYdxmkwAxIWjfQI8Awco",
            authDomain: "dream8-7b161.firebaseapp.com",
            databaseURL: "https://dream8-7b161-default-rtdb.firebaseio.com",
            projectId: "dream8-7b161",
            storageBucket: "dream8-7b161.firebasestorage.app",
            messagingSenderId: "606218522479",
            appId: "1:606218522479:web:2737643db3de735af7e29a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = 340;
        canvas.height = 540;

        let user = { id: "Guest", points: 0 };
        let ball = { x: 318, y: 500, vx: 0, vy: 0, r: 9, active: false };
        let pins = [];
        let holes = [20, 50, 10, 100, 30, 30, 100, 10, 50, 20];
        let score = 0, ballsLeft = 5;
        let charge = 0, isCharging = false;

        // 生成排列整齊的釘子 (蜂巢式排列)
        for (let i = 0; i < 8; i++) {
            for (let j = 0; j < 8; j++) {
                if (j === 7 && i % 2 === 0) continue;
                pins.push({ x: 35 + j * 40 + (i % 2 * 20), y: 120 + i * 45 });
            }
        }

        async function init() {
            try {
                await liff.init({ liffId: "2008968610-8dLoGQie" });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    user.id = p.userId;
                    db.ref('users/' + user.id + '/points').on('value', s => {
                        user.points = s.val() || 0;
                        document.getElementById('userPoints').innerText = user.points.toLocaleString();
                    });
                }
            } catch (e) { console.log(e); }
        }

        function draw() {
            // 背景與漸層
            let bgGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGrad.addColorStop(0, '#1e293b');
            bgGrad.addColorStop(1, '#0f172a');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 頂部圓弧擋板
            ctx.beginPath();
            ctx.arc(170, 100, 170, Math.PI, 0);
            ctx.lineWidth = 10; ctx.strokeStyle = "#475569"; ctx.stroke();

            // 畫出分位線
            ctx.strokeStyle = "rgba(71, 85, 105, 0.5)"; ctx.lineWidth = 2;
            for(let i=1; i<10; i++) {
                ctx.beginPath(); ctx.moveTo(i*31, 460); ctx.lineTo(i*31, 540); ctx.stroke();
            }

            // 畫孔位分數
            holes.forEach((s, i) => {
                ctx.fillStyle = s >= 50 ? "#eab308" : "#64748b";
                ctx.font = "black 12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(s, i*31 + 15, 500);
            });

            // 畫釘子 (立體感)
            pins.forEach(p => {
                ctx.fillStyle = "#94a3b8";
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "#f8fafc";
                ctx.beginPath(); ctx.arc(p.x-1, p.y-1, 1.5, 0, Math.PI * 2); ctx.fill();
            });

            // 畫鋼珠 (高質感鋼鐵色)
            if (ball.active || ballsLeft > 0) {
                let ballGrad = ctx.createRadialGradient(ball.x-3, ball.y-3, 1, ball.x, ball.y, ball.r);
                ballGrad.addColorStop(0, '#fff');
                ballGrad.addColorStop(0.5, '#cbd5e1');
                ballGrad.addColorStop(1, '#475569');
                ctx.fillStyle = ballGrad;
                ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
            }

            update();
            requestAnimationFrame(draw);
        }

        function update() {
            if (!ball.active) return;

            ball.vy += 0.25; // 重力
            ball.x += ball.vx;
            ball.y += ball.vy;

            // 邊界碰撞
            if (ball.x < ball.r) { ball.x = ball.r; ball.vx *= -0.6; }
            if (ball.x > canvas.width - ball.r && ball.y > 100) { ball.x = canvas.width - ball.r; ball.vx *= -0.6; }
            if (ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.6; }

            // 釘子碰撞物理
            pins.forEach(p => {
                const dx = ball.x - p.x, dy = ball.y - p.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < ball.r + 4) {
                    const angle = Math.atan2(dy, dx);
                    const speed = Math.sqrt(ball.vx**2 + ball.vy**2) * 0.8;
                    ball.vx = Math.cos(angle) * (speed + 1);
                    ball.vy = Math.sin(angle) * (speed + 1);
                }
            });

            // 掉入洞中
            if (ball.y > 510) {
                let idx = Math.floor(ball.x / 31);
                score += holes[Math.min(idx, 9)];
                ball.active = false;
                ballsLeft--;
                document.getElementById('gameState').innerHTML = `${score} <span class="text-xs text-slate-400">PTS</span> / ${ballsLeft} <span class="text-xs text-slate-400">B</span>`;
                
                if (ballsLeft > 0) {
                    ball.x = 318; ball.y = 500; ball.vx = 0; ball.vy = 0;
                } else {
                    setTimeout(() => {
                        document.getElementById('finalScore').innerText = score;
                        document.getElementById('resultModal').classList.remove('hidden');
                    }, 500);
                }
            }
        }

        // 蓄力邏輯
        const plunger = document.getElementById('spring-plunger');
        const container = document.getElementById('spring-container');

        container.addEventListener('touchstart', () => {
            if (ball.active || ballsLeft <= 0) return;
            isCharging = true;
        });

        window.addEventListener('touchend', () => {
            if (!isCharging) return;
            isCharging = false;
            
            // 第一球扣點
            if (ballsLeft === 5) {
                if (user.points < 10) { alert("點數不足！"); charge = 0; plunger.style.height = "30px"; return; }
                db.ref('users/' + user.id).update({ points: user.points - 10 });
            }

            ball.active = true;
            ball.vy = -(charge / 4);
            ball.vx = -1.2;
            charge = 0;
            plunger.style.height = "30px";
        });

        setInterval(() => {
            if (isCharging) {
                charge = Math.min(charge + 2.5, 90);
                plunger.style.height = (30 + charge) + "px";
            }
        }, 20);

        window.onload = () => { init(); draw(); };
    </script>
</body>
</html>
