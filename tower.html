<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>å¤¢å·¥å»  | å‹‡è€…çˆ¬å¡”</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #0f0c29;
        --card-bg: rgba(255, 255, 255, 0.05);
        --p: #ffd700;
        --gem: #00d2d3;
        --bomb: #ff4757;
        --text-glow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
    body {
        margin: 0; padding: 0;
        background: radial-gradient(circle at center, #302b63, #0f0c29);
        color: #fff;
        font-family: 'Roboto', sans-serif;
        display: flex; flex-direction: column;
        min-height: 100vh; overflow: hidden;
    }

    /* é ‚éƒ¨å°èˆª */
    .navbar {
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 100;
    }
    .back-btn { text-decoration: none; color: #aaa; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    .coin-pill {
        background: rgba(0, 0, 0, 0.5); border: 1px solid var(--p);
        padding: 6px 16px; border-radius: 50px;
        color: var(--p); font-family: 'Orbitron', sans-serif; font-weight: bold;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    }

    /* éŠæˆ²ä¸»å€ */
    .game-stage {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; position: relative;
    }

    /* é€²åº¦æ¢ HUD */
    .hud-container {
        width: 100%; max-width: 400px; margin-bottom: 30px;
        display: flex; justify-content: space-between; align-items: flex-end;
    }
    .level-badge {
        font-size: 2rem; font-family: 'Orbitron', sans-serif; font-weight: 900;
        color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.3);
    }
    .level-label { font-size: 0.8rem; color: #888; letter-spacing: 2px; text-transform: uppercase; }
    .next-prize {
        text-align: right;
    }
    .prize-val { font-size: 1.5rem; color: var(--gem); font-weight: bold; font-family: 'Orbitron', sans-serif; }

    /* é–€çš„å®¹å™¨ */
    .doors-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        width: 100%; max-width: 360px;
        perspective: 1000px; /* 3D æ•ˆæœ */
    }

    /* é–€ (å¡ç‰‡) */
    .door-card {
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        aspect-ratio: 1/1.2;
        position: relative;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        transform-style: preserve-3d;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        display: flex; align-items: center; justify-content: center;
    }
    .door-card:active { transform: scale(0.95); }

    /* é–€çš„æ­£é¢èˆ‡èƒŒé¢ */
    .door-face, .door-back {
        position: absolute; inset: 0; border-radius: 16px;
        backface-visibility: hidden;
        display: flex; align-items: center; justify-content: center;
        font-size: 3rem;
    }
    .door-face {
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
        color: rgba(255,255,255,0.3);
        font-family: 'Orbitron', sans-serif;
    }
    .door-back {
        transform: rotateY(180deg);
        background: rgba(0,0,0,0.8);
        border: 2px solid;
    }
    
    /* ç¿»ç‰Œå‹•ç•«ç‹€æ…‹ */
    .door-card.flipped { transform: rotateY(180deg); pointer-events: none; }
    
    /* çµæœæ¨£å¼ */
    .gem-style { border-color: var(--gem); box-shadow: 0 0 30px rgba(0, 210, 211, 0.4); }
    .bomb-style { border-color: var(--bomb); box-shadow: 0 0 30px rgba(255, 71, 87, 0.6); animation: shake 0.5s; }

    /* æ§åˆ¶æŒ‰éˆ•å€ */
    .controls {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        max-width: 400px; margin: 0 auto;
        display: flex; gap: 15px; z-index: 50;
    }
    .btn-main {
        flex: 1; padding: 18px; border-radius: 50px; border: none;
        font-size: 1.1rem; font-weight: 900; letter-spacing: 1px;
        cursor: pointer; transition: 0.2s;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        font-family: 'PingFang TC', sans-serif;
    }
    .btn-start {
        background: linear-gradient(90deg, #ff9966, #ff5e62);
        color: #fff;
    }
    .btn-cashout {
        background: linear-gradient(90deg, #11998e, #38ef7d);
        color: #fff;
        display: none;
    }
    .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

    /* å‹•ç•« Keyframes */
    @keyframes shake { 0%, 100% { transform: rotateY(180deg) translateX(0); } 25% { transform: rotateY(180deg) translateX(-5px); } 75% { transform: rotateY(180deg) translateX(5px); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    
    .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

    /* çµæœå½ˆçª— */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(10px);
    }
    .modal-card {
        background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1);
        padding: 40px; border-radius: 20px; text-align: center;
        width: 85%; max-width: 320px;
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
        transform: scale(0.9); transition: 0.3s;
    }
    .modal-active .modal-card { transform: scale(1); }
    
    .modal-icon { font-size: 4rem; margin-bottom: 15px; display: block; }
    .modal-title { font-size: 1.5rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
    .modal-amount { font-size: 2.5rem; font-weight: 900; font-family: 'Orbitron', sans-serif; margin-bottom: 25px; display: block; }
    .modal-btn { background: #fff; color: #000; width: 100%; padding: 15px; border-radius: 50px; font-weight: bold; border: none; font-size: 1rem; cursor: pointer; }

    #loading { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; justify-content: center; align-items: center; }
</style>
</head>
<body>

<div class="navbar">
    <a href="index.html" class="back-btn">â¬… é›¢é–‹</a>
    <div class="coin-pill">P <span id="uBal">---</span></div>
</div>

<div class="game-stage">
    
    <div class="hud-container fade-in-up" style="animation-delay: 0.1s;">
        <div>
            <div class="level-label">LEVEL</div>
            <div class="level-badge"><span id="curLvl">0</span><span style="font-size:1rem;color:#555">/8</span></div>
        </div>
        <div class="next-prize">
            <div class="level-label">CURRENT WIN</div>
            <div class="prize-val" id="curWin">0</div>
        </div>
    </div>

    <div class="doors-grid" id="doorsGrid">
        </div>

    <div id="loading"><span style="font-size:2rem; animation:spin 1s infinite">ğŸ”„</span></div>
</div>

<div class="controls fade-in-up" style="animation-delay: 0.3s;">
    <button class="btn-main btn-start" id="startBtn" onclick="startGame()">é–‹å§‹çˆ¬å¡” (10 P)</button>
    <button class="btn-main btn-cashout" id="cashoutBtn" onclick="cashOut()">ğŸ’° æ”¶æ‰‹é ˜éŒ¢</button>
</div>

<div class="modal-overlay" id="resModal">
    <div class="modal-card">
        <span class="modal-icon" id="resIcon">ğŸ†</span>
        <div class="modal-title" id="resTitle">æ­å–œç²åˆ©</div>
        <span class="modal-amount" id="resVal">+0</span>
        <button class="modal-btn" onclick="closeModal()">å†ä¾†ä¸€å±€</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const _cc = { apiKey: atob("QUl6YVN5RFBHRUl3Q0t5WXh6NlRZZHhta3dBeElXamZRSThBd2Nv"), databaseURL: atob("aHR0cHM6Ly9kcmVhbTgtN2IxNjEtZGVmYXVsdC1ydGRiLmZpcmViYXNlaW8uY29t"), projectId: atob("ZHJlYW04LTdiMTYx"), appId: atob("MTo2MDYyMTg1MjI0Nzk6d2ViOjI3Mzc2NDNkYjNkZTczNWFmN2UyOWE=") };
const app = initializeApp(_cc); const db = getDatabase(app);
const uid = localStorage.getItem('myScratchCode');
if(!uid) location.href = 'index.html';

// éŠæˆ²è¨­å®š
const COST = 10;
const PRIZES = [0, 12, 15, 20, 30, 50, 80, 150, 500]; // Lvl 0~8 (0æ˜¯èµ·å§‹)
let currentLevel = 0;
let isPlaying = false;
let bombIndex = -1;

// ç›£è½é¤˜é¡
onValue(ref(db, `users/${uid}/balance`), s => {
    document.getElementById('uBal').innerText = (s.val()||0).toLocaleString();
});

// åˆå§‹åŒ– 4 æ‰‡é–€çš„ UI
function renderDoors(delay = false) {
    const grid = document.getElementById('doorsGrid');
    grid.innerHTML = ''; // æ¸…ç©ºèˆŠçš„
    
    // ç”Ÿæˆæ–°çš„ç‚¸å½ˆä½ç½® (0-3)
    bombIndex = Math.floor(Math.random() * 4);

    for(let i=0; i<4; i++) {
        const card = document.createElement('div');
        card.className = 'door-card';
        if(delay) {
            card.style.opacity = '0';
            card.style.animation = `fadeInUp 0.4s ease ${i * 0.1}s forwards`;
        }
        
        card.innerHTML = `
            <div class="door-face">${i+1}</div>
            <div class="door-back" id="back-${i}"></div>
        `;
        
        card.onclick = () => handleDoorClick(card, i);
        grid.appendChild(card);
    }
}

// é–‹å§‹éŠæˆ²
window.startGame = async () => {
    if(isPlaying) return;
    
    // 1. å…ˆæ‰£æ¬¾ (Firebase)
    document.getElementById('loading').style.display = 'flex';
    let success = false;
    
    try {
        await runTransaction(ref(db, `users/${uid}`), (user) => {
            if(!user) return;
            if((user.balance || 0) < COST) throw "nomoney";
            user.balance -= COST;
            user.spending_counter = (user.spending_counter || 0) + COST;
            return user;
        });
        success = true;
    } catch(e) {
        if(e === "nomoney") alert("é¤˜é¡ä¸è¶³ï¼Œè«‹å…ˆå„²å€¼ï¼");
    }
    
    document.getElementById('loading').style.display = 'none';
    if(!success) return;

    // 2. éŠæˆ²ç‹€æ…‹é‡ç½®
    isPlaying = true;
    currentLevel = 0;
    updateHUD();
    renderDoors(true); // å¸¶å‹•ç•«ç”Ÿæˆ

    // åˆ‡æ›æŒ‰éˆ•
    document.getElementById('startBtn').style.display = 'none';
    const cashBtn = document.getElementById('cashoutBtn');
    cashBtn.style.display = 'block';
    cashBtn.innerHTML = `ğŸ’° é ˜å– ${PRIZES[currentLevel]} P`;
    cashBtn.classList.add('btn-disabled'); // ç¬¬ä¸€å±¤é‚„æ²’éï¼Œä¸èƒ½é ˜
};

// è™•ç†é»æ“Šé–€
function handleDoorClick(card, idx) {
    if(!isPlaying || card.classList.contains('flipped')) return;

    card.classList.add('flipped');
    const back = document.getElementById(`back-${idx}`);

    if(idx === bombIndex) {
        // ğŸ’£ è¸©åˆ°ç‚¸å½ˆ
        back.innerHTML = 'ğŸ’£';
        back.parentElement.classList.add('bomb-style');
        endGame(false);
    } else {
        // ğŸ’ éé—œ
        back.innerHTML = 'ğŸ’';
        back.parentElement.classList.add('gem-style');
        
        // å‡ç´šé‚è¼¯
        currentLevel++;
        updateHUD();

        if(currentLevel >= 8) {
            // é€šé—œå¤§ç
            setTimeout(() => endGame(true), 600);
        } else {
            // é€²ä¸‹ä¸€å±¤ (å»¶é²ä¸€ä¸‹è®“ç©å®¶çœ‹åˆ°å¯¶çŸ³)
            setTimeout(() => {
                renderDoors(true); // é‡æ–°ç”Ÿæˆæ–°çš„é–€
            }, 800);
            
            // è§£é–é ˜éŒ¢æŒ‰éˆ•
            const cashBtn = document.getElementById('cashoutBtn');
            cashBtn.classList.remove('btn-disabled');
            cashBtn.innerHTML = `ğŸ’° æ”¶æ‰‹é ˜éŒ¢ (${PRIZES[currentLevel]} P)`;
        }
    }
}

// æ”¶æ‰‹é ˜éŒ¢
window.cashOut = () => {
    if(!isPlaying || currentLevel === 0) return;
    endGame(true);
};

// çµç®—
async function endGame(isWin) {
    isPlaying = false;
    const finalWin = isWin ? PRIZES[currentLevel] : 0;

    if(isWin && finalWin > 0) {
        // è´éŒ¢å…¥å¸³
        await runTransaction(ref(db, `users/${uid}/balance`), (b) => (b||0) + finalWin);
        
        // å½ˆçª—è¨­å®š
        document.getElementById('resIcon').innerText = currentLevel===8 ? 'ğŸ‘‘' : 'ğŸ’';
        document.getElementById('resTitle').innerText = currentLevel===8 ? 'ç™»å³°é€ æ¥µï¼' : 'ç²åˆ©å…¥è¢‹';
        document.getElementById('resVal').innerText = `+${finalWin} P`;
        document.getElementById('resVal').style.color = '#00d2d3';
        
        if(finalWin >= 100) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            push(ref(db, `winLogs`), { uid, user: "çˆ¬å¡”å‹‡è€…", game: "å‹‡è€…çˆ¬å¡”", prize: `${finalWin} P`, time: serverTimestamp() });
        }
    } else {
        // è¼¸äº†
        document.getElementById('resIcon').innerText = 'ğŸ’¥';
        document.getElementById('resTitle').innerText = 'æŒ‘æˆ°å¤±æ•—';
        document.getElementById('resVal').innerText = '-10 P';
        document.getElementById('resVal').style.color = '#ff4757';
    }

    // é¡¯ç¤ºçµæœ
    const modal = document.getElementById('resModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-active'), 10);
}

window.closeModal = () => {
    document.getElementById('resModal').classList.remove('modal-active');
    setTimeout(() => document.getElementById('resModal').style.display = 'none', 300);
    
    // é‡ç½® UI
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('cashoutBtn').style.display = 'none';
    currentLevel = 0;
    updateHUD();
    document.getElementById('doorsGrid').innerHTML = '<div style="color:#666; font-size:0.9rem; grid-column:span 2; text-align:center; padding:50px;">æº–å‚™æŒ‘æˆ°...</div>';
};

function updateHUD() {
    document.getElementById('curLvl').innerText = currentLevel;
    document.getElementById('curWin').innerText = PRIZES[currentLevel];
}

</script>
</body>
</html>
