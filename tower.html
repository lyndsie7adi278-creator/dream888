<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>å¤¢å·¥å»  | æ–°æ˜¥å‹‡è€…çˆ¬å¡”</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #800000;
        --card-bg: linear-gradient(145deg, #d4af37, #aa8a2e);
        --p: #ffd700;
        --success: #ffce00;
        --fail: #ff4d4d;
        --accent: #ff0000;
    }
    * { 
        -webkit-tap-highlight-color: transparent; 
        user-select: none; 
        box-sizing: border-box; 
        font-family: 'Noto Serif TC', serif;
    }
    body {
        margin: 0; padding: 0;
        background: radial-gradient(circle at center, #850000, #4a0000);
        color: #fff;
        display: flex; flex-direction: column;
        min-height: 100vh; overflow: hidden;
        transition: background 0.5s;
    }
    /* å±éšªæ¨¡å¼èƒŒæ™¯ */
    body.danger-mode {
        background: radial-gradient(circle at center, #3d0000, #000000);
    }

    /* é ‚éƒ¨å°èˆª */
    .navbar {
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
        border-bottom: 2px solid var(--p);
        z-index: 100;
    }
    .back-btn { text-decoration: none; color: #ffcccb; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 5px; }
    
    .rules-btn {
        background: rgba(0,0,0,0.3); border: 1px solid var(--p);
        color: var(--p); padding: 5px 15px; border-radius: 20px;
        cursor: pointer; font-size: 0.9rem; font-weight: bold;
        transition: 0.2s;
        display: flex; align-items: center; gap: 5px;
    }
    .rules-btn:active { transform: scale(0.95); background: rgba(255, 215, 0, 0.2); }

    .coin-pill {
        background: rgba(0, 0, 0, 0.6); border: 1px solid var(--p);
        padding: 6px 16px; border-radius: 50px;
        color: var(--p); 
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        display: flex; align-items: center; gap: 8px;
    }
    .num-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }

    /* éŠæˆ²ä¸»å€ */
    .game-stage {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; position: relative;
    }

    /* é€²åº¦æ¢ HUD */
    .hud-container {
        width: 100%; max-width: 400px; margin-bottom: 25px;
        display: flex; justify-content: space-between; align-items: center;
        background: linear-gradient(90deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5), rgba(0,0,0,0.3));
        padding: 15px 20px; border-radius: 15px;
        border-top: 1px solid rgba(255,215,0,0.3);
        border-bottom: 1px solid rgba(255,215,0,0.3);
        position: relative;
        overflow: hidden;
    }
    .level-badge {
        font-size: 2.2rem; color: var(--p); text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    .level-label { font-size: 1rem; color: #ffcccb; margin-bottom: 5px; font-weight: 700; }
    
    .next-prize { text-align: right; }
    .prize-val { font-size: 1.8rem; color: #00ff88; text-shadow: 0 0 5px rgba(0,255,136,0.5); line-height: 1; }
    
    .next-hint {
        font-size: 0.9rem; color: #ccc; margin-top: 5px;
        display: flex; align-items: center; justify-content: flex-end; gap: 5px;
    }
    .next-hint span { color: var(--p); font-weight: bold; font-size: 1.1rem; }

    /* é›£åº¦æç¤ºæ¨™ç±¤ */
    .danger-tag {
        position: absolute; top: 0; left: 0; right: 0;
        background: rgba(255, 71, 87, 0.8); color: white;
        text-align: center; font-size: 0.8rem; padding: 2px 0;
        display: none; font-weight: bold; letter-spacing: 2px;
        animation: pulseRed 2s infinite;
    }

    .doors-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        width: 100%; max-width: 360px;
        perspective: 1000px;
    }

    .door-card {
        aspect-ratio: 1/1.2;
        position: relative;
        cursor: pointer;
        border-radius: 12px;
        background: transparent;
    }
    .door-card:active { transform: scale(0.96); transition: transform 0.1s; }

    .door-inner {
        position: relative;
        width: 100%; height: 100%;
        text-align: center;
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        transform-style: preserve-3d;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .door-inner.flipped { transform: rotateY(180deg); }

    .door-face, .door-back {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden;
        border-radius: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 3px solid var(--p);
    }
    
    .door-face {
        background: linear-gradient(160deg, #d90000, #8f0000);
        color: var(--p);
        font-size: 2.5rem;
        z-index: 2;
        text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .door-face::after {
        content: "ç¦"; font-family: 'Noto Serif TC', serif; font-weight: 900;
        font-size: 1.4rem; margin-top: 10px; 
        border: 2px solid var(--p); padding: 5px 10px; border-radius: 5px;
        background: rgba(0,0,0,0.2); box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }

    .door-back {
        transform: rotateY(180deg);
        background: #1a1a1a;
        font-size: 3.5rem;
        z-index: 1;
    }
    
    .gem-style .door-back { 
        border-color: #00ff88; 
        background: radial-gradient(circle, #0a3d22, #000); 
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.6); 
    }
    .bomb-style .door-back { 
        border-color: var(--fail); 
        background: radial-gradient(circle, #4a1111, #000); 
        box-shadow: 0 0 30px rgba(255, 77, 77, 0.6);
    }
    .shake-anim { animation: shake 0.5s; }

    .controls {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        max-width: 400px; margin: 0 auto;
        display: flex; gap: 15px; z-index: 50;
    }
    .btn-main {
        flex: 1; padding: 18px; border-radius: 12px; border: 2px solid var(--p);
        font-size: 1.3rem; font-weight: 900;
        cursor: pointer; transition: 0.2s;
        box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        letter-spacing: 2px;
    }
    .btn-start {
        background: linear-gradient(to bottom, #ffd700, #ff8c00);
        color: #800000;
        text-shadow: 0 1px 0 rgba(255,255,255,0.4);
    }
    .btn-cashout {
        background: linear-gradient(to bottom, #00b09b, #96c93d);
        color: #fff;
        display: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulseRed { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(8px);
    }
    .modal-card {
        background: #800000; border: 4px solid var(--p);
        padding: 30px; border-radius: 20px; text-align: center;
        width: 85%; max-width: 340px;
        transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0 50px rgba(255,215,0,0.2);
    }
    .modal-active .modal-card { transform: scale(1); }
    .modal-icon { font-size: 4.5rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 0 15px rgba(255,215,0,0.6)); }
    .modal-title { font-size: 2rem; color: var(--p); margin-bottom: 10px; font-weight: 900; }
    .modal-amount { font-size: 2.8rem; color: #fff; margin-bottom: 25px; display: block; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
    .modal-btn { background: var(--p); color: #800000; width: 100%; padding: 15px; border-radius: 10px; font-size: 1.3rem; font-weight: 900; cursor: pointer; border: none; letter-spacing: 2px; }
    
    .rules-content {
        text-align: left; color: #fff; font-size: 0.95rem; line-height: 1.6;
        margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 15px;
        border-radius: 10px; border: 1px solid rgba(255,215,0,0.2);
    }
    .rules-content ul { padding-left: 20px; margin: 0; }
    .rules-content li { margin-bottom: 6px; }

    #loading { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 99; justify-content: center; align-items: center; }
</style>
</head>
<body>

<div class="navbar">
    <a href="index.html" class="back-btn">â¬… è¿”å›</a>
    <button class="rules-btn" onclick="openRules()">ğŸ“œ è¦å‰‡</button>
    <div class="coin-pill">ğŸ§§ <span id="uBal" class="num-font">---</span></div>
</div>

<div class="game-stage">
    <div class="hud-container">
        <div class="danger-tag" id="dangerTag">âš ï¸ è­¦æˆ’ï¼šç‚¸å½ˆå¢é‡ (50%) âš ï¸</div>

        <div>
            <div class="level-label">ğŸ® ç•¶å‰å±¤æ•¸</div>
            <div class="level-badge num-font"><span id="curLvl">1</span><span style="font-size:1rem;color:#ffcccb">/8</span></div>
        </div>
        
        <div class="next-prize">
            <div class="level-label">ğŸ’° ç•¶å‰çé‡‘</div>
            <div class="prize-val num-font" id="curWin">0 P</div>
            <div class="next-hint" id="nextHintBox" style="display:none">
                ä¸‹ä¸€é—œ â–¶ <span class="num-font" id="nextWinVal">12</span> P
            </div>
        </div>
    </div>

    <div class="doors-grid" id="doorsGrid">
        <div style="color:var(--p); font-size:1.5rem; grid-column:span 2; text-align:center; padding:50px; font-weight:900;">ğŸ§¨ æº–å‚™å¥½é–‹é‹äº†å—ï¼Ÿ</div>
    </div>

    <div id="loading"><div style="font-size:3rem; animation:spin 2s linear infinite">ğŸ®</div></div>
</div>

<div class="controls">
    <button class="btn-main btn-start" id="startBtn" onclick="startGame()">é–‹é‹çˆ¬å¡” (10 P)</button>
    <button class="btn-main btn-cashout" id="cashoutBtn" onclick="cashOut()">ğŸ’° è¦‹å¥½å°±æ”¶</button>
</div>

<div class="modal-overlay" id="resModal">
    <div class="modal-card">
        <span class="modal-icon" id="resIcon">ğŸ§§</span>
        <div class="modal-title" id="resTitle">æ–°æ˜¥å¤§å‰</div>
        <span class="modal-amount num-font" id="resVal">+0</span>
        <button class="modal-btn" onclick="closeModal()">ç¹¼çºŒåŠªåŠ›</button>
    </div>
</div>

<div class="modal-overlay" id="rulesModal">
    <div class="modal-card">
        <div class="modal-title">ğŸ“œ éŠæˆ²è¦å‰‡</div>
        <div class="rules-content">
            <ul>
                <li><strong>æˆæœ¬ï¼š</strong>æ¯æ¬¡æŒ‘æˆ°æ¶ˆè€— 10 Pã€‚</li>
                <li><strong>æ™®é€šå±¤ (1-3)ï¼š</strong> 1 é¡†ç‚¸å½ˆ (75% éé—œç‡)ã€‚</li>
                <li><strong>å›°é›£å±¤ (4-8)ï¼š</strong> <span style="color:#ff4d4d;font-weight:bold">2 é¡†ç‚¸å½ˆ</span> (50% éé—œç‡)ã€‚</li>
                <li><strong>æ©Ÿåˆ¶ï¼š</strong>é¸ä¸­å…ƒå¯¶æ™‰ç´šï¼Œçé‡‘å€å¢ã€‚</li>
                <li><strong>æ”¶æ‰‹ï¼š</strong>éš¨æ™‚å¯æŒ‰ã€Œè¦‹å¥½å°±æ”¶ã€é ˜çã€‚</li>
                <li><strong>å¤±æ•—ï¼š</strong>é¸ä¸­ç‚¸å½ˆï¼Œç•¶å±€çé‡‘æ­¸é›¶ã€‚</li>
                <li><strong>å¤§çï¼š</strong>é€šé—œç¬¬ 8 å±¤ç² 888 Pï¼</li>
            </ul>
        </div>
        <button class="modal-btn" onclick="closeRules()">æˆ‘çŸ¥é“äº†</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const _cc = { apiKey: atob("QUl6YVN5RFBHRUl3Q0t5WXh6NlRZZHhta3dBeElXamZRSThBd2Nv"), databaseURL: atob("aHR0cHM6Ly9kcmVhbTgtN2IxNjEtZGVmYXVsdC1ydGRiLmZpcmViYXNlaW8uY29t"), projectId: atob("ZHJlYW04LTdiMTYx"), appId: atob("MTo2MDYyMTg1MjI0Nzk6d2ViOjI3Mzc2NDNkYjNkZTczNWFmN2UyOWE=") };
const app = initializeApp(_cc); const db = getDatabase(app);
const uid = localStorage.getItem('myScratchCode');
if(!uid) location.href = 'index.html';

const COST = 10;
const PRIZES = [0, 12, 15, 22, 35, 60, 100, 200, 888];
let currentLevel = 0;
let isPlaying = false;
let bombIndices = [];
let isAnimating = false;

onValue(ref(db, `users/${uid}/balance`), s => {
    document.getElementById('uBal').innerText = (s.val()||0).toLocaleString();
});

window.openRules = () => {
    const m = document.getElementById('rulesModal');
    m.style.display = 'flex';
    setTimeout(() => m.classList.add('modal-active'), 10);
};
window.closeRules = () => {
    const m = document.getElementById('rulesModal');
    m.classList.remove('modal-active');
    setTimeout(() => m.style.display = 'none', 300);
};

function renderDoors(withAnimation = false) {
    const grid = document.getElementById('doorsGrid');
    grid.innerHTML = '';
    bombIndices = [];
    
    // è¨ˆç®—ç‚¸å½ˆæ•¸é‡ï¼šLevel 0-3 (1é¡†), Level 4-8 (2é¡†)
    // é€™è£¡çš„ currentLevel æ˜¯æŒ‡ã€Œå·²å®Œæˆã€çš„å±¤æ•¸ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ 0 (å‰›é–‹å§‹) ç©çš„æ˜¯ç¬¬ä¸€å±¤
    // Level 1-3 (currentLevel 0,1,2) => 1 é¡†
    // Level 4+ (currentLevel 3ä»¥ä¸Š) => 2 é¡†
    const bombCount = currentLevel >= 3 ? 2 : 1;
    
    // ç”Ÿæˆä¸é‡è¤‡çš„ç‚¸å½ˆä½ç½®
    while(bombIndices.length < bombCount) {
        let r = Math.floor(Math.random() * 4);
        if(bombIndices.indexOf(r) === -1) bombIndices.push(r);
    }

    for(let i=0; i<4; i++) {
        const card = document.createElement('div');
        card.className = 'door-card';
        if(withAnimation) {
            card.style.opacity = '0';
            card.style.animation = `fadeInUp 0.4s ease ${i * 0.1}s forwards`;
        }
        
        card.innerHTML = `
            <div class="door-inner" id="inner-${i}">
                <div class="door-face num-font">${i+1}</div>
                <div class="door-back" id="back-${i}"></div>
            </div>
        `;
        
        card.onclick = () => handleDoorClick(card, i);
        grid.appendChild(card);
    }
}

window.startGame = async () => {
    if(isPlaying || isAnimating) return;
    
    document.getElementById('loading').style.display = 'flex';
    let success = false;
    try {
        await runTransaction(ref(db, `users/${uid}`), (user) => {
            if(!user) return;
            if((user.balance || 0) < COST) throw "nomoney";
            user.balance -= COST;
            user.spending_counter = (user.spending_counter || 0) + COST;
            return user;
        });
        success = true;
    } catch(e) {
        if(e === "nomoney") alert("é‡‘å¹£ä¸è¶³ï¼Œå¿«å»é ˜ç´…åŒ…å§ï¼");
    }
    
    document.getElementById('loading').style.display = 'none';
    if(!success) return;

    isPlaying = true;
    currentLevel = 0;
    document.body.classList.remove('danger-mode'); 
    updateHUD();
    renderDoors(true);

    document.getElementById('startBtn').style.display = 'none';
    const cashBtn = document.getElementById('cashoutBtn');
    cashBtn.style.display = 'block';
    cashBtn.innerHTML = `ğŸ’° é ˜å–çå‹µ`;
    cashBtn.classList.add('btn-disabled');
};

async function handleDoorClick(card, idx) {
    const inner = document.getElementById(`inner-${idx}`);
    if(!isPlaying || isAnimating || inner.classList.contains('flipped')) return;

    isAnimating = true;
    inner.classList.add('flipped');
    const back = document.getElementById(`back-${idx}`);

    // æª¢æŸ¥ç‚¸å½ˆ
    if(bombIndices.includes(idx)) {
        back.innerHTML = 'ğŸ§¨';
        inner.parentElement.classList.add('shake-anim');
        inner.parentElement.classList.add('bomb-style');
        
        setTimeout(() => {
            endGame(false);
            isAnimating = false;
        }, 1500);
    } else {
        back.innerHTML = 'ğŸ’°';
        inner.parentElement.classList.add('gem-style');
        
        currentLevel++;
        
        setTimeout(() => {
            updateHUD();
            if(currentLevel >= 8) {
                endGame(true);
            } else {
                renderDoors(true);
            }
            
            const cashBtn = document.getElementById('cashoutBtn');
            cashBtn.classList.remove('btn-disabled');
            cashBtn.innerHTML = `ğŸ’° æ”¶æ‰‹é ˜éŒ¢ (${PRIZES[currentLevel]} P)`;
            isAnimating = false;
        }, 1200);
    }
}

window.cashOut = () => {
    if(!isPlaying || currentLevel === 0 || isAnimating) return;
    endGame(true);
};

async function endGame(isWin) {
    isPlaying = false;
    const finalWin = isWin ? PRIZES[currentLevel] : 0;

    if(isWin && finalWin > 0) {
        await runTransaction(ref(db, `users/${uid}/balance`), (b) => (b||0) + finalWin);
        
        document.getElementById('resIcon').innerText = currentLevel >= 8 ? 'ğŸ‘‘' : 'å…ƒå¯¶';
        document.getElementById('resIcon').innerHTML = currentLevel >= 8 ? 'ğŸ®' : 'ğŸ’°';
        document.getElementById('resTitle').innerText = currentLevel >= 8 ? 'æ­å–œé€šé—œï¼' : 'è½è¢‹ç‚ºå®‰';
        document.getElementById('resVal').innerText = `+${finalWin} P`;
        document.getElementById('resVal').style.color = '#ffd700';
        
        confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 }, colors: ['#ff0000', '#ffd700'] });
        
        if(finalWin >= 100) {
            push(ref(db, `winLogs`), { uid, user: "æ–°æ˜¥å‹‡è€…", game: "å‹‡è€…çˆ¬å¡”", prize: `${finalWin} P`, time: serverTimestamp() });
        }
    } else {
        document.getElementById('resIcon').innerText = 'ğŸ§¨';
        document.getElementById('resTitle').innerText = 'ä¸‹æ¬¡å¥½é‹';
        document.getElementById('resVal').innerText = '-10 P';
        document.getElementById('resVal').style.color = '#ff4d4d';
    }

    const modal = document.getElementById('resModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-active'), 50);
}

window.closeModal = () => {
    document.getElementById('resModal').classList.remove('modal-active');
    setTimeout(() => {
        document.getElementById('resModal').style.display = 'none';
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('cashoutBtn').style.display = 'none';
        
        // é‡ç½®ç‚ºåˆå§‹ç‹€æ…‹
        currentLevel = 0;
        document.body.classList.remove('danger-mode');
        updateHUD(); // HUD æœƒè‡ªå‹•è™•ç†æˆé¡¯ç¤º 1/8
        
        document.getElementById('doorsGrid').innerHTML = '<div style="color:var(--p); font-size:1.5rem; grid-column:span 2; text-align:center; padding:50px; font-weight:900;">ğŸ§¨ æº–å‚™å¥½é–‹é‹äº†å—ï¼Ÿ</div>';
    }, 300);
};

function updateHUD() {
    // é¡¯ç¤ºé‚è¼¯ï¼š
    // å¦‚æœæ­£åœ¨ç©ï¼Œé¡¯ç¤ºã€Œç•¶å‰æŒ‘æˆ°å±¤æ•¸ã€ (currentLevel + 1)
    // å¦‚æœæ²’åœ¨ç©(åˆå§‹)ï¼Œé¡¯ç¤º 1
    // å¦‚æœé€šé—œ (currentLevel 8)ï¼Œé¡¯ç¤º 8
    let displayLvl = currentLevel + 1;
    if(currentLevel >= 8) displayLvl = 8;
    
    document.getElementById('curLvl').innerText = displayLvl;
    document.getElementById('curWin').innerText = PRIZES[currentLevel] + ' P';
    
    // å±éšªæ¨¡å¼åµæ¸¬ (Level 4+, å³å®Œæˆ 3 å±¤å¾Œ)
    const dangerTag = document.getElementById('dangerTag');
    if(currentLevel >= 3) {
        dangerTag.style.display = 'block';
        document.body.classList.add('danger-mode');
    } else {
        dangerTag.style.display = 'none';
        document.body.classList.remove('danger-mode');
    }

    const hintBox = document.getElementById('nextHintBox');
    const nextValSpan = document.getElementById('nextWinVal');
    
    if (isPlaying && currentLevel < 8) {
        hintBox.style.display = 'flex';
        nextValSpan.innerText = PRIZES[currentLevel + 1];
    } else {
        hintBox.style.display = 'none';
    }
}
</script>
</body>
</html>
