<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>å¤¢å·¥å»  | æ–°æ˜¥å‹‡è€…çˆ¬å¡”</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Orbitron:wght@700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg: #800000;
        --card-bg: linear-gradient(145deg, #d4af37, #aa8a2e);
        --p: #ffd700;
        --success: #ffce00;
        --fail: #ff4d4d;
        --accent: #ff0000;
    }
    * { 
        -webkit-tap-highlight-color: transparent; 
        user-select: none; 
        box-sizing: border-box; 
        font-family: 'ZCOOL KuaiLe', sans-serif; /* çµ±ä¸€ä¸­æ–‡å­—é«” */
    }
    body {
        margin: 0; padding: 0;
        background: radial-gradient(circle at center, #a50000, #4a0000);
        color: #fff;
        display: flex; flex-direction: column;
        min-height: 100vh; overflow: hidden;
    }

    /* é ‚éƒ¨å°èˆª */
    .navbar {
        padding: 15px 20px;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px);
        border-bottom: 2px solid var(--p);
        z-index: 100;
    }
    .back-btn { text-decoration: none; color: #ffcccb; font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
    .coin-pill {
        background: rgba(0, 0, 0, 0.5); border: 1px solid var(--p);
        padding: 6px 16px; border-radius: 50px;
        color: var(--p); 
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        display: flex; align-items: center; gap: 5px;
    }
    /* æ•¸å­—å°ˆç”¨å­—é«” */
    .num-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }

    /* éŠæˆ²ä¸»å€ */
    .game-stage {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 20px; position: relative;
    }

    /* é€²åº¦æ¢ HUD */
    .hud-container {
        width: 100%; max-width: 400px; margin-bottom: 20px;
        display: flex; justify-content: space-between; align-items: flex-end;
        background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px;
        border: 1px inset rgba(255,215,0,0.3);
    }
    .level-badge {
        font-size: 2.2rem; color: var(--p); text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    .level-label { font-size: 1rem; color: #ffcccb; margin-bottom: 5px; }
    .next-prize { text-align: right; }
    .prize-val { font-size: 1.6rem; color: #00ff88; }

    /* é–€çš„å®¹å™¨ */
    .doors-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        width: 100%; max-width: 360px;
        perspective: 1000px; /* 3D é€è¦–æ·±åº¦ */
    }

    /* é–€ (å¡ç‰‡å¤–æ¡†) */
    .door-card {
        aspect-ratio: 1/1.2;
        position: relative;
        cursor: pointer;
        border-radius: 12px;
        background: transparent;
    }
    .door-card:active { transform: scale(0.96); transition: transform 0.1s; }

    /* é–€çš„å…§éƒ¨æ—‹è½‰å±¤ (æ ¸å¿ƒå‹•ç•«å±¤) */
    .door-inner {
        position: relative;
        width: 100%; height: 100%;
        text-align: center;
        transition: transform 0.6s; /* ç¿»è½‰é€Ÿåº¦ */
        transform-style: preserve-3d;
        border-radius: 12px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }

    /* ç¿»ç‰Œç‹€æ…‹ */
    .door-inner.flipped { transform: rotateY(180deg); }

    /* é–€çš„æ­£é¢èˆ‡èƒŒé¢å…±ç”¨è¨­å®š */
    .door-face, .door-back {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; /* éš±è—èƒŒé¢ */
        border-radius: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 3px solid var(--p);
    }
    
    /* æ­£é¢ï¼šç´…åŒ…æ¨£å¼ */
    .door-face {
        background: linear-gradient(135deg, #e60000, #990000);
        color: var(--p);
        font-size: 2.5rem;
        z-index: 2;
    }
    .door-face::after {
        content: "ç¦"; font-size: 1.2rem; margin-top: 10px; 
        border: 2px solid var(--p); padding: 5px 10px; border-radius: 50%;
        background: rgba(0,0,0,0.1);
    }

    /* èƒŒé¢ï¼šæ­æ›‰å…§å®¹ */
    .door-back {
        transform: rotateY(180deg);
        background: #222;
        font-size: 3.5rem;
        z-index: 1;
    }
    
    /* çµæœæ¨£å¼ */
    .gem-style .door-back { 
        border-color: #00ff88; 
        background: radial-gradient(circle, #1a472a, #000); 
        box-shadow: 0 0 30px rgba(0, 255, 136, 0.6); 
    }
    .bomb-style .door-back { 
        border-color: var(--fail); 
        background: radial-gradient(circle, #4a1111, #000); 
        box-shadow: 0 0 30px rgba(255, 77, 77, 0.6);
    }
    /* ç‚¸å½ˆæŠ–å‹•å‹•ç•«éœ€å¥—ç”¨åœ¨ card æ•´é«” */
    .shake-anim { animation: shake 0.5s; }

    /* æ§åˆ¶æŒ‰éˆ•å€ */
    .controls {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        max-width: 400px; margin: 0 auto;
        display: flex; gap: 15px; z-index: 50;
    }
    .btn-main {
        flex: 1; padding: 18px; border-radius: 12px; border: 2px solid var(--p);
        font-size: 1.3rem; 
        cursor: pointer; transition: 0.2s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        /* å­—é«”ç¹¼æ‰¿ body è¨­å®š */
    }
    .btn-start {
        background: linear-gradient(to bottom, #ffd700, #ff8c00);
        color: #800000;
    }
    .btn-cashout {
        background: linear-gradient(to bottom, #00b09b, #96c93d);
        color: #fff;
        display: none;
    }
    .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

    /* å‹•ç•« Keyframes */
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* çµæœå½ˆçª— */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }
    .modal-card {
        background: #800000; border: 3px solid var(--p);
        padding: 30px; border-radius: 20px; text-align: center;
        width: 85%; max-width: 320px;
        transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .modal-active .modal-card { transform: scale(1); }
    .modal-icon { font-size: 4rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 0 10px var(--p)); }
    .modal-title { font-size: 1.8rem; color: var(--p); margin-bottom: 10px; }
    .modal-amount { font-size: 2.5rem; color: #fff; margin-bottom: 25px; display: block; }
    .modal-btn { background: var(--p); color: #800000; width: 100%; padding: 15px; border-radius: 10px; font-size: 1.2rem; cursor: pointer; border: none; }

    #loading { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 99; justify-content: center; align-items: center; }
</style>
</head>
<body>

<div class="navbar">
    <a href="index.html" class="back-btn">â¬… è¿”å›å¤§å»³</a>
    <div class="coin-pill">ğŸ§§ <span id="uBal" class="num-font">---</span></div>
</div>

<div class="game-stage">
    <div class="hud-container">
        <div>
            <div class="level-label">ğŸ® ç›®å‰æ¨“å±¤</div>
            <div class="level-badge num-font"><span id="curLvl">0</span><span style="font-size:1rem;color:#ffcccb">/8</span></div>
        </div>
        <div class="next-prize">
            <div class="level-label">ğŸ’° ç•¶å‰çé‡‘</div>
            <div class="prize-val num-font" id="curWin">0 P</div>
        </div>
    </div>

    <div class="doors-grid" id="doorsGrid">
        <div style="color:var(--p); font-size:1.4rem; grid-column:span 2; text-align:center; padding:50px;">ğŸ§¨ æº–å‚™å¥½é–‹é‹äº†å—ï¼Ÿ</div>
    </div>

    <div id="loading"><div style="font-size:3rem; animation:spin 2s linear infinite">ğŸ®</div></div>
</div>

<div class="controls">
    <button class="btn-main btn-start" id="startBtn" onclick="startGame()">é–‹é‹çˆ¬å¡” (10 P)</button>
    <button class="btn-main btn-cashout" id="cashoutBtn" onclick="cashOut()">ğŸ’° è¦‹å¥½å°±æ”¶</button>
</div>

<div class="modal-overlay" id="resModal">
    <div class="modal-card">
        <span class="modal-icon" id="resIcon">ğŸ§§</span>
        <div class="modal-title" id="resTitle">æ–°æ˜¥å¤§å‰</div>
        <span class="modal-amount num-font" id="resVal">+0</span>
        <button class="modal-btn" onclick="closeModal()">ç¹¼çºŒåŠªåŠ›</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const _cc = { apiKey: atob("QUl6YVN5RFBHRUl3Q0t5WXh6NlRZZHhta3dBeElXamZRSThBd2Nv"), databaseURL: atob("aHR0cHM6Ly9kcmVhbTgtN2IxNjEtZGVmYXVsdC1ydGRiLmZpcmViYXNlaW8uY29t"), projectId: atob("ZHJlYW04LTdiMTYx"), appId: atob("MTo2MDYyMTg1MjI0Nzk6d2ViOjI3Mzc2NDNkYjNkZTczNWFmN2UyOWE=") };
const app = initializeApp(_cc); const db = getDatabase(app);
const uid = localStorage.getItem('myScratchCode');
if(!uid) location.href = 'index.html';

const COST = 10;
const PRIZES = [0, 12, 15, 22, 35, 60, 100, 200, 888];
let currentLevel = 0;
let isPlaying = false;
let bombIndex = -1;
let isAnimating = false;

onValue(ref(db, `users/${uid}/balance`), s => {
    document.getElementById('uBal').innerText = (s.val()||0).toLocaleString();
});

// ç”Ÿæˆé–€ (ä¿®å¾©å‹•ç•«çµæ§‹)
function renderDoors(withAnimation = false) {
    const grid = document.getElementById('doorsGrid');
    grid.innerHTML = '';
    bombIndex = Math.floor(Math.random() * 4);

    for(let i=0; i<4; i++) {
        const card = document.createElement('div');
        card.className = 'door-card';
        if(withAnimation) {
            card.style.opacity = '0';
            card.style.animation = `fadeInUp 0.4s ease ${i * 0.1}s forwards`;
        }
        
        // æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ door-inner åŒ…è£¹æ­£åé¢
        card.innerHTML = `
            <div class="door-inner" id="inner-${i}">
                <div class="door-face num-font">${i+1}</div>
                <div class="door-back" id="back-${i}"></div>
            </div>
        `;
        
        card.onclick = () => handleDoorClick(card, i);
        grid.appendChild(card);
    }
}

window.startGame = async () => {
    if(isPlaying || isAnimating) return;
    
    document.getElementById('loading').style.display = 'flex';
    let success = false;
    try {
        await runTransaction(ref(db, `users/${uid}`), (user) => {
            if(!user) return;
            if((user.balance || 0) < COST) throw "nomoney";
            user.balance -= COST;
            user.spending_counter = (user.spending_counter || 0) + COST;
            return user;
        });
        success = true;
    } catch(e) {
        if(e === "nomoney") alert("é‡‘å¹£ä¸è¶³ï¼Œå¿«å»é ˜ç´…åŒ…å§ï¼");
    }
    
    document.getElementById('loading').style.display = 'none';
    if(!success) return;

    isPlaying = true;
    currentLevel = 0;
    updateHUD();
    renderDoors(true);

    document.getElementById('startBtn').style.display = 'none';
    const cashBtn = document.getElementById('cashoutBtn');
    cashBtn.style.display = 'block';
    cashBtn.innerHTML = `ğŸ’° é ˜å–çå‹µ`;
    cashBtn.classList.add('btn-disabled');
};

async function handleDoorClick(card, idx) {
    const inner = document.getElementById(`inner-${idx}`);
    // é˜²æ­¢é‡è¤‡é»æ“Šæˆ–å‹•ç•«ä¸­é»æ“Š
    if(!isPlaying || isAnimating || inner.classList.contains('flipped')) return;

    isAnimating = true;
    inner.classList.add('flipped'); // è§¸ç™¼ç¿»è½‰å‹•ç•«
    const back = document.getElementById(`back-${idx}`);

    if(idx === bombIndex) {
        // è¸©åˆ°é­ç‚® (å¤±æ•—)
        back.innerHTML = 'ğŸ§¨';
        inner.parentElement.classList.add('shake-anim'); // æ•´å€‹å¡ç‰‡æŠ–å‹•
        inner.parentElement.classList.add('bomb-style'); // è®Šæ›´æ¨£å¼
        
        // å»¶é•·ç­‰å¾…æ™‚é–“è‡³ 1.5 ç§’ï¼Œç¢ºä¿ç©å®¶çœ‹æ¸…æ¥š
        setTimeout(() => {
            endGame(false);
            isAnimating = false;
        }, 1500);
    } else {
        // æ‹¿åˆ°é‡‘å…ƒå¯¶ (æˆåŠŸ)
        back.innerHTML = 'ğŸ’°';
        inner.parentElement.classList.add('gem-style');
        
        currentLevel++;
        
        // æˆåŠŸä¹Ÿç­‰å¾… 1.2 ç§’ï¼Œäº«å—é–‹çç¬é–“
        setTimeout(() => {
            updateHUD();
            if(currentLevel >= 8) {
                endGame(true);
            } else {
                renderDoors(true); // é‡ç½®ç‚ºæ–°çš„é–€
            }
            
            const cashBtn = document.getElementById('cashoutBtn');
            cashBtn.classList.remove('btn-disabled');
            cashBtn.innerHTML = `ğŸ’° æ”¶æ‰‹é ˜éŒ¢ (${PRIZES[currentLevel]} P)`;
            isAnimating = false;
        }, 1200);
    }
}

window.cashOut = () => {
    if(!isPlaying || currentLevel === 0 || isAnimating) return;
    endGame(true);
};

async function endGame(isWin) {
    isPlaying = false;
    const finalWin = isWin ? PRIZES[currentLevel] : 0;

    if(isWin && finalWin > 0) {
        await runTransaction(ref(db, `users/${uid}/balance`), (b) => (b||0) + finalWin);
        
        document.getElementById('resIcon').innerText = currentLevel >= 8 ? 'ğŸ‘‘' : 'å…ƒå¯¶';
        document.getElementById('resIcon').innerHTML = currentLevel >= 8 ? 'ğŸ®' : 'ğŸ’°';
        document.getElementById('resTitle').innerText = currentLevel >= 8 ? 'æ­å–œé€šé—œï¼' : 'è½è¢‹ç‚ºå®‰';
        document.getElementById('resVal').innerText = `+${finalWin} P`;
        document.getElementById('resVal').style.color = '#ffd700';
        
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#ff0000', '#ffd700'] });
        
        if(finalWin >= 100) {
            push(ref(db, `winLogs`), { uid, user: "æ–°æ˜¥å‹‡è€…", game: "å‹‡è€…çˆ¬å¡”", prize: `${finalWin} P`, time: serverTimestamp() });
        }
    } else {
        document.getElementById('resIcon').innerText = 'ğŸ§¨';
        document.getElementById('resTitle').innerText = 'ä¸‹æ¬¡å¥½é‹';
        document.getElementById('resVal').innerText = '-10 P';
        document.getElementById('resVal').style.color = '#ff4d4d';
    }

    const modal = document.getElementById('resModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('modal-active'), 50);
}

window.closeModal = () => {
    document.getElementById('resModal').classList.remove('modal-active');
    setTimeout(() => {
        document.getElementById('resModal').style.display = 'none';
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('cashoutBtn').style.display = 'none';
        currentLevel = 0;
        updateHUD();
        document.getElementById('doorsGrid').innerHTML = '<div style="color:var(--p); font-size:1.4rem; grid-column:span 2; text-align:center; padding:50px;">ğŸ§¨ æº–å‚™å¥½é–‹é‹äº†å—ï¼Ÿ</div>';
    }, 300);
};

function updateHUD() {
    document.getElementById('curLvl').innerText = currentLevel;
    document.getElementById('curWin').innerText = PRIZES[currentLevel] + ' P';
}
</script>
</body>
</html>
